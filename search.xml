<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>CPUç¼“å­˜ä¸MESIåè®®</title>
    <url>/posts/1a5fbe08.html</url>
    <content><![CDATA[<h2 id="å¼•è¨€"><a class="markdownIt-Anchor" href="#å¼•è¨€"></a> å¼•è¨€</h2>
<h2 id=""><a class="markdownIt-Anchor" href="#"></a> </h2>
<img src="/posts/1a5fbe08/cpu%E7%BB%93%E6%9E%84%E5%9B%BE.svg" class="" title="cpuç»“æ„å›¾">
]]></content>
      <categories>
        <category>CS</category>
      </categories>
      <tags>
        <tag>cpu</tag>
        <tag>CS</tag>
      </tags>
  </entry>
  <entry>
    <title>è®°å½•ä¸€æ¬¡æ’æŸ¥å› çº¿ç¨‹WAITINGå¯¼è‡´åº”ç”¨å‡æ­»çš„ç»å†</title>
    <url>/posts/7e818be6.html</url>
    <content><![CDATA[<h3 id="èƒŒæ™¯"><a class="markdownIt-Anchor" href="#èƒŒæ™¯"></a> èƒŒæ™¯</h3>
<p>åœ¨ä¸€ä¸ªé˜³å…‰æ˜åªšçš„ä¸‹åˆï¼Œæˆ‘æ­£åœ¨æ‚ å“‰æ¸¸å“‰çš„åœ¨å·¥ä½ä¸Šç•…æ¸¸ç½‘ç»œä¸–ç•Œ(æ‘¸é±¼ ğŸ˜ƒ )ï¼Œå¿½ç„¶å¿ƒé‡Œæœ‰ç‚¹ä¸å¥½çš„é¢„æ„Ÿï¼Œæœç„¶å“ˆï¼Œä¼ä¸šå¾®ä¿¡é‡Œäº§å“ç»ç†å¼¹äº†ä¸€æ¡æ¶ˆæ¯ç»™æˆ‘è¯´æµ‹è¯•æœåŠ¡å™¨çš„ç³»ç»Ÿç™»å½•è¿›å»è·å–ä¸åˆ°èœå•ï¼Œæˆ‘éšå³è¿æ¥åˆ°æµ‹è¯•æœåŠ¡å™¨ï¼Œå¿ƒæƒ³è¿™ç§é—®é¢˜é‡æ–°è¿è¡Œä¸‹åº”è¯¥å°±æ²¡äº‹äº†ï¼Œåˆ°ç³»ç»Ÿç®¡ç†åå°ç›®å½•é‡æ–°è·‘ä¸‹ <a href="http://start.sh">start.sh</a> è„šæœ¬ï¼Œæƒ³ä¸åˆ°ï¼Œç«Ÿç„¶ä¹Ÿè¢«è¿™é—®é¢˜æŠ˜è…¾äº†ä¸€ä¸ªå°æ—¶ï¼Œå› æ­¤è®°å½•ä¸€ä¸‹æ’æŸ¥è¿‡ç¨‹</p>
<h3 id="è¿‡ç¨‹"><a class="markdownIt-Anchor" href="#è¿‡ç¨‹"></a> è¿‡ç¨‹</h3>
<ol>
<li>å½“é‡æ–°è¿è¡Œäº†start.shè„šæœ¬åï¼Œç³»ç»Ÿæ­£å¸¸è¿è¡ŒæˆåŠŸï¼Œä½†æ˜¯è¿‡ä¸€ä¼šå°±ç«‹é©¬åˆæ˜¯å¡æ­»çŠ¶æ€ï¼Œæˆ‘æ‰“å¼€æµè§ˆå™¨ç™»å½•è¿›å…¥ç³»ç»Ÿï¼Œf12æ‰“å¼€æ§åˆ¶å°çœ‹åˆ°è·å–èœå•çš„è¯·æ±‚ä¸€ç›´åœ¨åŠ è½½ä¸­ï¼Œæ²¡æœ‰æ‹¿åˆ°å“åº”ï¼Œä½¿ç”¨ tail å‘½ä»¤æŸ¥çœ‹æ—¥å¿—ä¿¡æ¯ï¼Œè¯·æ±‚æ—¥å¿—å’Œå“åº”çš„æ—¥å¿—ä¿¡æ¯ä¹Ÿéƒ½èƒ½å¤Ÿæ­£å¸¸è¾“å‡º</li>
<li>å¿ƒæƒ³è¿™æ˜¯ä»€ä¹ˆç©æ„ï¼Œå“åº”ä¹Ÿè¿”å›äº†ä¸ºä»€ä¹ˆä¼šå¡æ­»å‘¢ï¼ŒçŒœæµ‹æ˜¯ä¸æ˜¯ç½‘å…³å‡ºäº†é—®é¢˜ï¼Œéšå³åˆå»æ’æŸ¥ç½‘å…³çš„æ—¥å¿—ï¼Œå‘ç°åªè¾“å‡ºäº†è¯·æ±‚çš„æ—¥å¿—ï¼Œæ²¡æœ‰è¾“å‡ºå“åº”çš„æ—¥å¿—ï¼Œéš¾é“æ˜¯ç½‘å…³çš„é—®é¢˜å—ï¼Œéšå³remote debugç½‘å…³æœåŠ¡(æµ‹è¯•æœåŠ¡å™¨åœ¨æœ¬åœ°æœºæˆ¿ï¼Œä¸ºäº†æ–¹ä¾¿è°ƒè¯•å¼€å¯äº†remote debug)ï¼Œå°†æ–­ç‚¹æ‰“åœ¨äº† <code>NettyRoutingFilter#filter</code> æ–¹æ³•ä¸­(NettyRoutingFilteræ˜¯æœ€ç»ˆçš„å‘é€è¯·æ±‚çš„è¿‡æ»¤å™¨)ï¼Œç„¶åè®©å®¢æˆ·ç«¯çš„è¯·æ±‚å‘é€è¿‡æ¥ï¼Œå‘ç°åªæœ‰è¯·æ±‚å‘é€è¿‡å»ï¼Œè¿Ÿè¿Ÿæ¥å—ä¸åˆ°ç³»ç»ŸæœåŠ¡çš„å“åº”(æ²¡æœ‰é…ç½®responseTimeouté…ç½®ï¼Œä¼šä¸€ç›´ç­‰å¾…æœåŠ¡çš„å“åº”)ï¼Œå› æ­¤çŸ¥é“é—®é¢˜ç‚¹è‚¯å®šå‘ç”Ÿåœ¨ç³»ç»ŸæœåŠ¡ä¾§äº†</li>
<li>æ’æŸ¥æ˜¯ä¸æ˜¯ç³»ç»ŸæœåŠ¡æ‰€åœ¨æœåŠ¡å™¨çš„ç¡¬ç›˜ç©ºé—´æˆ–è€…å†…å­˜ä¸è¶³äº†å¯¼è‡´çš„ï¼Œ
<ul>
<li>ä½¿ç”¨ <code>df -h</code> å‘½ä»¤æŸ¥çœ‹è¿˜æœ‰100å¤šGçš„ç©ºé—´ï¼Œä¸æ˜¯ç£ç›˜ç©ºé—´ä¸è¶³å¼•å‘çš„</li>
<li>ä½¿ç”¨<code>free -m -h</code>è·å–ç©ºé—²å†…å­˜ä¹Ÿè¿˜è¦10å¤šGï¼Œ</li>
<li>ä½¿ç”¨<code>jstat -gc è¿›ç¨‹id 2000 5 </code> æŸ¥çœ‹javaè¿›ç¨‹å†…å­˜ä½¿ç”¨æƒ…å†µï¼Œä¹Ÿéƒ½æ˜¯æ­£å¸¸çš„</li>
</ul>
</li>
<li>çœ‹åˆ°éƒ½æ˜¯æ­£å¸¸çš„ï¼Œé¡¿æ—¶å°±æ¯«æ— å¤´ç»ªäº†ï¼Œåªèƒ½ç–¯ç‹‚æ‘¸å¤´ä»¥ç¤ºä¸è§£ï¼Œçªç„¶è„‘æµ·é‡Œé—ªç°äº†ä¸€ç‚¹æ€è·¯ï¼Œæ—¢ç„¶è¯·æ±‚æ— å“åº”ï¼Œæ˜¯ä¸æ˜¯çº¿ç¨‹è¢«é˜»å¡ä½äº†ï¼Œéšå³ <code>jastck è¿›ç¨‹id</code> å‘½ä»¤æ‰“å°ä¸‹æœåŠ¡çš„çº¿ç¨‹ä¿¡æ¯ï¼ŒæŸ¥çœ‹ä¸‹è¯·æ±‚çº¿ç¨‹çš„çŠ¶æ€å †æ ˆï¼Œéšå³å°±å‘ç°äº†é—®é¢˜æ ¹æºæ‰€åœ¨</li>
</ol>
<pre class="line-numbers language-java" data-language="java"><code class="language-java">åªç»™å‡ºè¯·æ±‚çº¿ç¨‹çš„çŠ¶æ€ä»¥åŠå †æ ˆä¿¡æ¯
<span class="token string">"http-nio-6002-exec-2"</span> #<span class="token number">151</span> daemon prio<span class="token operator">=</span><span class="token number">5</span> os_prio<span class="token operator">=</span><span class="token number">0</span> tid<span class="token operator">=</span><span class="token number">0x000070fb4d7c8000</span> nid<span class="token operator">=</span><span class="token number">0x3c3178</span> waiting <span class="token keyword">for</span> monitor entry <span class="token punctuation">[</span><span class="token number">0x000070fce07fb000</span><span class="token punctuation">]</span>

<span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Thread<span class="token punctuation">.</span>State</span><span class="token operator">:</span> <span class="token constant">BLOCKED</span> <span class="token punctuation">(</span>on object monitor<span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>impl<span class="token punctuation">.</span></span>SocketFrameHandler</span><span class="token punctuation">.</span><span class="token function">writeFrame</span><span class="token punctuation">(</span><span class="token class-name">SocketFrameHandler</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">170</span><span class="token punctuation">)</span>

<span class="token operator">-</span> waiting <span class="token keyword">to</span> <span class="token namespace">lock</span> <span class="token generics"><span class="token punctuation">&lt;</span>0x00000000eac318c0<span class="token punctuation">></span></span> <span class="token punctuation">(</span>a <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>DataOutputStream</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>impl<span class="token punctuation">.</span></span>AMQConnection</span><span class="token punctuation">.</span><span class="token function">writeFrame</span><span class="token punctuation">(</span><span class="token class-name">AMQConnection</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">562</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>impl<span class="token punctuation">.</span></span>AMQCommand</span><span class="token punctuation">.</span><span class="token function">transmit</span><span class="token punctuation">(</span><span class="token class-name">AMQCommand</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">130</span><span class="token punctuation">)</span>

<span class="token operator">-</span> locked <span class="token generics"><span class="token punctuation">&lt;</span>0x00000000fa3a3cb0<span class="token punctuation">></span></span> <span class="token punctuation">(</span>a <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>impl<span class="token punctuation">.</span></span>CommandAssembler</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>impl<span class="token punctuation">.</span></span>AMQChannel</span><span class="token punctuation">.</span><span class="token function">quiescingTransmit</span><span class="token punctuation">(</span><span class="token class-name">AMQChannel</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">447</span><span class="token punctuation">)</span>

<span class="token operator">-</span> locked <span class="token generics"><span class="token punctuation">&lt;</span>0x00000000fa3a38d8<span class="token punctuation">></span></span> <span class="token punctuation">(</span>a <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Object</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>impl<span class="token punctuation">.</span></span>AMQChannel</span><span class="token punctuation">.</span><span class="token function">quiescingTransmit</span><span class="token punctuation">(</span><span class="token class-name">AMQChannel</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">429</span><span class="token punctuation">)</span>

<span class="token operator">-</span> locked <span class="token generics"><span class="token punctuation">&lt;</span>0x00000000fa3a38d8<span class="token punctuation">></span></span> <span class="token punctuation">(</span>a <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Object</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>impl<span class="token punctuation">.</span></span>AMQChannel</span><span class="token punctuation">.</span><span class="token function">quiescingRpc</span><span class="token punctuation">(</span><span class="token class-name">AMQChannel</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">346</span><span class="token punctuation">)</span>

<span class="token operator">-</span> locked <span class="token generics"><span class="token punctuation">&lt;</span>0x00000000fa3a38d8<span class="token punctuation">></span></span> <span class="token punctuation">(</span>a <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Object</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>impl<span class="token punctuation">.</span></span>AMQChannel</span><span class="token punctuation">.</span><span class="token function">rpc</span><span class="token punctuation">(</span><span class="token class-name">AMQChannel</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">337</span><span class="token punctuation">)</span>

<span class="token operator">-</span> locked <span class="token generics"><span class="token punctuation">&lt;</span>0x00000000fa3a38d8<span class="token punctuation">></span></span> <span class="token punctuation">(</span>a <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Object</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>impl<span class="token punctuation">.</span></span>AMQChannel</span><span class="token punctuation">.</span><span class="token function">privateRpc</span><span class="token punctuation">(</span><span class="token class-name">AMQChannel</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">277</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>impl<span class="token punctuation">.</span></span>AMQChannel</span><span class="token punctuation">.</span><span class="token function">exnWrappingRpc</span><span class="token punctuation">(</span><span class="token class-name">AMQChannel</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">138</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>impl<span class="token punctuation">.</span></span>ChannelN</span><span class="token punctuation">.</span><span class="token keyword">open</span><span class="token punctuation">(</span><span class="token class-name">ChannelN</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">133</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>impl<span class="token punctuation">.</span></span>ChannelManager</span><span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token class-name">ChannelManager</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">176</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>impl<span class="token punctuation">.</span></span>AMQConnection</span><span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token class-name">AMQConnection</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">553</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>rabbit<span class="token punctuation">.</span>connection<span class="token punctuation">.</span></span>SimpleConnection</span><span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token class-name">SimpleConnection</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">57</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>rabbit<span class="token punctuation">.</span>connection<span class="token punctuation">.</span></span>CachingConnectionFactory</span>$<span class="token class-name">ChannelCachingConnectionProxy</span><span class="token punctuation">.</span><span class="token function">createBareChannel</span><span class="token punctuation">(</span><span class="token class-name">CachingConnectionFactory</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1365</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>rabbit<span class="token punctuation">.</span>connection<span class="token punctuation">.</span></span>CachingConnectionFactory</span>$<span class="token class-name">ChannelCachingConnectionProxy</span><span class="token punctuation">.</span>access$<span class="token function">200</span><span class="token punctuation">(</span><span class="token class-name">CachingConnectionFactory</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1351</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>rabbit<span class="token punctuation">.</span>connection<span class="token punctuation">.</span></span>CachingConnectionFactory</span><span class="token punctuation">.</span><span class="token function">doCreateBareChannel</span><span class="token punctuation">(</span><span class="token class-name">CachingConnectionFactory</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">672</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>rabbit<span class="token punctuation">.</span>connection<span class="token punctuation">.</span></span>CachingConnectionFactory</span><span class="token punctuation">.</span><span class="token function">createBareChannel</span><span class="token punctuation">(</span><span class="token class-name">CachingConnectionFactory</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">655</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>rabbit<span class="token punctuation">.</span>connection<span class="token punctuation">.</span></span>CachingConnectionFactory</span><span class="token punctuation">.</span><span class="token function">getCachedChannelProxy</span><span class="token punctuation">(</span><span class="token class-name">CachingConnectionFactory</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">625</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>rabbit<span class="token punctuation">.</span>connection<span class="token punctuation">.</span></span>CachingConnectionFactory</span><span class="token punctuation">.</span><span class="token function">getChannel</span><span class="token punctuation">(</span><span class="token class-name">CachingConnectionFactory</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">516</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>rabbit<span class="token punctuation">.</span>connection<span class="token punctuation">.</span></span>CachingConnectionFactory</span><span class="token punctuation">.</span>access$<span class="token function">1700</span><span class="token punctuation">(</span><span class="token class-name">CachingConnectionFactory</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">102</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>rabbit<span class="token punctuation">.</span>connection<span class="token punctuation">.</span></span>CachingConnectionFactory</span>$<span class="token class-name">ChannelCachingConnectionProxy</span><span class="token punctuation">.</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token class-name">CachingConnectionFactory</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1370</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>rabbit<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span>RabbitTemplate</span><span class="token punctuation">.</span><span class="token function">doExecute</span><span class="token punctuation">(</span><span class="token class-name">RabbitTemplate</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">2079</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>rabbit<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span>RabbitTemplate</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">RabbitTemplate</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">2047</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>rabbit<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span>RabbitTemplate</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token class-name">RabbitTemplate</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">994</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>rabbit<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span>RabbitTemplate</span><span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token class-name">RabbitTemplate</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1100</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>rabbit<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span>RabbitTemplate</span><span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token class-name">RabbitTemplate</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1091</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>xx<span class="token punctuation">.</span>logger<span class="token punctuation">.</span>reports<span class="token punctuation">.</span></span>RabbitLoggerReport</span><span class="token punctuation">.</span><span class="token function">reportLog</span><span class="token punctuation">(</span><span class="token class-name">RabbitLoggerReport</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">25</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>xx<span class="token punctuation">.</span>logger<span class="token punctuation">.</span>reports<span class="token punctuation">.</span></span>DefaultLoggerReportChain</span><span class="token punctuation">.</span><span class="token function">reportLog</span><span class="token punctuation">(</span><span class="token class-name">DefaultLoggerReportChain</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">71</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>xx<span class="token punctuation">.</span>logger<span class="token punctuation">.</span>reports<span class="token punctuation">.</span></span>DefaultLoggerReportChain</span><span class="token punctuation">.</span><span class="token function">reportLog</span><span class="token punctuation">(</span><span class="token class-name">DefaultLoggerReportChain</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">72</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>xx<span class="token punctuation">.</span>logger<span class="token punctuation">.</span>reports<span class="token punctuation">.</span></span>DefaultLoggerReportChain</span><span class="token punctuation">.</span><span class="token function">reportLog</span><span class="token punctuation">(</span><span class="token class-name">DefaultLoggerReportChain</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">60</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>xx<span class="token punctuation">.</span>logger<span class="token punctuation">.</span>advisor<span class="token punctuation">.</span></span>LogReportInterceptor</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">LogReportInterceptor</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">53</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>aop<span class="token punctuation">.</span>framework<span class="token punctuation">.</span></span>ReflectiveMethodInvocation</span><span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token class-name">ReflectiveMethodInvocation</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">186</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>xx<span class="token punctuation">.</span>logger<span class="token punctuation">.</span>advisor<span class="token punctuation">.</span></span>LogReportInterceptor</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">LogReportInterceptor</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">46</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>aop<span class="token punctuation">.</span>framework<span class="token punctuation">.</span></span>ReflectiveMethodInvocation</span><span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token class-name">ReflectiveMethodInvocation</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">186</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>aop<span class="token punctuation">.</span>framework<span class="token punctuation">.</span></span>CglibAopProxy</span>$<span class="token class-name">DynamicAdvisedInterceptor</span><span class="token punctuation">.</span><span class="token function">intercept</span><span class="token punctuation">(</span><span class="token class-name">CglibAopProxy</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">688</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>xx<span class="token punctuation">.</span>sys<span class="token punctuation">.</span>modules<span class="token punctuation">.</span>system<span class="token punctuation">.</span>controller<span class="token punctuation">.</span></span>SysFileController</span>$$<span class="token class-name">EnhancerBySpringCGLIB</span>$$bc9efccd<span class="token punctuation">.</span><span class="token function">queryByRelevanceId</span><span class="token punctuation">(</span><span class="token generics"><span class="token punctuation">&lt;</span>generated<span class="token punctuation">></span></span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">sun<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span>GeneratedMethodAccessor357</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Unknown</span> <span class="token class-name">Source</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">sun<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span>DelegatingMethodAccessorImpl</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">DelegatingMethodAccessorImpl</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">43</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span>Method</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Method</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">498</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>method<span class="token punctuation">.</span>support<span class="token punctuation">.</span></span>InvocableHandlerMethod</span><span class="token punctuation">.</span><span class="token function">doInvoke</span><span class="token punctuation">(</span><span class="token class-name">InvocableHandlerMethod</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">190</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>method<span class="token punctuation">.</span>support<span class="token punctuation">.</span></span>InvocableHandlerMethod</span><span class="token punctuation">.</span><span class="token function">invokeForRequest</span><span class="token punctuation">(</span><span class="token class-name">InvocableHandlerMethod</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">138</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>mvc<span class="token punctuation">.</span>method<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span>ServletInvocableHandlerMethod</span><span class="token punctuation">.</span><span class="token function">invokeAndHandle</span><span class="token punctuation">(</span><span class="token class-name">ServletInvocableHandlerMethod</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">104</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>mvc<span class="token punctuation">.</span>method<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span>RequestMappingHandlerAdapter</span><span class="token punctuation">.</span><span class="token function">invokeHandlerMethod</span><span class="token punctuation">(</span><span class="token class-name">RequestMappingHandlerAdapter</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">892</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>mvc<span class="token punctuation">.</span>method<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span>RequestMappingHandlerAdapter</span><span class="token punctuation">.</span><span class="token function">handleInternal</span><span class="token punctuation">(</span><span class="token class-name">RequestMappingHandlerAdapter</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">797</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>mvc<span class="token punctuation">.</span>method<span class="token punctuation">.</span></span>AbstractHandlerMethodAdapter</span><span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span><span class="token class-name">AbstractHandlerMethodAdapter</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">87</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span>DispatcherServlet</span><span class="token punctuation">.</span><span class="token function">doDispatch</span><span class="token punctuation">(</span><span class="token class-name">DispatcherServlet</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1039</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span>DispatcherServlet</span><span class="token punctuation">.</span><span class="token function">doService</span><span class="token punctuation">(</span><span class="token class-name">DispatcherServlet</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">942</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span>FrameworkServlet</span><span class="token punctuation">.</span><span class="token function">processRequest</span><span class="token punctuation">(</span><span class="token class-name">FrameworkServlet</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1005</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span>FrameworkServlet</span><span class="token punctuation">.</span><span class="token function">doGet</span><span class="token punctuation">(</span><span class="token class-name">FrameworkServlet</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">897</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span>HttpServlet</span><span class="token punctuation">.</span><span class="token function">service</span><span class="token punctuation">(</span><span class="token class-name">HttpServlet</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">634</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span>FrameworkServlet</span><span class="token punctuation">.</span><span class="token function">service</span><span class="token punctuation">(</span><span class="token class-name">FrameworkServlet</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">882</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span>HttpServlet</span><span class="token punctuation">.</span><span class="token function">service</span><span class="token punctuation">(</span><span class="token class-name">HttpServlet</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">741</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>catalina<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span>ApplicationFilterChain</span><span class="token punctuation">.</span><span class="token function">internalDoFilter</span><span class="token punctuation">(</span><span class="token class-name">ApplicationFilterChain</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">231</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>catalina<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span>ApplicationFilterChain</span><span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ApplicationFilterChain</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">166</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>tomcat<span class="token punctuation">.</span>websocket<span class="token punctuation">.</span>server<span class="token punctuation">.</span></span>WsFilter</span><span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">WsFilter</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">53</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>catalina<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span>ApplicationFilterChain</span><span class="token punctuation">.</span><span class="token function">internalDoFilter</span><span class="token punctuation">(</span><span class="token class-name">ApplicationFilterChain</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">193</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>catalina<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span>ApplicationFilterChain</span><span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ApplicationFilterChain</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">166</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>druid<span class="token punctuation">.</span>support<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span>WebStatFilter</span><span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">WebStatFilter</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">124</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>catalina<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span>ApplicationFilterChain</span><span class="token punctuation">.</span><span class="token function">internalDoFilter</span><span class="token punctuation">(</span><span class="token class-name">ApplicationFilterChain</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">193</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>catalina<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span>ApplicationFilterChain</span><span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ApplicationFilterChain</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">166</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>xx<span class="token punctuation">.</span>common<span class="token punctuation">.</span>xss<span class="token punctuation">.</span></span>XssFilter</span><span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">XssFilter</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">55</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>catalina<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span>ApplicationFilterChain</span><span class="token punctuation">.</span><span class="token function">internalDoFilter</span><span class="token punctuation">(</span><span class="token class-name">ApplicationFilterChain</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">193</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>catalina<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span>ApplicationFilterChain</span><span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ApplicationFilterChain</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">166</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>filter<span class="token punctuation">.</span></span>RequestContextFilter</span><span class="token punctuation">.</span><span class="token function">doFilterInternal</span><span class="token punctuation">(</span><span class="token class-name">RequestContextFilter</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">99</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>filter<span class="token punctuation">.</span></span>OncePerRequestFilter</span><span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">OncePerRequestFilter</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">107</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>catalina<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span>ApplicationFilterChain</span><span class="token punctuation">.</span><span class="token function">internalDoFilter</span><span class="token punctuation">(</span><span class="token class-name">ApplicationFilterChain</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">193</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>catalina<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span>ApplicationFilterChain</span><span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ApplicationFilterChain</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">166</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>filter<span class="token punctuation">.</span></span>FormContentFilter</span><span class="token punctuation">.</span><span class="token function">doFilterInternal</span><span class="token punctuation">(</span><span class="token class-name">FormContentFilter</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">92</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>filter<span class="token punctuation">.</span></span>OncePerRequestFilter</span><span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">OncePerRequestFilter</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">107</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>catalina<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span>ApplicationFilterChain</span><span class="token punctuation">.</span><span class="token function">internalDoFilter</span><span class="token punctuation">(</span><span class="token class-name">ApplicationFilterChain</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">193</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>catalina<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span>ApplicationFilterChain</span><span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ApplicationFilterChain</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">166</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>filter<span class="token punctuation">.</span></span>HiddenHttpMethodFilter</span><span class="token punctuation">.</span><span class="token function">doFilterInternal</span><span class="token punctuation">(</span><span class="token class-name">HiddenHttpMethodFilter</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">93</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>filter<span class="token punctuation">.</span></span>OncePerRequestFilter</span><span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">OncePerRequestFilter</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">107</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>catalina<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span>ApplicationFilterChain</span><span class="token punctuation">.</span><span class="token function">internalDoFilter</span><span class="token punctuation">(</span><span class="token class-name">ApplicationFilterChain</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">193</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>catalina<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span>ApplicationFilterChain</span><span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ApplicationFilterChain</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">166</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>filter<span class="token punctuation">.</span></span>CharacterEncodingFilter</span><span class="token punctuation">.</span><span class="token function">doFilterInternal</span><span class="token punctuation">(</span><span class="token class-name">CharacterEncodingFilter</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">200</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>filter<span class="token punctuation">.</span></span>OncePerRequestFilter</span><span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">OncePerRequestFilter</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">107</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>catalina<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span>ApplicationFilterChain</span><span class="token punctuation">.</span><span class="token function">internalDoFilter</span><span class="token punctuation">(</span><span class="token class-name">ApplicationFilterChain</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">193</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>catalina<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span>ApplicationFilterChain</span><span class="token punctuation">.</span><span class="token function">doFilter</span><span class="token punctuation">(</span><span class="token class-name">ApplicationFilterChain</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">166</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>catalina<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span>StandardWrapperValve</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">StandardWrapperValve</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">200</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>catalina<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span>StandardContextValve</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">StandardContextValve</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">96</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>catalina<span class="token punctuation">.</span>authenticator<span class="token punctuation">.</span></span>AuthenticatorBase</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">AuthenticatorBase</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">490</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>catalina<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span>StandardHostValve</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">StandardHostValve</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">139</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>catalina<span class="token punctuation">.</span>valves<span class="token punctuation">.</span></span>ErrorReportValve</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">ErrorReportValve</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">92</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>catalina<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span>StandardEngineValve</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">StandardEngineValve</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">74</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>catalina<span class="token punctuation">.</span>connector<span class="token punctuation">.</span></span>CoyoteAdapter</span><span class="token punctuation">.</span><span class="token function">service</span><span class="token punctuation">(</span><span class="token class-name">CoyoteAdapter</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">343</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>coyote<span class="token punctuation">.</span>http11<span class="token punctuation">.</span></span>Http11Processor</span><span class="token punctuation">.</span><span class="token function">service</span><span class="token punctuation">(</span><span class="token class-name">Http11Processor</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">408</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>coyote<span class="token punctuation">.</span></span>AbstractProcessorLight</span><span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span><span class="token class-name">AbstractProcessorLight</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">66</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>coyote<span class="token punctuation">.</span></span>AbstractProtocol</span>$<span class="token class-name">ConnectionHandler</span><span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span><span class="token class-name">AbstractProtocol</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">836</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>tomcat<span class="token punctuation">.</span>util<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span>NioEndpoint</span>$<span class="token class-name">SocketProcessor</span><span class="token punctuation">.</span><span class="token function">doRun</span><span class="token punctuation">(</span><span class="token class-name">NioEndpoint</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1747</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>tomcat<span class="token punctuation">.</span>util<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span>SocketProcessorBase</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">SocketProcessorBase</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">49</span><span class="token punctuation">)</span>

<span class="token operator">-</span> locked <span class="token generics"><span class="token punctuation">&lt;</span>0x00000000f97c1de0<span class="token punctuation">></span></span> <span class="token punctuation">(</span>a <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>tomcat<span class="token punctuation">.</span>util<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span>NioEndpoint</span>$<span class="token class-name">NioSocketWrapper</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span>ThreadPoolExecutor</span><span class="token punctuation">.</span><span class="token function">runWorker</span><span class="token punctuation">(</span><span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1149</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span>ThreadPoolExecutor</span>$<span class="token class-name">Worker</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">624</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>tomcat<span class="token punctuation">.</span>util<span class="token punctuation">.</span>threads<span class="token punctuation">.</span></span>TaskThread</span>$<span class="token class-name">WrappingRunnable</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">TaskThread</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">61</span><span class="token punctuation">)</span>

at <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>Thread</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">748</span><span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol start="5">
<li>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„è¯·æ±‚çº¿ç¨‹å·²ç»è¢«BLOCKEDäº†ï¼Œçº¿ç¨‹å †æ ˆè¡¨æ˜æ˜¯rabbitmqæ¶ˆæ¯å‘é€é˜»å¡ä½äº†ï¼Œå› ä¸ºæˆ‘ä»¬çš„æ—¥å¿—åˆ‡é¢ä¼šå°†è¯·æ±‚çš„æ—¥å¿—ä¿¡æ¯å‘é€åˆ°rabbitmqä¸­ï¼Œæ‰€ä»¥å †æ ˆé‡Œå‡ºç°äº†rabbitmqï¼Œè¿™ä¹Ÿè§£é‡Šäº†æ§åˆ¶å°å¯ä»¥æ­£å¸¸è¾“å‡ºï¼Œä½†æ˜¯è¯·æ±‚å°±æ˜¯æ²¡æœ‰è¿”å›ç›¸åº”</li>
<li>éšå³è¿æ¥rabbitmqçš„æœåŠ¡å™¨ï¼Œæ‰“å°æ—¥å¿—çœ‹ä¸‹é”™è¯¯ä¿¡æ¯ï¼Œå‘ç°ç£ç›˜ä¸è¶³å¯¼è‡´æ¶ˆæ¯æ ¹æœ¬æ— æ³•å†™å…¥ï¼Œä½¿ç”¨<code>df -h</code> æŒ‡ä»¤æŸ¥çœ‹ç¡¬ç›˜ç©ºé—´æƒ…å†µï¼Œå‘ç°åªæœ‰å‡ ç™¾kçš„ç©ºé—´äº†ï¼Œå› ä¸ºè¿™å°æœåŠ¡å™¨åªè¿è¡Œäº†dockerå®¹å™¨ï¼ŒçŒœæµ‹æ˜¯dockerçš„è¿è¡Œæ—¥å¿—æœªæ¸…ç†å¯¼è‡´ç©ºé—´å ç”¨çš„è¿‡å¤§ï¼Œç„¶åç¼–å†™äº†æ¸…ç†æ—¥å¿—çš„è„šæœ¬</li>
</ol>
<pre class="line-numbers language-bash" data-language="bash"><div class="caption"><span>title</span></div><code class="language-bash"><span class="token shebang important">#!/bin/sh </span>
  
<span class="token builtin class-name">echo</span> <span class="token string">"======== start clean docker containers logs ========"</span>  
  
<span class="token assign-left variable">logs</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">find</span> /var/lib/docker/containers/ <span class="token parameter variable">-name</span> *-json.log<span class="token variable">)</span></span>  
  
<span class="token keyword">for</span> <span class="token for-or-select variable">log</span> <span class="token keyword">in</span> <span class="token variable">$logs</span>  
        <span class="token keyword">do</span>  
                <span class="token builtin class-name">echo</span> <span class="token string">"clean logs : <span class="token variable">$log</span>"</span>  
                <span class="token function">cat</span> /dev/null <span class="token operator">></span> <span class="token variable">$log</span>  
        <span class="token keyword">done</span>  

<span class="token builtin class-name">echo</span> <span class="token string">"======== end clean docker containers logs ========"</span>  <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å†åˆ·æ–°æµè§ˆå™¨è¯·æ±‚æœç„¶ç«‹é©¬æˆåŠŸäº†ï¼Œé•¿åä¸€å£æ°”ï¼Œä¸è¿‡ç”±äºdockerä¼šä¸€ç›´è¿è¡Œï¼Œäº§ç”Ÿçš„æ—¥å¿—å¤§å°ä¼šæºæºä¸æ–­çš„å¢é•¿ï¼Œä¸ºäº†æ²»æœ¬è®¾ç½®äº†dockerçš„æ—¥å¿—å¤§å°ä¸Šé™ï¼Œä»¥å…å†å‡ºç°è¿™ç§æƒ…å†µ<br />
7. ä¿®æ”¹<code>/etc/docker/daemon.json</code> æ–‡ä»¶ï¼Œå°†ä¸‹é¢çš„å†…å®¹å¤åˆ¶è¿›å»å† <code>systemctl restart docker</code> å³å¯</p>
<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token comment"># å¢åŠ ä¸‹é¢çš„å†…å®¹</span>
"log<span class="token punctuation">-</span>driver"<span class="token punctuation">:</span><span class="token string">"json-file"</span><span class="token punctuation">,</span>
<span class="token key atrule">"log-opts"</span><span class="token punctuation">:</span> <span class="token punctuation">&#123;</span>"max<span class="token punctuation">-</span>size"<span class="token punctuation">:</span><span class="token string">"1g"</span><span class="token punctuation">,</span> "max<span class="token punctuation">-</span>file"<span class="token punctuation">:</span><span class="token string">"3"</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>]]></content>
      <categories>
        <category>å·¥ä½œlog</category>
      </categories>
  </entry>
  <entry>
    <title>Hotspotæºç å‰–æJavaæ–¹æ³•æ‰§è¡Œæµç¨‹</title>
    <url>/posts/48bea92d.html</url>
    <content><![CDATA[<h4 id="1-èƒŒæ™¯"><a class="markdownIt-Anchor" href="#1-èƒŒæ™¯"></a> 1. èƒŒæ™¯</h4>
<p>åœ¨å­¦ä¹ JMMçš„è¿‡ç¨‹ä¸­äº§ç”Ÿäº†å¯¹æƒ³æ¢ç´¢æ ˆå¸§å†…å­˜åˆ†é…çš„åº•å±‚åŸç†çš„æƒ³æ³•ï¼Œæ•…æ­¤å†™ä¸‹è¿™ç¯‡åšå®¢ä»¥æ¢³ç†å’Œå­¦ä¹ hotspotè™šæ‹Ÿæœºæ˜¯å¦‚ä½•æ‰§è¡Œjavaæ–¹æ³•å¹¶ä¸”åˆ†é…æ ˆå¸§ç©ºé—´çš„</p>
<blockquote>
<p>æœ¬ç¯‡åšå®¢æ˜¯åŸºäºHotspotçš„ CppInterpreter.cpp[^1] æ‰€ç¼–å†™çš„ï¼Œå…¶ä»–åŸºäºç¡¬ä»¶æ¶æ„è€Œå¼€å‘çš„æ±‡ç¼–ä»£ç è®©äººæ™¦æ¶©éš¾æ‡‚ï¼Œä¸è¿‡åŸç†éƒ½ä¸€æ ·çš„ï¼Œæ‰€ä»¥æ— éœ€çº ç»“</p>
</blockquote>
<h4 id="2-ç›¸å…³æ¦‚å¿µ"><a class="markdownIt-Anchor" href="#2-ç›¸å…³æ¦‚å¿µ"></a> 2. ç›¸å…³æ¦‚å¿µ</h4>
<h5 id="ç‰¹æ®Šå¯„å­˜å™¨"><a class="markdownIt-Anchor" href="#ç‰¹æ®Šå¯„å­˜å™¨"></a> ç‰¹æ®Šå¯„å­˜å™¨</h5>
<ul>
<li><code>sp(stack pointer)</code>: æ ˆé¡¶æŒ‡é’ˆï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½ä¼šæœ‰ç§æœ‰çš„æ ˆï¼Œè€Œè¿™ä¸ªæŒ‡é’ˆæŒ‡å‘çº¿ç¨‹æ ˆçš„é¡¶éƒ¨ï¼Œå‹æ ˆå‡ºæ ˆéƒ½ä¾é æ­¤æŒ‡é’ˆçš„ç§»åŠ¨</li>
<li><code>fp(frame pointer)</code>ï¼šæ ˆå¸§æŒ‡é’ˆï¼Œjvmä¼šç»™æ¯ä¸ªè°ƒç”¨çš„æ–¹æ³•åˆ†é…ä¸€ä¸ªæ ˆå¸§ï¼Œç”¨äºå­˜å‚¨æ–¹æ³•çš„å±€éƒ¨å˜é‡ï¼Œå‚æ•°å’Œè¿”å›åœ°å€ç­‰ï¼Œè€Œè¿™ä¸ªæŒ‡é’ˆæŒ‡å‘æ ˆå¸§çš„èµ·å§‹åœ°å€</li>
<li><code>bcp(byte code poiniter)</code>ï¼šå­—èŠ‚ç æŒ‡é’ˆï¼Œå­˜å‚¨å½“å‰æ‰§è¡Œçš„Javaå­—èŠ‚ç æŒ‡ä»¤çš„ä½ç½®ï¼Œæ¯æ‰§è¡Œå®Œå½“å‰æŒ‡ä»¤ï¼Œå°±ä¼šæ›´æ–°ä¸ºä¸‹ä¸€æ¡è¦æ‰§è¡Œçš„å­—èŠ‚ç æŒ‡ä»¤çš„ä½ç½®</li>
<li><code>pc(program counter pointer)</code>ï¼šç¨‹åºè®¡æ•°å™¨ï¼Œç”¨äºå­˜å‚¨ä¸‹ä¸€æ¡å³å°†è¦æ‰§è¡Œçš„æŒ‡ä»¤çš„å†…å­˜åœ°å€
<ul>
<li>æ³¨æ„ä¸ä¸Šé¢çš„bcpæ˜¯ä¸åŒçš„ä½œç”¨ï¼Œpcæ˜¯cpuæ‰€ä½¿ç”¨çš„ï¼Œè€Œbcpæ˜¯jvmæ‰€ä½¿ç”¨çš„ï¼Œä¸€æ¡å­—èŠ‚ç æŒ‡ä»¤å¯¹åº”ç€åº•å±‚å¤šæ¡æŒ‡ä»¤</li>
</ul>
</li>
</ul>
<h5 id="è°ƒç”¨æ–¹æ³•å­—èŠ‚ç æŒ‡ä»¤"><a class="markdownIt-Anchor" href="#è°ƒç”¨æ–¹æ³•å­—èŠ‚ç æŒ‡ä»¤"></a> è°ƒç”¨æ–¹æ³•å­—èŠ‚ç æŒ‡ä»¤</h5>
<p>åœ¨javaä¸­è°ƒç”¨æ–¹æ³•çš„ä»£ç æ ¹æ®ä¸åŒçš„æƒ…å†µä¼šè¢«ç¼–è¯‘æˆä¸ºä¸åŒçš„å­—èŠ‚ç æŒ‡ä»¤ï¼Œæœ‰å¦‚ä¸‹4ç§</p>
<ul>
<li><code>invokevirtual</code>: è™šæ–¹æ³•ï¼Œé€šè¿‡å¯¹è±¡å¼•ç”¨è°ƒç”¨å®ä¾‹æ–¹æ³•ï¼Œè™šæ–¹æ³•åªæœ‰åœ¨è¿è¡Œæ—¶æ ¹æ®å¯¹è±¡çš„å®é™…ç±»å‹æ‰èƒ½ç¡®å®šå…·ä½“è°ƒç”¨å“ªä¸ªç±»çš„æ–¹æ³•</li>
<li><code>invokeinterface</code>ï¼šæ¥å£æ–¹æ³•ï¼Œé€šè¿‡æ¥å£å¼•ç”¨è°ƒç”¨æ¥å£æ–¹æ³•</li>
<li><code>invokespecial</code>ï¼šç‰¹æ®Šæ–¹æ³•è°ƒç”¨ï¼Œä¸‰ç§æƒ…å†µï¼šå®ä¾‹æ„é€ æ–¹æ³•ï¼Œç§æœ‰æ–¹æ³•ï¼Œé€šè¿‡superå…³é”®å­—è°ƒç”¨çˆ¶ç±»æ–¹æ³•</li>
<li><code>invokestatic</code>ï¼šè°ƒç”¨ç±»çš„é™æ€æ–¹æ³•</li>
</ul>
<h3 id="3-æºç å‰–æ"><a class="markdownIt-Anchor" href="#3-æºç å‰–æ"></a> 3. æºç å‰–æ</h3>
<blockquote>
<p>åŸºäºjdk8u cppInterpreter.cppè§£æä»£ç ï¼Œä¸è¿‡é‰´äºç”±Gary Bensonè´¡çŒ®çš„ä»£ç æˆªè‡³ç›®å‰æœ€æ–°ç‰ˆ<code>25</code>å¹¶æœªå‘ç”Ÿå¤§çš„æ”¹å˜(ä¸è¿‡å‘½åä»cppå‰ç¼€ä¿®æ”¹ä¸ºzeroäº†ï¼Œæ‰€ä»¥è‹¥æ˜¯æŸ¥çœ‹æœ€æ–°ç‰ˆè¯·æ³¨æ„æ›¿æ¢)</p>
</blockquote>
<h4 id="æ–¹æ³•å…¥å£"><a class="markdownIt-Anchor" href="#æ–¹æ³•å…¥å£"></a> æ–¹æ³•å…¥å£</h4>
<p>hotspotä¼šå¯¹æ‰§è¡Œçš„javaæ–¹æ³•è¿›è¡Œåˆ†ç±»<sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup>ï¼Œå¯¹äºæ™®é€šçš„æ–¹æ³•é€šå¸¸å¯¹åº”ç€ä¸¤ç§</p>
<ul>
<li><code>zerolocals</code>ï¼šè¡¨ç¤ºæ–¹æ³•éœ€è¦è¿›è¡Œå±€éƒ¨å˜é‡åˆå§‹åŒ–ï¼Œä»¥å­˜å‚¨æ–¹æ³•å‚æ•°å’Œæ–¹æ³•å†…å±€éƒ¨å˜é‡</li>
<li><code>zerolocals_synchronized</code>ï¼šå’Œä¸Šé¢ä¸€æ ·ï¼Œåªæ˜¯æ–¹æ³•ä¸Šå¢åŠ äº†synchronizedä¿®é¥°<br />
hotspotè§£é‡Šå™¨ä¼šå¯¹è¿™ä¸¤ç§æ–¹æ³•ä¼šç”Ÿæˆä¸€ä¸ª<code>EntryPoint</code>(æ ¹æ®æ¶æ„ä¸åŒå¯èƒ½ä¼šç”Ÿæˆä¸åŒçš„<code>EntryPoint</code>)ï¼Œåç»­æ‰§è¡Œæ­¤ç±»çš„æ–¹æ³•ç›´æ¥ä»è¯¥<code>EntryPoint</code>è¿›å…¥æ‰§è¡Œ (å…¶å®å°±æ˜¯ç­–ç•¥æ¨¡å¼)</li>
</ul>
<p>åˆ›å»º<code>EntryPoint</code>çš„è°ƒç”¨é“¾<br />
å¦‚æœæ˜¯Threads::create_vm -&gt; init_globals() -&gt; stubRoutines_init1() -&gt; StubRoutines::initialize2() -&gt; StubGenerator_generate(&amp;buffer, true) -&gt; generate_all() -&gt; generate_method_entry<br />
<code>stubGenerator_zero.cpp</code></p>
<pre class="line-numbers language-C++" data-language="C++"><code class="language-C++">&#x2F;&#x2F; å¦‚æœæ˜¯å…¶ä»–çš„è§£é‡Šå™¨,æ­¤æ–¹æ³•ä¼šå¯¹å„ç§ç±»å‹çš„æ–¹æ³•åˆ›å»º EntryPointï¼Œä½†å½“å‰æ˜¯c++ç¼–å†™çš„è§£é‡Šå™¨ï¼Œæ‰€ä»¥ç›´æ¥ç”¨c++ä»£ç å»æ‰§è¡Œjavaä»£ç ,æ²¡æœ‰ä¸ºå…¶ç”Ÿæˆ EntryPoint

#undef method_entry


  void generate_initial() &#123;
    &#x2F;&#x2F; Generates all stubs and initializes the entry points

    &#x2F;&#x2F; entry points that exist in all platforms Note: This is code
    &#x2F;&#x2F; that could be shared among different platforms - however the
    &#x2F;&#x2F; benefit seems to be smaller than the disadvantage of having a
    &#x2F;&#x2F; much more complicated generator structure. See also comment in
    &#x2F;&#x2F; stubRoutines.hpp.

    StubRoutines::_forward_exception_entry   &#x3D; ShouldNotCallThisStub();
    &#x2F;**
     * call_stub å‡½æ•°åœ°å€
     *&#x2F;
    StubRoutines::_call_stub_entry           &#x3D; (address) call_stub;
    StubRoutines::_catch_exception_entry     &#x3D; ShouldNotCallThisStub();

    &#x2F;&#x2F; atomic calls
    StubRoutines::_atomic_xchg_entry         &#x3D; ShouldNotCallThisStub();
    StubRoutines::_atomic_xchg_ptr_entry     &#x3D; ShouldNotCallThisStub();
    StubRoutines::_atomic_cmpxchg_entry      &#x3D; ShouldNotCallThisStub();
    StubRoutines::_atomic_cmpxchg_ptr_entry  &#x3D; ShouldNotCallThisStub();
    StubRoutines::_atomic_cmpxchg_long_entry &#x3D; ShouldNotCallThisStub();
    StubRoutines::_atomic_add_entry          &#x3D; ShouldNotCallThisStub();
    StubRoutines::_atomic_add_ptr_entry      &#x3D; ShouldNotCallThisStub();
    StubRoutines::_fence_entry               &#x3D; ShouldNotCallThisStub();

    &#x2F;&#x2F; amd64 does this here, sparc does it in generate_all()
    StubRoutines::_handler_for_unsafe_access_entry &#x3D;
      ShouldNotCallThisStub();
  &#125;
   
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å¯ä»¥çœ‹ä¸‹stubGenerator_template</p>
<p>åœ¨cppInter</p>
<pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">void CppInterpreterGenerator::generate_all() &#123;
  AbstractInterpreterGenerator::generate_all();

  &#123; CodeletMark cm(_masm, &quot;result handlers for native calls&quot;);
#define method_entry(kind) Interpreter::_entry_table[Interpreter::kind] &#x3D; generate_method_entry(Interpreter::kind)

  &#123; CodeletMark cm(_masm, &quot;(kind &#x3D; frame_manager)&quot;);
    &#x2F;&#x2F; all non-native method kinds
    method_entry(zerolocals);
    method_entry(zerolocals_synchronized);
    method_entry(empty);
    method_entry(accessor);
    method_entry(abstract);
    method_entry(java_lang_math_sin   );
    method_entry(java_lang_math_cos   );
    method_entry(java_lang_math_tan   );
    method_entry(java_lang_math_abs   );
    method_entry(java_lang_math_sqrt  );
    method_entry(java_lang_math_log   );
    method_entry(java_lang_math_log10 );
    method_entry(java_lang_math_pow );
    method_entry(java_lang_math_exp );
    method_entry(java_lang_ref_reference_get);

    initialize_method_handle_entries();

    Interpreter::_native_entry_begin &#x3D; Interpreter::code()-&gt;code_end();
    method_entry(native);
    method_entry(native_synchronized);
    Interpreter::_native_entry_end &#x3D; Interpreter::code()-&gt;code_end();
  &#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-C++" data-language="C++"><code class="language-C++">
address AbstractInterpreterGenerator::generate_method_entry(
    AbstractInterpreter::MethodKind kind) &#123;
  address entry_point &#x3D; NULL;

  switch (kind) &#123;
  case Interpreter::zerolocals:
  case Interpreter::zerolocals_synchronized:
    break;
  &#x2F;&#x2F; ... çœç•¥äº†å…¶ä»–åˆ†æ”¯æ¡ä»¶çš„åˆ¤æ–­
  &#125;

  &#x2F;&#x2F; ç”±äºæ˜¯zerolocalsæˆ–è€…zerolocals_synchronied
  if (entry_point &#x3D;&#x3D; NULL) 
    entry_point &#x3D; ((InterpreterGenerator*) this)-&gt;generate_normal_entry(false);

  return entry_point;
&#125;

address InterpreterGenerator::generate_normal_entry(bool synchronized) &#123;
  assert(synchronized &#x3D;&#x3D; false, &quot;should be&quot;);

  return generate_entry((address) CppInterpreter::normal_entry);
&#125;
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="åˆ†æjavaæ–¹æ³•æ‰§è¡Œæµç¨‹"><a class="markdownIt-Anchor" href="#åˆ†æjavaæ–¹æ³•æ‰§è¡Œæµç¨‹"></a> åˆ†æjavaæ–¹æ³•æ‰§è¡Œæµç¨‹</h4>
<ol>
<li>è°ƒç”¨javaæ–¹æ³•å…¥å£<br />
<code>javaCalls.cpp#call_virtual</code></li>
</ol>
<pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">void JavaCalls::call_virtual(JavaValue* result, KlassHandle spec_klass, Symbol* name, Symbol* signature, JavaCallArguments* args, TRAPS) &#123;
  CallInfo callinfo;
  Handle receiver &#x3D; args-&gt;receiver();
  KlassHandle recvrKlass(THREAD, receiver.is_null() ? (Klass*)NULL : receiver-&gt;klass());
  LinkResolver::resolve_virtual_call(
          callinfo, receiver, recvrKlass, spec_klass, name, signature,
          KlassHandle(), false, true, CHECK);
  methodHandle method &#x3D; callinfo.selected_method();
  assert(method.not_null(), &quot;should have thrown exception&quot;);

  &#x2F;&#x2F; Invoke the method
  JavaCalls::call(result, method, args, CHECK);
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">int CppInterpreter::normal_entry(Method* method, intptr_t UNUSED, TRAPS) &#123;  
  JavaThread *thread &#x3D; (JavaThread *) THREAD;  
  &#x2F;&#x2F; Allocate and initialize our frame. 
  &#x2F;&#x2F; ä¸ºæ–¹æ³•åˆ†é…å¹¶åˆå§‹åŒ–æ ˆå¸§ï¼Œå…¶å†…éƒ¨å°±ä¼šåˆ›å»ºæˆ‘ä»¬çš„å±€éƒ¨å˜é‡è¡¨ï¼Œä»¥åŠè®¾ç½®bcpæŒ‡é’ˆ
  InterpreterFrame *frame &#x3D; InterpreterFrame::build(method, CHECK_0);
  &#x2F;&#x2F; ä¿å­˜æˆ‘ä»¬çš„æ ˆå¸§åˆ°çº¿ç¨‹æ ˆä¸­  
  thread-&gt;push_zero_frame(frame);  
  &#x2F;&#x2F; Execute those bytecodes!  
  &#x2F;&#x2F; è¿›å…¥æ‰§è¡Œå­—èŠ‚ç çš„ä¸»å…¥å£
  main_loop(0, THREAD);  
  
  &#x2F;&#x2F; No deoptimized frames on the stack  
  return 0;  
&#125;
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol start="2">
<li>æ„å»ºæ–¹æ³•æ ˆå¸§</li>
</ol>
<pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">InterpreterFrame *InterpreterFrame::build(Method* const method, TRAPS) &#123;
  JavaThread *thread &#x3D; (JavaThread *) THREAD;
  ZeroStack *stack &#x3D; thread-&gt;zero_stack();

  &#x2F;&#x2F; Calculate the size of the frame we&#39;ll build, including
  &#x2F;&#x2F; any adjustments to the caller&#39;s frame that we&#39;ll make.
  &#x2F;&#x2F; æ–¹æ³•å†…éƒ¨å±€éƒ¨å˜é‡æ•°é‡
  int extra_locals  &#x3D; 0;
  &#x2F;&#x2F; ç›‘è§†å™¨å ç”¨ç©ºé—´å¤§å°
  int monitor_words &#x3D; 0;
  &#x2F;&#x2F; å±€éƒ¨å˜é‡è¡¨å˜é‡ä¸ªæ•°&#x2F;é•¿åº¦
  int stack_words   &#x3D; 0;
  &#x2F;&#x2F; æ³¨æ„ï¼Œä¸Šé¢çš„å‚æ•°ç¼–è¯‘æœŸå°±å¯ä»¥ç¡®å®šä¸‹æ¥ï¼Œå¯ä»¥é€šè¿‡javap -l .class çœ‹åˆ°å±€éƒ¨å˜é‡è¡¨ä¿¡æ¯
  &#x2F;&#x2F; æ‰€ä»¥è¿™é‡Œåªæ˜¯å–å‡ºæ¥ç„¶ååˆ†é…ä¸€ä¸ªå¤§å°åˆé€‚çš„å±€éƒ¨å˜é‡è¡¨æ¥å­˜å‚¨æ–¹æ³•ä¸­æ‰€æ“ä½œçš„å˜é‡
  if (!method-&gt;is_native()) &#123;
	&#x2F;&#x2F; å±€éƒ¨å˜é‡è¡¨é•¿åº¦ - æ–¹æ³•å‚æ•° å¾—åˆ° æ–¹æ³•å†…éƒ¨å®šä¹‰çš„å±€éƒ¨å˜é‡ä¸ªæ•°
    extra_locals &#x3D; method-&gt;max_locals() - method-&gt;size_of_parameters();
    &#x2F;&#x2F; å±€éƒ¨å˜é‡è¡¨soltä¸ªæ•°
    stack_words  &#x3D; method-&gt;max_stack();
  &#125;
  if (method-&gt;is_synchronized()) &#123;
	&#x2F;&#x2F; æ–¹æ³•æ˜¯åŒæ­¥çš„ï¼Œé‚£ä¹ˆéœ€è¦åˆ†é…ä¸€ä¸ªsoltå­˜å‚¨
    monitor_words &#x3D; frame::interpreter_frame_monitor_size();
  &#125;
	&#x2F;&#x2F; æ£€æŸ¥æ˜¯å¦æ ˆæº¢å‡º
  stack-&gt;overflow_check(
    extra_locals + header_words + monitor_words + stack_words, CHECK_NULL);

  &#x2F;&#x2F; Adjust the caller&#39;s stack frame to accomodate any additional
  &#x2F;&#x2F; local variables we have contiguously with our parameters.
  &#x2F;&#x2F; é¢„å…ˆå¡«å……
  for (int i &#x3D; 0; i &lt; extra_locals; i++)
    stack-&gt;push(0);
    &#x2F;&#x2F; åˆ†é…å±€éƒ¨å˜é‡è¡¨ç©ºé—´äº†
  intptr_t *locals;
  if (method-&gt;is_native())
	  &#x2F;&#x2F; å…¥è‚¡æ˜¯nativeæ–¹æ³•
    locals &#x3D; stack-&gt;sp() + (method-&gt;size_of_parameters() - 1);
  else
    locals &#x3D; stack-&gt;sp() + (method-&gt;max_locals() - 1);

  stack-&gt;push(0); &#x2F;&#x2F; next_frame, filled in later
  intptr_t *fp &#x3D; stack-&gt;sp();
  assert(fp - stack-&gt;sp() &#x3D;&#x3D; next_frame_off, &quot;should be&quot;);

  stack-&gt;push(INTERPRETER_FRAME);
  assert(fp - stack-&gt;sp() &#x3D;&#x3D; frame_type_off, &quot;should be&quot;);

  interpreterState istate &#x3D;
    (interpreterState) stack-&gt;alloc(sizeof(BytecodeInterpreter));
  assert(fp - stack-&gt;sp() &#x3D;&#x3D; istate_off, &quot;should be&quot;);

  istate-&gt;set_locals(locals);
  istate-&gt;set_method(method);
  istate-&gt;set_self_link(istate);
  istate-&gt;set_prev_link(NULL);
  istate-&gt;set_thread(thread);
  istate-&gt;set_bcp(method-&gt;is_native() ? NULL : method-&gt;code_base());
  istate-&gt;set_constants(method-&gt;constants()-&gt;cache());
  istate-&gt;set_msg(BytecodeInterpreter::method_entry);
  istate-&gt;set_oop_temp(NULL);
  istate-&gt;set_mdx(NULL);
  istate-&gt;set_callee(NULL);

  istate-&gt;set_monitor_base((BasicObjectLock *) stack-&gt;sp());
  if (method-&gt;is_synchronized()) &#123;
    BasicObjectLock *monitor &#x3D;
      (BasicObjectLock *) stack-&gt;alloc(monitor_words * wordSize);
    oop object;
    if (method-&gt;is_static())
      object &#x3D; method-&gt;constants()-&gt;pool_holder()-&gt;java_mirror();
    else
      object &#x3D; (oop) (void*)locals[0];
    monitor-&gt;set_obj(object);
  &#125;

  istate-&gt;set_stack_base(stack-&gt;sp());
  istate-&gt;set_stack(stack-&gt;sp() - 1);
  if (stack_words)
    stack-&gt;alloc(stack_words * wordSize);
  istate-&gt;set_stack_limit(stack-&gt;sp() - 1);

  return (InterpreterFrame *) fp;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol start="4">
<li>ä¸»å…¥å£</li>
</ol>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">

<span class="token keyword">void</span> CppInterpreter<span class="token operator">::</span><span class="token function">main_loop</span><span class="token punctuation">(</span><span class="token keyword">int</span> recurse<span class="token punctuation">,</span> TRAPS<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  # å½“å‰javaçº¿ç¨‹
  JavaThread <span class="token operator">*</span>thread <span class="token operator">=</span> <span class="token punctuation">(</span>JavaThread <span class="token operator">*</span><span class="token punctuation">)</span> THREAD<span class="token punctuation">;</span>
  <span class="token comment">// çº¿ç¨‹æ ˆ</span>
  ZeroStack <span class="token operator">*</span>stack <span class="token operator">=</span> thread<span class="token operator">-></span><span class="token function">zero_stack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// If we are entering from a deopt we may need to call</span>
  <span class="token comment">// ourself a few times in order to get to our frame.</span>
  <span class="token comment">// é€’å½’è°ƒç”¨ï¼Œä¸å¤ªç†è§£</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>recurse<span class="token punctuation">)</span>
    <span class="token function">main_loop</span><span class="token punctuation">(</span>recurse <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> THREAD<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// è½¬æ¢ä¸ºè§£é‡Šå™¨æ ˆå¸§ç±»å‹</span>
  InterpreterFrame <span class="token operator">*</span>frame <span class="token operator">=</span> thread<span class="token operator">-></span><span class="token function">top_zero_frame</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">as_interpreter_frame</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// è§£é‡Šå™¨çŠ¶æ€[è¯¥çŠ¶æ€ä¿¡æ¯åŒ…å«äº†æ‰§è¡Œæ–¹æ³•æ‰€éœ€è¦çš„ä¸€åˆ‡ä¿¡æ¯ï¼ŒåŒ…æ‹¬ä¸ä»…é™äºå½“å‰çº¿ç¨‹ï¼Œæ ˆï¼Œæ ˆå¸§ï¼Œæœ¬åœ°å˜é‡è¡¨ï¼Œpc,sp åœ°å€]</span>
  interpreterState istate <span class="token operator">=</span> frame<span class="token operator">-></span><span class="token function">interpreter_state</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Method<span class="token operator">*</span> method <span class="token operator">=</span> istate<span class="token operator">-></span><span class="token function">method</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token class-name">intptr_t</span> <span class="token operator">*</span>result <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> result_slots <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token comment">// å¾ªç¯é‡Œæ˜¯å› ä¸ºæœ‰æ‰§è¡Œçš„æŒ‡ä»¤æ¡ä»¶ä¸æ»¡è¶³ï¼Œä»è€Œè¿›å…¥å¯¹åº”çš„åˆ†æ”¯å†æ‰§è¡ŒæŒ‡ä»¤</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>true<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// We can set up the frame anchor with everything we want at</span>
    <span class="token comment">// this point as we are thread_in_Java and no safepoints can</span>
    <span class="token comment">// occur until we go to vm mode.  We do have to clear flags</span>
    <span class="token comment">// on return from vm but that is it.</span>
    <span class="token comment">// è®¾ç½®javaçº¿ç¨‹çš„spä»¥åŠfpå¯„å­˜å™¨ï¼Œå¹¶ä¸”è®©java pcåœ°å€æ¸…ç©º</span>
    <span class="token comment">// src\cpu\zero\vm\javaFrameAnchor_zero.hpp#set(intptr_t* sp, address pc, ZeroFrame* fp)</span>
    thread<span class="token operator">-></span><span class="token function">set_last_Java_frame</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Call the interpreter</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>JvmtiExport<span class="token operator">::</span><span class="token function">can_post_interpreter_events</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      BytecodeInterpreter<span class="token operator">::</span><span class="token function">runWithChecks</span><span class="token punctuation">(</span>istate<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
      <span class="token comment">// è¿™é‡Œå°±æ˜¯æ‰§è¡Œå­—èŠ‚ç æŒ‡ä»¤çš„å…³é”®ä¹‹å¤„ï¼Œä¼š</span>
      BytecodeInterpreter<span class="token operator">::</span><span class="token function">run</span><span class="token punctuation">(</span>istate<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fixup_after_potential_safepoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Clear the frame anchor</span>
    thread<span class="token operator">-></span><span class="token function">reset_last_Java_frame</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Examine the message from the interpreter to decide what to do</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>istate<span class="token operator">-></span><span class="token function">msg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> BytecodeInterpreter<span class="token operator">::</span>call_method<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      Method<span class="token operator">*</span> callee <span class="token operator">=</span> istate<span class="token operator">-></span><span class="token function">callee</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Trim back the stack to put the parameters at the top</span>
      stack<span class="token operator">-></span><span class="token function">set_sp</span><span class="token punctuation">(</span>istate<span class="token operator">-></span><span class="token function">stack</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Make the call</span>
      Interpreter<span class="token operator">::</span><span class="token function">invoke_method</span><span class="token punctuation">(</span>callee<span class="token punctuation">,</span> istate<span class="token operator">-></span><span class="token function">callee_entry_point</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> THREAD<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">fixup_after_potential_safepoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Convert the result</span>
      istate<span class="token operator">-></span><span class="token function">set_stack</span><span class="token punctuation">(</span>stack<span class="token operator">-></span><span class="token function">sp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Restore the stack</span>
      stack<span class="token operator">-></span><span class="token function">set_sp</span><span class="token punctuation">(</span>istate<span class="token operator">-></span><span class="token function">stack_limit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Resume the interpreter</span>
      istate<span class="token operator">-></span><span class="token function">set_msg</span><span class="token punctuation">(</span>BytecodeInterpreter<span class="token operator">::</span>method_resume<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>istate<span class="token operator">-></span><span class="token function">msg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> BytecodeInterpreter<span class="token operator">::</span>more_monitors<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">int</span> monitor_words <span class="token operator">=</span> frame<span class="token operator">::</span><span class="token function">interpreter_frame_monitor_size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Allocate the space</span>
      stack<span class="token operator">-></span><span class="token function">overflow_check</span><span class="token punctuation">(</span>monitor_words<span class="token punctuation">,</span> THREAD<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>HAS_PENDING_EXCEPTION<span class="token punctuation">)</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      stack<span class="token operator">-></span><span class="token function">alloc</span><span class="token punctuation">(</span>monitor_words <span class="token operator">*</span> wordSize<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Move the expression stack contents</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">intptr_t</span> <span class="token operator">*</span>p <span class="token operator">=</span> istate<span class="token operator">-></span><span class="token function">stack</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> p <span class="token operator">&lt;</span> istate<span class="token operator">-></span><span class="token function">stack_base</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> p<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token operator">*</span><span class="token punctuation">(</span>p <span class="token operator">-</span> monitor_words<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>

      <span class="token comment">// Move the expression stack pointers</span>
      istate<span class="token operator">-></span><span class="token function">set_stack_limit</span><span class="token punctuation">(</span>istate<span class="token operator">-></span><span class="token function">stack_limit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> monitor_words<span class="token punctuation">)</span><span class="token punctuation">;</span>
      istate<span class="token operator">-></span><span class="token function">set_stack</span><span class="token punctuation">(</span>istate<span class="token operator">-></span><span class="token function">stack</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> monitor_words<span class="token punctuation">)</span><span class="token punctuation">;</span>
      istate<span class="token operator">-></span><span class="token function">set_stack_base</span><span class="token punctuation">(</span>istate<span class="token operator">-></span><span class="token function">stack_base</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> monitor_words<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Zero the new monitor so the interpreter can find it.</span>
      <span class="token punctuation">(</span><span class="token punctuation">(</span>BasicObjectLock <span class="token operator">*</span><span class="token punctuation">)</span> istate<span class="token operator">-></span><span class="token function">stack_base</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">set_obj</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Resume the interpreter</span>
      istate<span class="token operator">-></span><span class="token function">set_msg</span><span class="token punctuation">(</span>BytecodeInterpreter<span class="token operator">::</span>got_monitors<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>istate<span class="token operator">-></span><span class="token function">msg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> BytecodeInterpreter<span class="token operator">::</span>return_from_method<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// Copy the result into the caller's frame</span>
      result_slots <span class="token operator">=</span> type2size<span class="token punctuation">[</span>method<span class="token operator">-></span><span class="token function">result_type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token function">assert</span><span class="token punctuation">(</span>result_slots <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> result_slots <span class="token operator">&lt;=</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"what?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      result <span class="token operator">=</span> istate<span class="token operator">-></span><span class="token function">stack</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> result_slots<span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>istate<span class="token operator">-></span><span class="token function">msg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> BytecodeInterpreter<span class="token operator">::</span>throwing_exception<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token function">assert</span><span class="token punctuation">(</span>HAS_PENDING_EXCEPTION<span class="token punctuation">,</span> <span class="token string">"should do"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>istate<span class="token operator">-></span><span class="token function">msg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> BytecodeInterpreter<span class="token operator">::</span>do_osr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// Unwind the current frame</span>
      thread<span class="token operator">-></span><span class="token function">pop_zero_frame</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Remove any extension of the previous frame</span>
      <span class="token keyword">int</span> extra_locals <span class="token operator">=</span> method<span class="token operator">-></span><span class="token function">max_locals</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> method<span class="token operator">-></span><span class="token function">size_of_parameters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      stack<span class="token operator">-></span><span class="token function">set_sp</span><span class="token punctuation">(</span>stack<span class="token operator">-></span><span class="token function">sp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> extra_locals<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Jump into the OSR method</span>
      Interpreter<span class="token operator">::</span><span class="token function">invoke_osr</span><span class="token punctuation">(</span>
        method<span class="token punctuation">,</span> istate<span class="token operator">-></span><span class="token function">osr_entry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> istate<span class="token operator">-></span><span class="token function">osr_buf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> THREAD<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
      <span class="token function">ShouldNotReachHere</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// Unwind the current frame</span>
  thread<span class="token operator">-></span><span class="token function">pop_zero_frame</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Pop our local variables</span>
  stack<span class="token operator">-></span><span class="token function">set_sp</span><span class="token punctuation">(</span>stack<span class="token operator">-></span><span class="token function">sp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> method<span class="token operator">-></span><span class="token function">max_locals</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Push our result</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> result_slots<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// Adjust result to smaller</span>
    <span class="token keyword">union</span> <span class="token punctuation">&#123;</span>
      <span class="token class-name">intptr_t</span> res<span class="token punctuation">;</span>
      jint res_jint<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    res <span class="token operator">=</span> result<span class="token punctuation">[</span><span class="token operator">-</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result_slots <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      BasicType t <span class="token operator">=</span> method<span class="token operator">-></span><span class="token function">result_type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">is_subword_type</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        res_jint <span class="token operator">=</span> <span class="token punctuation">(</span>jint<span class="token punctuation">)</span><span class="token function">narrow</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> res_jint<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    stack<span class="token operator">-></span><span class="token function">push</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr class="footnotes-sep" />
<section class="footnotes">
<ol class="footnotes-list">
<li id="fn1" class="footnote-item"><p>å…·ä½“åˆ†ç±»ç±»åˆ«å¯æŸ¥çœ‹ <code>AbstractInterpreter.hpp$MethodKind</code>, ç‰¹åˆ«çš„æ˜¯Mathç±»ï¼Œè¯¥ç±»ä¸‹çš„æ•°å­¦è®¡ç®—æ–¹æ³•éƒ½ä¼šè¿›è¡Œå†…è” <a href="#fnref1" class="footnote-backref">â†©ï¸</a></p>
</li>
</ol>
</section>
]]></content>
      <categories>
        <category>æºç åˆ†æ</category>
        <category>hotspot</category>
      </categories>
  </entry>
  <entry>
    <title>JVM Atomicæºç è§£æ</title>
    <url>/posts/6961ed95.html</url>
    <content><![CDATA[<h1 id="å¼•è¨€"><a class="markdownIt-Anchor" href="#å¼•è¨€"></a> å¼•è¨€</h1>
<p>åœ¨æ—¥å¸¸å·¥ä½œçš„è¿‡ç¨‹ä¸­ï¼Œå¸¸å¸¸ä¼šä½¿ç”¨åˆ°ä¸€äº›<code>å…±äº«å˜é‡</code>æ¥ç›‘æ§æŸäº›æŒ‡æ ‡ï¼Œæ¯”å¦‚<code>IMç³»ç»Ÿ</code>ä¸­ä¸ºäº†ä¿è¯æœåŠ¡ç«¯è½¬å‘æ¶ˆæ¯ç»™å®¢æˆ·ç«¯æ—¶çš„æ¶ˆæ¯æœåŠ¡è´¨é‡ï¼Œæˆ‘å€Ÿé‰´äº†<code>TCP</code>çš„è¶…æ—¶é‡ä¼ æœºåˆ¶ï¼Œå½“é€šè¿‡<code>channel</code>å°†æ¶ˆæ¯æ¨é€ç»™å®¢æˆ·ç«¯åï¼Œè¾¾åˆ°ä¸€å®šçš„æ—¶é—´ï¼ŒæœåŠ¡ç«¯è¿˜æ²¡æœ‰æ”¶åˆ°å®¢æˆ·ç«¯å¯¹è¯¥æ¶ˆæ¯çš„<code>ack</code>æ¶ˆæ¯ï¼Œé‚£ä¹ˆå°±è®¤ä¸ºè¯¥æ¶ˆæ¯ä¸¢å¤±ï¼Œä¼šè§¦å‘é‡ä¼ ï¼Œä¸ºäº†èƒ½å¤ŸæŒæ¡æŸä¸ªèŠ‚ç‚¹çš„æ¶ˆæ¯è´¨é‡æƒ…å†µå’Œè¶…æ—¶é‡ä¼ é˜Ÿåˆ—çš„é•¿åº¦ï¼Œæˆ‘å¯¹é‡ä¼ çš„æ¬¡æ•°ä»¥åŠé˜Ÿåˆ—çš„é•¿åº¦éƒ½ä½¿ç”¨äº†<code>Metrics</code>è¿›è¡Œç›‘æ§ï¼Œè€Œä¸ºäº†ç¡®ä¿åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ç´¯åŠ é‡ä¼ çš„æ¬¡æ•°çš„çº¿ç¨‹å®‰å…¨æ€§ï¼Œæˆ‘é‡‡ç”¨äº†<code>AtomicLong</code>ç”¨æ¥è®¡ç®—é‡ä¼ æ¬¡æ•°è®¡æ•°ï¼Œ<code>AtomicLong</code>ç§°ä¸ºåŸå­å˜é‡ï¼Œå†…éƒ¨åˆ©ç”¨<code>CAS</code>æŒ‡ä»¤è‡ªæ—‹çš„æ–¹å¼æ¥å®Œæˆå€¼çš„æ¯”è¾ƒå’Œæ›´æ–°ï¼Œç¡®ä¿äº†æ“ä½œçš„çº¿ç¨‹å®‰å…¨ï¼Œä½†æ˜¯å…¶åº•å±‚æ˜¯å¦‚ä½•ä¿è¯çš„å‘¢ï¼Œä¿ç•™ç–‘é—®ï¼Œè·Ÿéšæœ¬æ–‡å¯»æ‰¾ç­”æ¡ˆ</p>
<h1 id="atomiclong"><a class="markdownIt-Anchor" href="#atomiclong"></a> AtomicLong</h1>
<p>é¦–å…ˆé€šè¿‡é˜…è¯»Javaå±‚é¢çš„<code>AtomicLong</code>çš„æºç ï¼Œäº†è§£ä¸‹å®ƒçš„è‡ªå¢å®ç°</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AtomicLong</span> <span class="token keyword">extends</span> <span class="token class-name">Number</span> <span class="token keyword">implements</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span>Serializable</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// setup to use Unsafe.compareAndSwapLong for updates</span>
    <span class="token comment">// Unsafe æä¾›äº†å¾ˆå¤šæœ€åº•å±‚çš„æ“ä½œï¼Œæ­¤å¤„ä¸»è¦æ˜¯ç”¨åˆ°å…¶å†…éƒ¨å®šä¹‰çš„CASç›¸å…³çš„æ–¹æ³•</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Unsafe</span> unsafe <span class="token operator">=</span> <span class="token class-name">Unsafe</span><span class="token punctuation">.</span><span class="token function">getUnsafe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> valueOffset<span class="token punctuation">;</span>
    <span class="token comment">// å½“å‰æœºå™¨æ˜¯å¦æ”¯æŒ8å­—èŠ‚çš„é•¿æ•´å‹çš„casæ“ä½œ,å¦‚æœä¸æ”¯æŒ,ä¸ºäº†ç¡®ä¿åŸå­æ€§çš„è¯»å–å’Œå†™å…¥,ä¼šä½¿ç”¨é”çš„æ–¹å¼æ¥æ“ä½œå…±äº«å˜é‡ valueï¼Œæ¯”å¦‚32ä½æœºå™¨å°±æ˜¯false</span>
    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> <span class="token constant">VM_SUPPORTS_LONG_CAS</span> <span class="token operator">=</span> <span class="token class-name">VMSupportsCS8</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">static</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
	        <span class="token comment">// è·å–AtomicLongç±»çš„å±æ€§valueåœ¨å®ä¾‹æ•°æ®åŒºä¸­çš„åç§»é‡</span>
            valueOffset <span class="token operator">=</span> unsafe<span class="token punctuation">.</span>objectFieldOffset
                <span class="token punctuation">(</span><span class="token class-name">AtomicLong</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">"value"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// volatile ä¿®é¥°,ä¿è¯å½“æœ‰çº¿ç¨‹ä¿®æ”¹è¯¥å˜é‡çš„å€¼å¯¹å…¶ä»–çº¿ç¨‹çš„å¯è§æ€§</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">long</span> value<span class="token punctuation">;</span>

	<span class="token comment">// åŸå­æ€§çš„é€’å¢1</span>
	<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">long</span> <span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token comment">// é€šè¿‡unsafeæ¥å®Œæˆ</span>
        <span class="token keyword">return</span> unsafe<span class="token punctuation">.</span><span class="token function">getAndAddLong</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> valueOffset<span class="token punctuation">,</span> <span class="token number">1L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Unsafeç±»</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Unsafe</span> <span class="token punctuation">&#123;</span>

	<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">long</span> <span class="token function">getAndAddLong</span><span class="token punctuation">(</span><span class="token class-name">Object</span> object<span class="token punctuation">,</span> <span class="token keyword">long</span> offset<span class="token punctuation">,</span> <span class="token keyword">long</span> value<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">long</span> result<span class="token punctuation">;</span>
	<span class="token comment">// é€šè¿‡è‡ªæ—‹çš„æ–¹å¼ç»™æŒ‡å®šçš„å±æ€§è®¾ç½®å€¼</span>
	<span class="token keyword">do</span> <span class="token punctuation">&#123;</span>
		<span class="token comment">// è·å–åŸºäºobjectå¯¹è±¡æŒ‡å®šoffsetçš„å±æ€§å€¼</span>
		result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getLongVolatile</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// æ¯”è¾ƒè¯¥å±æ€§çš„å€¼æ˜¯å¦ç­‰äºç›®æ ‡å€¼result,å¦‚æœç­‰äº,é‚£ä¹ˆå°±æ›´æ–°ä¸ºresult + value,å¦‚æœæ›´æ–°å¤±è´¥ï¼Œå†æ¬¡é‡è¯•</span>
	<span class="token punctuation">&#125;</span> <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">compareAndSwapLong</span><span class="token punctuation">(</span>object<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> result<span class="token punctuation">,</span> result <span class="token operator">+</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// casæˆåŠŸçš„ç›®æ ‡å€¼</span>
	<span class="token keyword">return</span> result<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token comment">// è·å–å¯¹è±¡å±æ€§çš„å€¼</span>
	<span class="token keyword">public</span> <span class="token keyword">native</span> <span class="token keyword">long</span> <span class="token function">getLongVolatile</span><span class="token punctuation">(</span><span class="token class-name">Object</span> object<span class="token punctuation">,</span> <span class="token keyword">long</span> fieldOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">// native æ–¹æ³•</span>
	<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">native</span> <span class="token keyword">boolean</span> <span class="token function">compareAndSwapLong</span><span class="token punctuation">(</span><span class="token class-name">Object</span> var1<span class="token punctuation">,</span> <span class="token keyword">long</span> var2<span class="token punctuation">,</span> <span class="token keyword">long</span> var4<span class="token punctuation">,</span> <span class="token keyword">long</span> var6<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å¯ä»¥çœ‹åˆ°<code>AtomicLong#getAndIncrement</code>æ–¹æ³•å†…éƒ¨ç›´æ¥ä½¿ç”¨äº†<code>Unsafe#getAndAddLong</code>æ–¹æ³•æ¥å®Œæˆè‡ªå¢1çš„æ“ä½œï¼Œåœ¨<code>unsafe</code>æ–¹æ³•å†…éƒ¨ä¼šä¸€ç›´è‡ªæ—‹è·å–<code>AtomicLong</code>å¯¹è±¡å±æ€§<code>value</code>çš„å€¼ï¼Œç„¶å<code>cas</code>æ›´æ–°<code>value</code>ï¼Œå¦‚æœæ›´æ–°å¤±è´¥é‚£ä¹ˆç»§ç»­é‡è¯•</p>
<p>ä¸Šé¢çš„æ–¹æ³•ç®€æ´æ˜äº†ï¼Œä½†æ˜¯å´çœ‹ä¸åˆ°åº•å±‚æ˜¯å¦‚ä½•å¤„ç†çš„ï¼Œæ‰€ä»¥ä¸ºäº†ææ¸…ç»†èŠ‚ï¼Œç»§ç»­æ·±ç©¶æºç </p>
<h1 id="è¯»å–-è®¡ç®—-æ›´æ–°"><a class="markdownIt-Anchor" href="#è¯»å–-è®¡ç®—-æ›´æ–°"></a> è¯»å– è®¡ç®— æ›´æ–°</h1>
<p>åœ¨<code>CPU</code>ä¸­è¦å¯¹å€¼åšä¸€ä¸ªæ›´æ–°æ“ä½œï¼Œéœ€è¦ç»å†è¯»å–å€¼ï¼Œè®¡ç®—å€¼ï¼Œæ›´æ–°å€¼çš„è¿‡ç¨‹ï¼Œæ¯”å¦‚ä¸€ä¸ª <code>i = i + 5</code>åº•å±‚ä¼šç”Ÿæˆä¸‰æ¡æ±‡ç¼–æŒ‡ä»¤ï¼š</p>
<pre class="line-numbers language-asm" data-language="asm"><code class="language-asm">&#x2F;&#x2F; è¯»å–ï¼šä»å†…å­˜è¯»å–åœ°å€içš„å€¼
MOV AX, iaddr
&#x2F;&#x2F; è®¡ç®—ï¼šå¯¹å¯„å­˜å™¨ä¸­çš„å€¼è¿›è¡ŒåŠ  5 æ“ä½œ
ADD AX, 5    
&#x2F;&#x2F; æ›´æ–°ï¼šå°†è®¡ç®—åçš„ç»“æœå†™å›åˆ°å†…å­˜ä¸­çš„ i
MOV iaddr, AX <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å¦‚æœå¤šä¸ªçº¿ç¨‹åŒæ—¶å¯¹<code>i</code>è¿›è¡Œè¯»å†™æ“ä½œï¼Œé‚£ä¹ˆæœ€ç»ˆçš„ç»“æœå¾ˆæœ‰å¯èƒ½ä¼šä¸é¢„æœŸä¸ä¸€è‡´</p>
<table>
<thead>
<tr>
<th>æ‰§è¡Œæ—¶åº</th>
<th>çº¿ç¨‹</th>
<th>å†…å­˜ i åœ°å€å­˜å‚¨çš„å€¼</th>
<th>è¯»å–(AX = i)</th>
<th>AX è®¡ç®—</th>
<th>æ›´æ–°(i = AX)</th>
<th>çº¿ç¨‹çŠ¶æ€</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>A</td>
<td>10</td>
<td>10</td>
<td></td>
<td></td>
<td><code>RUNNING</code> (context switch)</td>
</tr>
<tr>
<td>2</td>
<td>B</td>
<td>10</td>
<td>10</td>
<td>AX = 20 = AX + 10</td>
<td>i = AX = 20</td>
<td><code>RUNNING</code></td>
</tr>
<tr>
<td>3</td>
<td>A</td>
<td>20</td>
<td>10</td>
<td>AX = 15 = AX + 5</td>
<td>i = AX = 15</td>
<td><code>RUNNING</code></td>
</tr>
<tr>
<td>4</td>
<td>A</td>
<td>15</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>5</td>
<td>B</td>
<td>15</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>å¯ä»¥çœ‹åˆ°è¡¨æ ¼æœ€å<code>i</code>çš„å€¼ä¸º15ï¼Œ<code>Bçº¿ç¨‹</code>æ‰€åšçš„æ›´æ–°è¢«<code>Açº¿ç¨‹</code>è¦†ç›–ï¼Œä¸é¢„æœŸçš„20ä¸ä¸€è‡´ï¼Œåœ¨<code>i</code>ä¸Šå‘ç”Ÿäº†çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œä¸ºäº†ä¿è¯è®¡ç®—ä¸æ›´æ–°å€¼çš„ç»“æœæ˜¯æ­£ç¡®çš„ï¼Œä¸€èˆ¬é€šè¿‡ä¸¤ç§é€”å¾„ï¼š</p>
<ul>
<li>å¯¹å…³äº<code>i</code>çš„ä¸´ç•ŒåŒºä»£ç åŠ é”ï¼Œç¡®ä¿åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½æ‰§è¡Œä¸´ç•ŒåŒºä¸­çš„ä»£ç </li>
<li>è¦ä¹ˆé€šè¿‡CASæŒ‡ä»¤æ¥è‡ªæ—‹æ›´æ–°ï¼Œç›´åˆ°æ›´æ–°æˆåŠŸ</li>
</ul>
<h1 id="casæŒ‡ä»¤"><a class="markdownIt-Anchor" href="#casæŒ‡ä»¤"></a> CASæŒ‡ä»¤</h1>
<blockquote>
<p><code>CAS</code>çš„å…¨ç§°ä¸ºï¼šCompare And Swapï¼Œé¡¾åæ€ä¹‰å°±æ˜¯æ¯”è¾ƒç›®æ ‡åœ°å€çš„å€¼æ˜¯å¦ä¸æœŸæœ›å€¼ç›¸ç­‰ï¼Œå¦‚æœç›¸ç­‰å°±æŠŠç›®æ ‡å€¼æ›´æ–°åˆ°ç›®æ ‡åœ°å€ä¸­</p>
</blockquote>
<p>åœ¨è§£æåº•å±‚æºç ä¹‹å‰ï¼Œå…ˆäº†è§£ä¸€ä¸‹<code>cas</code>åº•å±‚çš„æŒ‡ä»¤<br />
æˆ‘ä»¬å¸¸ç”¨çš„<code>cpu</code>ä¸€èˆ¬ä¸ºä¸¤ç§æ¶æ„ï¼Œåˆ†åˆ«æ˜¯<code>x86</code>å’Œ<code>arm</code>ï¼Œè¿™ä¸¤ç§æ¶æ„éƒ½æœ‰å„è‡ªçš„æŒ‡ä»¤é›†ï¼ŒæŒ‡ä»¤é›†ä¸­éƒ½å®šä¹‰äº†å„è‡ªçš„casæŒ‡ä»¤</p>
<ul>
<li><code>X86</code>ï¼šæŒ‡ä»¤å¤æ‚ï¼Œæ€§èƒ½ä¼˜ç§€ï¼ŒåŠŸè€—è¾ƒé«˜ï¼Œå¹¿æ³›ç”¨äºPCï¼ŒæœåŠ¡å™¨ç­‰é¢†åŸŸ</li>
<li><code>ARM</code>ï¼šæŒ‡ä»¤ç²¾ç®€ï¼Œä¿è¯ä¸€å®šæ€§èƒ½çš„åŒæ—¶ï¼ŒåŠŸè€—è¡¨ç°å‡ºè‰²ï¼Œå¹¿æ³›ç”¨äºç§»åŠ¨ç«¯ä¸­æ–­ï¼ŒåµŒå…¥å¼è®¾å¤‡ç­‰é¢†åŸŸ</li>
</ul>
<h2 id="x86"><a class="markdownIt-Anchor" href="#x86"></a> X86</h2>
<blockquote>
<p>ä¸‹æ–‡æŒ‡ä»¤ä»‹ç»æ¥æºäº Intel å¼€å‘äººå‘˜æ‰‹å†Œ <a href="https://www.intel.cn/content/www/cn/zh/content-details/782158/intel-64-and-ia-32-architectures-software-developer-s-manual-combined-volumes-1-2a-2b-2c-2d-3a-3b-3c-3d-and-4.html?wapkw=intel%2064%20and%20ia-32%20architectures%20software%20developer%27s%20manual&amp;docid=782158">IntelÂ® 64 å’Œ IA-32 æ¶æ„è½¯ä»¶å¼€å‘äººå‘˜æ‰‹å†Œåˆå¹¶å·ï¼š1ã€2Aã€2Bã€2Cã€2Dã€3Aã€3Bã€3Cã€3D å’Œ 4</a></p>
</blockquote>
<p>åœ¨X86ä¸­ï¼Œå®šä¹‰äº†æŒ‡ä»¤<code>CMPXCHG</code>ï¼Œå®ƒçš„åŸºæœ¬åŠŸèƒ½æ˜¯æ¯”è¾ƒEAXå¯„å­˜å™¨çš„å€¼å’ŒæŒ‡å®šå†…å­˜åœ°å€çš„å€¼ï¼Œå¦‚æœç›¸ç­‰ï¼Œåˆ™å°†å†…å­˜åœ°å€ä¸­çš„å€¼æ›¿æ¢ä¸ºæŒ‡å®šæ“ä½œæ•°çš„å€¼ï¼Œå¦‚æœä¸ç›¸ç­‰ï¼Œåˆ™å°†å†…å­˜åœ°å€ä¸­çš„å€¼åŠ è½½åˆ°EAXå¯„å­˜å™¨ä¸­</p>
<ul>
<li><code>CMPXCHG</code>æŒ‡ä»¤åŸå‹ï¼š<code>CMPXCHG address, new_value</code>
<ul>
<li>å°†æ¯”è¾ƒå€¼æ”¾å…¥<code>EAX</code>å¯„å­˜å™¨çš„æŒ‡ä»¤è¦å…ˆäº<code>CMPXCHG</code>æŒ‡ä»¤ä¹‹å‰å®šä¹‰ï¼š<code>MOV EAX, expected_value</code></li>
</ul>
</li>
</ul>
<p>å¯ä»¥çœ‹åˆ°ï¼Œ<code>CMPXCHG</code> æŒ‡ä»¤å°†å€¼çš„è¯»å–å’Œæ¯”è¾ƒæ›´æ–°åˆ†ä¸ºäº†ä¸¤æ­¥ï¼Œå…ˆéœ€è¦å°†ç›®æ ‡åœ°å€çš„æœŸæœ›å€¼æ”¾å…¥<code>EAX</code>å¯„å­˜å™¨ï¼Œå†æ¥æ‰§è¡Œ<code>CMPXCHG</code>æŒ‡ä»¤å®Œæˆæ¯”è¾ƒå¹¶äº¤æ¢çš„æ“ä½œï¼Œå› æ­¤åªæ˜¯ä¿è¯äº†<strong>æ¯”è¾ƒå’Œæ›´æ–°</strong>æ“ä½œçš„åŸå­æ€§ï¼Œä¸èƒ½ä¿è¯è¯»å–åˆ°çš„æ•°æ®ä¸€å®šæ˜¯æœ€æ–°çš„ï¼Œæ‰€ä»¥ä¼šå‡ºç°CASå¤±è´¥çš„æƒ…å†µï¼Œå› æ­¤ä¸Šå±‚éœ€è¦é€šè¿‡è‡ªæ—‹æ¥æ‰§è¡ŒCASæ“ä½œï¼Œç¡®ä¿èƒ½å¤Ÿå®Œæˆæ›´æ–°ã€‚</p>
<p>æˆ‘ä»¬é€šè¿‡<code>CMPXCHG</code>æŒ‡ä»¤å¯ä»¥å®Œæˆæ¯”è¾ƒå€¼å’Œæ›´æ–°å€¼çš„åŸå­æ€§ï¼Œä½†å¦‚æœåªé€šè¿‡è¯¥æŒ‡ä»¤å°±èƒ½å®ŒæˆåŸå­æ“ä½œäº†å—ï¼Œæ˜¾ç„¶æ²¡æœ‰è¿™ä¹ˆç®€å•ï¼Œå¬æˆ‘ç»†ç»†é“æ¥</p>
<h2 id="cpu-ç¼“å­˜"><a class="markdownIt-Anchor" href="#cpu-ç¼“å­˜"></a> CPU ç¼“å­˜</h2>
<blockquote>
<p>è¯¦ç»†äº†è§£<code>CPU</code>ç¼“å­˜ä½“ç³»å¯ç§»æ­¥è¿™ç¯‡åšå®¢ <a  href="/posts/1a5fbe08.html">CPUç¼“å­˜ä¸MESIåè®®</a></p>
<ul>
<li>ä¸‹é¢çš„å†…å®¹å¤§éƒ¨åˆ†æ¥æºäºè¯¥åšå®¢</li>
</ul>
</blockquote>
<p><code>cpu</code>åœ¨å°†æ•°æ®å†™å…¥åˆ°ç›®æ ‡åœ°å€ä¹‹å‰ï¼Œéœ€è¦å°†æ•°æ®å…ˆä»å†…å­˜è¯»å–åˆ°<code>L1æ•°æ®ç¼“å­˜</code>ï¼Œå†ä»<code>L1æ•°æ®ç¼“å­˜</code>è¯»å–åˆ°<code>å¯„å­˜å™¨</code>ä¸­ï¼Œç»è¿‡<code>ALU</code>è®¡ç®—ï¼Œå†é€šè¿‡<code>mov</code>ç³»åˆ—æŒ‡ä»¤æŠŠæ•°æ®æ‹·è´åˆ°ç›®æ ‡åœ°å€ï¼Œä½†æ­¤æ—¶åªæ˜¯å†™å…¥<code>L1æ•°æ®ç¼“å­˜</code>ï¼Œè€Œ<code>L1æ•°æ®ç¼“å­˜</code>å®ƒæ˜¯<code>cpu</code>ç§æœ‰çš„ï¼Œé‚£ä¹ˆåœ¨å¤šcpuç¯å¢ƒä¸‹(<em>å‡è®¾æ¯ä¸ªcpuåªæœ‰ä¸€ä¸ªæ ¸</em>)ï¼Œå¦‚æœæ²¡æœ‰é¢å¤–çš„æ‰‹æ®µï¼Œå°±ä¼šé€ æˆ<code>cpu A</code>å¯¹åœ°å€<code>A</code>çš„å€¼çš„æ›´æ–°æ“ä½œæ˜¯å¯¹å…¶ä»–<code>cpu</code>æ˜¯ä¸å¯è§çš„ï¼Œå› ä¸ºæ­¤æ—¶æœ€æ–°çš„æ•°æ®åªæ˜¯åœ¨å®ƒè‡ªå·±çš„<code>L1ç§æœ‰æ•°æ®ç¼“å­˜</code>ä¸­ï¼Œå¯¹äºè¿™ä¸ªé—®é¢˜ï¼Œèªæ˜çš„<code>cpu</code>è®¾è®¡å¸ˆå½“ç„¶ç»™å‡ºäº†è§£å†³åŠæ³•</p>
<h3 id="lock-æŒ‡ä»¤"><a class="markdownIt-Anchor" href="#lock-æŒ‡ä»¤"></a> Lock# æŒ‡ä»¤</h3>
<blockquote>
<p>å…³äºIntel å¼€å‘äººå‘˜æ‰‹å†Œ å¯¹ Lock# æŒ‡ä»¤çš„ä»‹ç»å¯ä»¥æŸ¥é˜…ä¸‹é¢çš„æ–‡ç« </p>
<ul>
<li>â€“  å·2 Chapter 3.3  LOCKâ€”Assert LOCK# Signal Prefix   1213 é¡µ</li>
<li>â€“  å·3 Chapter 10.1 Locked Atomic Operations  3368é¡µ<br />
ä¸‹é¢çš„å†…å®¹å¤§éƒ¨åˆ†æ¥è‡ªäºè¯¥æ‰‹å†Œ</li>
</ul>
</blockquote>
<p>Intel ä¸º<code>cpu</code>æä¾›äº† Lock# æŒ‡ä»¤ï¼Œå°†è¯¥æŒ‡ä»¤ä¸ç‰¹å®šæŒ‡ä»¤ç»“åˆä½¿ç”¨å¯ä»¥ä¿è¯å¤šä¸ª<code>CPU</code>å¯¹ç›®æ ‡å…±äº«åœ°å€çš„æ“ä½œæ˜¯äº’æ–¥çš„ï¼Œå› ä¸ºLock æŒ‡ä»¤éœ€è¦å’Œå…¶ä»–æŒ‡ä»¤ç»“åˆä½¿ç”¨å› æ­¤ä¹Ÿç§°ä¸º <code>Lock é”å‰ç¼€</code></p>
<p>åœ¨æ—©æœŸçš„Intel cpuä¸­(<em>å¦‚Pentium</em>)ï¼ŒLock é”å‰ç¼€æŒ‡ä»¤æ€»æ˜¯ä¼šé€šè¿‡æ€»çº¿ä»²è£å™¨æ¥é”å®šæ€»çº¿ï¼Œä¿è¯äº†ç‰¹å®šçš„æŒ‡ä»¤åœ¨æ‰§è¡Œæ—¶æ˜¯åŸå­çš„ä»¥åŠå¤šå¤„ç†å™¨ç¯å¢ƒä¸‹è¯»å†™ç›®æ ‡åœ°å€æ•°æ®çš„ä¸€è‡´æ€§ï¼Œé˜²æ­¢å…¶ä»–<code>CPU</code>åŒæ—¶è®¿é—®æˆ–ä¿®æ”¹åŒä¸€å†…å­˜åœ°å€çš„æ•°æ®ï¼Œä½†è¿™ç§æ–¹å¼ä¼šå¯¼è‡´å…¶ä»–Cpuåœ¨æ€»çº¿é”å®šçš„æœŸé—´ï¼Œå› ä¸ºå¤„ç†å™¨æ— æ³•ä½¿ç”¨æ€»çº¿å»è®¿é—®å†…å­˜è€Œå¯¼è‡´çš„é˜»å¡(stall)ï¼Œå¯¼è‡´äº†æ€§èƒ½çš„æ€¥å‰§é™ä½ï¼Œå› æ­¤åœ¨<code>P6</code>ä»¥åŠåç»­Intelå¤„ç†å™¨ä¸­ï¼Œå¢åŠ äº†<code>ç¼“å­˜è¡Œé”å®š</code>æŠ€æœ¯æ¥è§£å†³å› æ€»çº¿é”å®šè€Œå¯¼è‡´çš„æ€§èƒ½ç“¶é¢ˆ</p>
<h4 id="æ€»çº¿ä»²è£å™¨"><a class="markdownIt-Anchor" href="#æ€»çº¿ä»²è£å™¨"></a> æ€»çº¿ä»²è£å™¨</h4>
<p>åœ¨ä»‹ç»ä¸‹é¢çš„æ¦‚å¿µä¹‹å‰ï¼Œæˆ‘æƒ³å…ˆä»‹ç»ä¸€ä¸ªé‡è¦çš„ç¡¬ä»¶å•å…ƒ<code>æ€»çº¿ä»²è£å™¨</code>ï¼Œæ€»çº¿ä»²è£å™¨å®ƒè¿æ¥äº†æ‰€æœ‰è®¾å¤‡æ‰€è®¿é—®çš„æ€»çº¿ï¼ŒåŒ…æ‹¬åœ°å€æ€»çº¿ï¼Œæ•°æ®æ€»çº¿ï¼Œæ§åˆ¶æ€»çº¿ï¼Œå®ƒç®¡ç†å¤šä¸ªè®¾å¤‡å¯¹å…±äº«æ€»çº¿çš„è®¿é—®è¯·æ±‚ï¼Œç¡®ä¿åœ¨åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªè®¾å¤‡èƒ½å¤Ÿè®¿é—®æ€»çº¿ï¼Œä»è€Œé¿å…æ•°æ®å†²çªå’Œä¸ä¸€è‡´æ€§</p>
<ul>
<li><code>åœ°å€æ€»çº¿(Address Bus)</code>ï¼šç”¨äºæŒ‡å®šæ•°æ®ä¼ è¾“çš„ç›®æ ‡åœ°å€</li>
<li><code>æ•°æ®æ€»çº¿(Data Bus)</code>ï¼šç”¨äºæ•°æ®çš„ä¼ è¾“</li>
<li><code>æ§åˆ¶æ€»çº¿</code>ï¼šç”¨äºä¼ è¾“æ§åˆ¶ä¿¡å·ï¼Œå¦‚è¯»å†™å‘½ä»¤ï¼Œä¸­æ–­è¯·æ±‚ç­‰</li>
</ul>
<p>å·¥ä½œæµç¨‹</p>
<ol>
<li>æ¥å—è¯·æ±‚ï¼šæ¥æ”¶æ¥è‡ªå„ä¸ªè®¾å¤‡(å¦‚cpuï¼Œdmaæ§åˆ¶å™¨ï¼Œi/oè®¾å¤‡ç­‰)çš„æ€»çº¿è®¿é—®è¯·æ±‚</li>
<li>åˆ†é…æ€»çº¿ä½¿ç”¨æƒï¼šæ ¹æ®æŸç§ç®—æ³•(å¦‚å›ºå®šä¼˜å…ˆçº§ï¼Œè½®è¯¢ç­‰)å†³å®šå“ªä¸ªè®¾å¤‡è·å¾—æ€»çº¿çš„ä½¿ç”¨æƒ</li>
<li>é‡Šæ”¾æ€»çº¿ä½¿ç”¨æƒï¼šå½“è®¾å¤‡å®Œæˆæ•°æ®ä¼ è¾“åï¼Œé‡Šæ”¾æ€»çº¿ä½¿ç”¨æƒï¼Œå…è®¸å…¶ä»–è®¾å¤‡è®¿é—®æ€»çº¿</li>
</ol>
<h4 id="æ€»çº¿é”å®š"><a class="markdownIt-Anchor" href="#æ€»çº¿é”å®š"></a> æ€»çº¿é”å®š</h4>
<p>ä»‹ç»ä¸€ä¸‹æ€»çº¿é”å®šçš„æµç¨‹ï¼Œä»¥ç†è§£ä¸ºä»€ä¹ˆèƒ½ä¿è¯æŒ‡ä»¤æ‰§è¡Œçš„åŸå­æ€§å’Œè¯»å†™æ•°æ®çš„ä¸€è‡´æ€§ï¼Œæ€§èƒ½ç“¶é¢ˆå‘ç”Ÿçš„åŸå› </p>
<ol>
<li>CPUåœ¨æ‰§è¡Œ<code>lock</code> å‰ç¼€æŒ‡ä»¤æ—¶ï¼Œä¼šä½¿èƒ½æ€»çº¿é”å®šå¼•è„š(Lock#)ï¼Œå‘æ€»çº¿ä»²è£å™¨å‘é€ç”µä¿¡å·ï¼Œè¯¥ä¿¡å·ä¼´éšå½“å‰æ€»çº¿å‘¨æœŸ(å¦‚å†…å­˜è¯»/å†™æ“ä½œ)æŒç»­æœ‰æ•ˆï¼Œç›´è‡³æ“ä½œå®Œæˆ</li>
<li>æ€»çº¿ä»²è£å™¨æ£€æµ‹åˆ°<code>Lock</code>ä¿¡å·ï¼Œä¼šå†»ç»“å½“å‰è¯·æ±‚ä»²è£é˜Ÿåˆ—ï¼Œæš‚åœå¤„ç†å…¶ä»–è®¾å¤‡çš„æ€»çº¿è¯·æ±‚ï¼Œç¡®ä¿å½“å‰CPUçš„æ“ä½œä¸å—å¹²æ‰°ï¼Œé˜»æ­¢å…¶ä»–è®¾å¤‡æŠ¢å æ€»çº¿</li>
<li>åœ¨<code>Lock</code>æœ‰æ•ˆæœŸé—´ï¼ŒCPUå®Œå…¨ç‹¬å æ€»çº¿å¯ä»¥å®‰å…¨çš„å¯¹å…±äº«å†…å­˜æ‰§è¡Œè¯»å†™æ“ä½œ</li>
<li>CPUå®Œæˆ<code>Lock</code>æŒ‡ä»¤åï¼Œæ’¤é”€<code>Lock</code>ä¿¡å·ï¼Œæ€»çº¿ä»²è£å™¨æ¢å¤æ­£å¸¸å·¥ä½œï¼Œå…¶ä»–è®¾å¤‡æ­¤æ—¶å¯ä»¥ç«äº‰è®¿é—®æ€»çº¿</li>
</ol>
<p>å¯ä»¥çœ‹åˆ°æ•´ä¸ªæµç¨‹ï¼Œæ€»çº¿é”å®šéœ€è¦ä¸€ç›´ç­‰å¾…<code>lock</code>æŒ‡ä»¤çš„æ‰§è¡Œå®Œæˆæ‰èƒ½é‡Šæ”¾æ€»çº¿ï¼Œåœ¨æ­¤æœŸé—´ï¼Œæ‰€æœ‰è®¾å¤‡éƒ½æ— æ³•è®¿é—®æ€»çº¿ï¼Œå¯æƒ³è€ŒçŸ¥å¯¹æ€§èƒ½çš„å½±å“æœ‰å¤šå¤§</p>
<h4 id="ç¼“å­˜è¡Œé”å®š"><a class="markdownIt-Anchor" href="#ç¼“å­˜è¡Œé”å®š"></a> ç¼“å­˜è¡Œé”å®š</h4>
<blockquote>
<p>ä¸‹é¢å†…å®¹éƒ½æ¥æºä¸‹é¢è¿™ç¯‡åšå®¢ï¼Œæ­¤å¤„ä¸ºäº†è¯¥ç¯‡åšå®¢çš„å®Œæ•´æ€§ï¼Œæä¾›å¯¹ç¼“å­˜è¡Œä»¥åŠç›¸å…³æ¦‚å¿µçš„ç®€è¦è¯´æ˜ï¼Œè¯¦ç»†ç»†èŠ‚è¯·çœ‹ï¼š</p>
<ul>
<li><a  href="/posts/1a5fbe08.html">CPUç¼“å­˜ä¸MESIåè®®</a></li>
</ul>
</blockquote>
<h5 id="ç¼“å­˜ç»“æ„"><a class="markdownIt-Anchor" href="#ç¼“å­˜ç»“æ„"></a> ç¼“å­˜ç»“æ„</h5>
<p>å¤„ç†å™¨åœ¨è®¿é—®å†…å­˜æ—¶é€šå¸¸éœ€è¦100åˆ°300ä¸ªå‘¨æœŸï¼Œè¿™æ„å‘³ç€åœ¨è¿™ä¸ªè®¿å­˜å‘¨æœŸä¸­ï¼Œcpuåªèƒ½å¹²ç­‰ç€å†…å­˜æ§åˆ¶å™¨å°†æ•°æ®å“åº”ç»™cpuï¼Œä¸ºäº†æé«˜æ•ˆç‡ï¼Œå¼¥è¡¥å¤„ç†å™¨ä¸å†…å­˜ä¹‹é—´çš„å·®è·ï¼Œå› æ­¤åœ¨å¤„ç†å™¨ä¸å†…å­˜ä¹‹é—´å¢åŠ äº†ç¼“å­˜ç»“æ„ï¼Œåˆ†ä¸º<code>L1</code>ï¼Œ<code>L2</code>ï¼Œ<code>L3</code>ä¸‰çº§ç¼“å­˜ï¼Œ<code>L1ç¼“å­˜</code>å’Œ<code>L2ç¼“å­˜</code>æ˜¯<code>cpuæ ¸å¿ƒ</code>ç§æœ‰ï¼Œè€Œ<code>L3</code>ç¼“å­˜åˆ™å±äºåŒä¸€ä¸ª<code>cpu</code>çš„æ ¸å¿ƒå…±äº«ï¼Œè¶Šé è¿‘cpuçš„é€Ÿåº¦ä¹Ÿå°±è¶Šå¿«ï¼Œä½†æ˜¯å¯å­˜å‚¨çš„å®¹é‡ä¹Ÿè¶Šå°</p>
<h5 id="ç¼“å­˜è¡ŒçŠ¶æ€"><a class="markdownIt-Anchor" href="#ç¼“å­˜è¡ŒçŠ¶æ€"></a> ç¼“å­˜è¡ŒçŠ¶æ€</h5>
<p>ä¸ç®¡æ˜¯L1ï¼ŒL2ï¼ŒL3ç¼“å­˜ï¼Œå…¶ç¼“å­˜è¡Œçš„çŠ¶æ€éƒ½ä¼šåœ¨<code>Modified</code>,<code>Exclusive</code>,<code>Shared</code>,<code>Invalidate</code>å››ä¸ªçŠ¶æ€ä¸­åˆ‡æ¢</p>
<ul>
<li><code>Modified</code>ï¼šå½“å‰ç¼“å­˜è¡Œä¸­çš„å‰¯æœ¬æ•°æ®å·²è¢«ä¿®æ”¹ï¼Œæ„å‘³ç€å†…å­˜ä¸­çš„æ•°æ®æ˜¯è¿‡æœŸçš„</li>
<li><code>Exclusive</code>ï¼šå¤„äºè¯¥çŠ¶æ€çš„ç¼“å­˜è¡Œè¡¨ç¤ºåªå­˜åœ¨å½“å‰cpuçš„ç¼“å­˜ä¸­ï¼Œå¹¶ä¸”ä¸å†…å­˜ä¸­çš„å‰¯æœ¬ç›¸åŒ</li>
<li><code>Shared</code>ï¼šå¤„äºè¯¥çŠ¶æ€çš„ç¼“å­˜è¡Œæ„å‘³ç€åŒæ—¶ä¹Ÿå­˜åœ¨å…¶ä»–cpuçš„ç¼“å­˜ä¸­ï¼Œå¹¶ä¸”ä¸å†…å­˜ä¸­çš„å‰¯æœ¬ç›¸åŒ</li>
<li><code>Invalidate</code>ï¼šå¤„äºè¯¥çŠ¶æ€çš„ç¼“å­˜è¡Œè¡¨ç¤ºæ˜¯å¤±æ•ˆçŠ¶æ€æ— æ³•è®¿é—®ï¼Œéœ€è¦é‡æ–°æ‰§è¡Œç¼“å­˜è¡Œå¡«å……</li>
</ul>
<h5 id="å†…å­˜ç›®å½•"><a class="markdownIt-Anchor" href="#å†…å­˜ç›®å½•"></a> å†…å­˜ç›®å½•</h5>
<p>å†…å­˜ç›®å½•æ˜¯å¤šæ ¸å¤„ç†å™¨ç³»ç»Ÿä¸­ç”¨äºé«˜æ•ˆç®¡ç†ç¼“å­˜ä¸€è‡´æ€§çš„å…³é”®ç¡¬ä»¶ç»“æ„ï¼Œå®ƒé€šè¿‡è®°å½•å†…å­˜å—<sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup>åœ¨å„çº§ç¼“å­˜ä¸­çš„çŠ¶æ€å’Œä½ç½®ï¼Œå‡å°‘äº†ä¼ ç»Ÿ<code>ä¾¦å¬</code>(<em>Snooping</em>)åè®®ä¸­çš„å¹¿æ’­å¼€é”€</p>
<ul>
<li>å¦‚æœæ²¡æœ‰å†…å­˜ç›®å½•è®°å½•å†…å­˜å—çš„ä¿¡æ¯ï¼Œé‚£ä¹ˆæ ¹æ®ä¼ ç»Ÿ<code>ä¾¦å¬åè®®</code>çš„å¤„ç†ï¼Œéœ€è¦åœ¨æ€»çº¿ä¸Šå¹¿æ’­è¯·æ±‚ï¼Œç¼“å­˜äº†è¯¥å†…å­˜å—çš„<code>cpu</code>æ”¶åˆ°è¯·æ±‚ååˆ™ç»™å‡ºå“åº”ï¼Œæ²¡æœ‰åˆ™è®¿é—®ä¸»å­˜</li>
</ul>
<blockquote>
<p>å†…å­˜ç›®å½•é€šå¸¸é›†æˆåœ¨å†…å­˜æ§åˆ¶å™¨æˆ–è€…æ˜¯L3ç¼“å­˜ä¸­</p>
</blockquote>
<p>å†…å­˜ç›®å½•çš„ä½œç”¨å°±æ˜¯å¯¹ç¼“å­˜çŠ¶æ€è¿›è¡Œè·Ÿè¸ªï¼Œå®ƒä¼šè®°å½•æ¯ä¸ªå†…å­˜å—(ç¼“å­˜è¡Œ)çš„ç¼“å­˜å‰¯æœ¬åˆ†å¸ƒåœ¨å“ªäº›<code>cpu</code>ä¸­ï¼Œä»¥åŠåœ¨è¿™äº›<code>cpu</code>ç¼“å­˜ä¸­çš„çŠ¶æ€ï¼Œé€šè¿‡ç²¾ç¡®çš„ç›®å½•ä¿¡æ¯ï¼Œé¿å…å‘æ‰€æœ‰<code>cpu</code>å¹¿æ’­è¯·æ±‚ï¼Œä»…å‘é€ç»™æŒæœ‰æœ‰æ•ˆçŠ¶æ€ç¼“å­˜çš„<code>cpu</code>ï¼Œå‡å°‘äº†æ— æ•ˆçš„æ€»çº¿ä¾¦å¬æµé‡</p>
<h5 id="ç¼“å­˜çŠ¶æ€çš„ç»´æŠ¤"><a class="markdownIt-Anchor" href="#ç¼“å­˜çŠ¶æ€çš„ç»´æŠ¤"></a> ç¼“å­˜çŠ¶æ€çš„ç»´æŠ¤</h5>
<p>ç¼“å­˜è¡Œçš„çŠ¶æ€æ˜¯ç”±ç¼“å­˜ä¸€è‡´æ€§<code>MESI</code>åè®®ç»´æŠ¤ï¼Œå½“æŸä¸ª<code>cpu</code>æ ¸å¿ƒæƒ³è¦å†™å…¥æŸä¸ªåœ°å€çš„æ•°æ®æ—¶ï¼Œå¿…é¡»è¦åœ¨L1ç¼“å­˜ä¸­æŒæœ‰è¯¥å†…å­˜å—çš„ç¼“å­˜è¡Œï¼Œå¹¶ä¸”ç¼“å­˜è¡ŒçŠ¶æ€å¿…é¡»ä¸º<code>E</code>æˆ–<code>M</code>çš„ï¼Œå¦‚æœæ˜¯å…¶ä»–çŠ¶æ€(<code>R</code>æˆ–è€…<code>I</code>)æˆ–è€…æ²¡æœ‰æœªåœ¨ç¼“å­˜è¡Œå‘½ä¸­ï¼Œé‚£ä¹ˆå°±éœ€è¦é€šè¿‡é¢å¤–çš„æ–¹å¼æ¥è·å–å¯¹è¯¥åœ°å€çš„å¯ä¿®æ”¹æƒåŠ›ï¼Œå¦‚æœæœ‰<code>cpu</code>ï¼Œè¿™æ˜¯ç¼“å­˜ä¸€è‡´æ€§åè®®ä¸ºäº†ä¿è¯å¤šæ ¸ä¹‹é—´çš„ç¼“å­˜æ•°æ®çš„ä¸€è‡´æ€§æ‰€è§„å®šçš„</p>
<h5 id="cpu-è¯»å–å†…å­˜æ•°æ®æµç¨‹"><a class="markdownIt-Anchor" href="#cpu-è¯»å–å†…å­˜æ•°æ®æµç¨‹"></a> cpu è¯»å–å†…å­˜æ•°æ®æµç¨‹</h5>
<p>cpuåœ¨è¯»å–å†…å­˜æ•°æ®æ—¶ï¼Œé¦–å…ˆä¼šæ£€æŸ¥æœ€è¿‘çš„L1ç¼“å­˜ï¼Œå¦‚æœå‘½ä¸­å°±ç›´æ¥è¿”å›ï¼Œæœªå‘½ä¸­åˆ™å‘ä¸‹æŸ¥è¯¢L2ç¼“å­˜ï¼Œå¦‚æœL2ç¼“å­˜å‘½ä¸­ï¼Œé‚£ä¹ˆè¿”å›æ•°æ®å¹¶å†™å…¥L1ç¼“å­˜ï¼Œæœªå‘½ä¸­ï¼Œç»§ç»­æŸ¥è¯¢L3ç¼“å­˜ï¼Œå¦‚æœå‘½ä¸­ï¼Œè¿”å›æ•°æ®å¹¶å†™å…¥L2ç¼“å­˜å’ŒL1ç¼“å­˜ï¼Œå¦‚æœæœªå‘½ä¸­ï¼Œé‚£ä¹ˆä¼šé€šè¿‡å‘å†…å­˜æ§åˆ¶å™¨å‘é€<code>BusRead</code>è¯·æ±‚ï¼Œå†…å­˜æ§åˆ¶å™¨ä¼šæ£€æŸ¥å†…å­˜ç›®å½•ï¼ŒæŸ¥çœ‹è¯¥åœ°å€çš„æ•°æ®æ˜¯å¦è¢«å…¶ä»–cpuç¼“å­˜ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™åœ¨æ€»çº¿ä¸Šå¹¿æ’­è¯·æ±‚ï¼ŒæŒæœ‰äº†è¯¥åœ°å€ç¼“å­˜è¡Œçš„<code>cpu</code>ä¼šå“åº”æ•°æ®ï¼Œå¦‚æœçŠ¶æ€æ˜¯Mï¼Œæ ¹æ®<code>ç¼“å­˜ä¸€è‡´æ€§åè®®</code>ï¼Œé‚£ä¹ˆéœ€è¦å°†ç¼“å­˜è¡Œçš„æ•°æ®å†™å…¥ä¸»å­˜ï¼Œå¹¶å°†çŠ¶æ€ä¿®æ”¹ä¸ºSï¼Œå¦‚æœå…¶ä»–<code>cpu</code>çš„ç¼“å­˜ä¸­æ²¡æœ‰è¯¥åœ°å€çš„æ•°æ®ï¼Œåˆ™å†…å­˜æ§åˆ¶å™¨éœ€è¦è®¿é—®ä¸»å­˜ï¼Œå¹¶é€šè¿‡é¢„å–æŠ€æœ¯è¯»å–åŒ…å«è¯¥ç›®æ ‡åœ°å€å‰åçš„64ä¸ªå­—èŠ‚ï¼Œç„¶åå°†æ•°æ®æŒ‰é¡ºåºä»ä¸»å­˜å¡«å……åˆ°L3ï¼Œå¹¶ä¸”åŒæ—¶è§¦å‘L2å’ŒL1çš„<code>çº§è”å¡«å……</code>ï¼Œæ•°æ®å†™å…¥å„è‡ªçš„ç¼“å­˜</p>
<h5 id="cpu-å†™å…¥å†…å­˜æ•°æ®æµç¨‹"><a class="markdownIt-Anchor" href="#cpu-å†™å…¥å†…å­˜æ•°æ®æµç¨‹"></a> cpu å†™å…¥å†…å­˜æ•°æ®æµç¨‹</h5>
<p>cpu å°†æ•°æ®å†™å…¥ç›®æ ‡å†…å­˜åœ°å€ä¹‹å‰ï¼Œé¦–å…ˆä¼šæ£€æŸ¥æ˜¯å¦æŒæœ‰è¯¥ç›®æ ‡å†…å­˜åœ°å€çš„ç¼“å­˜è¡Œï¼Œå¦‚æœæŒæœ‰ï¼Œå¹¶ä¸”çŠ¶æ€æ˜¯<code>E</code>ï¼Œé‚£ä¹ˆç›´æ¥å†™å…¥ï¼Œå¹¶ä¸”æ›´æ”¹ç¼“å­˜è¡ŒçŠ¶æ€ä¸º<code>M</code>ï¼Œ</p>
<h3 id="arm"><a class="markdownIt-Anchor" href="#arm"></a> ARM</h3>
<hr class="footnotes-sep" />
<section class="footnotes">
<ol class="footnotes-list">
<li id="fn1" class="footnote-item"><p>å†…å­˜å—é€šå¸¸å¯¹åº”ä¸€ä¸ªç¼“å­˜è¡Œ <a href="#fnref1" class="footnote-backref">â†©ï¸</a></p>
</li>
</ol>
</section>
]]></content>
      <categories>
        <category>æºç åˆ†æ</category>
        <category>hotspot</category>
      </categories>
      <tags>
        <tag>æºç </tag>
        <tag>JVM</tag>
      </tags>
  </entry>
  <entry>
    <title>JMM</title>
    <url>/posts/cff6dd61.html</url>
    <content><![CDATA[<h3 id="å¼•è¨€"><a class="markdownIt-Anchor" href="#å¼•è¨€"></a> å¼•è¨€</h3>
<p>åœ¨Javaè¿™ä¸ªä¸–ç•Œä¸­ï¼Œå¦‚æœæŠŠJVMæ¯”ä½œä¸€ä¸ªè¿è¡Œjavaä»£ç çš„ç”Ÿæ€åœŸå£¤ï¼Œé‚£ä¹ˆJMMå°±æ˜¯Javaä¸­çš„ç”Ÿæ€æ³•åˆ™ï¼Œå®ƒè§„å®šäº†è¿™ä¸ªä¸–ç•Œçš„è¿è¡Œè§„åˆ™ï¼Œå®šä¹‰äº†çº¿ç¨‹æœ¬åœ°çš„å˜é‡è¯»å–å­˜å‚¨ï¼Œå¤šçº¿ç¨‹ä¹‹é—´çš„å˜é‡å…±äº«è§„åˆ™ï¼Œå¹¶å±è”½äº†åº•å±‚ä¸åŒcpuæ¶æ„ï¼Œç³»ç»Ÿä¹‹é—´çš„å·®åˆ«ï¼Œæˆ‘ä»¬åªéœ€è¦éµå®ˆè§„èŒƒä¾¿å¯ä»¥å¼€å‘å‡ºç¨³å®šå¯é çš„å•/å¤šçº¿ç¨‹åº”ç”¨</p>
<h3 id="ä»‹ç»"><a class="markdownIt-Anchor" href="#ä»‹ç»"></a> ä»‹ç»</h3>
<p><a href="https://docs.oracle.com/javase/specs/jls/se23/html/jls-17.html#jls-17.4"><code>JMM(Java Memory Model)</code></a>ï¼šæ˜¯ Java è¯­è¨€è§„èŒƒå®šä¹‰çš„ä¸€ç»„è§„åˆ™ï¼Œç”¨äºåè°ƒå¤šçº¿ç¨‹ä¹‹é—´çš„å†…å­˜è®¿é—®æ“ä½œï¼Œä¿è¯å¤šçº¿ç¨‹ç¨‹åºåœ¨ä¸åŒçš„ç¡¬ä»¶å’Œæ“ä½œç³»ç»Ÿå¹³å°ä¸Šéƒ½èƒ½æ­£ç¡®åœ°æ‰§è¡Œã€‚ä¸‹é¢ä»å‡ ä¸ªæ–¹é¢å¯¹ JMM è¿›è¡Œå®Œæ•´çš„æè¿°ï¼š</p>
<h4 id="åŸºæœ¬æ¦‚å¿µ"><a class="markdownIt-Anchor" href="#åŸºæœ¬æ¦‚å¿µ"></a> åŸºæœ¬æ¦‚å¿µ</h4>
<p><code>ä¸»å†…å­˜ (Main Memory)</code>: ä¸»å†…å­˜æ˜¯æ‰€æœ‰çº¿ç¨‹å…±äº«çš„å†…å­˜åŒºåŸŸï¼Œå®ƒå­˜å‚¨äº†Javaçš„å¯¹è±¡ï¼Œé™æ€å˜é‡ï¼Œç±»ä¿¡æ¯ï¼Œå¸¸é‡æ± ä¿¡æ¯<br />
<code>å·¥ä½œå†…å­˜(Working Memory)</code>: æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„å·¥ä½œå†…å­˜ï¼Œå®ƒæ˜¯çº¿ç¨‹ç§æœ‰çš„ï¼Œçº¿ç¨‹åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œä¼šå°†ä¸»å†…å­˜çš„æ•°æ®æ‹·è´åˆ°è‡ªå·±çš„å·¥ä½œå†…å­˜ï¼Œæ“ä½œå®Œæˆåå†å°†ç»“æœå†™å›ä¸»å†…å­˜</p>
<blockquote>
<p>å®šä¹‰ä¸Šé¢çš„æ¦‚å¿µæ˜¯è§£å†³ä¸åŒå¹³å°ä»¥åŠä¸åŒç¡¬ä»¶æ¶æ„ä¸‹çš„å†…å­˜äº¤äº’çº¦æŸï¼Œåœ¨å…·ä½“å®ç°ä¸Šä¸»å†…å­˜å¯ä»¥çœ‹ä½œæ˜¯RAMï¼Œè€Œå·¥ä½œå†…å­˜çœ‹ä½œæ˜¯å¯„å­˜å™¨ï¼ŒCPUç¼“å­˜ä»¥åŠå±€éƒ¨å˜é‡è¡¨(è¿™ä¸ªæ˜¯æ ˆå¸§ä¸­çš„ä¸€å—åŒºåŸŸï¼Œè¿™å—åŒºåŸŸçš„å¤§å°ç¼–è¯‘æœŸå°±å¯ä»¥ç¡®å®šä¸‹æ¥)</p>
</blockquote>
<h4 id="å·¥ä½œå†…å­˜ä¹‹å±€éƒ¨å˜é‡è¡¨"><a class="markdownIt-Anchor" href="#å·¥ä½œå†…å­˜ä¹‹å±€éƒ¨å˜é‡è¡¨"></a> å·¥ä½œå†…å­˜ä¹‹å±€éƒ¨å˜é‡è¡¨</h4>
<p>å±€éƒ¨å˜é‡è¡¨æ˜¯æ ˆå¸§ä¸­å¼€è¾Ÿçš„ä¸€å—ç¡®å®šå¤§å°çš„è¿ç»­å†…å­˜åŒºåŸŸï¼Œç”¨äºå­˜æ”¾æ–¹æ³•ä¸­ä½¿ç”¨åˆ°çš„å˜é‡</p>
<p>&lt;&lt;&lt;&lt;&lt;&lt;&lt; HEAD</p>
<blockquote>
<p>å¦‚æœå¯¹å±€éƒ¨å˜é‡è¡¨æ˜¯å¦‚ä½•åœ¨æ ˆå¸§ä¸­åˆ›å»ºæ„Ÿå…´è¶£ï¼Œå¯ä»¥åœ¨è¿™ç¯‡åšå®¢æ‰¾åˆ°ç­”æ¡ˆ <a  href="/posts/48bea92d.html">Hotspotæºç å‰–æJavaæ–¹æ³•æ‰§è¡Œæµç¨‹</a></p>
</blockquote>
<h4 id="ç¼–è¯‘ä¼˜åŒ–"><a class="markdownIt-Anchor" href="#ç¼–è¯‘ä¼˜åŒ–"></a> ç¼–è¯‘ä¼˜åŒ–</h4>
<p>Javaçš„å­—èŠ‚ç é€šå¸¸æ˜¯ç”±è§£é‡Šå™¨å’Œç¼–è¯‘å™¨ç›¸äº’é…åˆæ‰§è¡Œçš„ï¼Œä¸ºäº†è®©Javaåº”ç”¨èƒ½å¤Ÿæ›´å¿«é€Ÿçš„å¯åŠ¨é€šå¸¸æ˜¯è§£é‡Šå™¨å…ˆå‘æŒ¥ä½œç”¨ï¼Œé€è¡Œè§£é‡Šå­—èŠ‚ç æŒ‡ä»¤è½¬æ¢æˆä¸ºå¯¹åº”å¹³å°çš„</p>
<p>=======<br />
<sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup>jdk8u hotspot <code>CppInterpreter.cpp</code> æ˜¯ä¸€ä¸ªc++ç¼–å†™çš„å­—èŠ‚ç è§£é‡Šå™¨ï¼Œå…¶ä¸­ç¼–å†™äº†å¦‚ä½•å…³è”å±€éƒ¨å˜é‡è¡¨ä»¥åŠè§£é‡Šæ‰§è¡Œå­—èŠ‚ç æŒ‡ä»¤çš„ä»£ç ï¼Œæ¥ä¸‹æ¥è®©æˆ‘ä»¬çœ‹æºç æ¥äº†è§£æ–¹æ³•çš„æ‰§è¡Œè¿‡ç¨‹ä»¥åŠå­—èŠ‚ç è§£é‡Šæ‰§è¡Œçš„æµç¨‹</p>
<ol>
<li>æ‰§è¡Œjavaæ–¹æ³•çš„å…¥å£</li>
</ol>
<pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">int CppInterpreter::normal_entry(Method* method, intptr_t UNUSED, TRAPS) &#123;  
  JavaThread *thread &#x3D; (JavaThread *) THREAD;  
  &#x2F;&#x2F; Allocate and initialize our frame. 
  &#x2F;&#x2F; ä¸ºæ–¹æ³•åˆ†é…å¹¶åˆå§‹åŒ–æ ˆå¸§ï¼Œå…¶å†…éƒ¨å°±ä¼šåˆ›å»ºæˆ‘ä»¬çš„å±€éƒ¨å˜é‡è¡¨ï¼Œä»¥åŠè®¾ç½®bcpæŒ‡é’ˆ
  InterpreterFrame *frame &#x3D; InterpreterFrame::build(method, CHECK_0);
  &#x2F;&#x2F; ä¿å­˜æˆ‘ä»¬çš„æ ˆå¸§åˆ°çº¿ç¨‹æ ˆä¸­  
  thread-&gt;push_zero_frame(frame);  
  &#x2F;&#x2F; Execute those bytecodes!  
  &#x2F;&#x2F; è¿›å…¥æ‰§è¡Œå­—èŠ‚ç çš„ä¸»å…¥å£
  main_loop(0, THREAD);  
  
  &#x2F;&#x2F; No deoptimized frames on the stack  
  return 0;  
&#125;
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol start="2">
<li>æ„å»ºæ–¹æ³•æ ˆå¸§</li>
</ol>
<pre class="line-numbers language-c++" data-language="c++"><code class="language-c++">InterpreterFrame *InterpreterFrame::build(Method* const method, TRAPS) &#123;
  JavaThread *thread &#x3D; (JavaThread *) THREAD;
  ZeroStack *stack &#x3D; thread-&gt;zero_stack();

  &#x2F;&#x2F; Calculate the size of the frame we&#39;ll build, including
  &#x2F;&#x2F; any adjustments to the caller&#39;s frame that we&#39;ll make.
  &#x2F;&#x2F; æ–¹æ³•å†…éƒ¨å±€éƒ¨å˜é‡æ•°é‡
  int extra_locals  &#x3D; 0;
  &#x2F;&#x2F; ç›‘è§†å™¨å ç”¨ç©ºé—´å¤§å°
  int monitor_words &#x3D; 0;
  &#x2F;&#x2F; å±€éƒ¨å˜é‡è¡¨å˜é‡ä¸ªæ•°&#x2F;é•¿åº¦
  int stack_words   &#x3D; 0;
  &#x2F;&#x2F; æ³¨æ„ï¼Œä¸Šé¢çš„å‚æ•°ç¼–è¯‘æœŸå°±å¯ä»¥ç¡®å®šä¸‹æ¥ï¼Œå¯ä»¥é€šè¿‡javap -l .class çœ‹åˆ°å±€éƒ¨å˜é‡è¡¨ä¿¡æ¯
  &#x2F;&#x2F; æ‰€ä»¥è¿™é‡Œåªæ˜¯å–å‡ºæ¥ç„¶ååˆ†é…ä¸€ä¸ªå¤§å°åˆé€‚çš„å±€éƒ¨å˜é‡è¡¨æ¥å­˜å‚¨æ–¹æ³•ä¸­æ‰€æ“ä½œçš„å˜é‡
  if (!method-&gt;is_native()) &#123;
	&#x2F;&#x2F; å±€éƒ¨å˜é‡è¡¨é•¿åº¦ - æ–¹æ³•å‚æ•° å¾—åˆ° æ–¹æ³•å†…éƒ¨å®šä¹‰çš„å±€éƒ¨å˜é‡ä¸ªæ•°
    extra_locals &#x3D; method-&gt;max_locals() - method-&gt;size_of_parameters();
    &#x2F;&#x2F; å±€éƒ¨å˜é‡è¡¨soltä¸ªæ•°
    stack_words  &#x3D; method-&gt;max_stack();
  &#125;
  if (method-&gt;is_synchronized()) &#123;
	&#x2F;&#x2F; æ–¹æ³•æ˜¯åŒæ­¥çš„ï¼Œé‚£ä¹ˆéœ€è¦åˆ†é…ä¸€ä¸ªsoltå­˜å‚¨
    monitor_words &#x3D; frame::interpreter_frame_monitor_size();
  &#125;
	&#x2F;&#x2F; æ£€æŸ¥æ˜¯å¦æ ˆæº¢å‡º
  stack-&gt;overflow_check(
    extra_locals + header_words + monitor_words + stack_words, CHECK_NULL);

  &#x2F;&#x2F; Adjust the caller&#39;s stack frame to accomodate any additional
  &#x2F;&#x2F; local variables we have contiguously with our parameters.
  &#x2F;&#x2F; push() -&gt; *(--sp) &#x3D; value æ ˆæ‰©å®¹ï¼ˆåœ¨æ“ä½œç³»ç»Ÿé‡Œï¼Œæ ˆçš„å¢é•¿æ˜¯å‘ä½åœ°å€å¢é•¿çš„ï¼Œè€Œæ•°æ®æ®µæ˜¯å‘ä¸Šæ‰©å®¹çš„ï¼‰ï¼Œé¢„å…ˆå ç”¨å±€éƒ¨å˜é‡çš„ç©ºé—´
  for (int i &#x3D; 0; i &lt; extra_locals; i++)
    stack-&gt;push(0);
    &#x2F;&#x2F; æŒ‡å‘å±€éƒ¨å˜é‡è¡¨æœ€åä¸€ä¸ªæ§½ä½çš„æŒ‡é’ˆ
  intptr_t *locals;
  if (method-&gt;is_native())
	  &#x2F;&#x2F; å¦‚æœæ˜¯nativeæ–¹æ³•,æ²¡æœ‰æ–¹æ³•å±€éƒ¨å˜é‡,åªéœ€è¦åœ¨æ ˆå¸§æœ‰å­˜æ”¾æ–¹æ³•å‚æ•°çš„ç©ºé—´å³å¯
    locals &#x3D; stack-&gt;sp() + (method-&gt;size_of_parameters() - 1);
  else
	  &#x2F;&#x2F; javaæ–¹æ³• (æ³¨æ„ï¼šspå·²ç»æ‰©å®¹äº†extra_localsä¸ªä½ç½®)
    locals &#x3D; stack-&gt;sp() + (method-&gt;max_locals() - 1);

  stack-&gt;push(0); &#x2F;&#x2F; next_frame, filled in later
  intptr_t *fp &#x3D; stack-&gt;sp();
  assert(fp - stack-&gt;sp() &#x3D;&#x3D; next_frame_off, &quot;should be&quot;);

  stack-&gt;push(INTERPRETER_FRAME);
  assert(fp - stack-&gt;sp() &#x3D;&#x3D; frame_type_off, &quot;should be&quot;);

  interpreterState istate &#x3D;
    (interpreterState) stack-&gt;alloc(sizeof(BytecodeInterpreter));
  assert(fp - stack-&gt;sp() &#x3D;&#x3D; istate_off, &quot;should be&quot;);

  istate-&gt;set_locals(locals);
  istate-&gt;set_method(method);
  istate-&gt;set_self_link(istate);
  istate-&gt;set_prev_link(NULL);
  istate-&gt;set_thread(thread);
  istate-&gt;set_bcp(method-&gt;is_native() ? NULL : method-&gt;code_base());
  istate-&gt;set_constants(method-&gt;constants()-&gt;cache());
  istate-&gt;set_msg(BytecodeInterpreter::method_entry);
  istate-&gt;set_oop_temp(NULL);
  istate-&gt;set_mdx(NULL);
  istate-&gt;set_callee(NULL);

  istate-&gt;set_monitor_base((BasicObjectLock *) stack-&gt;sp());
  if (method-&gt;is_synchronized()) &#123;
    BasicObjectLock *monitor &#x3D;
      (BasicObjectLock *) stack-&gt;alloc(monitor_words * wordSize);
    oop object;
    if (method-&gt;is_static())
      object &#x3D; method-&gt;constants()-&gt;pool_holder()-&gt;java_mirror();
    else
      object &#x3D; (oop) (void*)locals[0];
    monitor-&gt;set_obj(object);
  &#125;

  istate-&gt;set_stack_base(stack-&gt;sp());
  istate-&gt;set_stack(stack-&gt;sp() - 1);
  if (stack_words)
    stack-&gt;alloc(stack_words * wordSize);
  istate-&gt;set_stack_limit(stack-&gt;sp() - 1);

  return (InterpreterFrame *) fp;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol start="2">
<li>ä¸»å…¥å£</li>
</ol>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">

<span class="token keyword">void</span> CppInterpreter<span class="token operator">::</span><span class="token function">main_loop</span><span class="token punctuation">(</span><span class="token keyword">int</span> recurse<span class="token punctuation">,</span> TRAPS<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  # å½“å‰javaçº¿ç¨‹
  JavaThread <span class="token operator">*</span>thread <span class="token operator">=</span> <span class="token punctuation">(</span>JavaThread <span class="token operator">*</span><span class="token punctuation">)</span> THREAD<span class="token punctuation">;</span>
  <span class="token comment">// çº¿ç¨‹æ ˆ</span>
  ZeroStack <span class="token operator">*</span>stack <span class="token operator">=</span> thread<span class="token operator">-></span><span class="token function">zero_stack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// If we are entering from a deopt we may need to call</span>
  <span class="token comment">// ourself a few times in order to get to our frame.</span>
  <span class="token comment">// é€’å½’è°ƒç”¨ï¼Œä¸å¤ªç†è§£</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>recurse<span class="token punctuation">)</span>
    <span class="token function">main_loop</span><span class="token punctuation">(</span>recurse <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> THREAD<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// è½¬æ¢ä¸ºè§£é‡Šå™¨æ ˆå¸§ç±»å‹</span>
  InterpreterFrame <span class="token operator">*</span>frame <span class="token operator">=</span> thread<span class="token operator">-></span><span class="token function">top_zero_frame</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">as_interpreter_frame</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// è§£é‡Šå™¨çŠ¶æ€[è¯¥çŠ¶æ€ä¿¡æ¯åŒ…å«äº†æ‰§è¡Œæ–¹æ³•æ‰€éœ€è¦çš„ä¸€åˆ‡ä¿¡æ¯ï¼ŒåŒ…æ‹¬ä¸ä»…é™äºå½“å‰çº¿ç¨‹ï¼Œæ ˆï¼Œæ ˆå¸§ï¼Œæœ¬åœ°å˜é‡è¡¨ï¼Œpc,sp åœ°å€]</span>
  interpreterState istate <span class="token operator">=</span> frame<span class="token operator">-></span><span class="token function">interpreter_state</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Method<span class="token operator">*</span> method <span class="token operator">=</span> istate<span class="token operator">-></span><span class="token function">method</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token class-name">intptr_t</span> <span class="token operator">*</span>result <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> result_slots <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token comment">// å¾ªç¯é‡Œæ˜¯å› ä¸ºæœ‰æ‰§è¡Œçš„æŒ‡ä»¤æ¡ä»¶ä¸æ»¡è¶³ï¼Œä»è€Œè¿›å…¥å¯¹åº”çš„åˆ†æ”¯å†æ‰§è¡ŒæŒ‡ä»¤</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>true<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// We can set up the frame anchor with everything we want at</span>
    <span class="token comment">// this point as we are thread_in_Java and no safepoints can</span>
    <span class="token comment">// occur until we go to vm mode.  We do have to clear flags</span>
    <span class="token comment">// on return from vm but that is it.</span>
    <span class="token comment">// è®¾ç½®javaçº¿ç¨‹çš„spä»¥åŠfpå¯„å­˜å™¨ï¼Œå¹¶ä¸”è®©java pcåœ°å€æ¸…ç©º</span>
    <span class="token comment">// src\cpu\zero\vm\javaFrameAnchor_zero.hpp#set(intptr_t* sp, address pc, ZeroFrame* fp)</span>
    thread<span class="token operator">-></span><span class="token function">set_last_Java_frame</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Call the interpreter</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>JvmtiExport<span class="token operator">::</span><span class="token function">can_post_interpreter_events</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      BytecodeInterpreter<span class="token operator">::</span><span class="token function">runWithChecks</span><span class="token punctuation">(</span>istate<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
      <span class="token comment">// è¿™é‡Œå°±æ˜¯æ‰§è¡Œå­—èŠ‚ç æŒ‡ä»¤çš„å…³é”®ä¹‹å¤„ï¼Œä¼š</span>
      BytecodeInterpreter<span class="token operator">::</span><span class="token function">run</span><span class="token punctuation">(</span>istate<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fixup_after_potential_safepoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Clear the frame anchor</span>
    thread<span class="token operator">-></span><span class="token function">reset_last_Java_frame</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Examine the message from the interpreter to decide what to do</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>istate<span class="token operator">-></span><span class="token function">msg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> BytecodeInterpreter<span class="token operator">::</span>call_method<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      Method<span class="token operator">*</span> callee <span class="token operator">=</span> istate<span class="token operator">-></span><span class="token function">callee</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Trim back the stack to put the parameters at the top</span>
      stack<span class="token operator">-></span><span class="token function">set_sp</span><span class="token punctuation">(</span>istate<span class="token operator">-></span><span class="token function">stack</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Make the call</span>
      Interpreter<span class="token operator">::</span><span class="token function">invoke_method</span><span class="token punctuation">(</span>callee<span class="token punctuation">,</span> istate<span class="token operator">-></span><span class="token function">callee_entry_point</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> THREAD<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">fixup_after_potential_safepoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Convert the result</span>
      istate<span class="token operator">-></span><span class="token function">set_stack</span><span class="token punctuation">(</span>stack<span class="token operator">-></span><span class="token function">sp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Restore the stack</span>
      stack<span class="token operator">-></span><span class="token function">set_sp</span><span class="token punctuation">(</span>istate<span class="token operator">-></span><span class="token function">stack_limit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Resume the interpreter</span>
      istate<span class="token operator">-></span><span class="token function">set_msg</span><span class="token punctuation">(</span>BytecodeInterpreter<span class="token operator">::</span>method_resume<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>istate<span class="token operator">-></span><span class="token function">msg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> BytecodeInterpreter<span class="token operator">::</span>more_monitors<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">int</span> monitor_words <span class="token operator">=</span> frame<span class="token operator">::</span><span class="token function">interpreter_frame_monitor_size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Allocate the space</span>
      stack<span class="token operator">-></span><span class="token function">overflow_check</span><span class="token punctuation">(</span>monitor_words<span class="token punctuation">,</span> THREAD<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>HAS_PENDING_EXCEPTION<span class="token punctuation">)</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      stack<span class="token operator">-></span><span class="token function">alloc</span><span class="token punctuation">(</span>monitor_words <span class="token operator">*</span> wordSize<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Move the expression stack contents</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">intptr_t</span> <span class="token operator">*</span>p <span class="token operator">=</span> istate<span class="token operator">-></span><span class="token function">stack</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> p <span class="token operator">&lt;</span> istate<span class="token operator">-></span><span class="token function">stack_base</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> p<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token operator">*</span><span class="token punctuation">(</span>p <span class="token operator">-</span> monitor_words<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>

      <span class="token comment">// Move the expression stack pointers</span>
      istate<span class="token operator">-></span><span class="token function">set_stack_limit</span><span class="token punctuation">(</span>istate<span class="token operator">-></span><span class="token function">stack_limit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> monitor_words<span class="token punctuation">)</span><span class="token punctuation">;</span>
      istate<span class="token operator">-></span><span class="token function">set_stack</span><span class="token punctuation">(</span>istate<span class="token operator">-></span><span class="token function">stack</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> monitor_words<span class="token punctuation">)</span><span class="token punctuation">;</span>
      istate<span class="token operator">-></span><span class="token function">set_stack_base</span><span class="token punctuation">(</span>istate<span class="token operator">-></span><span class="token function">stack_base</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> monitor_words<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Zero the new monitor so the interpreter can find it.</span>
      <span class="token punctuation">(</span><span class="token punctuation">(</span>BasicObjectLock <span class="token operator">*</span><span class="token punctuation">)</span> istate<span class="token operator">-></span><span class="token function">stack_base</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">set_obj</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Resume the interpreter</span>
      istate<span class="token operator">-></span><span class="token function">set_msg</span><span class="token punctuation">(</span>BytecodeInterpreter<span class="token operator">::</span>got_monitors<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>istate<span class="token operator">-></span><span class="token function">msg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> BytecodeInterpreter<span class="token operator">::</span>return_from_method<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// Copy the result into the caller's frame</span>
      result_slots <span class="token operator">=</span> type2size<span class="token punctuation">[</span>method<span class="token operator">-></span><span class="token function">result_type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token function">assert</span><span class="token punctuation">(</span>result_slots <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> result_slots <span class="token operator">&lt;=</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"what?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      result <span class="token operator">=</span> istate<span class="token operator">-></span><span class="token function">stack</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> result_slots<span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>istate<span class="token operator">-></span><span class="token function">msg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> BytecodeInterpreter<span class="token operator">::</span>throwing_exception<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token function">assert</span><span class="token punctuation">(</span>HAS_PENDING_EXCEPTION<span class="token punctuation">,</span> <span class="token string">"should do"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>istate<span class="token operator">-></span><span class="token function">msg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> BytecodeInterpreter<span class="token operator">::</span>do_osr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// Unwind the current frame</span>
      thread<span class="token operator">-></span><span class="token function">pop_zero_frame</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Remove any extension of the previous frame</span>
      <span class="token keyword">int</span> extra_locals <span class="token operator">=</span> method<span class="token operator">-></span><span class="token function">max_locals</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> method<span class="token operator">-></span><span class="token function">size_of_parameters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      stack<span class="token operator">-></span><span class="token function">set_sp</span><span class="token punctuation">(</span>stack<span class="token operator">-></span><span class="token function">sp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> extra_locals<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Jump into the OSR method</span>
      Interpreter<span class="token operator">::</span><span class="token function">invoke_osr</span><span class="token punctuation">(</span>
        method<span class="token punctuation">,</span> istate<span class="token operator">-></span><span class="token function">osr_entry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> istate<span class="token operator">-></span><span class="token function">osr_buf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> THREAD<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
      <span class="token function">ShouldNotReachHere</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// Unwind the current frame</span>
  thread<span class="token operator">-></span><span class="token function">pop_zero_frame</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Pop our local variables</span>
  stack<span class="token operator">-></span><span class="token function">set_sp</span><span class="token punctuation">(</span>stack<span class="token operator">-></span><span class="token function">sp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> method<span class="token operator">-></span><span class="token function">max_locals</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Push our result</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> result_slots<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// Adjust result to smaller</span>
    <span class="token keyword">union</span> <span class="token punctuation">&#123;</span>
      <span class="token class-name">intptr_t</span> res<span class="token punctuation">;</span>
      jint res_jint<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    res <span class="token operator">=</span> result<span class="token punctuation">[</span><span class="token operator">-</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result_slots <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      BasicType t <span class="token operator">=</span> method<span class="token operator">-></span><span class="token function">result_type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">is_subword_type</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        res_jint <span class="token operator">=</span> <span class="token punctuation">(</span>jint<span class="token punctuation">)</span><span class="token function">narrow</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> res_jint<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    stack<span class="token operator">-></span><span class="token function">push</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="ç¼–è¯‘ä¼˜åŒ–-2"><a class="markdownIt-Anchor" href="#ç¼–è¯‘ä¼˜åŒ–-2"></a> ç¼–è¯‘ä¼˜åŒ–</h4>
<p>Javaçš„å­—èŠ‚ç é€šå¸¸æ˜¯ç”±è§£é‡Šå™¨å’Œç¼–è¯‘å™¨ç›¸äº’é…åˆæ‰§è¡Œçš„ï¼Œä¸ºäº†è®©Javaåº”ç”¨èƒ½å¤Ÿæ›´å¿«é€Ÿçš„å¯åŠ¨é€šå¸¸æ˜¯è§£é‡Šå™¨å…ˆå‘æŒ¥ä½œç”¨ï¼Œé€è¡Œè§£é‡Šå­—èŠ‚ç æŒ‡ä»¤è½¬æ¢æˆä¸ºå¯¹åº”å¹³å°çš„</p>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<blockquote>
<p>d285c6a6ba6cf1268fd57a563c42e4e07f0b53c9</p>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
</blockquote>
<hr class="footnotes-sep" />
<section class="footnotes">
<ol class="footnotes-list">
<li id="fn1" class="footnote-item"><p>CppInterpreteræ˜¯ç”¨C++å®ç°çš„å­—èŠ‚ç è§£é‡Šå™¨ï¼Œä¼˜ç‚¹æ˜¯å®ç°ç›¸å¯¹ç®€å•å®¹æ˜“ç†è§£ï¼Œç¼ºç‚¹å°±æ˜¯æ‰§è¡Œæ…¢ï¼Œæ‰€ä»¥é€šå¸¸ä¼šä½¿ç”¨TemplateInterpreterå®ç°çš„æ¨¡æ¿è§£é‡Šå™¨ï¼Œå®ƒå¯¹æ¯ä¸€ä¸ªå­—èŠ‚ç æŒ‡ä»¤éƒ½å¯¹åº”äº†ä¸€æ®µæ±‡ç¼–ä»£ç æ¥å®ç°ï¼Œå¯åŠ¨æ—¶ä¼šå¯¹å­—èŠ‚ç ä¸å¯¹åº”çš„æ±‡ç¼–ä»£ç å…¥å£åšç»‘å®šï¼Œæ•ˆç‡è¦é«˜å¾ˆå¤š<br />
<a href="https://book.douban.com/annotation/31407691/">ç¬¬232é¡µ 7.2.1 Interpreteræ¨¡å—</a> <a href="#fnref1" class="footnote-backref">â†©ï¸</a></p>
</li>
</ol>
</section>
]]></content>
      <categories>
        <category>æºç åˆ†æ</category>
        <category>hotspot</category>
      </categories>
  </entry>
  <entry>
    <title>Liunxç¼–è¯‘OpenJdk 8U</title>
    <url>/posts/09618d5b.html</url>
    <content><![CDATA[<blockquote>
<p>å¤äººå­¦é—®æ— é—åŠ›ï¼Œå°‘å£®å·¥å¤«è€å§‹æˆã€‚ çº¸ä¸Šå¾—æ¥ç»ˆè§‰æµ…ï¼Œç»çŸ¥æ­¤äº‹è¦èº¬è¡Œã€‚</p>
</blockquote>
<h2 id="èƒŒæ™¯"><a class="markdownIt-Anchor" href="#èƒŒæ™¯"></a> èƒŒæ™¯</h2>
<p>åœ¨å­¦ä¹ <code>openjdk 8u</code>æºç æ—¶ï¼Œå¯¹äº<code>CppInterpreter</code>æ ˆå¸§ä¸­å±€éƒ¨å˜é‡è¡¨çš„åˆ†é…å§‹ç»ˆç–‘æƒ‘ä¸è§£ï¼Œåªèƒ½æ¥è°ƒè¯•æºç æ¥è·å¾—ç­”æ¡ˆï¼Œå› æ­¤æœ‰äº†è¿™ç¯‡åšå®¢</p>
<p><strong>æœ¬æœºç¯å¢ƒ</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">lsb_release <span class="token parameter variable">-a</span>
	No LSB modules are available.
	Distributor ID: Ubuntu
	Description:    Ubuntu <span class="token number">22.04</span>.5 LTS
	Release:        <span class="token number">22.04</span>
	Codename:       jammy
æ¶æ„ï¼š                    x86_64
  CPU è¿è¡Œæ¨¡å¼ï¼š          <span class="token number">32</span>-bit, <span class="token number">64</span>-bit<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="æµç¨‹"><a class="markdownIt-Anchor" href="#æµç¨‹"></a> æµç¨‹</h2>
<h3 id="ä¸‹è½½-open-jdk-7u"><a class="markdownIt-Anchor" href="#ä¸‹è½½-open-jdk-7u"></a> ä¸‹è½½ open jdk 7u</h3>
<p>ç¼–è¯‘æŸä¸ªç‰ˆæœ¬çš„jdkéœ€è¦ç”¨å‰ä¸€ä¸ªç‰ˆæœ¬æ¥æŒ‡å®šä¸ºä¸º<code>bootjdk</code>ï¼Œæ‰€ä»¥ç¼–è¯‘<code>jdk8u</code>éœ€è¦ä½¿ç”¨<code>jdk7u</code>ä½œä¸º<code>bootjdk</code>æ¥ç¼–è¯‘</p>
<ul>
<li>é€šè¿‡<a href="https://www.oracle.com/java/technologies/javase/javase7-archive-downloads.html">Java Archive Downloads - Java SE 7</a>é“¾æ¥å¯ä»¥ä¸‹è½½jdk7</li>
</ul>
<p>é…ç½®ç¯å¢ƒå˜é‡ ä¿®æ”¹ <code>sudo vim /etc/profile</code></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># é…ç½®æˆä½ è‡ªå·±çš„ç›®å½•</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">JAVA_HOME</span><span class="token operator">=</span>/code/tmp/jdk1.7.0_80 
<span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span><span class="token environment constant">$PATH</span><span class="token builtin class-name">:</span><span class="token variable">$JAVA_HOME</span>/bin<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<ul>
<li>ä¸€å®šè¦é…ç½®ï¼Œå¦åˆ™ç¼–è¯‘æ—¶ä¼šæ‰¾ä¸åˆ°Javaå†…éƒ¨çš„ç›¸å…³ç±»</li>
</ul>
<h3 id="ä¸‹è½½æºç "><a class="markdownIt-Anchor" href="#ä¸‹è½½æºç "></a> ä¸‹è½½æºç </h3>
<p>æˆ‘é‡‡ç”¨çš„æ˜¯<code>jdk8u</code>ç‰ˆæœ¬çš„æºç ï¼Œä¹Ÿå¯ä»¥æ¢æˆè‡ªå·±çš„ç‰ˆæœ¬</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> clone https://github.com/openjdk/jdk8u.git<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>ä¸è¿‡ç”±äºgithubæ—¶ä¸æ—¶æ— æ³•è®¿é—®ï¼Œå¯ä»¥ä½¿ç”¨é•œåƒç«™æ¥å…‹éš†ï¼Œå¦‚æœæ— æ³•ä½¿ç”¨ï¼Œå°è¯•æœç´¢å…¶ä»–é•œåƒç«™</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> clone https://kkgithub.com/openjdk/jdk8u.git<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h4 id="ä¸‹è½½æ„å»ºå·¥å…·"><a class="markdownIt-Anchor" href="#ä¸‹è½½æ„å»ºå·¥å…·"></a> ä¸‹è½½æ„å»ºå·¥å…·</h4>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># å®‰è£…ç¼–è¯‘å™¨åŠæ„å»ºå·¥å…·</span>
<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> gcc g++ gdb <span class="token function">make</span>
<span class="token comment"># ä¸‹è½½å®‰è£…ä¾èµ–åŒ…</span>
<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> libasound2-dev libfreetype6-dev libcups2-dev libfontconfig1-dev libxext-dev libxrender-dev libxtst-dev libxt-dev<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="ç¼–è¯‘"><a class="markdownIt-Anchor" href="#ç¼–è¯‘"></a> ç¼–è¯‘</h3>
<p><strong>é…ç½®é˜¶æ®µ</strong></p>
<p>è¿›å…¥ <code>jdk8u</code>ç›®å½•ï¼Œæ‰§è¡Œ</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sh</span> ./configure <span class="token punctuation">\</span>
--with-debug-level<span class="token operator">=</span>slowdebug <span class="token punctuation">\</span>
--with-jvm-interpreter<span class="token operator">=</span>cpp <span class="token punctuation">\</span>
--with-jvm-variants<span class="token operator">=</span>zero <span class="token punctuation">\</span>
--disable-zip-debug-info <span class="token punctuation">\</span>
--with-target-bits<span class="token operator">=</span><span class="token number">64</span> <span class="token punctuation">\</span>
--with-boot-jdk<span class="token operator">=</span>/code/tmp/jdk1.7.0_80 <span class="token punctuation">\</span>
--with-freetype-include<span class="token operator">=</span>/usr/include/freetype2 <span class="token punctuation">\</span>
--with-freetype-lib<span class="token operator">=</span>/usr/lib/x86_64-linux-gnu/<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å‚æ•°å«ä¹‰</p>
<ul>
<li><code>with-debug-level</code>ï¼šè°ƒè¯•ä¿¡æ¯çº§åˆ«</li>
<li><code>with-jvm-interpreter</code>ï¼šä½¿ç”¨çš„è§£é‡Šå™¨ç±»å‹ï¼Œè¿™é‡Œä½¿ç”¨cppè§£é‡Šå™¨</li>
<li><code>with-jvm-variants</code>ï¼šæ„å»ºçš„jvmç§ç±» <code>zero</code>ä¸ä½¿ç”¨ä»»ä½•å³æ—¶ç¼–è¯‘å™¨ï¼Œåªè§£é‡Šæ‰§è¡Œä¸ç¼–è¯‘</li>
<li><code>with-target-bits</code>ï¼š64ä½</li>
<li><strong><code>with-boot-jdk</code></strong>: <strong>é‡ç‚¹</strong>ï¼Œè®¾ç½®æˆä½ è‡ªå·±jdk7çš„ç›®å½•</li>
<li>å¦å¤–ä¸¤ä¸ªå‚æ•°å›ºå®šé…ç½®ï¼Œå’Œå­—ä½“æœ‰å…³ï¼Œæ— éœ€åœ¨æ„</li>
</ul>
<blockquote>
<p>æƒ³å¯¹å‚æ•°è¿›è¡Œè°ƒæ•´ä»¥ç¼–è¯‘å…¶ä»–ç‰ˆæœ¬çš„jdkè¯·çœ‹å®˜æ–¹æ–‡æ¡£<a href="https://hg.openjdk.org/jdk8u/jdk8u/raw-file/tip/README-builds.html#make">OpenJDK Build README</a> æˆ–è€…æŸ¥çœ‹<code>jdk8u\common\autoconf\jdk-options.m4</code>æ–‡ä»¶ï¼Œéƒ½å¯¹å‚æ•°ä½œç”¨ä»¥åŠå¯å–å€¼åšäº†è¯¦ç»†ä»‹ç»</p>
</blockquote>
<p><strong>ç¼–è¯‘é˜¶æ®µ</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># éœ€è¦ä¿è¯æœ‰pythonç¯å¢ƒ</span>
<span class="token comment"># å®‰è£…pip</span>
<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> python-pip
<span class="token comment"># pipå®‰è£… compiledb</span>
<span class="token function">sudo</span> pip <span class="token function">install</span> compiledb
<span class="token comment"># æ„å»ºï¼Œå¹¶ä½¿ç”¨compiledbå·¥å…·ç”ŸæˆCompilation Database</span>
compiledb <span class="token function">make</span> all<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ç¼–è¯‘å®Œæˆå¯ä»¥è¿›å…¥ç›®å½•æ‰§è¡Œ<code>java -version</code></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> ./build/linux-x86_64-normal-zero-slowdebug/jdk/bin/

./java <span class="token parameter variable">-version</span>
<span class="token comment"># æ‰§è¡Œä¸‹é¢çš„è¾“å‡ºè¯´æ˜ç¼–è¯‘æˆåŠŸäº†</span>
openjdk version <span class="token string">"1.8.0_452-internal-debug"</span> OpenJDK Runtime Environment <span class="token punctuation">(</span>build <span class="token number">1.8</span>.0_452-internal-debug-root_2025_02_20_13_27-b00<span class="token punctuation">)</span> OpenJDK <span class="token number">64</span>-Bit Zero VM <span class="token punctuation">(</span>build <span class="token number">25.452</span>-b00-debug, interpreted mode<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="è°ƒè¯•"><a class="markdownIt-Anchor" href="#è°ƒè¯•"></a> è°ƒè¯•</h3>
<p>ä¸‹é¢æ˜¯ windows clion è¿œç¨‹è°ƒè¯• liunx ä¸Šçš„ jdk</p>
<ol>
<li>åœ¨liunxä¸Šå®‰è£… <code>gdbserver</code></li>
</ol>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> <span class="token parameter variable">-y</span> gdbserver<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ol start="2">
<li>windowsä¸Šå®‰è£… <code>mingw</code></li>
</ol>
<ul>
<li>ç‚¹å‡»é“¾æ¥ä¸‹è½½<a href="https://github.com/niXman/mingw-builds-binaries/releases">Releases Â· niXman/mingw-builds-binaries</a>,è§£å‹é…ç½®binç›®å½•çš„ç¯å¢ƒå˜é‡</li>
<li>cmd è¾“å…¥ <code>g++ --version</code> è¾“å‡ºç‰ˆæœ¬ä¿¡æ¯å³æˆåŠŸ</li>
</ul>
<img src="/posts/09618d5b/soft_version.png" class="" title="soft_version">
<p>éœ€è¦æ³¨æ„è¦ä¸‹è½½å’Œliunxä¸Šå®‰è£…çš„<code>gdbserver</code>ç›¸åŒçš„å¤§ç‰ˆæœ¬ï¼Œå¦åˆ™ä¼šå‡ºç°é—®é¢˜ï¼Œå¯é€šè¿‡<code>gdbserver --version</code>æŸ¥çœ‹ç‰ˆæœ¬ä¿¡æ¯</p>
<ol>
<li>å¼€å¯è¿œç¨‹è°ƒè¯•</li>
</ol>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">gdbserver :1234 ./build/linux-x86_64-normal-zero-slowdebug/jdk/bin//java xxx<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ol start="2">
<li>clion æ‰“å¼€jdké¡¹ç›®ï¼Œåœ¨<code>edit configurations</code>ä¸­æ·»åŠ <code>remote debug</code>ï¼Œ
<ol>
<li>è¾“å…¥  è¿œç¨‹ä¸»æœºip:port(gdbserver port)</li>
<li><strong>é…ç½®è·¯å¾„æ˜ å°„</strong>ï¼Œè¿™ä¸ªåœ°æ–¹è¸©å‘äº†ï¼Œå¿…é¡»é…ç½®ï¼Œå¦åˆ™æ— æ³•debug</li>
</ol>
</li>
</ol>
<img src="/posts/09618d5b/remote_debug.png" class="" title="remote_debug|375">
<ol>
<li>åœ¨è·Ÿè¸ªè°ƒè¯•ä¹‹å‰ï¼Œè¿˜éœ€è¦è®¾ç½® GDB å¯¹ SIGSEGV ä¿¡å·çš„å¤„ç†æ–¹å¼ï¼Œå¿½ç•¥è°ƒè¯•æ—¶çš„ SIGSEGV ä¿¡å· ï¼Œåœ¨ â€GDBâ€œ æ ‡ç­¾é¡µä¸‹çš„ â€œ(gdb)â€ å‘½ä»¤è¡Œä¸­è¾“å…¥</li>
</ol>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">handle SIGSEGV nostop noprint pass<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<blockquote>
<p>æœ¬æ–‡å‚è€ƒé“¾æ¥<br />
<a href="https://www.jianshu.com/p/feaed5853a02">OpenJDK ç¼–è¯‘è°ƒè¯•æŒ‡å—(Ubuntu 16.04 + MacOS 10.15) - ç®€ä¹¦</a><br />
<a href="https://blog.csdn.net/szm1160809039/article/details/131592828">Clionè¿œç¨‹è°ƒè¯•JDK_clionè¿œç¨‹è°ƒè¯•linux-CSDNåšå®¢</a><br />
<a href="https://blog.csdn.net/weixin_46416035/article/details/127387170">åœ¨windows11ä¸Šå®‰è£…æœ€æ–°ç‰ˆçš„gcc/g++ï¼ˆMinGWï¼‰â€“gcc version 12.2.0_æœ€æ–°ç‰ˆg+Â±CSDNåšå®¢</a></p>
</blockquote>
]]></content>
      <categories>
        <category>æºç åˆ†æ</category>
        <category>hotspot</category>
      </categories>
  </entry>
  <entry>
    <title>å­—èŠ‚ç æŒ‡ä»¤æ‰§è¡Œè¿‡ç¨‹ BytecodeInterpreter</title>
    <url>/posts/1fe4afce.html</url>
    <content><![CDATA[]]></content>
      <categories>
        <category>æºç åˆ†æ</category>
        <category>hotspot</category>
      </categories>
      <tags>
        <tag>æºç </tag>
        <tag>JVM</tag>
      </tags>
  </entry>
  <entry>
    <title>å­—èŠ‚ç è§£é‡Šå™¨ Interpreter</title>
    <url>/posts/f95e72b6.html</url>
    <content><![CDATA[<blockquote>
<p>åŠäº©æ–¹å¡˜ä¸€é‰´å¼€ï¼Œå¤©å…‰äº‘å½±å…±å¾˜å¾Šã€‚ é—®æ¸ é‚£å¾—æ¸…å¦‚è®¸ï¼Ÿä¸ºæœ‰æºå¤´æ´»æ°´æ¥ã€‚</p>
</blockquote>
<h1 id="ä»‹ç»"><a class="markdownIt-Anchor" href="#ä»‹ç»"></a> ä»‹ç»</h1>
<p>åœ¨è®¡ç®—æœºçš„ä¸–ç•Œä¸­ï¼Œå¦‚æœåˆæ— æ³•è§£å†³çš„é—®é¢˜ï¼Œé‚£ä¹ˆåªéœ€è¦åŠ ä¸€ä¸ªä¸­é—´å±‚ï¼Œæœ¬æ–‡æ‰€ä»‹ç»çš„è§£é‡Šå™¨åŒæ ·æ˜¯éµå¾ªè¿™ä¸ªæ€æƒ³<br />
å½“æˆ‘ä»¬çš„javaä»£ç é€šè¿‡ç¼–è¯‘å™¨ç¼–è¯‘æˆä¸ºå­—èŠ‚ç åï¼Œæ­¤æ—¶å°±å¯ä»¥è¢«jvmåŠ è½½åˆ°å†…å­˜ä¸­å»è§£é‡Šæ‰§è¡Œäº†ï¼Œä¸ºäº†æ”¯æŒè·¨å¹³å°ï¼ŒJVMä¼šæ ¹æ®ä¸åŒçš„ç¡¬ä»¶å¹³å°å¼€å‘ä¸€ä¸ªä¸“å±çš„è§£é‡Šå™¨ç”¨äºå°†å­—èŠ‚ç æŒ‡ä»¤ç¿»è¯‘æˆä¸ºå¯¹åº”å¹³å°çš„æœºå™¨æŒ‡ä»¤ï¼Œæˆ–è€…é‡‡ç”¨ä¸€ä¸ªé€šç”¨çš„è§£é‡Šå™¨ä½œä¸ºä¸­é—´å±‚æ¥è§£é‡Šå­—èŠ‚ç æŒ‡ä»¤ç„¶åæ‰§è¡Œå¯¹åº”çš„é€»è¾‘ã€‚</p>
<h1 id="hotspotä¸­çš„å®ç°"><a class="markdownIt-Anchor" href="#hotspotä¸­çš„å®ç°"></a> Hotspotä¸­çš„å®ç°</h1>
<h2 id="interpreter"><a class="markdownIt-Anchor" href="#interpreter"></a> Interpreter</h2>
<p><code>Hotspot</code>æ˜¯<code>jvm</code>çš„å®ç°ä¹‹ä¸€ï¼Œåœ¨<code>jdk8u</code>ä¸­çš„<code>Hotspot</code>ä¸­æœ‰ä»¥ä¸‹ä¸¤ä¸ª<code>è§£é‡Šå™¨</code></p>
<ul>
<li><code>cppInterpreter</code>ï¼šCppInterpreteræ˜¯ç”¨C<ins>å®ç°çš„å­—èŠ‚ç è§£é‡Šå™¨ï¼Œå¯¹æ¯ä¸€ä¸ªå­—èŠ‚ç æŒ‡ä»¤éƒ½ç¼–å†™äº†c</ins>æ–¹æ³•æ¥è¿›è¡Œå¤„ç†ï¼Œä¼˜ç‚¹æ˜¯å®ç°ç›¸å¯¹ç®€å•å®¹æ˜“ç†è§£ï¼Œç¼ºç‚¹å°±æ˜¯æ‰§è¡Œæ…¢</li>
<li><code>TemplateInterpreter</code>ï¼šTemplateInterpreterå®ç°çš„æ¨¡æ¿è§£é‡Šå™¨ï¼Œå®ƒå¯¹æ¯ä¸€ä¸ªå­—èŠ‚ç æŒ‡ä»¤éƒ½å¯¹åº”äº†ä¸€æ®µæ±‡ç¼–ä»£ç æ¥å®ç°ï¼Œå¯åŠ¨æ—¶ä¼šå°†å­—èŠ‚ç æŒ‡ä»¤ä¸å¯¹åº”çš„æ±‡ç¼–ä»£ç å…¥å£åšç»‘å®šï¼Œå½“æ‰§è¡Œåˆ°ä¸€æ¡å­—èŠ‚ç æŒ‡ä»¤æ—¶ä¼šè¿›å…¥å¯¹åº”çš„æ±‡ç¼–ä»£ç å…¥å£æ¥æ‰§è¡Œï¼Œå› æ­¤æ•ˆç‡è¦é«˜å¾ˆå¤šï¼Œä¹Ÿæ˜¯<code>Hotspot</code>ä¸­é»˜è®¤ä½¿ç”¨åˆ°çš„</li>
</ul>
<blockquote>
<p>å¯ä»¥çœ‹æœ¬æ–‡ç« äº†è§£è§£é‡Šå™¨çš„å‘å±•å†ç¨‹ <a href="https://book.douban.com/annotation/31407691/">ç¬¬232é¡µ 7.2.1 Interpreteræ¨¡å—</a><br />
äº†è§£ç¼–è¯‘jdkæ—¶å¦‚ä½•é€šè¿‡å‚æ•°æŒ‡å®šä½¿ç”¨å“ªä¸ªè§£é‡Šå™¨å¯ä»¥å‚è€ƒ<a  href="/posts/09618d5b.html">Liunxç¼–è¯‘OpenJdk 8U</a></p>
</blockquote>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// é€šè¿‡å®å®šä¹‰æ¥è®©Interpreteræ˜¯ç»§æ‰¿CppInterpreterè¿˜æ˜¯TemplateInterpreterï¼Œä»è€Œæ¥å¯ç”¨å¯¹åº”çš„è§£é‡Šå™¨</span>
class Interpreter<span class="token operator">:</span> public <span class="token function">CC_INTERP_ONLY</span><span class="token punctuation">(</span>CppInterpreter<span class="token punctuation">)</span> <span class="token function">NOT_CC_INTERP</span><span class="token punctuation">(</span>TemplateInterpreter<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>åœ¨ä»‹ç»ä¸­æˆ‘ä»¬æåˆ°å› ä¸ºæœ‰äº†è§£é‡Šå™¨javaå­—èŠ‚ç æ‰èƒ½è·¨å¹³å°è¿è¡Œï¼Œé‚£ä¹ˆæ˜¯å¦‚ä½•è·¨å¹³å°æ‰§è¡Œçš„å‘¢ï¼Ÿç­”æ¡ˆå°±æ˜¯ä¸ºæ¯ä¸ªç¡¬ä»¶æ¶æ„åšé€‚é…ï¼Œå¯¹å°±æ˜¯è¿™ä¹ˆç®€å•ï¼Œ<code>Hotspot</code>åŸºäºè¿™ä¸¤ç§è§£é‡Šå™¨éƒ½æä¾›äº†ä»¥ä¸‹å¹³å°çš„æ±‡ç¼–ä»£ç å®ç°</p>
<ul>
<li><code>sparc</code>ï¼šSPARCï¼ˆScalable Processor Architectureï¼‰æ˜¯ä¸€ç§ RISC æ¶æ„ï¼Œç”± Sun Microsystems å¼€å‘ã€‚å®ƒä»¥å…¶é«˜æ€§èƒ½ã€å¯æ‰©å±•æ€§å’Œå¯é æ€§è€Œé—»åï¼Œæ›¾ç»å¹¿æ³›åº”ç”¨äºæœåŠ¡å™¨å’Œå·¥ä½œç«™é¢†åŸŸ</li>
<li><code>aarch64</code>ï¼šAArch64 æ˜¯ ARM æ¶æ„çš„ 64 ä½æ‰§è¡ŒçŠ¶æ€ï¼Œæ˜¯ ARMv8 æ¶æ„å¼•å…¥çš„æ–°ç‰¹æ€§ã€‚å®ƒåœ¨ ARM å¤„ç†å™¨çš„å‘å±•å†ç¨‹ä¸­å…·æœ‰é‡è¦æ„ä¹‰ï¼Œä¸ºç§»åŠ¨è®¾å¤‡ã€åµŒå…¥å¼ç³»ç»Ÿä»¥åŠæœåŠ¡å™¨å¸‚åœºå¸¦æ¥äº† 64 ä½è®¡ç®—èƒ½åŠ›ã€‚</li>
<li><code>ppc</code>ï¼šPowerPC æ˜¯ä¸€ç§ç²¾ç®€æŒ‡ä»¤é›†è®¡ç®—æœºï¼ˆRISCï¼‰æ¶æ„ï¼Œç”± IBMã€è‹¹æœå’Œæ‘©æ‰˜ç½—æ‹‰ï¼ˆç° NXP åŠå¯¼ä½“ï¼‰è”åˆå¼€å‘ã€‚</li>
<li><code>x86</code>ï¼šx86 æ˜¯è‹±ç‰¹å°”å…¬å¸å¼€å‘çš„ä¸€ç³»åˆ—å¤æ‚æŒ‡ä»¤é›†è®¡ç®—æœºï¼ˆCISCï¼‰æ¶æ„ï¼Œæ˜¯ç›®å‰ä¸ªäººè®¡ç®—æœºå’ŒæœåŠ¡å™¨å¸‚åœºä¸­æœ€ä¸»æµçš„æ¶æ„ä¹‹ä¸€
<ul>
<li><code>x86_32</code>ï¼šæ”¯æŒ32ä½å¯»å€</li>
<li><code>x86_64</code>ï¼šæ”¯æŒ64ä½å¯»å€</li>
</ul>
</li>
<li><code>zero</code>ï¼š é›¶æ±‡ç¼–æ¶æ„ï¼ŒæŒ‡åœ¨ä¸ä¾èµ–ä»»ä½•æ¶æ„å¹³å°å°±å¯ä»¥è§£é‡Šå¹¶æ‰§è¡Œå­—èŠ‚ç æŒ‡ä»¤</li>
</ul>
<p>åœ¨ç¼–è¯‘jdkæ—¶å¯ä»¥é€šè¿‡<code>--with-jvm-variants</code>æ¥æ„å»ºæŒ‡å®šæ¶æ„çš„jdkï¼ˆæœ¬æ–‡ä¹Ÿä¸»è¦zeroæ¶æ„åšè¯´æ˜ï¼Œå…¶å®ƒåŸºäºæ±‡ç¼–çš„æ™¦æ¶©éš¾æ‡‚ï¼Œæœ‰å…´è¶£çš„è‡ªå·±å¯ä»¥äº†è§£ï¼‰</p>
<p>src/share/vm/interpreter/interpreter.hpp</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">class InterpreterCodelet<span class="token operator">:</span> public Stub <span class="token punctuation">&#123;</span>
<span class="token comment">// .... çœç•¥äº†ä»£ç </span>
<span class="token punctuation">&#125;</span>
class CodeletMark<span class="token operator">:</span> ResourceMark <span class="token punctuation">&#123;</span><span class="token comment">//...</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// é€šè¿‡å®å®šä¹‰æ¥è®©Interpreteræ˜¯ç»§æ‰¿CppInterpreterè¿˜æ˜¯TemplateInterpreterï¼Œä»è€Œæ¥å¯ç”¨å¯¹åº”çš„è§£é‡Šå™¨</span>
class Interpreter<span class="token operator">:</span> public <span class="token function">CC_INTERP_ONLY</span><span class="token punctuation">(</span>CppInterpreter<span class="token punctuation">)</span><span class="token function">NOT_CC_INTERP</span><span class="token punctuation">(</span>TemplateInterpreter<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  public<span class="token operator">:</span>
  <span class="token comment">// Debugging/printing</span>
  <span class="token keyword">static</span> InterpreterCodelet<span class="token operator">*</span> <span class="token function">codelet_containing</span><span class="token punctuation">(</span>address pc<span class="token punctuation">)</span>     <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> <span class="token punctuation">(</span>InterpreterCodelet<span class="token operator">*</span><span class="token punctuation">)</span>_code<span class="token operator">-></span><span class="token function">stub_containing</span><span class="token punctuation">(</span>pc<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
  
<span class="token comment">// é€šè¿‡æ¡ä»¶ç¼–è¯‘å°†æŒ‡å®šæ¶æ„çš„ä»£ç æ’å…¥è¿›æ¥</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">TARGET_ARCH_x86</span></span>
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">include</span> <span class="token string">"interpreter_x86.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">TARGET_ARCH_aarch64</span></span>
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">include</span> <span class="token string">"interpreter_aarch64.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">TARGET_ARCH_sparc</span></span>
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">include</span> <span class="token string">"interpreter_sparc.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">TARGET_ARCH_zero  </span><span class="token comment">// æœ¬æ–‡é’ˆå¯¹è¯¥æ¶æ„æ‰€ç¼–å†™</span></span>
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">include</span> <span class="token string">"interpreter_zero.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">TARGET_ARCH_arm</span></span>
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">include</span> <span class="token string">"interpreter_arm.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">TARGET_ARCH_ppc</span></span>
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">include</span> <span class="token string">"interpreter_ppc.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>interpreter</code>å¤´æ–‡ä»¶åªå®šä¹‰äº†ä¸€äº›é¡¶å±‚è®¾è®¡çš„ç±»æˆ–è€…æ¥å£ï¼Œä½†æœ€ä¸»è¦çš„æ˜¯ä¸¤ç‚¹</p>
<ul>
<li>é€šè¿‡å®æ¥åˆ¤æ–­è§£é‡Šå™¨æ˜¯ç»§æ‰¿<code>CppInterpreter</code>è¿˜æ˜¯<code>TemplateInterpreter</code></li>
<li>å®šä¹‰äº†æ¡ä»¶ç¼–è¯‘ï¼Œå°†ç¬¦åˆæ¶æ„æ¡ä»¶çš„ä»£ç åœ¨ç¼–è¯‘æ—¶æ’å…¥è¿›æ¥</li>
</ul>
<p>ä¸Šé¢ä¸¤ä¸ªè§£é‡Šå™¨çš„å®ç°éƒ½æ˜¯ç»§æ‰¿è‡ª <code>AbstractInterpreter</code>ï¼Œè€Œ<code>AbstractInterpreter</code>ä¸­æ‰æ˜¯é‡ç‚¹</p>
<h2 id="abstractinterpreter"><a class="markdownIt-Anchor" href="#abstractinterpreter"></a> AbstractInterpreter</h2>
<p>hotspot/src/share/vm/interpreter/abstractInterpreter.hpp</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// The C++ interface to the bytecode interpreter(s).  </span>
class AbstractInterpreter<span class="token operator">:</span> AllStatic <span class="token punctuation">&#123;</span>  
  friend class VMStructs<span class="token punctuation">;</span>  
  friend class Interpreter<span class="token punctuation">;</span>  
  friend class CppInterpreterGenerator<span class="token punctuation">;</span>  
 public<span class="token operator">:</span>  
  <span class="token keyword">enum</span> <span class="token class-name">MethodKind</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// æ–¹æ³•åˆ†ç±»,æ­¤å¤„ä¸ºäº†æ§åˆ¶ä»£ç é•¿åº¦åªä¿ç•™äº†å¸¸è§çš„å‡ ç§</span>
    zerolocals<span class="token punctuation">,</span> <span class="token comment">// éœ€è¦å±€éƒ¨å˜é‡è¡¨åˆå§‹åŒ–çš„æ™®é€šæ–¹æ³• method needs locals initialization  </span>
    zerolocals_synchronized<span class="token punctuation">,</span> <span class="token comment">// éœ€è¦å±€éƒ¨å˜é‡è¡¨åˆå§‹åŒ–çš„æ™®é€šåŒæ­¥æ–¹æ³•</span>
    number_of_method_entries
  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  
  
 protected<span class="token operator">:</span>  
  <span class="token keyword">static</span> StubQueue<span class="token operator">*</span> _code<span class="token punctuation">;</span> <span class="token comment">// è§£é‡Šå™¨åˆå§‹åŒ–æ˜¯ä¼šä¸ºæ­¤èµ‹å€¼ï¼Œä½†æˆ‘ç†è§£ä½œç”¨æ˜¯ä»€ä¹ˆ :( // the interpreter code (codelets)  </span>
  
  <span class="token comment">// method entry points  </span>
  <span class="token keyword">static</span> address    _entry_table<span class="token punctuation">[</span>number_of_method_entries<span class="token punctuation">]</span><span class="token punctuation">;</span>     <span class="token comment">// javaæ‰€æœ‰åˆ†ç±»çš„æ–¹æ³•å¯¹åº”çš„ entryPoint æ•°ç»„,é€šè¿‡MethodKindå³å¯æ‰¾åˆ°å¯¹åº”çš„è¿›å…¥ç‚¹  </span>
  
  friend class      AbstractInterpreterGenerator<span class="token punctuation">;</span>  <span class="token comment">// è´Ÿè´£ç”ŸæˆStubä»¥åŠæ–¹æ³•è¿›å…¥ç‚¹ entryPoint</span>
  friend class              InterpreterGenerator<span class="token punctuation">;</span> 
  
 public<span class="token operator">:</span>  
  <span class="token comment">// Initialization/debugging  </span>
  <span class="token keyword">static</span> <span class="token keyword">void</span>       <span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// åˆå§‹åŒ–æ–¹æ³•ï¼Œcreate_vmæ—¶ä¼šè¢«è°ƒç”¨</span>
  
  <span class="token comment">// æ ¹æ®æ–¹æ³•çš„å…ƒæ•°æ®è¿”å›å®ƒçš„æ‰€å±åˆ†ç±» MethodKind</span>
  <span class="token keyword">static</span> MethodKind <span class="token function">method_kind</span><span class="token punctuation">(</span>methodHandle m<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// æ ¹æ®æ–¹æ³•åˆ†ç±»MethodKindè¿”å›å¯¹åº”çš„EntryPointåœ°å€  </span>
  <span class="token keyword">static</span> address    <span class="token function">entry_for_kind</span><span class="token punctuation">(</span>MethodKind k<span class="token punctuation">)</span>                <span class="token punctuation">&#123;</span> <span class="token function">assert</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">&lt;=</span> k <span class="token operator">&amp;&amp;</span> k <span class="token operator">&lt;</span> number_of_method_entries<span class="token punctuation">,</span> <span class="token string">"illegal kind"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> _entry_table<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>  
  <span class="token comment">// æ ¹æ®æ–¹æ³•æ‰¾åˆ°å¯¹åº”çš„å…¥å£ç‚¹ </span>
  <span class="token comment">// ** æ³¨æ„: å½“ç±»è¢«åŠ è½½åç¬¬ä¸€æ¬¡é“¾æ¥æ˜¯ä¼šéå†æ–¹æ³•åˆ—è¡¨å¹¶æ‰§è¡Œ method->link_method() æ–¹æ³•ï¼Œå†…éƒ¨å°±ä¼šè°ƒç”¨æ­¤æ–¹æ³•è·å–å¹¶ç»‘å®šå¯¹åº”çš„EntryPoint **</span>
  <span class="token keyword">static</span> address    <span class="token function">entry_for_method</span><span class="token punctuation">(</span>methodHandle m<span class="token punctuation">)</span>            <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> <span class="token function">entry_for_kind</span><span class="token punctuation">(</span><span class="token function">method_kind</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>  
  
  <span class="token comment">// åŠ¨æ€ç”Ÿæˆæ–¹æ³•å…¥å£ç‚¹ï¼ŒåŠ¨æ€è¯­è¨€ä½¿ç”¨</span>
  <span class="token comment">// å·²è¢«ç¦ç”¨, é€šè¿‡å‚æ•°-XX:+UnlockDiagnosticVMOptions -XX:+EnableInvokeDynamicå¼€å¯</span>
  <span class="token keyword">static</span> <span class="token keyword">void</span>       <span class="token function">set_entry_for_kind</span><span class="token punctuation">(</span>MethodKind k<span class="token punctuation">,</span> address e<span class="token punctuation">)</span><span class="token punctuation">;</span>  
  <span class="token comment">// Runtime support  </span>
  <span class="token comment">// length = invoke bytecode length (to advance to next bytecode)  static address deopt_entry(TosState state, int length) &#123; ShouldNotReachHere(); return NULL; &#125; </span>
  <span class="token comment">// æ¨¡æ¿è§£é‡Šå™¨ä¼šä½¿ç”¨æ­¤æ–¹æ³•ï¼Œå½“æ‰§è¡Œreturnè¯­å¥æ—¶ä¼šè¿›å…¥å¤„ç† </span>
  <span class="token keyword">static</span> address <span class="token function">return_entry</span><span class="token punctuation">(</span>TosState state<span class="token punctuation">,</span> <span class="token keyword">int</span> length<span class="token punctuation">,</span> Bytecodes<span class="token operator">::</span>Code code<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token function">ShouldNotReachHere</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>  
  
  <span class="token keyword">static</span> address    <span class="token function">rethrow_exception_entry</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                   <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> _rethrow_exception_entry<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span> 
<span class="token comment">//------------------------------------------------------------------------------------------------------------------------  </span>
<span class="token comment">// The interpreter generator.  </span>
  
class Template<span class="token punctuation">;</span>  
class AbstractInterpreterGenerator<span class="token operator">:</span> public StackObj <span class="token punctuation">&#123;</span>  
 protected<span class="token operator">:</span>  
  InterpreterMacroAssembler<span class="token operator">*</span> _masm<span class="token punctuation">;</span>  
  
  <span class="token comment">// shared code sequences  </span>
  <span class="token comment">// Converter for native abi result to tosca result  address generate_result_handler_for(BasicType type);  </span>
  address <span class="token function">generate_slow_signature_handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
  
  <span class="token comment">// æ ¹æ®MethodKindç”Ÿæˆå¯¹åº”çš„ EntryPoint  </span>
  address <span class="token function">generate_method_entry</span><span class="token punctuation">(</span>AbstractInterpreter<span class="token operator">::</span>MethodKind kind<span class="token punctuation">)</span><span class="token punctuation">;</span>  
  
  <span class="token keyword">void</span> <span class="token function">bang_stack_shadow_pages</span><span class="token punctuation">(</span>bool native_call<span class="token punctuation">)</span><span class="token punctuation">;</span>  
  
  <span class="token keyword">void</span> <span class="token function">generate_all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
  <span class="token keyword">void</span> <span class="token function">initialize_method_handle_entries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
  
 public<span class="token operator">:</span>  
  <span class="token function">AbstractInterpreterGenerator</span><span class="token punctuation">(</span>StubQueue<span class="token operator">*</span> _code<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä¸Šé¢å±•ç¤ºå¾—æºç ç»è¿‡åˆ å‡ï¼ŒAbstractInterpreterä¸»è¦å°±æ˜¯å®šä¹‰äº†å¦‚ä¸‹å‡ ä¸ªé‡è¦çš„æ–¹æ³•å’Œç±»ä»¥åŠå±æ€§</p>
<ul>
<li><code>MethodKind</code>ï¼šè¡¨ç¤ºæ–¹æ³•çš„ç±»å‹ï¼Œæ¯ç§ç±»å‹çš„æ–¹æ³•æœ‰å¯¹åº”<code>EntryPoint</code></li>
<li><code>_entry_table</code>ï¼šæ–¹æ³•<code>EntryPoint</code>è¡¨ï¼Œç”¨äºå­˜å‚¨<code>MethodKind</code>å¯¹åº”çš„<code>EntryPoint</code></li>
<li><code>initialize()</code>ï¼šåœ¨åˆ›å»ºè™šæ‹Ÿæœºæ—¶ä¼šåˆå§‹åŒ–è§£é‡Šå™¨ï¼Œå…¶ä¸­å°±ä¼šæ‰§è¡Œè¯¥æ–¹æ³•</li>
<li><code>entry_for_method(methodHandle m)</code>ï¼šæ ¹æ®æ–¹æ³•å¯¹è±¡è¿”å›å¯¹åº”çš„<code>EntryPoint</code>åœ°å€</li>
<li><code>AbstractInterpreterGenerator</code>
<ul>
<li><code>generate_method_entry</code>ï¼šæ ¹æ®<code>MethodKind</code>ç”Ÿæˆå¯¹åº”çš„<code>EntryPoint</code></li>
<li><code>generate_all()</code>ï¼šç”Ÿæˆæ‰€æœ‰æ–¹æ³•ç±»å‹çš„<code>EntryPoint</code>ï¼Œ<strong>å¹¶å°†å…¶ä¿å­˜åˆ°<code>_entry_table</code>å±æ€§ä¸­</strong></li>
</ul>
</li>
</ul>
<p>AbstractInterpreteræ‰æ˜¯ä¸»è¦çš„å‡½æ•°å®šä¹‰æ¥å£ï¼Œç”±<code>CppInterpreter</code>å’Œ<code>TemplateInterpreter</code>æ¥å®ç°ï¼Œä¸Šé¢æˆ‘ä»¬è¯´åˆ°åœ¨åˆ›å»ºè™šæ‹Ÿæœºæ—¶ä¼šå¯¹è§£é‡Šå™¨è¿›è¡Œåˆå§‹åŒ–ï¼Œåœ¨åˆå§‹åŒ–çš„å‡½æ•°ä¸­å°±ä¼šæ‰§è¡Œå®ƒçš„<code>initialize</code>æ–¹æ³•ï¼Œæ¥ç€å°±è®©æˆ‘ä»¬å‘ä¸‹çœ‹ä¸¤ä¸ªè§£é‡Šå™¨çš„å®ç°å¯¹<code>initialize</code>æ–¹æ³•æ˜¯å¦‚ä½•å¤„ç†çš„å§</p>
<blockquote>
<p>åœ¨æ­¤ä¹‹å‰å¯ä»¥çœ‹ä¸‹ create_vm çš„æ•´ä½“æµç¨‹æ˜¯å¦‚ä½•è°ƒç”¨ <code>initialize</code>æ–¹æ³•çš„</p>
</blockquote>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// src/share/vm/runtime/thread.cpp</span>
jint Threads<span class="token operator">::</span><span class="token function">create_vm</span><span class="token punctuation">(</span>JavaVMInitArgs<span class="token operator">*</span> args<span class="token punctuation">,</span> bool<span class="token operator">*</span> canTryAgain<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">// ...</span>
<span class="token function">init_globals</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">//...</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// hotspot/src/share/vm/runtime/init.cpp</span>
jint <span class="token function">init_globals</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">// ...</span>
<span class="token function">interpreter_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// before any methods loaded</span>
<span class="token comment">// ...</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// hotspot/src/share/vm/interpreter/interpreter.cpp</span>
<span class="token keyword">void</span> <span class="token function">interpreter_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  
  Interpreter<span class="token operator">::</span><span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// è°ƒç”¨ è§£é‡Šå™¨çš„ initialize()</span>
	<span class="token comment">// ... </span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="cppinterpreter"><a class="markdownIt-Anchor" href="#cppinterpreter"></a> CppInterpreter</h3>
<img src="/posts/f95e72b6/%E8%A7%A3%E9%87%8A%E5%99%A8initialize%E6%96%B9%E6%B3%95%E8%B0%83%E7%94%A8%E6%B5%81%E7%A8%8B.png" class="" title="è§£é‡Šå™¨initializeæ–¹æ³•è°ƒç”¨æµç¨‹">
<p>ä¸Šé¢å·²ç»ä»‹ç»äº†<code>CppInterpreter</code>çš„å®šä¹‰ï¼Œè¿™é‡Œå°±ä¸å†å¤šè¯´ï¼Œç›´æ¥çœ‹<code>CppInterpreter.hpp</code>ä»£ç ä¸­å®šä¹‰äº†ä»€ä¹ˆ</p>
<p>hotspot/src/share/vm/interpreter/cppInterpreter.hpp</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// This file contains the platform-independent parts  </span>
<span class="token comment">// of the c++ interpreter  </span>
<span class="token comment">// ç»§æ‰¿AbstractInterpreter</span>
class CppInterpreter<span class="token operator">:</span> public AbstractInterpreter <span class="token punctuation">&#123;</span>  
  friend class VMStructs<span class="token punctuation">;</span>  friend class Interpreter<span class="token punctuation">;</span> <span class="token comment">// contains()  </span>
  friend class InterpreterGenerator<span class="token punctuation">;</span> <span class="token comment">// result handlers  </span>
  friend class CppInterpreterGenerator<span class="token punctuation">;</span> <span class="token comment">// result handlers  </span>
 public<span class="token operator">:</span>  
  
 public<span class="token operator">:</span>  <span class="token comment">// Initialization/debugging  </span>
  <span class="token keyword">static</span> <span class="token keyword">void</span>       <span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// </span>
  <span class="token comment">// this only returns whether a pc is within generated code for the interpreter.  </span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">TARGET_ARCH_x86  </span></span>
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">include</span> <span class="token string">"cppInterpreter_x86.hpp"</span>  </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span>  </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">TARGET_ARCH_aarch64  </span></span>
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">include</span> <span class="token string">"cppInterpreter_aarch64.hpp"</span>  </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span>  </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">TARGET_ARCH_sparc  </span></span>
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">include</span> <span class="token string">"cppInterpreter_sparc.hpp"</span>  </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span>  </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">TARGET_ARCH_zero  </span></span>
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">include</span> <span class="token string">"cppInterpreter_zero.hpp"</span>  </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span>  </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">TARGET_ARCH_arm  </span></span>
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">include</span> <span class="token string">"cppInterpreter_arm.hpp"</span>  </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span>  </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">TARGET_ARCH_ppc  </span></span>
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">include</span> <span class="token string">"cppInterpreter_ppc.hpp"</span>  </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span>  </span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å¯ä»¥çœ‹åˆ°<code>CppInterpreter</code>ç»§æ‰¿äº†<code>AbstractInterpreter</code>ï¼Œå…¶ä»–å°±ä¸»è¦æ˜¯å£°æ˜äº†ä¸€äº›æ–¹æ³•ï¼Œä¸è¿‡æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„ï¼Œå°±æ˜¯å¢åŠ äº†æ¡ä»¶ç¼–è¯‘ï¼Œè¿™é‡Œæˆ‘ä»¬é€‰æ‹©çš„æ˜¯zeroæ¶æ„ï¼Œæ‰€ä»¥ä¼šå°†<code>cppInterpreter_zero.hpp</code>ä»£ç ç»™æ’å…¥è¿›æ¥ï¼Œæ­¤å¤„éœ€ç•™æ„åé¢ä¼šè¯´åˆ°è¿™é‡Œï¼Œå…ˆæ¥ç€å¾€ä¸‹çœ‹å®ƒçš„å®ç°ä»£ç </p>
<p>hotspot/src/share/vm/interpreter/cppInterpreter.cpp</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">define</span> <span class="token macro-name">__</span> <span class="token expression">_masm<span class="token operator">-></span> </span></span>
<span class="token keyword">void</span> CppInterpreter<span class="token operator">::</span><span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>_code <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
  AbstractInterpreter<span class="token operator">::</span><span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// generate interpreter</span>
  <span class="token punctuation">&#123;</span> ResourceMark rm<span class="token punctuation">;</span>
    TraceTime <span class="token function">timer</span><span class="token punctuation">(</span><span class="token string">"Interpreter generation"</span><span class="token punctuation">,</span> TraceStartupTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> code_size <span class="token operator">=</span> InterpreterCodeSize<span class="token punctuation">;</span>
    <span class="token function">NOT_PRODUCT</span><span class="token punctuation">(</span>code_size <span class="token operator">*=</span> <span class="token number">4</span><span class="token punctuation">;</span><span class="token punctuation">)</span>  <span class="token comment">// debug uses extra interpreter code space</span>
    _code <span class="token operator">=</span> new <span class="token function">StubQueue</span><span class="token punctuation">(</span>new InterpreterCodeletInterface<span class="token punctuation">,</span> code_size<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>
                          <span class="token string">"Interpreter"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    InterpreterGenerator <span class="token function">g</span><span class="token punctuation">(</span>_code<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>PrintInterpreter<span class="token punctuation">)</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token comment">// Allow c++ interpreter to do one initialization now that switches are set, etc.</span>
  BytecodeInterpreter <span class="token function">start_msg</span><span class="token punctuation">(</span>BytecodeInterpreter<span class="token operator">::</span>initialize<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>JvmtiExport<span class="token operator">::</span><span class="token function">can_post_interpreter_events</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    BytecodeInterpreter<span class="token operator">::</span><span class="token function">runWithChecks</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>start_msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span>
    BytecodeInterpreter<span class="token operator">::</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>start_msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

CppInterpreterGenerator<span class="token operator">::</span><span class="token function">CppInterpreterGenerator</span><span class="token punctuation">(</span>StubQueue<span class="token operator">*</span> _code<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token function">AbstractInterpreterGenerator</span><span class="token punctuation">(</span>_code<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> CppInterpreterGenerator<span class="token operator">::</span><span class="token function">generate_all</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  AbstractInterpreterGenerator<span class="token operator">::</span><span class="token function">generate_all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#123;</span>
<span class="token comment">// å®å®šä¹‰method_entryæ–¹æ³• </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">method_entry</span><span class="token expression"><span class="token punctuation">(</span>kind<span class="token punctuation">)</span> Interpreter<span class="token operator">::</span>_entry_table<span class="token punctuation">[</span>Interpreter<span class="token operator">::</span>kind<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">generate_method_entry</span><span class="token punctuation">(</span>Interpreter<span class="token operator">::</span>kind<span class="token punctuation">)</span></span></span>
  <span class="token punctuation">&#123;</span> CodeletMark <span class="token function">cm</span><span class="token punctuation">(</span>_masm<span class="token punctuation">,</span> <span class="token string">"(kind = frame_manager)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// all non-native method kinds</span>
    <span class="token comment">// è°ƒç”¨ä¸Šé¢çš„å®</span>
    <span class="token function">method_entry</span><span class="token punctuation">(</span>zerolocals<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">method_entry</span><span class="token punctuation">(</span>zerolocals_synchronized<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">method_entry</span><span class="token punctuation">(</span>empty<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">method_entry</span><span class="token punctuation">(</span>accessor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">method_entry</span><span class="token punctuation">(</span>abstract<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ... çœç•¥å…¶ä»– method_entry(MethodKind)çš„è°ƒç”¨</span>
    <span class="token comment">// æ¨¡æ¿æ–¹æ³•ï¼Œç•™ç»™æ¡ä»¶ç¼–è¯‘çš„æ–‡ä»¶ä»£ç å®ç°</span>
    <span class="token function">initialize_method_handle_entries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">undef</span> <span class="token expression">method_entry</span></span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><code>initialize()</code>ï¼šä¸»è¦åšäº†ä¸¤ä»¶äº‹æƒ…
<ul>
<li>å®šä¹‰å¹¶åˆå§‹åŒ–<code>InterpreterGenerator g(_code)</code>å¯¹è±¡ï¼Œ</li>
<li>å®šä¹‰å¹¶åˆå§‹åŒ–<code>BytecodeInterpreter start_msg(BytecodeInterpreter::initialize)</code>å¯¹è±¡ï¼Œç„¶åæ‰§è¡Œ<code>BytecodeInterpreter::run(&amp;start_msg)</code>æ–¹æ³•
<ul>
<li><code>BytecodeInterpreter</code> å­—èŠ‚ç è§£é‡Šå™¨ï¼Œé¡¾åæ€ä¹‰ï¼Œå®ƒæ˜¯æœ€ç»ˆå¯¹å­—èŠ‚ç æŒ‡ä»¤è§£é‡Šæ‰§è¡Œçš„è§£é‡Šå™¨</li>
</ul>
</li>
</ul>
</li>
<li><code>generate_all</code>ï¼šè¯¥æ–¹æ³•é¦–å…ˆå®šä¹‰äº†ä¸€ä¸ª<code>method_entry</code>å®ï¼Œåœ¨å®ä¸­ä¼šè°ƒç”¨<code>generate_method_entry</code>æ–¹æ³•å¹¶ä¼ å…¥<code>MethodKind</code>å‚æ•°ï¼Œ<code>generate_method_entry</code>æ–¹æ³•ä¼šè¿”å›å¯¹åº”çš„<code>EntryPoint</code>åœ°å€ï¼Œæ¥ç€ä»¥<code>kind</code>å‚æ•°ä¸ºç´¢å¼•ä¿å­˜åˆ°<code>_entry_table</code>æ•°ç»„å±æ€§ä¸­ï¼Œæœ€åè°ƒç”¨<code>initialize_method_handle_entries()</code>æ–¹æ³•</li>
</ul>
<p>å¯ä»¥çœ‹åˆ°<code>CppInterpreter</code>ä¸­å¹¶æœªå®ç°<code>generate_method_entry</code>å’Œ<code>initialize_method_handle_entries</code>ä¸¤ä¸ªæ–¹æ³•ï¼Œè€Œä¸”<code>generate_all</code>æ–¹æ³•æ²¡æœ‰è¢«è°ƒç”¨ï¼Œæ˜¯ä¸æ˜¯æœ‰ç‚¹çº³é—·ï¼Œä¸‹é¢é©¬ä¸Šå°±ä¼šè§£ç­”ï¼Œè¿˜è®°å¾—æˆ‘ä»¬åœ¨çœ‹åˆ°<code>CppInterpreter.hpp</code>æ–‡ä»¶å®šä¹‰äº†<code>æ¡ä»¶ç¼–è¯‘</code>çš„ä»£ç å—ï¼Ÿç”±äºè¿™é‡Œæˆ‘ä»¬æŸ¥çœ‹çš„æ˜¯<code>zero</code>æ¶æ„çš„ä»£ç ï¼Œæ‰€ä»¥ä¼šæ’å…¥<code>CppInterpreter_zero.cpp</code>çš„ä»£ç åˆ°<code>CppInterpreter</code>ä¸­ï¼Œæ‰€ä»¥ä¸¤ä¸ªè°œåº•åœ¨è¯¥ç±»ä¸­å¯ä»¥æ­æ™“</p>
<ol>
<li>initialize() ä¸ºä»€ä¹ˆæ²¡æœ‰è°ƒç”¨ <code>generate_all</code>æ–¹æ³•</li>
<li>generate_method_entry å’Œ initialize_method_handle_entries æ–¹æ³•çš„å®ç°æ˜¯ä»€ä¹ˆ</li>
</ol>
<p>è®©æˆ‘ä»¬å¸¦ç€é—®é¢˜çœ‹ä¸‹é¢çš„ä»£ç ä»¥åŠè§£é‡Š</p>
<h4 id="cppinterpreter_zero"><a class="markdownIt-Anchor" href="#cppinterpreter_zero"></a> CppInterpreter_zero</h4>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// CppInterpreterä¸­generate_allæ–¹æ³•è°ƒç”¨çš„generate_method_entryä¾¿æ˜¯è¿™é‡Œå®ç°</span>
address AbstractInterpreterGenerator<span class="token operator">::</span><span class="token function">generate_method_entry</span><span class="token punctuation">(</span>
    AbstractInterpreter<span class="token operator">::</span>MethodKind kind<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  address entry_point <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

  <span class="token keyword">switch</span> <span class="token punctuation">(</span>kind<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">case</span> Interpreter<span class="token operator">::</span>zerolocals<span class="token operator">:</span>
  <span class="token keyword">case</span> Interpreter<span class="token operator">::</span>zerolocals_synchronized<span class="token operator">:</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token comment">// åˆ é™¤äº†å¾ˆå¤šcaseï¼Œjvmä¼šå¯¹Mathç±»çš„è®¡ç®—æ–¹æ³•åšç‰¹æ®Šå†…è”çš„å¤„ç†</span>
  <span class="token keyword">case</span> Interpreter<span class="token operator">::</span>java_lang_math_sin<span class="token operator">:</span>
  <span class="token keyword">case</span> Interpreter<span class="token operator">::</span>java_lang_math_cos<span class="token operator">:</span>
  <span class="token keyword">case</span> Interpreter<span class="token operator">::</span>java_lang_math_tan<span class="token operator">:</span>
  <span class="token keyword">case</span> Interpreter<span class="token operator">::</span>java_lang_math_abs<span class="token operator">:</span>
  <span class="token keyword">case</span> Interpreter<span class="token operator">::</span>java_lang_math_log<span class="token operator">:</span>
  <span class="token keyword">case</span> Interpreter<span class="token operator">::</span>java_lang_math_log10<span class="token operator">:</span>
  <span class="token keyword">case</span> Interpreter<span class="token operator">::</span>java_lang_math_sqrt<span class="token operator">:</span>
  <span class="token keyword">case</span> Interpreter<span class="token operator">::</span>java_lang_math_pow<span class="token operator">:</span>
  <span class="token keyword">case</span> Interpreter<span class="token operator">::</span>java_lang_math_exp<span class="token operator">:</span>
    entry_point <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>InterpreterGenerator<span class="token operator">*</span><span class="token punctuation">)</span> this<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">generate_math_entry</span><span class="token punctuation">(</span>kind<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token keyword">default</span><span class="token operator">:</span>
    <span class="token function">ShouldNotReachHere</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>entry_point <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
	<span class="token comment">// zerolocals å’Œ zerolocals_synchronized ä¼šè¿›å…¥è¿™é‡Œï¼Œä½¿ç”¨generate_normal_entryæ–¹æ³•ç”Ÿæˆ EntryPoint</span>
    entry_point <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>InterpreterGenerator<span class="token operator">*</span><span class="token punctuation">)</span> this<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">generate_normal_entry</span><span class="token punctuation">(</span>false<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> entry_point<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

address InterpreterGenerator<span class="token operator">::</span><span class="token function">generate_normal_entry</span><span class="token punctuation">(</span>bool synchronized<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>synchronized <span class="token operator">==</span> false<span class="token punctuation">,</span> <span class="token string">"should be"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token keyword">return</span> <span class="token function">generate_entry</span><span class="token punctuation">(</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span> CppInterpreter<span class="token operator">::</span>normal_entry<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// æ™®é€šjavaæ–¹æ³•æ‰§è¡Œçš„å…¥å£ç‚¹</span>
<span class="token keyword">int</span> CppInterpreter<span class="token operator">::</span><span class="token function">normal_entry</span><span class="token punctuation">(</span>Method<span class="token operator">*</span> method<span class="token punctuation">,</span> <span class="token class-name">intptr_t</span> UNUSED<span class="token punctuation">,</span> TRAPS<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// å½“å‰çº¿ç¨‹</span>
  JavaThread <span class="token operator">*</span>thread <span class="token operator">=</span> <span class="token punctuation">(</span>JavaThread <span class="token operator">*</span><span class="token punctuation">)</span> THREAD<span class="token punctuation">;</span>  
  <span class="token comment">// Allocate and initialize our frame.  </span>
  <span class="token comment">// ä¸ºè¯¥æ–¹æ³•åˆ†é…å±€éƒ¨å˜é‡è¡¨ç©ºé—´å¹¶ä¸”åˆ›å»ºè§£é‡Šå™¨æ ˆå¸§</span>
  InterpreterFrame <span class="token operator">*</span>frame <span class="token operator">=</span> InterpreterFrame<span class="token operator">::</span><span class="token function">build</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> CHECK_0<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// å°†æ ˆå¸§å‹å…¥å½“å‰çº¿ç¨‹æ ˆ</span>
  thread<span class="token operator">-></span><span class="token function">push_zero_frame</span><span class="token punctuation">(</span>frame<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// Execute those bytecodes!</span>
  <span class="token comment">// æ‰§è¡Œæ–¹æ³•ä¸­çš„å­—èŠ‚ç æŒ‡ä»¤</span>
  <span class="token function">main_loop</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> THREAD<span class="token punctuation">)</span><span class="token punctuation">;</span>  
  <span class="token comment">// No deoptimized frames on the stack  </span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>  
<span class="token punctuation">&#125;</span>
<span class="token comment">// åˆ›å»ºè§£é‡Šå™¨æ ˆå¸§</span>
InterpreterFrame <span class="token operator">*</span>InterpreterFrame<span class="token operator">::</span><span class="token function">build</span><span class="token punctuation">(</span>Method<span class="token operator">*</span> <span class="token keyword">const</span> method<span class="token punctuation">,</span> TRAPS<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  JavaThread <span class="token operator">*</span>thread <span class="token operator">=</span> <span class="token punctuation">(</span>JavaThread <span class="token operator">*</span><span class="token punctuation">)</span> THREAD<span class="token punctuation">;</span>
  ZeroStack <span class="token operator">*</span>stack <span class="token operator">=</span> thread<span class="token operator">-></span><span class="token function">zero_stack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Calculate the size of the frame we'll build, including</span>
  <span class="token comment">// any adjustments to the caller's frame that we'll make.</span>
  <span class="token comment">// å±€éƒ¨å˜é‡ä¸ªæ•°</span>
  <span class="token keyword">int</span> extra_locals  <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token comment">// ç›‘è§†å™¨é”ä¸ªæ•°</span>
  <span class="token keyword">int</span> monitor_words <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token comment">// å±€éƒ¨å˜é‡è¡¨å¤§å°</span>
  <span class="token keyword">int</span> stack_words   <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>method<span class="token operator">-></span><span class="token function">is_native</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">// è®¡ç®—å±€éƒ¨å˜é‡å¤§å°</span>
    extra_locals <span class="token operator">=</span> method<span class="token operator">-></span><span class="token function">max_locals</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> method<span class="token operator">-></span><span class="token function">size_of_parameters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    stack_words  <span class="token operator">=</span> method<span class="token operator">-></span><span class="token function">max_stack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>method<span class="token operator">-></span><span class="token function">is_synchronized</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
   <span class="token comment">// å¦‚æœæ˜¯åŒæ­¥æ–¹æ³•ï¼Œè·å–ç›‘è§†å™¨å¤§å°</span>
    monitor_words <span class="token operator">=</span> frame<span class="token operator">::</span><span class="token function">interpreter_frame_monitor_size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token comment">// æ ˆæº¢å‡ºæ£€æŸ¥</span>
  stack<span class="token operator">-></span><span class="token function">overflow_check</span><span class="token punctuation">(</span>
    extra_locals <span class="token operator">+</span> header_words <span class="token operator">+</span> monitor_words <span class="token operator">+</span> stack_words<span class="token punctuation">,</span> CHECK_NULL<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Adjust the caller's stack frame to accomodate any additional</span>
  <span class="token comment">// local variables we have contiguously with our parameters.</span>
  <span class="token comment">// å‹æ ˆæ“ä½œ é¢„åˆ†é…å˜é‡æ•°é‡ä¸ªæ•°çš„ç©ºé—´å¹¶åˆå§‹åŒ–ä¸º0</span>
  <span class="token comment">// å› ä¸ºæ–¹æ³•å‚æ•°å·²ç»å…¥æ ˆäº†,æ‰€ä»¥è¿™é‡Œåªéœ€è¦åˆ†é…å±€éƒ¨å˜é‡çš„ç©ºé—´</span>
  <span class="token comment">// æœ¬è´¨æ˜¯ç§»åŠ¨spæŒ‡é’ˆ *(--sp) = value </span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> extra_locals<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    stack<span class="token operator">-></span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// å±€éƒ¨å˜é‡è¡¨å¼•ç”¨</span>
  <span class="token class-name">intptr_t</span> <span class="token operator">*</span>locals<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>method<span class="token operator">-></span><span class="token function">is_native</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token comment">// nativeæ–¹æ³•ï¼Œæ²¡æœ‰å±€éƒ¨å˜é‡</span>
    locals <span class="token operator">=</span> stack<span class="token operator">-></span><span class="token function">sp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>method<span class="token operator">-></span><span class="token function">size_of_parameters</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span>
	<span class="token comment">// javaæ–¹æ³• max_locals()è¿”å›å±€éƒ¨å˜é‡è¡¨çš„å¤§å°</span>
	<span class="token comment">// è®¡ç®—å±€éƒ¨å˜é‡èµ·å§‹ä½ç½® init_sp - extra_locals + max_locals - 1</span>
    locals <span class="token operator">=</span> stack<span class="token operator">-></span><span class="token function">sp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>method<span class="token operator">-></span><span class="token function">max_locals</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  stack<span class="token operator">-></span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// next_frame, filled in later</span>
  <span class="token comment">// æ ˆé¡¶æŒ‡é’ˆ</span>
  <span class="token class-name">intptr_t</span> <span class="token operator">*</span>fp <span class="token operator">=</span> stack<span class="token operator">-></span><span class="token function">sp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// next_frame_off == 0 ,è¿™é‡Œåº”è¯¥æ˜¯å¿…ç„¶ç›¸ç­‰çš„ï¼Œä½†ä¸çŸ¥é“ä¸ºå•¥è¦æ–­è¨€</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>fp <span class="token operator">-</span> stack<span class="token operator">-></span><span class="token function">sp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> next_frame_off<span class="token punctuation">,</span> <span class="token string">"should be"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// è®¾ç½®å¸§ç±»å‹ä¸ºè§£é‡Šå™¨å¸§ç±»å‹</span>
  stack<span class="token operator">-></span><span class="token function">push</span><span class="token punctuation">(</span>INTERPRETER_FRAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// frame_type_off == 1 ,è¿™é‡Œåº”è¯¥æ˜¯å¿…ç„¶ç›¸ç­‰çš„ï¼Œä½†ä¸çŸ¥é“ä¸ºå•¥è¦æ–­è¨€</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>fp <span class="token operator">-</span> stack<span class="token operator">-></span><span class="token function">sp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> frame_type_off<span class="token punctuation">,</span> <span class="token string">"should be"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// è§£é‡Šå™¨çŠ¶æ€æˆ–è€…ç§°ä¸ºè§£é‡Šå™¨ä¸Šä¸‹æ–‡å¯¹è±¡(æˆ‘å–œæ¬¢å«ä¸Šä¸‹æ–‡å¯¹è±¡ï¼Œå®ƒä¿å­˜äº†æ‰§è¡Œæ–¹æ³•æ‰€éœ€è¦çš„æ‰€æœ‰ä¿¡æ¯)</span>
  <span class="token comment">// åœ¨æ ˆä¸Šåˆ†é…ä¸€ä¸ª InterpreterState å¤§å°çš„ç©ºé—´</span>
  <span class="token comment">// è¿™ä¸ªç©ºé—´ç”¨äºå­˜æ”¾è§£é‡Šå™¨è§£é‡Šæ‰§è¡Œæ–¹æ³•æ—¶æ‰€éœ€è¦çš„ç©ºé—´ï¼ˆå› ä¸ºè§£é‡Šæ–¹æ³•ä¹Ÿæ˜¯æ–¹æ³•ï¼Œä¹Ÿéœ€è¦åˆ†é…æ ˆå¸§ç©ºé—´æ¥å­˜å‚¨å˜é‡ï¼‰</span>
  interpreterState istate <span class="token operator">=</span>
    <span class="token punctuation">(</span>interpreterState<span class="token punctuation">)</span> stack<span class="token operator">-></span><span class="token function">alloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>BytecodeInterpreter<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>fp <span class="token operator">-</span> stack<span class="token operator">-></span><span class="token function">sp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> istate_off<span class="token punctuation">,</span> <span class="token string">"should be"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// è®¾ç½®å±€éƒ¨å˜é‡è¡¨æŒ‡é’ˆ</span>
  istate<span class="token operator">-></span><span class="token function">set_locals</span><span class="token punctuation">(</span>locals<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// æ‰§è¡Œçš„æ–¹æ³•å¯¹è±¡</span>
  istate<span class="token operator">-></span><span class="token function">set_method</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// å…³è”è‡ªå·±ï¼Œå¦‚æœä¸ºnullè¯´æ˜æ— æ•ˆ</span>
  istate<span class="token operator">-></span><span class="token function">set_self_link</span><span class="token punctuation">(</span>istate<span class="token punctuation">)</span><span class="token punctuation">;</span>
  istate<span class="token operator">-></span><span class="token function">set_prev_link</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// æ‰§è¡Œçº¿ç¨‹</span>
  istate<span class="token operator">-></span><span class="token function">set_thread</span><span class="token punctuation">(</span>thread<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// å­—èŠ‚ç æŒ‡é’ˆ</span>
  istate<span class="token operator">-></span><span class="token function">set_bcp</span><span class="token punctuation">(</span>method<span class="token operator">-></span><span class="token function">is_native</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token constant">NULL</span> <span class="token operator">:</span> method<span class="token operator">-></span><span class="token function">code_base</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// æ–¹æ³•å¸¸é‡æ± </span>
  istate<span class="token operator">-></span><span class="token function">set_constants</span><span class="token punctuation">(</span>method<span class="token operator">-></span><span class="token function">constants</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">cache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// æ¶ˆæ¯: è¡¨æ˜å½“å‰è§£é‡Šå™¨ä¸Šä¸‹æ–‡çš„é˜¶æ®µï¼Œmethod_entryè¡¨ç¤ºæ–¹æ³•è¿›å…¥</span>
  istate<span class="token operator">-></span><span class="token function">set_msg</span><span class="token punctuation">(</span>BytecodeInterpreter<span class="token operator">::</span>method_entry<span class="token punctuation">)</span><span class="token punctuation">;</span>
  istate<span class="token operator">-></span><span class="token function">set_oop_temp</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  istate<span class="token operator">-></span><span class="token function">set_mdx</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  istate<span class="token operator">-></span><span class="token function">set_callee</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// BasicObjectLock å¯¹è±¡æŒ‡é’ˆèµ·å§‹åœ°å€ï¼ˆæœ‰å…³synchronizedçš„å®ç°ï¼‰</span>
  istate<span class="token operator">-></span><span class="token function">set_monitor_base</span><span class="token punctuation">(</span><span class="token punctuation">(</span>BasicObjectLock <span class="token operator">*</span><span class="token punctuation">)</span> stack<span class="token operator">-></span><span class="token function">sp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>method<span class="token operator">-></span><span class="token function">is_synchronized</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// å¦‚æœæ˜¯åŒæ­¥æ–¹æ³•ï¼Œä¼šåˆ†é…é”å¯¹è±¡çš„BasicObjectLockç©ºé—´</span>
    BasicObjectLock <span class="token operator">*</span>monitor <span class="token operator">=</span>
      <span class="token punctuation">(</span>BasicObjectLock <span class="token operator">*</span><span class="token punctuation">)</span> stack<span class="token operator">-></span><span class="token function">alloc</span><span class="token punctuation">(</span>monitor_words <span class="token operator">*</span> wordSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// å…³è”çš„é”å¯¹è±¡</span>
    oop object<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>method<span class="token operator">-></span><span class="token function">is_static</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	  <span class="token comment">// é™æ€æ–¹æ³•é”å¯¹è±¡æ˜¯ class</span>
      object <span class="token operator">=</span> method<span class="token operator">-></span><span class="token function">constants</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">pool_holder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">java_mirror</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
	  <span class="token comment">// å®ä¾‹æ–¹æ³•éšå¯¹è±¡æ˜¯this</span>
      object <span class="token operator">=</span> <span class="token punctuation">(</span>oop<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>locals<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    monitor<span class="token operator">-></span><span class="token function">set_obj</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token comment">// è®¾ç½®ä¸Šä¸‹æ–‡çš„æ ˆåŸºåœ°å€</span>
  istate<span class="token operator">-></span><span class="token function">set_stack_base</span><span class="token punctuation">(</span>stack<span class="token operator">-></span><span class="token function">sp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// è®¾ç½®ä¸Šä¸‹æ–‡çš„æ ˆé¡¶æŒ‡é’ˆ</span>
  istate<span class="token operator">-></span><span class="token function">set_stack</span><span class="token punctuation">(</span>stack<span class="token operator">-></span><span class="token function">sp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// å±€éƒ¨å˜é‡è¡¨çš„å¤§å°ä¸ä¸º0</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>stack_words<span class="token punctuation">)</span>
  <span class="token comment">// åœ¨æ ˆä¸Šåˆ†é…å±€éƒ¨å˜é‡é•¿åº¦å¤§å°çš„ç©ºé—´</span>
    stack<span class="token operator">-></span><span class="token function">alloc</span><span class="token punctuation">(</span>stack_words <span class="token operator">*</span> wordSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// è®¾ç½®ä¸Šä¸‹æ–‡çš„æ ˆè¾¹ç•Œåœ°å€</span>
  istate<span class="token operator">-></span><span class="token function">set_stack_limit</span><span class="token punctuation">(</span>stack<span class="token operator">-></span><span class="token function">sp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// è¿”å›è§£é‡Šå™¨å¸§åœ°å€</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>InterpreterFrame <span class="token operator">*</span><span class="token punctuation">)</span> fp<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>


<span class="token comment">// ä¸ºäº†è¿è´¯æ€§å°†cppInterpreterGenerator_zeroçš„ä»£ç ä¹Ÿæ”¾åˆ°è¿™é‡Œäº†</span>
<span class="token comment">// ==========  hotspot/src/cpu/zero/vm/cppInterpreterGenerator_zero.hpp start =====</span>
protected<span class="token operator">:</span>  
 address <span class="token function">generate_entry</span><span class="token punctuation">(</span>address entry_point<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  
       <span class="token keyword">return</span> <span class="token function">generate_entry_impl</span><span class="token punctuation">(</span><span class="token function">assembler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> entry_point<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">&#125;</span>
 
public<span class="token operator">:</span>  
 <span class="token keyword">static</span> address <span class="token function">generate_entry_impl</span><span class="token punctuation">(</span>MacroAssembler<span class="token operator">*</span> masm<span class="token punctuation">,</span> address entry_point<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
   <span class="token comment">// å½“å‰ä»£ç æ®µçš„å½“å‰ä½ç½®çš„åœ°å€</span>
   <span class="token comment">// src/share/vm/asm/assembler.hpp#pc()</span>
   ZeroEntry <span class="token operator">*</span>entry <span class="token operator">=</span> <span class="token punctuation">(</span>ZeroEntry <span class="token operator">*</span><span class="token punctuation">)</span> masm<span class="token operator">-></span><span class="token function">pc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// è®¡ç®— ZeroEntry çš„å¤§å°ï¼Œç§»åŠ¨ZeroEntryä¸ªå¤§å°çš„pc()æŒ‡é’ˆï¼Œè…¾å‡ºå†…å­˜åŒºåŸŸæ¥å­˜æ”¾ ZeroEntry</span>
   masm<span class="token operator">-></span><span class="token function">advance</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>ZeroEntry<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// å…³è” entry_point</span>
   entry<span class="token operator">-></span><span class="token function">set_entry_point</span><span class="token punctuation">(</span>entry_point<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// è¿”å›entryçš„åœ°å€  </span>
   <span class="token keyword">return</span> <span class="token punctuation">(</span>address<span class="token punctuation">)</span> entry<span class="token punctuation">;</span>  
 <span class="token punctuation">&#125;</span>  
<span class="token comment">// =========== hotspot/src/cpu/zero/vm/cppInterpreterGenerator_zero.hpp end ======</span>

<span class="token comment">// åœ¨CppInterpreterä¸­çš„initializeæ–¹æ³•ä¸­ä¼šåˆ›å»º InterpreterGenerator å®ä¾‹ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œåœ¨æ„é€ æ–¹æ³•ä¸­ï¼Œæ‰§è¡Œäº†generate_all()æ–¹æ³•</span>
InterpreterGenerator<span class="token operator">::</span><span class="token function">InterpreterGenerator</span><span class="token punctuation">(</span>StubQueue<span class="token operator">*</span> code<span class="token punctuation">)</span>
 <span class="token operator">:</span> <span class="token function">CppInterpreterGenerator</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
   <span class="token function">generate_all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> CppInterpreter<span class="token operator">::</span><span class="token function">main_loop</span><span class="token punctuation">(</span><span class="token keyword">int</span> recurse<span class="token punctuation">,</span> TRAPS<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  JavaThread <span class="token operator">*</span>thread <span class="token operator">=</span> <span class="token punctuation">(</span>JavaThread <span class="token operator">*</span><span class="token punctuation">)</span> THREAD<span class="token punctuation">;</span>
  ZeroStack <span class="token operator">*</span>stack <span class="token operator">=</span> thread<span class="token operator">-></span><span class="token function">zero_stack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// If we are entering from a deopt we may need to call</span>
  <span class="token comment">// ourself a few times in order to get to our frame.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>recurse<span class="token punctuation">)</span>
    <span class="token function">main_loop</span><span class="token punctuation">(</span>recurse <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> THREAD<span class="token punctuation">)</span><span class="token punctuation">;</span>

  InterpreterFrame <span class="token operator">*</span>frame <span class="token operator">=</span> thread<span class="token operator">-></span><span class="token function">top_zero_frame</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">as_interpreter_frame</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  interpreterState istate <span class="token operator">=</span> frame<span class="token operator">-></span><span class="token function">interpreter_state</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Method<span class="token operator">*</span> method <span class="token operator">=</span> istate<span class="token operator">-></span><span class="token function">method</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token class-name">intptr_t</span> <span class="token operator">*</span>result <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> result_slots <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span>true<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// We can set up the frame anchor with everything we want at</span>
    <span class="token comment">// this point as we are thread_in_Java and no safepoints can</span>
    <span class="token comment">// occur until we go to vm mode.  We do have to clear flags</span>
    <span class="token comment">// on return from vm but that is it.</span>
    thread<span class="token operator">-></span><span class="token function">set_last_Java_frame</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Call the interpreter</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>JvmtiExport<span class="token operator">::</span><span class="token function">can_post_interpreter_events</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      BytecodeInterpreter<span class="token operator">::</span><span class="token function">runWithChecks</span><span class="token punctuation">(</span>istate<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
      BytecodeInterpreter<span class="token operator">::</span><span class="token function">run</span><span class="token punctuation">(</span>istate<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fixup_after_potential_safepoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Clear the frame anchor</span>
    thread<span class="token operator">-></span><span class="token function">reset_last_Java_frame</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Examine the message from the interpreter to decide what to do</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>istate<span class="token operator">-></span><span class="token function">msg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> BytecodeInterpreter<span class="token operator">::</span>call_method<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      Method<span class="token operator">*</span> callee <span class="token operator">=</span> istate<span class="token operator">-></span><span class="token function">callee</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Trim back the stack to put the parameters at the top</span>
      stack<span class="token operator">-></span><span class="token function">set_sp</span><span class="token punctuation">(</span>istate<span class="token operator">-></span><span class="token function">stack</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Make the call</span>
      Interpreter<span class="token operator">::</span><span class="token function">invoke_method</span><span class="token punctuation">(</span>callee<span class="token punctuation">,</span> istate<span class="token operator">-></span><span class="token function">callee_entry_point</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> THREAD<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">fixup_after_potential_safepoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Convert the result</span>
      istate<span class="token operator">-></span><span class="token function">set_stack</span><span class="token punctuation">(</span>stack<span class="token operator">-></span><span class="token function">sp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Restore the stack</span>
      stack<span class="token operator">-></span><span class="token function">set_sp</span><span class="token punctuation">(</span>istate<span class="token operator">-></span><span class="token function">stack_limit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Resume the interpreter</span>
      istate<span class="token operator">-></span><span class="token function">set_msg</span><span class="token punctuation">(</span>BytecodeInterpreter<span class="token operator">::</span>method_resume<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>istate<span class="token operator">-></span><span class="token function">msg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> BytecodeInterpreter<span class="token operator">::</span>more_monitors<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">int</span> monitor_words <span class="token operator">=</span> frame<span class="token operator">::</span><span class="token function">interpreter_frame_monitor_size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Allocate the space</span>
      stack<span class="token operator">-></span><span class="token function">overflow_check</span><span class="token punctuation">(</span>monitor_words<span class="token punctuation">,</span> THREAD<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>HAS_PENDING_EXCEPTION<span class="token punctuation">)</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      stack<span class="token operator">-></span><span class="token function">alloc</span><span class="token punctuation">(</span>monitor_words <span class="token operator">*</span> wordSize<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Move the expression stack contents</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">intptr_t</span> <span class="token operator">*</span>p <span class="token operator">=</span> istate<span class="token operator">-></span><span class="token function">stack</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> p <span class="token operator">&lt;</span> istate<span class="token operator">-></span><span class="token function">stack_base</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> p<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token operator">*</span><span class="token punctuation">(</span>p <span class="token operator">-</span> monitor_words<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>

      <span class="token comment">// Move the expression stack pointers</span>
      istate<span class="token operator">-></span><span class="token function">set_stack_limit</span><span class="token punctuation">(</span>istate<span class="token operator">-></span><span class="token function">stack_limit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> monitor_words<span class="token punctuation">)</span><span class="token punctuation">;</span>
      istate<span class="token operator">-></span><span class="token function">set_stack</span><span class="token punctuation">(</span>istate<span class="token operator">-></span><span class="token function">stack</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> monitor_words<span class="token punctuation">)</span><span class="token punctuation">;</span>
      istate<span class="token operator">-></span><span class="token function">set_stack_base</span><span class="token punctuation">(</span>istate<span class="token operator">-></span><span class="token function">stack_base</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> monitor_words<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Zero the new monitor so the interpreter can find it.</span>
      <span class="token punctuation">(</span><span class="token punctuation">(</span>BasicObjectLock <span class="token operator">*</span><span class="token punctuation">)</span> istate<span class="token operator">-></span><span class="token function">stack_base</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">set_obj</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Resume the interpreter</span>
      istate<span class="token operator">-></span><span class="token function">set_msg</span><span class="token punctuation">(</span>BytecodeInterpreter<span class="token operator">::</span>got_monitors<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>istate<span class="token operator">-></span><span class="token function">msg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> BytecodeInterpreter<span class="token operator">::</span>return_from_method<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// Copy the result into the caller's frame</span>
      result_slots <span class="token operator">=</span> type2size<span class="token punctuation">[</span>method<span class="token operator">-></span><span class="token function">result_type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token function">assert</span><span class="token punctuation">(</span>result_slots <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> result_slots <span class="token operator">&lt;=</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"what?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      result <span class="token operator">=</span> istate<span class="token operator">-></span><span class="token function">stack</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> result_slots<span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>istate<span class="token operator">-></span><span class="token function">msg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> BytecodeInterpreter<span class="token operator">::</span>throwing_exception<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token function">assert</span><span class="token punctuation">(</span>HAS_PENDING_EXCEPTION<span class="token punctuation">,</span> <span class="token string">"should do"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>istate<span class="token operator">-></span><span class="token function">msg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> BytecodeInterpreter<span class="token operator">::</span>do_osr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// Unwind the current frame</span>
      thread<span class="token operator">-></span><span class="token function">pop_zero_frame</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Remove any extension of the previous frame</span>
      <span class="token keyword">int</span> extra_locals <span class="token operator">=</span> method<span class="token operator">-></span><span class="token function">max_locals</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> method<span class="token operator">-></span><span class="token function">size_of_parameters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      stack<span class="token operator">-></span><span class="token function">set_sp</span><span class="token punctuation">(</span>stack<span class="token operator">-></span><span class="token function">sp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> extra_locals<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Jump into the OSR method</span>
      Interpreter<span class="token operator">::</span><span class="token function">invoke_osr</span><span class="token punctuation">(</span>
        method<span class="token punctuation">,</span> istate<span class="token operator">-></span><span class="token function">osr_entry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> istate<span class="token operator">-></span><span class="token function">osr_buf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> THREAD<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
      <span class="token function">ShouldNotReachHere</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token comment">// Unwind the current frame</span>
  thread<span class="token operator">-></span><span class="token function">pop_zero_frame</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// Pop our local variables</span>
  stack<span class="token operator">-></span><span class="token function">set_sp</span><span class="token punctuation">(</span>stack<span class="token operator">-></span><span class="token function">sp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> method<span class="token operator">-></span><span class="token function">max_locals</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Push our result</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> result_slots<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// Adjust result to smaller</span>
    <span class="token keyword">union</span> <span class="token punctuation">&#123;</span>
      <span class="token class-name">intptr_t</span> res<span class="token punctuation">;</span>
      jint res_jint<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    res <span class="token operator">=</span> result<span class="token punctuation">[</span><span class="token operator">-</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result_slots <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      BasicType t <span class="token operator">=</span> method<span class="token operator">-></span><span class="token function">result_type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">is_subword_type</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        res_jint <span class="token operator">=</span> <span class="token punctuation">(</span>jint<span class="token punctuation">)</span><span class="token function">narrow</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> res_jint<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    stack<span class="token operator">-></span><span class="token function">push</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">// CC_INTERP</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¯¥ç±»ä¸­çš„å…¶ä»–å‡½æ•°éƒ½å·²ç»è¢«åˆ æ‰ï¼Œåªä¿ç•™æ ¸å¿ƒçš„280è¡Œä»£ç <br />
ä¹‹å‰çœ‹åˆ°<code>CppInterpreter#generate_all</code> æ–¹æ³•ä¼šè°ƒç”¨<code>generate_method_entry</code>ï¼Œå…¶å®å°±æ˜¯è°ƒç”¨ä¸Šé¢çš„æ–¹æ³•<br />
ä¸‹é¢æ¥åˆ†ææ•´ä¸ªæ‰§è¡Œé“¾åšäº†å“ªäº›äº‹æƒ…<br />
<code>generate_method_entry</code>ï¼šæ ¹æ®ä¼ å…¥çš„<code>MethodKind</code>å‚æ•°è¿›å…¥å¯¹åº”çš„åˆ†æ”¯å¤„ç†ï¼Œæˆ‘ä»¬æ™®é€šçš„javaæ–¹æ³•å¤§éƒ½æ˜¯<code>zerolocals</code>ï¼Œæ‰€ä»¥ä¼šç›´æ¥breakï¼Œæ¥ç€ä¼šç›´æ¥<code>generate_normal_entry</code>æ–¹æ³•</p>
<ul>
<li><code>generate_normal_entry</code>ï¼šå®ƒç›´æ¥æ‰§è¡Œ<code>generate_entry</code>æ–¹æ³•ï¼Œå¹¶å°†<code>CppInterpreter::normal_entry</code>æ–¹æ³•çš„åœ°å€å€¼ä½œä¸ºå‚æ•°è¿›è¡Œä¼ é€’</li>
<li><code>generate_entry</code>ï¼š<br />
<code>normal_entry</code>ï¼šå°±åšä¸‰ä»¶äº‹</li>
</ul>
<ul>
<li><code>InterpreterFrame::build</code>ï¼šä¸ºæ–¹æ³•å±€éƒ¨å˜é‡è¡¨åˆ†é…ç©ºé—´ï¼Œå¦‚æœæ˜¯åŒæ­¥æ–¹æ³•ä¼šåˆ›å»ºBasicLockObjectå¯¹è±¡æ¥å…³è”é”å¯¹è±¡ï¼Œç„¶ååœ¨æ ˆä¸Šåˆ†é…è§£é‡Šå™¨æ–¹æ³•æ ˆå¸§ï¼Œå­˜æ”¾è§£é‡Šå™¨ä¸Šä¸‹æ–‡å¯¹è±¡ä»¥åŠæ‰§è¡Œæ–¹æ³•æ—¶æ‰€éœ€çš„å˜é‡</li>
<li><code>Thread::push_zero_frame</code>ï¼šå°†åˆ›å»ºçš„æ ˆå¸§å‹å…¥çº¿ç¨‹æ ˆä¸­</li>
<li><code>main_loop</code>ï¼šæ‰§è¡Œå­—èŠ‚ç æŒ‡ä»¤çš„å…¥å£
<ul>
<li><code>BytecodeInterpreter::run(istate)</code> å†…éƒ¨è°ƒç”¨æ­¤æ–¹æ³•æ‰§è¡Œå­—èŠ‚ç æŒ‡ä»¤ï¼Œé™äºç¯‡å¹…ï¼Œæœ¬ç« ä¸ä»‹ç»å¦‚ä½•æ‰§è¡Œçš„äº†ï¼Œæœ‰å…´è¶£æŸ¥çœ‹è¿™ç¯‡åšå®¢<a  href="/posts/1fe4afce.html">å­—èŠ‚ç æŒ‡ä»¤æ‰§è¡Œè¿‡ç¨‹ BytecodeInterpreter</a></li>
</ul>
</li>
</ul>
<h3 id="templateinterpreter"><a class="markdownIt-Anchor" href="#templateinterpreter"></a> TemplateInterpreter</h3>
<p>å‰æ–‡è¯´è¿‡ï¼Œåˆå§‹åŒ–è§£é‡Šå™¨æ—¶ä¼šè°ƒç”¨<code>Interpreter::initialize</code>æ–¹æ³•ï¼Œé‚£ä¹ˆè¿™é‡Œå°±ä¸å†èŠ±è´¹è¿‡å¤šçš„ç¯‡å¹…ï¼Œè®©æˆ‘ä»¬ç›´æ¥çœ‹<code>TemplateInterpreter::initialize</code>æ–¹æ³•åšäº†ä»€ä¹ˆ</p>
<blockquote>
<p>æ³¨æ„çš„æ˜¯ï¼ŒTemplateInterpreteræ²¡æœ‰zeroæ¶æ„çš„å®ç°ï¼Œå› æ­¤æˆ‘è¿™é‡Œé‡‡å–<code>aarch64</code>æ¶æ„çš„è¿›è¡Œå±•ç¤ºï¼Œè¿™ç§é€»è¾‘éƒ½æ˜¯ä¸€æ ·çš„ï¼Œçœ‹æ‡‚ä¸€ä¸ªå°±okäº†</p>
</blockquote>
<p>hotspot/src/share/vm/interpreter/templateInterpreter.cpp</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">// æ­£åœ¨ä½¿ç”¨åˆ°çš„å­—èŠ‚ç æŒ‡ä»¤åˆ†å‘è¡¨ï¼Œåœ¨_normal_tableå’Œ_safept_tableä¹‹é—´åˆ‡æ¢</span>
DispatchTable TemplateInterpreter<span class="token operator">::</span>_active_table<span class="token punctuation">;</span> 
<span class="token comment">// æ­£å¸¸çŠ¶æ€ä¸‹çš„å­—èŠ‚ç æŒ‡ä»¤åˆ†å‘è¡¨ åªè¦å…³æ³¨è¿™ä¸ªå³å¯</span>
DispatchTable TemplateInterpreter<span class="token operator">::</span>_normal_table<span class="token punctuation">;</span>
<span class="token comment">// å®‰å…¨ç‚¹çŠ¶æ€ä¸‹çš„å­—èŠ‚ç æŒ‡ä»¤åˆ†å‘è¡¨</span>
DispatchTable TemplateInterpreter<span class="token operator">::</span>_safept_table<span class="token punctuation">;</span>

<span class="token keyword">void</span> TemplateInterpreter<span class="token operator">::</span><span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>_code <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token comment">// assertions</span>
  <span class="token function">assert</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>Bytecodes<span class="token operator">::</span>number_of_codes <span class="token operator">&lt;=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>DispatchTable<span class="token operator">::</span>length<span class="token punctuation">,</span>
         <span class="token string">"dispatch table too small"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  AbstractInterpreter<span class="token operator">::</span><span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// è¿™é‡Œæ˜¯å…³é”®ï¼Œåˆå§‹åŒ– dispatch table</span>
  TemplateTable<span class="token operator">::</span><span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// generate interpreter</span>
  <span class="token punctuation">&#123;</span> ResourceMark rm<span class="token punctuation">;</span>
    TraceTime <span class="token function">timer</span><span class="token punctuation">(</span><span class="token string">"Interpreter generation"</span><span class="token punctuation">,</span> TraceStartupTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> code_size <span class="token operator">=</span> InterpreterCodeSize<span class="token punctuation">;</span>
    <span class="token function">NOT_PRODUCT</span><span class="token punctuation">(</span>code_size <span class="token operator">*=</span> <span class="token number">4</span><span class="token punctuation">;</span><span class="token punctuation">)</span>  <span class="token comment">// debug uses extra interpreter code space</span>
    _code <span class="token operator">=</span> new <span class="token function">StubQueue</span><span class="token punctuation">(</span>new InterpreterCodeletInterface<span class="token punctuation">,</span> code_size<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>
                          <span class="token string">"Interpreter"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// è§£é‡Šå™¨ç”Ÿæˆå™¨ï¼šä¹Ÿæ˜¯ç”Ÿæˆå„ç§æ–¹æ³•ç±»å‹çš„ EntryPoint</span>
    InterpreterGenerator <span class="token function">g</span><span class="token punctuation">(</span>_code<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>PrintInterpreter<span class="token punctuation">)</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token comment">// initialize dispatch table</span>
  <span class="token comment">// å°†å½“å‰ä½¿ç”¨çš„åˆ†å‘è¡¨æŒ‡é’ˆ _active_table æŒ‡å‘normal_table </span>
  _active_table <span class="token operator">=</span> _normal_table<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä¸Šé¢çš„ä»£ç æœ€æ ¸å¿ƒçš„å°±æ˜¯æ‰§è¡Œ<code>TemplateTable::initialize</code>æ–¹æ³•ä»¥åŠåˆå§‹åŒ–è§£é‡Šå™¨ç”Ÿæˆå™¨<code>InterpreterGenerator g(_code)</code>ï¼Œæ¥ä¸‹æ¥ç›´æ¥æŸ¥çœ‹è¿™ä¸¤ä¸ªæ–¹æ³•å†…åšäº†å“ªäº›äº‹æƒ…</p>
<h4 id="templatetable"><a class="markdownIt-Anchor" href="#templatetable"></a> TemplateTable</h4>
<ul>
<li>hotspot/src/share/vm/interpreter/templateTable.cpp</li>
</ul>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> TemplateTable<span class="token operator">::</span><span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>_is_initialized<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

  <span class="token comment">// Initialize table</span>
  TraceTime <span class="token function">timer</span><span class="token punctuation">(</span><span class="token string">"TemplateTable initialization"</span><span class="token punctuation">,</span> TraceStartupTime<span class="token punctuation">)</span><span class="token punctuation">;</span>

  _bs <span class="token operator">=</span> Universe<span class="token operator">::</span><span class="token function">heap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">barrier_set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// For better readability</span>
  <span class="token keyword">const</span> <span class="token keyword">char</span> _    <span class="token operator">=</span> <span class="token char">' '</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token keyword">int</span>  ____ <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token keyword">int</span>  ubcp <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> Template<span class="token operator">::</span>uses_bcp_bit<span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token keyword">int</span>  disp <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> Template<span class="token operator">::</span>does_dispatch_bit<span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token keyword">int</span>  clvm <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> Template<span class="token operator">::</span>calls_vm_bit<span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token keyword">int</span>  iswd <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> Template<span class="token operator">::</span>wide_bit<span class="token punctuation">;</span>
  <span class="token comment">//                                    interpr. templates</span>
  <span class="token comment">// Java spec bytecodes                ubcp|disp|clvm|iswd  in    out   generator             argument</span>
  <span class="token comment">// è¿™é‡Œå°±æ˜¯å»ºç«‹å­—èŠ‚ç æŒ‡ä»¤å’Œä¸ä¹‹å¯¹åº”å¤„ç†æ–¹æ³•çš„æ˜ å°„å…³ç³»</span>
  <span class="token comment">// è¿™é‡Œåªå±•ç¤ºäº†å»ºç«‹ iload ä»¥åŠå¯¹åº”å¤„ç†æ–¹æ³•çš„æ˜ å°„å…³ç³» </span>
  <span class="token function">def</span><span class="token punctuation">(</span>Bytecodes<span class="token operator">::</span>_iload               <span class="token punctuation">,</span> ubcp<span class="token operator">|</span>____<span class="token operator">|</span>clvm<span class="token operator">|</span>____<span class="token punctuation">,</span> vtos<span class="token punctuation">,</span> itos<span class="token punctuation">,</span> iload               <span class="token punctuation">,</span>  _           <span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// çœç•¥äº†å°†è¿‘300è¡Œçš„å­—èŠ‚ç æŒ‡ä»¤ä¸æ¨¡æ¿æ–¹æ³•çš„æ˜ å°„å…³ç³»å®šä¹‰</span>

  _is_initialized <span class="token operator">=</span> true<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">/*
*  Bytecodes::Code codeï¼šå­—èŠ‚ç æŒ‡ä»¤
*  flags: å­—èŠ‚ç æŒ‡ä»¤çš„æ ‡è¯†ä½
*  TosState inï¼šæ‰§è¡Œè¯¥å­—èŠ‚ç æŒ‡ä»¤æ—¶è¾“å…¥çš„æ ˆé¡¶çŠ¶æ€ Top Of Stack State
*  TosState outï¼šæ‰§è¡Œè¯¥å­—èŠ‚ç æŒ‡ä»¤æ—¶è¾“å‡ºçš„æ ˆé¡¶çŠ¶æ€ Top Of Stack State
*  gen: å­—èŠ‚ç æŒ‡ä»¤å¤„ç†å‡½æ•°åœ°å€
*  argï¼šå­—èŠ‚ç æŒ‡ä»¤å¤„ç†å‡½æ•°å‚æ•°
*/</span>
<span class="token keyword">void</span> TemplateTable<span class="token operator">::</span><span class="token function">def</span><span class="token punctuation">(</span>Bytecodes<span class="token operator">::</span>Code code<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> TosState in<span class="token punctuation">,</span> TosState out<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>gen<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  
  <span class="token comment">// should factor out these constants  </span>
  <span class="token keyword">const</span> <span class="token keyword">int</span> ubcp <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> Template<span class="token operator">::</span>uses_bcp_bit<span class="token punctuation">;</span>  
  <span class="token keyword">const</span> <span class="token keyword">int</span> disp <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> Template<span class="token operator">::</span>does_dispatch_bit<span class="token punctuation">;</span>  
  <span class="token keyword">const</span> <span class="token keyword">int</span> clvm <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> Template<span class="token operator">::</span>calls_vm_bit<span class="token punctuation">;</span>  
  <span class="token keyword">const</span> <span class="token keyword">int</span> iswd <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> Template<span class="token operator">::</span>wide_bit<span class="token punctuation">;</span>  
  <span class="token comment">// determine which table to use  </span>
  bool is_wide <span class="token operator">=</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> iswd<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>  
  <span class="token comment">// make sure that wide instructions have a vtos entry point  </span>
  <span class="token comment">// (since they are executed extremely rarely, it doesn't pay out to have an  // extra set of 5 dispatch tables for the wide instructions - for simplicity  // they all go with one table)  assert(in == vtos || !is_wide, "wide instructions have vtos entry point only"); </span>
 <span class="token comment">// </span>
  Template<span class="token operator">*</span> t <span class="token operator">=</span> is_wide <span class="token operator">?</span> <span class="token function">template_for_wide</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">template_for</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>  
  <span class="token comment">// setup entry  å±æ€§åˆå§‹åŒ–</span>
  t<span class="token operator">-></span><span class="token function">initialize</span><span class="token punctuation">(</span>flags<span class="token punctuation">,</span> in<span class="token punctuation">,</span> out<span class="token punctuation">,</span> gen<span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>  
  <span class="token function">assert</span><span class="token punctuation">(</span>t<span class="token operator">-></span><span class="token function">bytecode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> code<span class="token punctuation">,</span> <span class="token string">"just checkin'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">&#125;</span>

<span class="token comment">// æ ¹æ®codeè·å–ä»æ¨¡æ¿è¡¨ä¸­è·å–å¯¹åº”çš„Templateå¯¹è±¡</span>
<span class="token keyword">static</span> Template<span class="token operator">*</span> <span class="token function">template_for</span><span class="token punctuation">(</span>Bytecodes<span class="token operator">::</span>Code code<span class="token punctuation">)</span>  <span class="token punctuation">&#123;</span>
	Bytecodes<span class="token operator">::</span><span class="token function">check</span>     <span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>_template_table     <span class="token punctuation">[</span>code<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// åˆå§‹åŒ–æ¨¡æ¿å¯¹è±¡å±æ€§å€¼</span>
<span class="token keyword">void</span> Template<span class="token operator">::</span><span class="token function">initialize</span><span class="token punctuation">(</span><span class="token keyword">int</span> flags<span class="token punctuation">,</span> TosState tos_in<span class="token punctuation">,</span> TosState tos_out<span class="token punctuation">,</span> generator gen<span class="token punctuation">,</span> <span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  _flags   <span class="token operator">=</span> flags<span class="token punctuation">;</span>
  _tos_in  <span class="token operator">=</span> tos_in<span class="token punctuation">;</span>
  _tos_out <span class="token operator">=</span> tos_out<span class="token punctuation">;</span>
  _gen     <span class="token operator">=</span> gen<span class="token punctuation">;</span>
  _arg     <span class="token operator">=</span> arg<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å¯ä»¥çœ‹åˆ°åœ¨<code>def</code>æ–¹æ³•ä¸­ä¼šä¼ å…¥å­—èŠ‚ç æŒ‡ä»¤å¤„ç†å‡½æ•°<code>gen</code>çš„åœ°å€ï¼Œè€Œæ ¹æ®ä¸åŒæ¶æ„å‡½æ•°çš„å®ç°ä¹Ÿä¼šæœ‰æ‰€ä¸åŒï¼Œæ‰€ä»¥<code>TemplateTable</code>æœ‰ä¸åŒçš„æ¶æ„å®ç°ï¼Œæˆ‘ä»¬çœ‹<code>aarch64</code>å¹³å°ä¸‹çš„<code>TemplateTable</code>çš„å®ç°<br />
hotspot/src/cpu/aarch64/vm/templateTable_aarch64.cpp</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> TemplateTable<span class="token operator">::</span><span class="token function">iload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  
  <span class="token function">transition</span><span class="token punctuation">(</span>vtos<span class="token punctuation">,</span> itos<span class="token punctuation">)</span><span class="token punctuation">;</span>  
  <span class="token keyword">if</span> <span class="token punctuation">(</span>RewriteFrequentPairs<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  
    <span class="token comment">// åˆ æ‰äº†åœ¨æŸäº›caseä¸‹å¯¹iloadé‡å†™ä¼˜åŒ–çš„é€»è¾‘</span>
  <span class="token punctuation">&#125;</span>  
  <span class="token comment">// do iload, get the local value into tos  </span>
  <span class="token function">locals_index</span><span class="token punctuation">(</span>r1<span class="token punctuation">)</span><span class="token punctuation">;</span>  
  __ <span class="token function">ldr</span><span class="token punctuation">(</span>r0<span class="token punctuation">,</span> <span class="token function">iaddress</span><span class="token punctuation">(</span>r1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><code>iload()</code>ï¼šå¯ä»¥çœ‹åˆ°å¯¹<code>iload</code>æŒ‡ä»¤çš„å¤„ç†å°±æ˜¯å°†å±€éƒ¨å˜é‡è¡¨çš„ç´¢å¼•ç»™r1ï¼Œç„¶åä»å±€éƒ¨å˜é‡è¡¨åŠ è½½intç±»å‹çš„å€¼åˆ°å¯„å­˜å™¨r0ä¸­</li>
</ul>
<p>åˆå§‹åŒ–<code>InterpreterGenerator</code> æ—¶ä¼šç”Ÿæˆå„ç§ç±»å‹æ–¹æ³•çš„<code>EntryPoint</code><br />
hotspot/src/cpu/aarch64/vm/templateInterpreter_aarch64.cpp</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">  
InterpreterGenerator<span class="token operator">::</span><span class="token function">InterpreterGenerator</span><span class="token punctuation">(</span>StubQueue<span class="token operator">*</span> code<span class="token punctuation">)</span>  
  <span class="token operator">:</span> <span class="token function">TemplateInterpreterGenerator</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  
   <span class="token function">generate_all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// down here so it can be "virtual"  </span>
<span class="token punctuation">&#125;</span>


<span class="token keyword">void</span> TemplateInterpreterGenerator<span class="token operator">::</span><span class="token function">generate_all</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  AbstractInterpreterGenerator<span class="token operator">::</span><span class="token function">generate_all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// å®å®šä¹‰</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">method_entry</span><span class="token expression"><span class="token punctuation">(</span>kind<span class="token punctuation">)</span>                                                                    </span><span class="token punctuation">\</span>
  <span class="token expression"><span class="token punctuation">&#123;</span> CodeletMark <span class="token function">cm</span><span class="token punctuation">(</span>_masm<span class="token punctuation">,</span> </span><span class="token string">"method entry point (kind = "</span> <span class="token expression"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">kind</span> </span></span><span class="token string">")"</span><span class="token expression"><span class="token punctuation">)</span><span class="token punctuation">;</span>                    </span><span class="token punctuation">\</span>
    <span class="token expression">Interpreter<span class="token operator">::</span>_entry_table<span class="token punctuation">[</span>Interpreter<span class="token operator">::</span>kind<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">generate_method_entry</span><span class="token punctuation">(</span>Interpreter<span class="token operator">::</span>kind<span class="token punctuation">)</span><span class="token punctuation">;</span>  </span><span class="token punctuation">\</span>
  <span class="token expression"><span class="token punctuation">&#125;</span></span></span>

  <span class="token comment">// all non-native method kinds</span>
  <span class="token function">method_entry</span><span class="token punctuation">(</span>zerolocals<span class="token punctuation">)</span>
  <span class="token function">method_entry</span><span class="token punctuation">(</span>zerolocals_synchronized<span class="token punctuation">)</span>
  <span class="token comment">// åŠ¨æ€æ–¹æ³•æ”¯æŒ</span>
  <span class="token function">initialize_method_handle_entries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// all native method kinds (must be one contiguous block)</span>
  Interpreter<span class="token operator">::</span>_native_entry_begin <span class="token operator">=</span> Interpreter<span class="token operator">::</span><span class="token function">code</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">code_end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">method_entry</span><span class="token punctuation">(</span>native<span class="token punctuation">)</span>
  <span class="token function">method_entry</span><span class="token punctuation">(</span>native_synchronized<span class="token punctuation">)</span>
  Interpreter<span class="token operator">::</span>_native_entry_end <span class="token operator">=</span> Interpreter<span class="token operator">::</span><span class="token function">code</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">code_end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">undef</span> <span class="token expression">method_entry</span></span>
  <span class="token comment">// Bytecodes</span>
  <span class="token function">set_entry_points_for_all_bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">set_safepoints_for_all_bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>å¯ä»¥çœ‹åˆ°ä¹Ÿæ˜¯åœ¨<code>InterpreterGenerator</code>æ„é€ æ–¹æ³•ä¸­è°ƒç”¨äº†<code>generate_all</code>å‡½æ•°æ¥ç»™å„ç§ç±»å‹çš„æ–¹æ³•ç”Ÿæˆå¹¶å…³è” EntryPoint
<ul>
<li>å…·ä½“é€»è¾‘å°±ä¸æ¦‚è¿°äº†ï¼Œæ€è·¯ä¸€æ ·</li>
</ul>
</li>
</ul>
<p>è¿™é‡Œç›´æ¥å±•ç¤ºç”Ÿæˆ<code>zerolocals</code>ç±»å‹æ–¹æ³•çš„<code>EntryPoint</code>ä»£ç ï¼Œä½†æ˜¯ä¸ä¼šåšæ³¨é‡Š(æ±‡ç¼–çœ‹ä¸æ‡‚ ğŸ˜¦ ï¼Œåªèƒ½é æ¨æµ‹ï¼Œä¸ºäº†ä¸è¯¯å¯¼å¤§å®¶ï¼Œåªæ˜¯è´´å‡ºæºä»£ç ä½œä¸ºäº†è§£  )</p>
<h4 id="interpretergenerator"><a class="markdownIt-Anchor" href="#interpretergenerator"></a> InterpreterGenerator</h4>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">address InterpreterGenerator<span class="token operator">::</span><span class="token function">generate_normal_entry</span><span class="token punctuation">(</span>bool synchronized<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// determine code generation flags</span>
  bool inc_counter  <span class="token operator">=</span> UseCompiler <span class="token operator">||</span> CountCompiledCalls<span class="token punctuation">;</span>

  <span class="token comment">// rscratch1: sender sp</span>
  address entry_point <span class="token operator">=</span> __ <span class="token function">pc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> Address <span class="token function">constMethod</span><span class="token punctuation">(</span>rmethod<span class="token punctuation">,</span> Method<span class="token operator">::</span><span class="token function">const_offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> Address <span class="token function">access_flags</span><span class="token punctuation">(</span>rmethod<span class="token punctuation">,</span> Method<span class="token operator">::</span><span class="token function">access_flags_offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> Address <span class="token function">size_of_parameters</span><span class="token punctuation">(</span>r3<span class="token punctuation">,</span>
                                   ConstMethod<span class="token operator">::</span><span class="token function">size_of_parameters_offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> Address <span class="token function">size_of_locals</span><span class="token punctuation">(</span>r3<span class="token punctuation">,</span> ConstMethod<span class="token operator">::</span><span class="token function">size_of_locals_offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// get parameter size (always needed)</span>
  <span class="token comment">// need to load the const method first</span>
  __ <span class="token function">ldr</span><span class="token punctuation">(</span>r3<span class="token punctuation">,</span> constMethod<span class="token punctuation">)</span><span class="token punctuation">;</span>
  __ <span class="token function">load_unsigned_short</span><span class="token punctuation">(</span>r2<span class="token punctuation">,</span> size_of_parameters<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// r2: size of parameters</span>

  __ <span class="token function">load_unsigned_short</span><span class="token punctuation">(</span>r3<span class="token punctuation">,</span> size_of_locals<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// get size of locals in words</span>
  __ <span class="token function">sub</span><span class="token punctuation">(</span>r3<span class="token punctuation">,</span> r3<span class="token punctuation">,</span> r2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// r3 = no. of additional locals</span>

  <span class="token comment">// see if we've got enough room on the stack for locals plus overhead.</span>
  <span class="token function">generate_stack_overflow_check</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// compute beginning of parameters (rlocals)</span>
  __ <span class="token function">add</span><span class="token punctuation">(</span>rlocals<span class="token punctuation">,</span> esp<span class="token punctuation">,</span> r2<span class="token punctuation">,</span> ext<span class="token operator">::</span>uxtx<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  __ <span class="token function">sub</span><span class="token punctuation">(</span>rlocals<span class="token punctuation">,</span> rlocals<span class="token punctuation">,</span> wordSize<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Make room for locals</span>
  __ <span class="token function">sub</span><span class="token punctuation">(</span>rscratch1<span class="token punctuation">,</span> esp<span class="token punctuation">,</span> r3<span class="token punctuation">,</span> ext<span class="token operator">::</span>uxtx<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  __ <span class="token function">andr</span><span class="token punctuation">(</span>sp<span class="token punctuation">,</span> rscratch1<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// r3 - # of additional locals</span>
  <span class="token comment">// allocate space for locals</span>
  <span class="token comment">// explicitly initialize locals</span>
  <span class="token punctuation">&#123;</span>
    Label exit<span class="token punctuation">,</span> loop<span class="token punctuation">;</span>
    __ <span class="token function">ands</span><span class="token punctuation">(</span>zr<span class="token punctuation">,</span> r3<span class="token punctuation">,</span> r3<span class="token punctuation">)</span><span class="token punctuation">;</span>
    __ <span class="token function">br</span><span class="token punctuation">(</span>Assembler<span class="token operator">::</span>LE<span class="token punctuation">,</span> exit<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// do nothing if r3 &lt;= 0</span>
    __ <span class="token function">bind</span><span class="token punctuation">(</span>loop<span class="token punctuation">)</span><span class="token punctuation">;</span>
    __ <span class="token function">str</span><span class="token punctuation">(</span>zr<span class="token punctuation">,</span> <span class="token function">Address</span><span class="token punctuation">(</span>__ <span class="token function">post</span><span class="token punctuation">(</span>rscratch1<span class="token punctuation">,</span> wordSize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    __ <span class="token function">sub</span><span class="token punctuation">(</span>r3<span class="token punctuation">,</span> r3<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// until everything initialized</span>
    __ <span class="token function">cbnz</span><span class="token punctuation">(</span>r3<span class="token punctuation">,</span> loop<span class="token punctuation">)</span><span class="token punctuation">;</span>
    __ <span class="token function">bind</span><span class="token punctuation">(</span>exit<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// And the base dispatch table</span>
  __ <span class="token function">get_dispatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// initialize fixed part of activation frame</span>
  <span class="token function">generate_fixed_frame</span><span class="token punctuation">(</span>false<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// make sure method is not native &amp; not abstract</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">ASSERT</span></span>
  __ <span class="token function">ldrw</span><span class="token punctuation">(</span>r0<span class="token punctuation">,</span> access_flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#123;</span>
    Label L<span class="token punctuation">;</span>
    __ <span class="token function">tst</span><span class="token punctuation">(</span>r0<span class="token punctuation">,</span> JVM_ACC_NATIVE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    __ <span class="token function">br</span><span class="token punctuation">(</span>Assembler<span class="token operator">::</span>EQ<span class="token punctuation">,</span> L<span class="token punctuation">)</span><span class="token punctuation">;</span>
    __ <span class="token function">stop</span><span class="token punctuation">(</span><span class="token string">"tried to execute native method as non-native"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    __ <span class="token function">bind</span><span class="token punctuation">(</span>L<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
 <span class="token punctuation">&#123;</span>
    Label L<span class="token punctuation">;</span>
    __ <span class="token function">tst</span><span class="token punctuation">(</span>r0<span class="token punctuation">,</span> JVM_ACC_ABSTRACT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    __ <span class="token function">br</span><span class="token punctuation">(</span>Assembler<span class="token operator">::</span>EQ<span class="token punctuation">,</span> L<span class="token punctuation">)</span><span class="token punctuation">;</span>
    __ <span class="token function">stop</span><span class="token punctuation">(</span><span class="token string">"tried to execute abstract method in interpreter"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    __ <span class="token function">bind</span><span class="token punctuation">(</span>L<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

  <span class="token comment">// Since at this point in the method invocation the exception</span>
  <span class="token comment">// handler would try to exit the monitor of synchronized methods</span>
  <span class="token comment">// which hasn't been entered yet, we set the thread local variable</span>
  <span class="token comment">// _do_not_unlock_if_synchronized to true. The remove_activation</span>
  <span class="token comment">// will check this flag.</span>

   <span class="token keyword">const</span> Address <span class="token function">do_not_unlock_if_synchronized</span><span class="token punctuation">(</span>rthread<span class="token punctuation">,</span>
        <span class="token function">in_bytes</span><span class="token punctuation">(</span>JavaThread<span class="token operator">::</span><span class="token function">do_not_unlock_if_synchronized_offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  __ <span class="token function">mov</span><span class="token punctuation">(</span>rscratch2<span class="token punctuation">,</span> true<span class="token punctuation">)</span><span class="token punctuation">;</span>
  __ <span class="token function">strb</span><span class="token punctuation">(</span>rscratch2<span class="token punctuation">,</span> do_not_unlock_if_synchronized<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// increment invocation count &amp; check for overflow</span>
  Label invocation_counter_overflow<span class="token punctuation">;</span>
  Label profile_method<span class="token punctuation">;</span>
  Label profile_method_continue<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>inc_counter<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">generate_counter_incr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>invocation_counter_overflow<span class="token punctuation">,</span>
                          <span class="token operator">&amp;</span>profile_method<span class="token punctuation">,</span>
                          <span class="token operator">&amp;</span>profile_method_continue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ProfileInterpreter<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      __ <span class="token function">bind</span><span class="token punctuation">(</span>profile_method_continue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>

  Label continue_after_compile<span class="token punctuation">;</span>
  __ <span class="token function">bind</span><span class="token punctuation">(</span>continue_after_compile<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">bang_stack_shadow_pages</span><span class="token punctuation">(</span>false<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// reset the _do_not_unlock_if_synchronized flag</span>
  __ <span class="token function">strb</span><span class="token punctuation">(</span>zr<span class="token punctuation">,</span> do_not_unlock_if_synchronized<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// check for synchronized methods</span>
  <span class="token comment">// Must happen AFTER invocation_counter check and stack overflow check,</span>
  <span class="token comment">// so method is not locked if overflows.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>synchronized<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// Allocate monitor and lock method</span>
    <span class="token function">lock_method</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// no synchronization necessary</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">ASSERT</span></span>
    <span class="token punctuation">&#123;</span>
      Label L<span class="token punctuation">;</span>
      __ <span class="token function">ldrw</span><span class="token punctuation">(</span>r0<span class="token punctuation">,</span> access_flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
      __ <span class="token function">tst</span><span class="token punctuation">(</span>r0<span class="token punctuation">,</span> JVM_ACC_SYNCHRONIZED<span class="token punctuation">)</span><span class="token punctuation">;</span>
      __ <span class="token function">br</span><span class="token punctuation">(</span>Assembler<span class="token operator">::</span>EQ<span class="token punctuation">,</span> L<span class="token punctuation">)</span><span class="token punctuation">;</span>
      __ <span class="token function">stop</span><span class="token punctuation">(</span><span class="token string">"method needs synchronization"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      __ <span class="token function">bind</span><span class="token punctuation">(</span>L<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// start execution</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">ASSERT</span></span>
  <span class="token punctuation">&#123;</span>
    Label L<span class="token punctuation">;</span>
     <span class="token keyword">const</span> Address <span class="token function">monitor_block_top</span> <span class="token punctuation">(</span>rfp<span class="token punctuation">,</span>
                 frame<span class="token operator">::</span>interpreter_frame_monitor_block_top_offset <span class="token operator">*</span> wordSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    __ <span class="token function">ldr</span><span class="token punctuation">(</span>rscratch1<span class="token punctuation">,</span> monitor_block_top<span class="token punctuation">)</span><span class="token punctuation">;</span>
    __ <span class="token function">cmp</span><span class="token punctuation">(</span>esp<span class="token punctuation">,</span> rscratch1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    __ <span class="token function">br</span><span class="token punctuation">(</span>Assembler<span class="token operator">::</span>EQ<span class="token punctuation">,</span> L<span class="token punctuation">)</span><span class="token punctuation">;</span>
    __ <span class="token function">stop</span><span class="token punctuation">(</span><span class="token string">"broken stack frame setup in interpreter"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    __ <span class="token function">bind</span><span class="token punctuation">(</span>L<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

  <span class="token comment">// jvmti support</span>
  __ <span class="token function">notify_method_entry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  __ <span class="token function">dispatch_next</span><span class="token punctuation">(</span>vtos<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// invocation counter overflow</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>inc_counter<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ProfileInterpreter<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// We have decided to profile this method in the interpreter</span>
      __ <span class="token function">bind</span><span class="token punctuation">(</span>profile_method<span class="token punctuation">)</span><span class="token punctuation">;</span>
      __ <span class="token function">call_VM</span><span class="token punctuation">(</span>noreg<span class="token punctuation">,</span> <span class="token function">CAST_FROM_FN_PTR</span><span class="token punctuation">(</span>address<span class="token punctuation">,</span> InterpreterRuntime<span class="token operator">::</span>profile_method<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      __ <span class="token function">set_method_data_pointer_for_bcp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// don't think we need this</span>
      __ <span class="token function">get_method</span><span class="token punctuation">(</span>r1<span class="token punctuation">)</span><span class="token punctuation">;</span>
      __ <span class="token function">b</span><span class="token punctuation">(</span>profile_method_continue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// Handle overflow of counter and compile method</span>
    __ <span class="token function">bind</span><span class="token punctuation">(</span>invocation_counter_overflow<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">generate_counter_overflow</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>continue_after_compile<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">return</span> entry_point<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä¸Šé¢çš„ä»£ç ä¸­åœ¨48è¡Œå¤„è°ƒç”¨äº†<code>generate_fixed_frame</code>ï¼Œä¸ºè§£é‡Šå™¨æ–¹æ³•ç”Ÿæˆæ ˆå¸§ï¼Œå¹¶ä¸”ä¼šåœ¨æ ˆä¸Šå­˜æ”¾åç»­æ–¹æ³•æ‰§è¡Œæ‰€éœ€è¦çš„å¸¸é‡æ± ï¼Œä»¥åŠåˆ†é…ç›®æ ‡æ‰§è¡Œæ–¹æ³•å†…éƒ¨çš„å±€éƒ¨å˜é‡æ‰€ä½¿ç”¨åˆ°çš„ç©ºé—´</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> TemplateInterpreterGenerator<span class="token operator">::</span><span class="token function">generate_fixed_frame</span><span class="token punctuation">(</span>bool native_call<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// initialize fixed part of activation frame</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>native_call<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    __ <span class="token function">sub</span><span class="token punctuation">(</span>esp<span class="token punctuation">,</span> sp<span class="token punctuation">,</span> <span class="token number">12</span> <span class="token operator">*</span>  wordSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    __ <span class="token function">mov</span><span class="token punctuation">(</span>rbcp<span class="token punctuation">,</span> zr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    __ <span class="token function">stp</span><span class="token punctuation">(</span>esp<span class="token punctuation">,</span> zr<span class="token punctuation">,</span> <span class="token function">Address</span><span class="token punctuation">(</span>__ <span class="token function">pre</span><span class="token punctuation">(</span>sp<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">12</span> <span class="token operator">*</span> wordSize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// add 2 zero-initialized slots for native calls</span>
    __ <span class="token function">stp</span><span class="token punctuation">(</span>zr<span class="token punctuation">,</span> zr<span class="token punctuation">,</span> <span class="token function">Address</span><span class="token punctuation">(</span>sp<span class="token punctuation">,</span> <span class="token number">10</span> <span class="token operator">*</span> wordSize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    __ <span class="token function">sub</span><span class="token punctuation">(</span>esp<span class="token punctuation">,</span> sp<span class="token punctuation">,</span> <span class="token number">10</span> <span class="token operator">*</span>  wordSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    __ <span class="token function">ldr</span><span class="token punctuation">(</span>rscratch1<span class="token punctuation">,</span> <span class="token function">Address</span><span class="token punctuation">(</span>rmethod<span class="token punctuation">,</span> Method<span class="token operator">::</span><span class="token function">const_offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// get ConstMethod</span>
    __ <span class="token function">add</span><span class="token punctuation">(</span>rbcp<span class="token punctuation">,</span> rscratch1<span class="token punctuation">,</span> <span class="token function">in_bytes</span><span class="token punctuation">(</span>ConstMethod<span class="token operator">::</span><span class="token function">codes_offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// get codebase</span>
    __ <span class="token function">stp</span><span class="token punctuation">(</span>esp<span class="token punctuation">,</span> rbcp<span class="token punctuation">,</span> <span class="token function">Address</span><span class="token punctuation">(</span>__ <span class="token function">pre</span><span class="token punctuation">(</span>sp<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">10</span> <span class="token operator">*</span> wordSize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>ProfileInterpreter<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    Label method_data_continue<span class="token punctuation">;</span>
    __ <span class="token function">ldr</span><span class="token punctuation">(</span>rscratch1<span class="token punctuation">,</span> <span class="token function">Address</span><span class="token punctuation">(</span>rmethod<span class="token punctuation">,</span> Method<span class="token operator">::</span><span class="token function">method_data_offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    __ <span class="token function">cbz</span><span class="token punctuation">(</span>rscratch1<span class="token punctuation">,</span> method_data_continue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    __ <span class="token function">lea</span><span class="token punctuation">(</span>rscratch1<span class="token punctuation">,</span> <span class="token function">Address</span><span class="token punctuation">(</span>rscratch1<span class="token punctuation">,</span> <span class="token function">in_bytes</span><span class="token punctuation">(</span>MethodData<span class="token operator">::</span><span class="token function">data_offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    __ <span class="token function">bind</span><span class="token punctuation">(</span>method_data_continue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    __ <span class="token function">stp</span><span class="token punctuation">(</span>rscratch1<span class="token punctuation">,</span> rmethod<span class="token punctuation">,</span> <span class="token function">Address</span><span class="token punctuation">(</span>sp<span class="token punctuation">,</span> <span class="token number">4</span> <span class="token operator">*</span> wordSize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// save Method* and mdp (method data pointer)</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    __ <span class="token function">stp</span><span class="token punctuation">(</span>zr<span class="token punctuation">,</span> rmethod<span class="token punctuation">,</span> <span class="token function">Address</span><span class="token punctuation">(</span>sp<span class="token punctuation">,</span> <span class="token number">4</span> <span class="token operator">*</span> wordSize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// save Method* (no mdp)</span>
  <span class="token punctuation">&#125;</span>

  __ <span class="token function">ldr</span><span class="token punctuation">(</span>rcpool<span class="token punctuation">,</span> <span class="token function">Address</span><span class="token punctuation">(</span>rmethod<span class="token punctuation">,</span> Method<span class="token operator">::</span><span class="token function">const_offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  __ <span class="token function">ldr</span><span class="token punctuation">(</span>rcpool<span class="token punctuation">,</span> <span class="token function">Address</span><span class="token punctuation">(</span>rcpool<span class="token punctuation">,</span> ConstMethod<span class="token operator">::</span><span class="token function">constants_offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  __ <span class="token function">ldr</span><span class="token punctuation">(</span>rcpool<span class="token punctuation">,</span> <span class="token function">Address</span><span class="token punctuation">(</span>rcpool<span class="token punctuation">,</span> ConstantPool<span class="token operator">::</span><span class="token function">cache_offset_in_bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  __ <span class="token function">stp</span><span class="token punctuation">(</span>rlocals<span class="token punctuation">,</span> rcpool<span class="token punctuation">,</span> <span class="token function">Address</span><span class="token punctuation">(</span>sp<span class="token punctuation">,</span> <span class="token number">2</span> <span class="token operator">*</span> wordSize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  __ <span class="token function">stp</span><span class="token punctuation">(</span>rfp<span class="token punctuation">,</span> lr<span class="token punctuation">,</span> <span class="token function">Address</span><span class="token punctuation">(</span>sp<span class="token punctuation">,</span> <span class="token number">8</span> <span class="token operator">*</span> wordSize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  __ <span class="token function">lea</span><span class="token punctuation">(</span>rfp<span class="token punctuation">,</span> <span class="token function">Address</span><span class="token punctuation">(</span>sp<span class="token punctuation">,</span> <span class="token number">8</span> <span class="token operator">*</span> wordSize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// set sender sp</span>
  <span class="token comment">// leave last_sp as null</span>
  __ <span class="token function">stp</span><span class="token punctuation">(</span>zr<span class="token punctuation">,</span> r13<span class="token punctuation">,</span> <span class="token function">Address</span><span class="token punctuation">(</span>sp<span class="token punctuation">,</span> <span class="token number">6</span> <span class="token operator">*</span> wordSize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Move SP out of the way</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> native_call<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    __ <span class="token function">ldr</span><span class="token punctuation">(</span>rscratch1<span class="token punctuation">,</span> <span class="token function">Address</span><span class="token punctuation">(</span>rmethod<span class="token punctuation">,</span> Method<span class="token operator">::</span><span class="token function">const_offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// </span>
    __ <span class="token function">ldrh</span><span class="token punctuation">(</span>rscratch1<span class="token punctuation">,</span> <span class="token function">Address</span><span class="token punctuation">(</span>rscratch1<span class="token punctuation">,</span> ConstMethod<span class="token operator">::</span><span class="token function">max_stack_offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    __ <span class="token function">add</span><span class="token punctuation">(</span>rscratch1<span class="token punctuation">,</span> rscratch1<span class="token punctuation">,</span> frame<span class="token operator">::</span><span class="token function">interpreter_frame_monitor_size</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
           <span class="token operator">+</span> <span class="token punctuation">(</span>EnableInvokeDynamic <span class="token operator">?</span> <span class="token number">2</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    __ <span class="token function">sub</span><span class="token punctuation">(</span>rscratch1<span class="token punctuation">,</span> sp<span class="token punctuation">,</span> rscratch1<span class="token punctuation">,</span> ext<span class="token operator">::</span>uxtw<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    __ <span class="token function">andr</span><span class="token punctuation">(</span>sp<span class="token punctuation">,</span> rscratch1<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<hr />
<p>æœ¬æ–‡åˆ°æ­¤ç»“æŸï¼Œå¯èƒ½æœ‰è¯¸å¤šçº°æ¼ä¹‹å¤„è¿˜è¯·æŒ‡æ­£</p>
]]></content>
      <categories>
        <category>æºç åˆ†æ</category>
        <category>hotspot</category>
      </categories>
      <tags>
        <tag>æºç </tag>
        <tag>JVM</tag>
      </tags>
  </entry>
  <entry>
    <title>Liunx Futex</title>
    <url>/posts/991d833e.html</url>
    <content><![CDATA[<h2 id="èƒŒæ™¯"><a class="markdownIt-Anchor" href="#èƒŒæ™¯"></a> èƒŒæ™¯</h2>
<p>å†™è¿™ç¯‡çš„æ–‡ç« çš„åŸå› æ˜¯å› ä¸ºåœ¨ç ”ç©¶ java çš„é‡é‡çº§é”ä¸­ç”¨åˆ°äº† <code>pthred_mutex_t</code>ä½œä¸ºäº’æ–¥é”ï¼Œ<code>pthred_mutex_t</code>ä¸­åŠ é”å‡½æ•°<code>pthread_mutex_lock</code>å½“ç«äº‰é”å¤±è´¥æ—¶ä¾¿ä¼šé€šè¿‡ç³»ç»Ÿè°ƒç”¨<code>futex_wait</code>å°†å½“å‰çº¿ç¨‹é˜»å¡ç­‰å¾…åˆ°å…¶å†…éƒ¨çš„æ¡ä»¶å˜é‡<code>__lock</code>ä¸Šï¼Œè®¾ç½®çº¿ç¨‹çš„çŠ¶æ€ä¸º<code>INTERRUPTABLE</code>ï¼Œå½“ä½¿ç”¨è§£é”å‡½æ•°<code>pthread_mutex_unlock</code>æ—¶ä¾¿ä¼šå°†<code>__lock</code>çš„å€¼æ”¹å˜ä¸º0ï¼Œç„¶åé€šè¿‡ç³»ç»Ÿè°ƒç”¨<code>futex_wake</code>å”¤é†’é˜»å¡ç­‰å¾…åœ¨æ¡ä»¶å˜é‡<code>__lock</code>ä¸Šçš„çº¿ç¨‹ï¼Œå°†çº¿ç¨‹çš„çŠ¶æ€æ”¹ä¸ºå¯è¿è¡ŒçŠ¶æ€ï¼Œå½“ç„¶ï¼Œä¸Šé¢çš„æµç¨‹æ˜¯çœ‹å®Œ<code>futex</code>çš„æºç åæ€»ç»“çš„ä¸€ä¸ªå¤§æ¦‚çš„æµç¨‹ï¼Œä¸ºäº†ææ¸…æ¥š<code>pthread_mutex_lock</code>å’Œ<code>pthread_mutex_unlock</code>åšäº†ä»€ä¹ˆï¼Œæˆ‘åªèƒ½æ·±ç©¶æºç ï¼Œè§£ç­”å¿ƒä¸­ç–‘æƒ‘</p>
<h2 id="é”"><a class="markdownIt-Anchor" href="#é”"></a> é”</h2>
<p>åœ¨ä»‹ç»<code>futex</code>ä¹‹å‰ï¼Œæˆ‘æƒ³å…ˆåœ¨javaå±‚é¢å»ä»‹ç»ä¸ºä»€ä¹ˆä¸åœ¨ç”¨æˆ·æ€å»å®ç°è‡ªå·±çš„é”æœºåˆ¶ï¼Œè¿™æ ·å°±èƒ½å¤Ÿé¿å…ç”±äºç³»ç»Ÿè°ƒç”¨å¯¼è‡´çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢çš„å¼€é”€ï¼Œå› ä¸ºæˆ‘åœ¨æ·±ç©¶æºç çš„è¿‡ç¨‹ä¸­ä¹Ÿå‡ºç°äº†ç±»ä¼¼çš„ç–‘æƒ‘ï¼Œæœå¯»äº†å¾ˆå¤šåšå®¢ä»¥åŠAIä½†æ˜¯å¹¶æœªç»™å‡ºæˆ‘æƒ³è¦çš„å›ç­”ï¼Œå½“çœ‹æ‡‚äº†<code>futex</code>çš„æºç åæˆ‘æ‰æ‡‚äº†ä¸ºä»€ä¹ˆä¸è¿™æ ·åšï¼Œæ¥ä¸‹æ¥è®©æˆ‘ä»¬å…ˆå°è¯•åœ¨javaå±‚é¢è®¾è®¡ä¸€ä¸ªè‡ªå·±çš„é”</p>
<h3 id="java-lock"><a class="markdownIt-Anchor" href="#java-lock"></a> Java Lock</h3>
<p>æˆ‘ä»¬å¯ä»¥æƒ³ä¸€ä¸‹å¸¸è§é”çš„æœºåˆ¶</p>
<ul>
<li><code>lock</code>å’Œ<code>unlock</code>ï¼šå¦‚æœåŠ é”æˆåŠŸå°±è¿”å›ï¼Œå¦‚æœå¤±è´¥å°±è¦èƒ½å¤Ÿé˜»å¡ç­‰å¾…ï¼Œä¸èƒ½ä¸€ç›´è‡ªæ—‹ç­‰å¾…é”çš„é‡Šæ”¾ï¼Œå½“æŒæœ‰é”çš„çº¿ç¨‹é‡Šæ”¾åå°±éœ€è¦å”¤é†’åœ¨é”ä¸Šé˜»å¡ç­‰å¾…çš„çº¿ç¨‹å»ç«äº‰é”</li>
<li><code>wait</code>å’Œ<code>notify</code>ï¼šå½“æŒæœ‰é”çš„çº¿ç¨‹æ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç°æŸä¸ªæ¡ä»¶ä¸æ»¡è¶³æ—¶ï¼Œå°±åº”è¯¥ä¸»åŠ¨çš„æ”¾å¼ƒé”çš„æŒæœ‰æƒï¼Œå¹¶ä¸”ç”±äºçº¿ç¨‹æ˜¯å› ä¸ºæ¡ä»¶ä¸æ»¡è¶³é‡Šæ”¾é”çš„ï¼Œæ‰€ä»¥å½“æ¡ä»¶ä¸æ»¡è¶³ä¹‹å‰éƒ½ä¸åº”è¯¥æ‹¥æœ‰ç«äº‰é”çš„æƒåŠ›ï¼Œç›´åˆ°æ¡ä»¶æ»¡è¶³æ—¶ç«äº‰åˆ°é”åå†å‘ä¸‹æ‰§è¡Œã€‚å½“æŸä¸ªçº¿ç¨‹è·å¾—é”åï¼Œæ”¹å˜æ¡ä»¶çš„çŠ¶æ€åä¾¿éœ€è¦å°†æ­£åœ¨è¯¥æ¡ä»¶ä¸Šé˜»å¡ç­‰å¾…çš„çº¿ç¨‹æå‡ä¸ºä¹Ÿèƒ½å¤Ÿæ­£å¸¸å‚ä¸ç«äº‰é”çš„çŠ¶æ€</li>
</ul>
<p>æ ¹æ®ä¸Šé¢çš„æœºåˆ¶ï¼Œå› æ­¤å°±æœ‰äº†å¦‚ä¸‹çš„ç®€å•å®ç°</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Lock</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">// é”å˜é‡ï¼Œ0æ— é” 1æœ‰é”</span>
	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AtomicBoolean</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicBoolean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// é”å˜é‡ï¼Œ0æ— é” 1æœ‰é”</span>
	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AtomicBoolean</span> entryLock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicBoolean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// é”å˜é‡ï¼Œ0æ— é” 1æœ‰é”</span>
	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AtomicBoolean</span> waitLock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicBoolean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// é”çš„æŒæœ‰è€…</span>
	<span class="token keyword">private</span> <span class="token class-name">Thread</span> owner<span class="token punctuation">;</span>
	<span class="token comment">// é‡å…¥æ¬¡æ•°</span>
	<span class="token keyword">private</span> <span class="token keyword">int</span> recurrences<span class="token punctuation">;</span>
	<span class="token comment">// è¿›å…¥åˆ°è¯¥é”ä¸­ç«äº‰é˜»å¡çš„çº¿ç¨‹é˜Ÿåˆ—</span>
	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Queue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Thread</span><span class="token punctuation">></span></span> entryList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Thread</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// ç­‰å¾…æ¡ä»¶å”¤é†’çš„ç­‰å¾…é˜Ÿåˆ—</span>
	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Queue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Thread</span><span class="token punctuation">></span></span> waitList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Thread</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	

	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
		<span class="token class-name">Thread</span> current <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>lock<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>owner <span class="token operator">==</span> current<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
				recurrences<span class="token operator">++</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span><span class="token punctuation">;</span>
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>lock<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
				owner <span class="token operator">=</span> current<span class="token punctuation">;</span>
				<span class="token keyword">return</span><span class="token punctuation">;</span>
			<span class="token punctuation">&#125;</span>
			<span class="token function">queueSpinLock</span><span class="token punctuation">(</span>entryLock<span class="token punctuation">)</span><span class="token punctuation">;</span>
			entryList<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">queueUnlock</span><span class="token punctuation">(</span>entryLock<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">wait</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>owner <span class="token operator">!=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
			<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalMonitorStateException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>recurrences <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
			recurrences<span class="token operator">--</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>
		owner <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
		lock<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// ä¸æ»¡è¶³æ—¶ï¼Œåº”è¯¥é˜»å¡ç­‰å¾…</span>
		<span class="token function">queueSpinLock</span><span class="token punctuation">(</span>entryLock<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">Thread</span> waitLockThread <span class="token operator">=</span> entryList<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">queueUnlock</span><span class="token punctuation">(</span>entryLock<span class="token punctuation">)</span><span class="token punctuation">;</span>
		entryLock<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>waitLockThread <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
			<span class="token function">wake</span><span class="token punctuation">(</span>waitLockThread<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token comment">// Objectçš„waitæ–¹æ³•ä¸å¯é‡å†™</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">wait0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
		<span class="token class-name">Thread</span> current <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>owner <span class="token operator">!=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
			<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalMonitorStateException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>

		<span class="token function">queueSpinLock</span><span class="token punctuation">(</span>entryLock<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">Thread</span> wokenThread <span class="token operator">=</span> entryList<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">queueUnlock</span><span class="token punctuation">(</span>entryLock<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">queueSpinLock</span><span class="token punctuation">(</span>waitLock<span class="token punctuation">)</span><span class="token punctuation">;</span>
		waitList<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">queueUnlock</span><span class="token punctuation">(</span>waitLock<span class="token punctuation">)</span><span class="token punctuation">;</span>
		owner <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
		lock<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">wake</span><span class="token punctuation">(</span>wokenThread<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">wait</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	
	<span class="token comment">// Objectçš„notifyæ–¹æ³•ä¸å¯é‡å†™</span>
	<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">notify0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>owner <span class="token operator">!=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
			<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalMonitorStateException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>
		<span class="token function">queueSpinLock</span><span class="token punctuation">(</span>waitLock<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">Thread</span> wokenThread <span class="token operator">=</span> waitList<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">queueUnlock</span><span class="token punctuation">(</span>waitLock<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>wokenThread <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
			<span class="token function">queueSpinLock</span><span class="token punctuation">(</span>entryLock<span class="token punctuation">)</span><span class="token punctuation">;</span>
			entryList<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>wokenThread<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">queueUnlock</span><span class="token punctuation">(</span>entryLock<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>


	<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">wait</span><span class="token punctuation">(</span><span class="token class-name">Thread</span> t<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
		<span class="token comment">// çº¿ç¨‹ç­‰å¾…ï¼Œè¿™é‡Œçš„å®ç°åœ¨javaå±‚é¢æ²¡æœ‰,ä¹Ÿå°±æ˜¯æˆ‘æœ¬å°èŠ‚æƒ³è®²çš„åœ°æ–¹</span>
		<span class="token comment">// é€šå¸¸ä½¿ç”¨ LockSupport.park(); æ¥å°†å½“å‰çº¿ç¨‹çŠ¶æ€ç½®ä¸ºä¸å¯è°ƒåº¦çŠ¶æ€</span>
		<span class="token comment">// javaå±‚é¢æ˜¯WAITINGï¼Œoså±‚é¢æ˜¯INTERRUPTABLE</span>
		<span class="token comment">// LockSupport.park();</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">wake</span><span class="token punctuation">(</span><span class="token class-name">Thread</span> t<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
		<span class="token comment">// çº¿ç¨‹å”¤é†’ï¼Œè¿™é‡Œçš„å®ç°javaå±‚é¢æ²¡æœ‰</span>
		<span class="token comment">// é€šå¸¸ä½¿ç”¨LockSupport.unpark(waitLockThread),å°†çº¿ç¨‹çŠ¶æ€ç½®ä¸ºå¯è¿è¡ŒçŠ¶æ€</span>
		<span class="token comment">// javaå±‚é¢æ˜¯RUNNABLEï¼Œoså±‚é¢æ˜¯RUNNING</span>
		<span class="token comment">// LockSupport.unpark(t);</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">queueSpinLock</span><span class="token punctuation">(</span><span class="token class-name">AtomicBoolean</span> lock<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
		<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>lock<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
				<span class="token keyword">return</span><span class="token punctuation">;</span>
			<span class="token punctuation">&#125;</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">queueUnlock</span><span class="token punctuation">(</span><span class="token class-name">AtomicBoolean</span> lock<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
		lock<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä¸Šé¢çš„ä»£ç æ˜¯ä¸€ä¸ªç®€å•çš„é”çš„å®ç°ï¼Œå°†<code>wait(Thread t)</code>å’Œ<code>wake(Thread t)</code>ä¸­åˆ†åˆ«ä½¿ç”¨çš„<code>LockSupport</code>å·¥å…·ç±»ä¸­çš„<code>park</code>å’Œ<code>unpark</code>æ–¹æ³•çš„æ³¨é‡Šæ‰“å¼€æ˜¯èƒ½å¤Ÿæ­£å¸¸å·¥ä½œçš„ï¼Œä½†æˆ‘è¿™é‡Œå´ä¸æƒ³ç”¨è¯¥ç±»ä¸­çš„æ–¹æ³•ï¼Œå¹¶ä¸”ä¹Ÿåœ¨æ³¨é‡Šè¯´æ˜äº†åŸå› ï¼Œå› ä¸ºè¯¥æ–¹æ³•åº•å±‚ä¼šè¿›è¡Œç³»ç»Ÿè°ƒç”¨ä»è€Œä¼šå¯¼è‡´çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œæœ¬å°èŠ‚å¼€å¤´å°±è¯´æƒ³åœ¨ç”¨æˆ·æ€å®ç°çº¿ç¨‹ä¹‹é—´çš„é€šä¿¡æœºåˆ¶ï¼Œé¿å…ç³»ç»Ÿè°ƒç”¨çš„å¼€é”€ï¼Œè®©æˆ‘ä»¬æ¥æƒ³æƒ³åœ¨ç”¨æˆ·æ€æ€ä¹ˆæ‰èƒ½å¤Ÿåšåˆ°</p>
<ul>
<li>è¦æƒ³å½“é”æ¡ä»¶ä¸æ»¡è¶³æ—¶è®©å‡ºcpuçš„æ‰§è¡Œæƒä½†åˆé¿å…ç³»ç»Ÿè°ƒç”¨çš„å¼€é”€ï¼Œé‚£ä¹ˆç”¨æˆ·æ€å°±å¿…é¡»èƒ½å¤Ÿè°ƒåº¦çº¿ç¨‹çš„è¿è¡Œï¼Œè¿™æ˜¾ç„¶æ˜¯ä¸å®‰å…¨çš„ï¼Œæ¶æ„è¿›ç¨‹å¯ä»¥æ°¸è¿œåªè°ƒåº¦è‡ªå·±çš„çº¿ç¨‹ï¼Œè€Œå¯¼è‡´å…¶ä»–çº¿ç¨‹é¥¥é¥¿ï¼Œå°±è¿™ä¸€ç‚¹å°±è¶³ä»¥å¦å†³è¿™ç§ä¼˜åŒ–æ•ˆç‡çš„ææ¡ˆ</li>
</ul>
<h2 id="ä»‹ç»"><a class="markdownIt-Anchor" href="#ä»‹ç»"></a> ä»‹ç»</h2>
<p>åœ¨Liunx å†…æ ¸ä¸­æä¾›äº†ä¸€ç§å¿«é€Ÿæ£€æŸ¥é”å†²çªçš„ç³»ç»Ÿè°ƒç”¨ï¼Œç§°ä¸º<code>Fast Userspace Mutex</code> ç®€ç§° <code>Futex</code>ï¼Œå®ƒé¿å…äº†å½“é”æœªå†²çªæ—¶ä¹Ÿéœ€è¦é™·å…¥åˆ°å†…æ ¸æ€å®ŒæˆåŠ é”æ“ä½œå†åˆ‡æ¢åˆ°ç”¨æˆ·æ€çš„å¼€é”€ï¼Œåªæœ‰å½“é”å†²çªæ—¶ï¼Œç«äº‰é”çš„çº¿ç¨‹æ‰éœ€è¦é™·å…¥å†…æ ¸æ€å»é˜»å¡ç­‰å¾…é”çš„é‡Šæ”¾</p>
<p><code>futex</code>æä¾›äº†ä¸¤ä¸ªå…³é”®çš„æ–¹æ³•ï¼Œä»è€Œæ”¯æŒäº†å½“ç”¨æˆ·æ€æ£€æµ‹åˆ°é”å†²çªæ—¶å¯ä»¥é˜»å¡ç«äº‰é”çš„çº¿ç¨‹ï¼Œå½“é”è¢«æŒæœ‰è€…é‡Šæ”¾äº†å†å”¤é†’é˜»å¡ç­‰å¾…çš„çº¿ç¨‹ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•åˆ†åˆ«æ˜¯ï¼š</p>
<ul>
<li><code>futex_wait(u32 __user *uaddr, unsigned int flags, u32 val, ktime_t *abs_time, u32 bitset)</code> <a href="https://elixir.bootlin.com/linux/v4.0/source/kernel/futex.c#L2164">æºç é“¾æ¥</a>
<ul>
<li><code>*uaddr</code>ï¼šæŒ‡å‘ç”¨æˆ·ç©ºé—´é”å˜é‡åœ°å€çš„æŒ‡é’ˆ</li>
<li><code>flags</code>ï¼šé”æ ‡å¿—ä½
<ul>
<li><code>FLAGS_SHARED = 0x01</code>ï¼šæ˜¯å¦å¤šä¸ªè¿›ç¨‹å…±äº« <code>0: PRIVATE 1: SHARED</code></li>
<li><code>FLAGS_CLOCKRT = 0x02</code>ï¼šæ˜¯å¦é‡‡ç”¨å®æ—¶æ—¶é’Ÿæ¥ä¸ºå…¶è®¾ç½®è¶…æ—¶æ—¶é—´</li>
<li><code>FLAGS_HAS_TIMEOUT = 0x04</code>ï¼šæ˜¯å¦éœ€è¦è¶…æ—¶å”¤é†’</li>
</ul>
</li>
<li><code>val</code>ï¼šé”å˜é‡å€¼ï¼Œå¦‚æœå’Œ<code>*uaddr</code>å€¼ç›¸ç­‰å°±é˜»å¡ç­‰å¾…ï¼Œä¸ç›¸ç­‰è¯´æ˜æœ‰å…¶ä»–è¿›ç¨‹å·²ç»ä¿®æ”¹äº†è¯¥å€¼ï¼Œé‚£ä¹ˆä¼šç›´æ¥è¿”å›</li>
<li><code>abs_time</code>ï¼šè®¾ç½®è¶…æ—¶å”¤é†’çš„ç»å¯¹æ—¶é—´</li>
<li><code>bitset</code>ï¼šè®¾ç½®ä½æ©ç ï¼Œåªæœ‰å½“<code>*uaddr</code>æŒ‡å‘çš„å€¼çš„æŸä½å‘ç”Ÿå˜æ›´æ‰è¢«å”¤é†’</li>
</ul>
</li>
<li><code>futex_wake(u32 __user *uaddr, unsigned int flags, int nr_wake, u32 bitset)</code> <a href="https://elixir.bootlin.com/linux/v4.0/source/kernel/futex.c#L1214">æºç é“¾æ¥</a>
<ul>
<li><code>*uaddr</code>ï¼šå”¤é†’åœ¨æŒ‡å®šç”¨æˆ·ç©ºé—´åœ°å€æŒ‡é’ˆä¸Šé˜»å¡ç­‰å¾…çš„çº¿ç¨‹</li>
<li><code>flags</code>ï¼š
<ul>
<li><code>FLAGS_SHARED = 0x01</code>ï¼šæ˜¯å¦å¤šä¸ªè¿›ç¨‹å…±äº« <code>0: PRIVATE 1: SHARED</code></li>
</ul>
</li>
<li><code>nr_wake</code>ï¼šå”¤é†’æŒ‡å®šæ•°é‡çš„çº¿ç¨‹</li>
<li><code>bitset</code>ï¼šç”¨äºæ¯”è¾ƒåœ¨è°ƒç”¨<code>futex_wait</code>ä¼ å…¥çš„<code>bitset</code>çš„å€¼æ˜¯å¦å‘ç”Ÿå˜åŒ–ï¼Œå¦‚æœæ²¡æœ‰å‘ç”Ÿå˜åŒ–åˆ™ä¸å”¤é†’</li>
</ul>
</li>
</ul>
<p>ä¸Šé¢ä»‹ç»äº†ä¸¤ä¸ªå‡½æ•°ä»¥åŠå‚æ•°çš„ä½œç”¨ï¼Œæ¥ä¸‹æ¥è®©æˆ‘ä»¬å»æ¢ç©¶æºç ï¼Œçœ‹çœ‹æ˜¯å¦‚ä½•å®ç°çš„</p>
<blockquote>
<p>åœ¨çº¿æºç  <a href="https://elixir.bootlin.com/linux/v4.0/source/kernel/futex.c#L2053">futex.c - kernel/futex.c - Linux source code v4.0 - Bootlin Elixir Cross Referencer</a></p>
</blockquote>
<h2 id="futex_wait-æºç è§£æ"><a class="markdownIt-Anchor" href="#futex_wait-æºç è§£æ"></a> futex_wait æºç è§£æ</h2>
<h3 id="æºç æµç¨‹æ—¶åºå›¾"><a class="markdownIt-Anchor" href="#æºç æµç¨‹æ—¶åºå›¾"></a> æºç æµç¨‹æ—¶åºå›¾</h3>
<img src="/posts/991d833e/futex_wait.svg" class="" title="futex_wait">
<p>ä¸Šé¢æ˜¯<code>futex_wait</code>çš„æ‰§è¡Œæ—¶åºï¼Œç›´è§‚äº†è§£ä¸€ä¸‹æ•´ä¸ªçš„æ‰§è¡Œè¿‡ç¨‹ï¼Œä¸‹é¢æ·±ç©¶æºç ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹äº’æ–¥é”çš„åº•å±‚å®ç°</p>
<blockquote>
<p>æ³¨æ„ï¼Œæœ¬æ–‡æ‰€è¯´çš„è¿›ç¨‹è¯­ä¹‰å…¶å®å°±æ˜¯çº¿ç¨‹ï¼Œåœ¨<code>liunx</code>ä¸­çº¿ç¨‹å’Œè¿›ç¨‹å…±ç”¨ä¸€ä¸ªç»“æ„ä½“<code>task_struct</code>ï¼Œé€šè¿‡å†…éƒ¨çš„ä¸¤ä¸ªå±æ€§<code>pid</code>å’Œ<code>tgid</code>æ¥åŒºåˆ†çº¿ç¨‹ä¸è¿›ç¨‹<br />
å¦‚æœ <code>pid == tgid</code>æ˜¯è¿›ç¨‹ï¼Œå¦åˆ™å°±æ˜¯çº¿ç¨‹</p>
</blockquote>
<h3 id="futex_wait"><a class="markdownIt-Anchor" href="#futex_wait"></a> futex_wait</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">futex_wait</span><span class="token punctuation">(</span>u32 __user <span class="token operator">*</span>uaddr<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> u32 val<span class="token punctuation">,</span>
		      <span class="token class-name">ktime_t</span> <span class="token operator">*</span>abs_time<span class="token punctuation">,</span> u32 bitset<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token comment">// å¦‚æœè®¾ç½®äº†ç­‰å¾…æ—¶é—´ï¼Œå°†ç”±å®šæ—¶å™¨å”¤é†’è¯¥ç­‰å¾…çš„è¿›ç¨‹</span>
	<span class="token keyword">struct</span> <span class="token class-name">hrtimer_sleeper</span> timeout<span class="token punctuation">,</span> <span class="token operator">*</span>to <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">restart_block</span> <span class="token operator">*</span>restart<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">futex_hash_bucket</span> <span class="token operator">*</span>hb<span class="token punctuation">;</span>
	<span class="token comment">// åˆå§‹åŒ– futex_q , futex_q æ˜¯ç­‰å¾…é˜Ÿåˆ—ä¸­çš„å…ƒç´ ç±»å‹</span>
	<span class="token keyword">struct</span> <span class="token class-name">futex_q</span> q <span class="token operator">=</span> futex_q_init<span class="token punctuation">;</span>
	<span class="token keyword">int</span> ret<span class="token punctuation">;</span>
	<span class="token comment">// é€šå¸¸æ˜¯ 0xffffffffï¼Œåœ¨è°ƒç”¨futex_wakeæ—¶ä¼šåˆ¤æ–­uaddrçš„å€¼çš„bit mask æ˜¯å¦å‘ç”Ÿæ”¹å˜ä»è€Œå†³å®šæ˜¯å¦å”¤é†’</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bitset<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
	q<span class="token punctuation">.</span>bitset <span class="token operator">=</span> bitset<span class="token punctuation">;</span>
	<span class="token comment">// è®¾ç½®äº†è¶…æ—¶æ—¶é—´ï¼Œå½“è¾¾åˆ°äº†è¶…æ—¶æ—¶é—´ä¼šç”± hrtimeræ¥é‡æ–°è°ƒåº¦çº¿ç¨‹</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>abs_time<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		to <span class="token operator">=</span> <span class="token operator">&amp;</span>timeout<span class="token punctuation">;</span>
		<span class="token function">hrtimer_init_on_stack</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>to<span class="token operator">-></span>timer<span class="token punctuation">,</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> FLAGS_CLOCKRT<span class="token punctuation">)</span> <span class="token operator">?</span>
				      CLOCK_REALTIME <span class="token operator">:</span> CLOCK_MONOTONIC<span class="token punctuation">,</span>
				      HRTIMER_MODE_ABS<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">hrtimer_init_sleeper</span><span class="token punctuation">(</span>to<span class="token punctuation">,</span> current<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">hrtimer_set_expires_range_ns</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>to<span class="token operator">-></span>timer<span class="token punctuation">,</span> <span class="token operator">*</span>abs_time<span class="token punctuation">,</span>
					     current<span class="token operator">-></span>timer_slack_ns<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

retry<span class="token operator">:</span>
	<span class="token comment">/*
	 * Prepare to wait on uaddr. On success, holds hb lock and increments
	 * q.key refs.
	 */</span>
	<span class="token comment">// ä¸»è¦æ˜¯åšå‰ç½®æ“ä½œ</span>
	<span class="token comment">// 1. å¯¹futex_qæ‰€è¦å­˜æ”¾çš„ç­‰å¾…é˜Ÿåˆ—åŠ é”</span>
	<span class="token comment">// 2. å°†å­˜æ”¾çš„ç­‰å¾…é˜Ÿåˆ—çš„æŒ‡é’ˆèµ‹å€¼ç»™ hb åœ°å€</span>
	<span class="token comment">// 3. åˆ¤æ–­uaddrçš„å€¼æ˜¯å¦ç­‰äºvalï¼Œå¦‚æœç­‰äºï¼Œé‚£ä¹ˆè¯´æ˜æ²¡æœ‰å…¶ä»–è¿›ç¨‹å¯¹è¯¥åœ°å€çš„å€¼åšæ›´æ”¹,è¿”å›0ï¼Œå¦åˆ™é0</span>
	ret <span class="token operator">=</span> <span class="token function">futex_wait_setup</span><span class="token punctuation">(</span>uaddr<span class="token punctuation">,</span> val<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> <span class="token operator">&amp;</span>q<span class="token punctuation">,</span> <span class="token operator">&amp;</span>hb<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
		<span class="token comment">// é0ï¼Œç›´æ¥è·³è½¬åˆ°out</span>
		<span class="token keyword">goto</span> out<span class="token punctuation">;</span>
	<span class="token comment">/* queue_me and wait for wakeup, timeout, or a signal. */</span>
	<span class="token comment">// å°† futex_q å…¥é˜Ÿï¼Œå¹¶ä¸”å°†å½“å‰è¿›ç¨‹è®¾ç½®ä¸ºä¸å¯è°ƒåº¦çŠ¶æ€ï¼Œç„¶åä¼šé‡æ–°å¼€å§‹è°ƒåº¦è¿›ç¨‹</span>
	<span class="token function">futex_wait_queue_me</span><span class="token punctuation">(</span>hb<span class="token punctuation">,</span> <span class="token operator">&amp;</span>q<span class="token punctuation">,</span> to<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// æ‰§è¡Œåˆ°è¿™é‡Œå°±æ˜¯è¢«å”¤é†’äº†</span>
	<span class="token comment">/* If we were woken (and unqueued), we succeeded, whatever. */</span>
	ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token comment">/* unqueue_me() drops q.key ref */</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">unqueue_me</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>q<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token comment">// æ˜¯è¢«å…¶ä»–è¿›ç¨‹å”¤é†’çš„ï¼Œç›´æ¥è·³è½¬åˆ° out</span>
		<span class="token keyword">goto</span> out<span class="token punctuation">;</span>
	
	<span class="token comment">// å¯èƒ½æ˜¯è¢«å®šæ—¶å™¨ç»™å”¤é†’çš„</span>
	ret <span class="token operator">=</span> <span class="token operator">-</span>ETIMEDOUT<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>to <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>to<span class="token operator">-></span>task<span class="token punctuation">)</span>
		<span class="token comment">// è®¾ç½®äº†å®šæ—¶å™¨ï¼Œå¹¶ä¸”å®šæ—¶ä»»åŠ¡å·²ç»æ‰§è¡Œäº†ï¼Œé‚£ä¹ˆå°±æ˜¯è¢«å®šæ—¶ä»»åŠ¡å”¤é†’çš„ï¼Œç›´æ¥è°ƒæ¢åˆ°out</span>
		<span class="token keyword">goto</span> out<span class="token punctuation">;</span>

	<span class="token comment">/*
	 * We expect signal_pending(current), but we might be the
	 * victim of a spurious wakeup as well.
	 */</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">signal_pending</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token comment">// ä¸æ˜¯è¢«ä¿¡å·å”¤é†’çš„,è¯´æ˜æ˜¯è™šå‡å”¤é†’ï¼Œé‡æ–°é˜»å¡ç­‰å¾…</span>
		<span class="token keyword">goto</span> retry<span class="token punctuation">;</span>
	<span class="token comment">// æ˜¯è¢«ä¿¡å·å”¤é†’çš„</span>
	ret <span class="token operator">=</span> <span class="token operator">-</span>ERESTARTSYS<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>abs_time<span class="token punctuation">)</span>
		<span class="token keyword">goto</span> out<span class="token punctuation">;</span>
	<span class="token comment">// å’Œä¿¡å·æœ‰å…³ï¼Œä½†ä¸å¤ªäº†è§£</span>
	restart <span class="token operator">=</span> <span class="token operator">&amp;</span>current<span class="token operator">-></span>restart_block<span class="token punctuation">;</span>
	restart<span class="token operator">-></span>fn <span class="token operator">=</span> futex_wait_restart<span class="token punctuation">;</span>
	restart<span class="token operator">-></span>futex<span class="token punctuation">.</span>uaddr <span class="token operator">=</span> uaddr<span class="token punctuation">;</span>
	restart<span class="token operator">-></span>futex<span class="token punctuation">.</span>val <span class="token operator">=</span> val<span class="token punctuation">;</span>
	restart<span class="token operator">-></span>futex<span class="token punctuation">.</span>time <span class="token operator">=</span> abs_time<span class="token operator">-></span>tv64<span class="token punctuation">;</span>
	restart<span class="token operator">-></span>futex<span class="token punctuation">.</span>bitset <span class="token operator">=</span> bitset<span class="token punctuation">;</span>
	restart<span class="token operator">-></span>futex<span class="token punctuation">.</span>flags <span class="token operator">=</span> flags <span class="token operator">|</span> FLAGS_HAS_TIMEOUT<span class="token punctuation">;</span>

	ret <span class="token operator">=</span> <span class="token operator">-</span>ERESTART_RESTARTBLOCK<span class="token punctuation">;</span>

out<span class="token operator">:</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>to<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token comment">// è®¾ç½®äº†å®šæ—¶ä»»åŠ¡ï¼Œå°†å…¶å–æ¶ˆ</span>
		<span class="token function">hrtimer_cancel</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>to<span class="token operator">-></span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">destroy_hrtimer_on_stack</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>to<span class="token operator">-></span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token comment">// è¿”å›æ‰§è¡Œç»“æœ</span>
	<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä¸Šé¢çš„æ³¨é‡Šå·²ç»éƒ½è§£é‡Šäº†æ¯è¡Œä»£ç çš„ç”¨é€”ï¼Œè¿™é‡Œæ€»ç»“ä¸€ä¸‹</p>
<ol>
<li>å¦‚æœè®¾ç½®äº†è¶…æ—¶å”¤é†’ï¼Œé‚£ä¹ˆå°±ä¼šä¸ºå…¶è®¾ç½®ä¸€ä¸ªå®šæ—¶å™¨ï¼Œå½“è¶…è¿‡æŒ‡å®šçš„æ—¶é—´åå®šæ—¶å™¨å°±ä¼šå”¤é†’è¯¥è¿›ç¨‹</li>
<li>æ‰§è¡Œ<code>futex_wait_setup</code>æ–¹æ³•ï¼Œå®Œæˆå°†å½“å‰è¿›ç¨‹æ‰€å…³è”çš„<code>futex_q</code>å¯¹è±¡æ’å…¥åˆ°ç­‰å¾…é˜Ÿåˆ—ä¹‹å‰çš„åˆå§‹åŒ–å·¥ä½œï¼Œå¹¶ä¸”åˆ¤æ–­å®ƒçš„è¿”å›å€¼ï¼Œå¦‚æœæ˜¯é0ï¼Œé‚£ä¹ˆè¯´æ˜<code>uaddr</code>åœ°å€çš„å€¼å·²ç»è¢«æ›´æ”¹äº†ï¼Œç›´æ¥è¿”å›é€€å‡ºæ‰§è¡Œ</li>
<li>æ‰§è¡Œ<code>futex_wait_queue_me</code>æ–¹æ³•ï¼Œæ‰§è¡ŒçœŸæ­£çš„æ’å…¥ç­‰å¾…é˜Ÿåˆ—çš„æ“ä½œå¹¶ä¸”å°†å½“å‰è¿›ç¨‹è®¾ç½®ä¸ºä¸å¯è°ƒåº¦çš„çŠ¶æ€ï¼Œç„¶åæ‰§è¡Œè°ƒåº¦è¿›ç¨‹<code>schedule</code>å‡½æ•°</li>
<li>è¢«å”¤é†’äº†ï¼Œå°±æ£€æŸ¥æ˜¯ä»€ä¹ˆåŸå› å”¤é†’çš„å½“å‰è¿›ç¨‹ï¼Œå¹¶ä¸”è¿”å›å¯¹åº”çš„è¿”å›å€¼ï¼Œå¦‚æœæ˜¯0å°±è¯´æ˜æ˜¯è¢«å…¶ä»–è¿›ç¨‹è°ƒç”¨<code>futex_wake</code>å”¤é†’çš„</li>
</ol>
<p>okï¼Œæ€»ç»“äº†ä¸€ä¸‹æµç¨‹ï¼Œæ¥ä¸‹æ¥è®©æˆ‘ä»¬å…·ä½“çš„çœ‹ä¸‹è¿™äº›æ–¹æ³•åšäº†ä»€ä¹ˆæ“ä½œ</p>
<h3 id="futex_wait_setup"><a class="markdownIt-Anchor" href="#futex_wait_setup"></a> futex_wait_setup</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">futex_wait_setup</span><span class="token punctuation">(</span>u32 __user <span class="token operator">*</span>uaddr<span class="token punctuation">,</span> u32 val<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span>
			   <span class="token keyword">struct</span> <span class="token class-name">futex_q</span> <span class="token operator">*</span>q<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">futex_hash_bucket</span> <span class="token operator">*</span><span class="token operator">*</span>hb<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	u32 uval<span class="token punctuation">;</span>
	<span class="token keyword">int</span> ret<span class="token punctuation">;</span>

	<span class="token comment">/*
	 * Access the page AFTER the hash-bucket is locked.
	 * Order is important:
	 *
	 *   Userspace waiter: val = var; if (cond(val)) futex_wait(&amp;var, val);
	 *   Userspace waker:  if (cond(var)) &#123; var = new; futex_wake(&amp;var); &#125;
	 *
	 * The basic logical guarantee of a futex is that it blocks ONLY
	 * if cond(var) is known to be true at the time of blocking, for
	 * any cond.  If we locked the hash-bucket after testing *uaddr, that
	 * would open a race condition where we could block indefinitely with
	 * cond(var) false, which would violate the guarantee.
	 *
	 * On the other hand, we insert q and release the hash-bucket only
	 * after testing *uaddr.  This guarantees that futex_wait() will NOT
	 * absorb a wakeup if *uaddr does not match the desired values
	 * while the syscall executes.
	 */</span>
retry<span class="token operator">:</span>
	<span class="token comment">// é€šè¿‡uaddræ¥è®¡ç®—å¹¶åˆå§‹åŒ–futex_qçš„key</span>
	ret <span class="token operator">=</span> <span class="token function">get_futex_key</span><span class="token punctuation">(</span>uaddr<span class="token punctuation">,</span> flags <span class="token operator">&amp;</span> FLAGS_SHARED<span class="token punctuation">,</span> <span class="token operator">&amp;</span>q<span class="token operator">-></span>key<span class="token punctuation">,</span> VERIFY_READ<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unlikely</span><span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> ret<span class="token punctuation">;</span>

retry_private<span class="token operator">:</span>
	<span class="token comment">// å¯¹futex_qå°†è¦å­˜æ”¾çš„ç­‰å¾…é˜Ÿåˆ—åŠ é”ï¼Œå¹¶è¿”å›è¿™ä¸ªç­‰å¾…é˜Ÿåˆ—çš„æŒ‡é’ˆ</span>
	<span class="token operator">*</span>hb <span class="token operator">=</span> <span class="token function">queue_lock</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// å°†åœ¨ç”¨æˆ·ç©ºé—´ä¸­uaddråœ°å€çš„å€¼æ‹·è´åˆ°å†…æ ¸ç©ºé—´ä¸­çš„uvalåœ°å€ä½ç½®</span>
	ret <span class="token operator">=</span> <span class="token function">get_futex_value_locked</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>uval<span class="token punctuation">,</span> uaddr<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token comment">// æ‹·è´å¤±è´¥ï¼Œé‡Šæ”¾é˜Ÿåˆ—é”</span>
		<span class="token function">queue_unlock</span><span class="token punctuation">(</span><span class="token operator">*</span>hb<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// å†æ¬¡ä»ç”¨æˆ·ç©ºé—´ä¸­å°†uaddråœ°å€çš„å€¼æ‹·è´åˆ°uval</span>
		ret <span class="token operator">=</span> <span class="token function">get_user</span><span class="token punctuation">(</span>uval<span class="token punctuation">,</span> uaddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
			<span class="token comment">// æ‹·è´å¤±è´¥ï¼Œè·³è½¬åˆ°outå¤„</span>
			<span class="token keyword">goto</span> out<span class="token punctuation">;</span>
		<span class="token comment">// æ‹·è´æˆåŠŸ,é‡è¯•</span>
		<span class="token keyword">goto</span> retry_private<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>uval <span class="token operator">!=</span> val<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token comment">// å¦‚æœå€¼ä¸ç›¸ç­‰äº†ï¼Œè¯´æ˜å·²ç»æœ‰è¿›ç¨‹(æ­¤å¤„å…¶å®æ˜¯çº¿ç¨‹)ä¿®æ”¹äº†é”å˜é‡åœ°å€ä¸­çš„å€¼</span>
		<span class="token function">queue_unlock</span><span class="token punctuation">(</span><span class="token operator">*</span>hb<span class="token punctuation">)</span><span class="token punctuation">;</span>
		ret <span class="token operator">=</span> <span class="token operator">-</span>EWOULDBLOCK<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

out<span class="token operator">:</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
		<span class="token comment">// å¤„ç†å¤šè¿›ç¨‹å…±äº«é”åœ°å€çš„é€»è¾‘ï¼Œå†…éƒ¨å¯¹ç§æœ‰è¿›ç¨‹é”æ˜¯ä¸ä¼šå¤„ç†çš„</span>
		<span class="token function">put_futex_key</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>q<span class="token operator">-></span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span>
<span class="token function">get_futex_key</span><span class="token punctuation">(</span>u32 __user <span class="token operator">*</span>uaddr<span class="token punctuation">,</span> <span class="token keyword">int</span> fshared<span class="token punctuation">,</span> <span class="token keyword">union</span> futex_key <span class="token operator">*</span>key<span class="token punctuation">,</span> <span class="token keyword">int</span> rw<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> address <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span>uaddr<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">mm_struct</span> <span class="token operator">*</span>mm <span class="token operator">=</span> current<span class="token operator">-></span>mm<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">page</span> <span class="token operator">*</span>page<span class="token punctuation">,</span> <span class="token operator">*</span>page_head<span class="token punctuation">;</span>
	<span class="token keyword">int</span> err<span class="token punctuation">,</span> ro <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

	<span class="token comment">/*
	 * The futex address must be "naturally" aligned.
	 */</span>
	<span class="token comment">// è®¡ç®— uaddr åœ¨å†…å­˜é¡µå†…åç§»é‡</span>
	key<span class="token operator">-></span>both<span class="token punctuation">.</span>offset <span class="token operator">=</span> address <span class="token operator">%</span> PAGE_SIZE<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unlikely</span><span class="token punctuation">(</span><span class="token punctuation">(</span>address <span class="token operator">%</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
	<span class="token comment">// è®¡ç®—å¾—åˆ° uaddr æ‰€åœ¨å†…å­˜é¡µçš„é¦–åœ°å€</span>
	address <span class="token operator">-=</span> key<span class="token operator">-></span>both<span class="token punctuation">.</span>offset<span class="token punctuation">;</span>
	<span class="token comment">// åˆ¤æ–­æ˜¯å¦å¯ä»¥è®¿é—®</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unlikely</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">access_ok</span><span class="token punctuation">(</span>rw<span class="token punctuation">,</span> uaddr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token operator">-</span>EFAULT<span class="token punctuation">;</span>

	<span class="token comment">/*
	 * PROCESS_PRIVATE futexes are fast.
	 * As the mm cannot disappear under us and the 'key' only needs
	 * virtual address, we dont even have to find the underlying vma.
	 * Note : We do have to check 'uaddr' is a valid user address,
	 *        but access_ok() should be faster than find_vma()
	 */</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fshared<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token comment">// å¤„ç†ç§æœ‰è¿›ç¨‹é”ï¼Œé€šå¸¸æ˜¯èµ°è¿™ä¸ªé€»è¾‘</span>
		key<span class="token operator">-></span>private<span class="token punctuation">.</span>mm <span class="token operator">=</span> mm<span class="token punctuation">;</span> <span class="token comment">// å†…å­˜ç»“æ„å¯¹è±¡</span>
		key<span class="token operator">-></span>private<span class="token punctuation">.</span>address <span class="token operator">=</span> address<span class="token punctuation">;</span> <span class="token comment">// åœ°å€</span>
		<span class="token comment">// é’ˆå¯¹ç§æœ‰è¿›ç¨‹é”å°±æ˜¯å¢åŠ å†…å­˜å±éšœçš„ä½œç”¨,ä¿è¯ä¸Šé¢æŒ‡ä»¤ä»¥åŠåœ¨è¯¥å‡½æ•°ä¹‹åçš„æŒ‡ä»¤é¡ºåºæ€§</span>
		<span class="token function">get_futex_key_refs</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">/* implies MB (B) */</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token comment">// å¤šè¿›ç¨‹å…±äº«é”é€»è¾‘ çœç•¥</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token comment">/* The key must be already stored in q->key. */</span>
<span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">struct</span> <span class="token class-name">futex_hash_bucket</span> <span class="token operator">*</span><span class="token function">queue_lock</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">futex_q</span> <span class="token operator">*</span>q<span class="token punctuation">)</span>
	<span class="token function">__acquires</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hb<span class="token operator">-></span>lock<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token keyword">struct</span> <span class="token class-name">futex_hash_bucket</span> <span class="token operator">*</span>hb<span class="token punctuation">;</span>
	<span class="token comment">// è·å–futex_qæ‰€åœ¨çš„é“¾è¡¨ futex_qæ˜¯åœ¨ä¸€ä¸ªhashæ•°ç»„ä¸­çš„é“¾è¡¨ä¸Š</span>
	hb <span class="token operator">=</span> <span class="token function">hash_futex</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>q<span class="token operator">-></span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/*
	 * Increment the counter before taking the lock so that
	 * a potential waker won't miss a to-be-slept task that is
	 * waiting for the spinlock. This is safe as all queue_lock()
	 * users end up calling queue_me(). Similarly, for housekeeping,
	 * decrement the counter at queue_unlock() when some error has
	 * occurred and we don't end up adding the task to the list.
	 */</span>
	<span class="token comment">// åŸå­æ€§çš„å¢åŠ ä¸€ä¸ªç­‰å¾…è¿›ç¨‹çš„æ•°é‡</span>
	<span class="token function">hb_waiters_inc</span><span class="token punctuation">(</span>hb<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// å°†futex_qçš„é”æŒ‡é’ˆæŒ‡å‘å®ƒè¦å­˜æ”¾çš„ç­‰å¾…é˜Ÿåˆ—çš„é”ï¼Œå› ä¸ºæ¥ä¸‹æ¥åœ¨è¯¥é˜Ÿåˆ—ä¸Šåšæ“ä½œ,è¦ä¿è¯çº¿ç¨‹å®‰å…¨</span>
	q<span class="token operator">-></span>lock_ptr <span class="token operator">=</span> <span class="token operator">&amp;</span>hb<span class="token operator">-></span>lock<span class="token punctuation">;</span>
	<span class="token comment">// ç»™ç­‰å¾…é˜Ÿåˆ—åŠ è‡ªæ—‹é”</span>
	<span class="token function">spin_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hb<span class="token operator">-></span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* implies MB (A) */</span>
	<span class="token keyword">return</span> hb<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token function">queue_unlock</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">futex_hash_bucket</span> <span class="token operator">*</span>hb<span class="token punctuation">)</span>
	<span class="token function">__releases</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hb<span class="token operator">-></span>lock<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token function">spin_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hb<span class="token operator">-></span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">hb_waiters_dec</span><span class="token punctuation">(</span>hb<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">get_futex_value_locked</span><span class="token punctuation">(</span>u32 <span class="token operator">*</span>dest<span class="token punctuation">,</span> u32 __user <span class="token operator">*</span>from<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token keyword">int</span> ret<span class="token punctuation">;</span>

	<span class="token function">pagefault_disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// å°†åœ¨ç”¨æˆ·ç©ºé—´ä¸­formåœ°å€çš„å€¼æ‹·è´åˆ°å†…æ ¸ç©ºé—´ä¸­çš„deståœ°å€ä½ç½®</span>
	ret <span class="token operator">=</span> <span class="token function">__copy_from_user_inatomic</span><span class="token punctuation">(</span>dest<span class="token punctuation">,</span> from<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">pagefault_enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// æ‹·è´æˆåŠŸè¿”å›0</span>
	<span class="token keyword">return</span> ret <span class="token operator">?</span> <span class="token operator">-</span>EFAULT <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>futex_wait_setup</code>ä¸»è¦å°±åšä¸‰ä»¶äº‹</p>
<ul>
<li>è°ƒç”¨<code>get_futex_key</code>å‡½æ•°ï¼Œå†…éƒ¨ä¼šæ ¹æ®<code>uaddr</code>åœ°å€è®¡ç®—<code>futex_q</code>å…ƒç´ çš„<code>key</code>ï¼Œå¹¶ä¸”åˆ¤æ–­<code>uaddr</code>åœ°å€æ˜¯å¦å¯ä»¥è¢«è®¿é—®ï¼Œç„¶ååˆå§‹åŒ–<code>futex_q</code>çš„å†…å­˜ç»“æ„<code>mm</code>å’Œé”åœ°å€<code>address</code>è¿™ä¸¤ä¸ªå­—æ®µ</li>
<li>è°ƒç”¨<code>queue_lock(q)</code>å‡½æ•°ï¼Œå¯¹<code>futex_q</code>å°†è¦æ’å…¥çš„ç­‰å¾…é˜Ÿåˆ—åŠ é”ï¼Œå¹¶ä¸”è¿”å›ç­‰å¾…é˜Ÿåˆ—çš„åœ°å€</li>
<li>è·å–<code>uaddr</code>çš„å€¼å¹¶ä¸<code>val</code>åˆ¤æ–­ï¼Œå¦‚æœä¸ç›¸ç­‰è¯´æ˜è¢«å…¶ä»–è¿›ç¨‹æ›´æ”¹è¿‡äº†ï¼Œé‚£ä¹ˆä¸åº”è¯¥ç»§ç»­æ‰§è¡Œè¿”å›é0ï¼Œç›¸ç­‰åˆ™è¿”å›0</li>
</ul>
<h3 id="futex_wait_queue_me"><a class="markdownIt-Anchor" href="#futex_wait_queue_me"></a> futex_wait_queue_me</h3>
<p>è¯¥å‡½æ•°æ˜¯<code>futex_wait</code>çš„å…³é”®ï¼Œå®Œæˆäº†é˜»å¡å½“å‰è¿›ç¨‹å¹¶é‡æ–°è°ƒåº¦è¿›ç¨‹æ‰§è¡Œçš„åŠŸèƒ½</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">futex_wait_queue_me</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">futex_hash_bucket</span> <span class="token operator">*</span>hb<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">futex_q</span> <span class="token operator">*</span>q<span class="token punctuation">,</span>
				<span class="token keyword">struct</span> <span class="token class-name">hrtimer_sleeper</span> <span class="token operator">*</span>timeout<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token comment">/*
	 * The task state is guaranteed to be set before another task can
	 * wake it. set_current_state() is implemented using set_mb() and
	 * queue_me() calls spin_unlock() upon completion, both serializing
	 * access to the hash list and forcing another memory barrier.
	 */</span>
	<span class="token comment">// è®¾ç½®è¿›ç¨‹çŠ¶æ€ä¸ºTASK_INTERRUPTIBLE,æ³¨æ„ï¼šåœ¨liunxå†…æ ¸ä¸­åªä¼šè°ƒåº¦çŠ¶æ€ä¸ºTASK_RUNNINGçš„è¿›ç¨‹ï¼Œæ‰€ä»¥è¯¥è¿›ç¨‹ä¸ä¼šè¢«è°ƒåº¦äº†</span>
	<span class="token function">set_current_state</span><span class="token punctuation">(</span>TASK_INTERRUPTIBLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// å°† futex_q æ’å…¥åˆ°ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œå¹¶ä¸”ä¼šé‡Šæ”¾ç­‰å¾…é˜Ÿåˆ—çš„é”</span>
	<span class="token function">queue_me</span><span class="token punctuation">(</span>q<span class="token punctuation">,</span> hb<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/* Arm the timer */</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>timeout<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token comment">// è®¾ç½®äº†è¶…æ—¶ï¼Œé‚£ä¹ˆå¯åŠ¨å®šæ—¶å™¨æ¥è°ƒåº¦å”¤é†’è¯¥è¿›ç¨‹</span>
		<span class="token function">hrtimer_start_expires</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>timeout<span class="token operator">-></span>timer<span class="token punctuation">,</span> HRTIMER_MODE_ABS<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">hrtimer_active</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>timeout<span class="token operator">-></span>timer<span class="token punctuation">)</span><span class="token punctuation">)</span>
			timeout<span class="token operator">-></span>task <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>

	<span class="token comment">/*
	 * If we have been removed from the hash list, then another task
	 * has tried to wake us, and we can skip the call to schedule().
	 */</span>
	 <span class="token comment">// åˆ¤æ–­å½“å‰futex_qçš„èŠ‚ç‚¹æ˜¯å¦è¿˜åœ¨ç­‰å¾…é˜Ÿåˆ—ä¸­,å¦‚æœä¸åœ¨ï¼Œè¯´æ˜å·²ç»æœ‰è¿›ç¨‹å”¤é†’,é‚£ä¹ˆå°±ä¸è¿›è¡Œè¿›ç¨‹çš„è°ƒåº¦,é¿å…ä¸Šä¸‹æ–‡åˆ‡æ¢</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">likely</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">plist_node_empty</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>q<span class="token operator">-></span>list<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token comment">/*
		 * If the timer has already expired, current will already be
		 * flagged for rescheduling. Only call schedule if there
		 * is no timeout, or if it has yet to expire.
		 */</span>
		<span class="token comment">// æ²¡æœ‰è®¾ç½®å®šæ—¶å”¤é†’æˆ–è€…å·²ç»å®šæ—¶å™¨æ²¡æœ‰è¶…æ—¶</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>timeout <span class="token operator">||</span> timeout<span class="token operator">-></span>task<span class="token punctuation">)</span>
			<span class="token comment">// é‡æ–°è°ƒåº¦è¿›ç¨‹</span>
			<span class="token function">freezable_schedule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token comment">// è¢«å”¤é†’äº†(è¢«å…¶ä»–è¿›ç¨‹å”¤é†’æˆ–è€…æ˜¯å®šæ—¶å™¨å”¤é†’),è®¾ç½®è¿›ç¨‹çš„çŠ¶æ€ä¸ºTASK_RUNNING(è¿™é‡Œæ˜¯é˜²å¾¡æ€§ç¼–ç¨‹ï¼Œæ— è®ºä¸Šé¢å“ªç§å”¤é†’æ–¹å¼ï¼Œåœ¨è°ƒåº¦è¯¥çº¿ç¨‹æ—¶éƒ½ä¼šå°†çŠ¶æ€è®¾ç½®ä¸ºTASK_RUNNING)</span>
	<span class="token comment">// å¯ä»¥æŸ¥çœ‹ core.c ttwu_do_wakeupå‡½æ•°å®ç°</span>
	<span class="token function">__set_current_state</span><span class="token punctuation">(</span>TASK_RUNNING<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>queue_meï¼šå°†futex_qæ‰€åœ¨èŠ‚ç‚¹æ’å…¥åˆ°ç­‰å¾…é˜Ÿåˆ—ä¸­</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token function">queue_me</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">futex_q</span> <span class="token operator">*</span>q<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">futex_hash_bucket</span> <span class="token operator">*</span>hb<span class="token punctuation">)</span>
	<span class="token function">__releases</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hb<span class="token operator">-></span>lock<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token keyword">int</span> prio<span class="token punctuation">;</span>

	<span class="token comment">/*
	 * The priority used to register this element is
	 * - either the real thread-priority for the real-time threads
	 * (i.e. threads with a priority lower than MAX_RT_PRIO)
	 * - or MAX_RT_PRIO for non-RT threads.
	 * Thus, all RT-threads are woken first in priority order, and
	 * the others are woken last, in FIFO order.
	 */</span>
	prio <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span>current<span class="token operator">-></span>normal_prio<span class="token punctuation">,</span> MAX_RT_PRIO<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token function">plist_node_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>q<span class="token operator">-></span>list<span class="token punctuation">,</span> prio<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// å°†futex_qæ‰€åœ¨çš„èŠ‚ç‚¹æ’å…¥åˆ°ç­‰å¾…é˜Ÿåˆ—ä¸­ æ³¨æ„: è™½ç„¶å–åæ˜¯ list ä½†å…¶å®æ˜¯ä¸ªèŠ‚ç‚¹ç±»å‹</span>
	<span class="token function">plist_add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>q<span class="token operator">-></span>list<span class="token punctuation">,</span> <span class="token operator">&amp;</span>hb<span class="token operator">-></span>chain<span class="token punctuation">)</span><span class="token punctuation">;</span>
	q<span class="token operator">-></span>task <span class="token operator">=</span> current<span class="token punctuation">;</span>
	<span class="token function">spin_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hb<span class="token operator">-></span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// plist_addæ–¹æ³•</span>
<span class="token keyword">void</span> <span class="token function">plist_add</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">plist_node</span> <span class="token operator">*</span>node<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">plist_head</span> <span class="token operator">*</span>head<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>futex_wait_queue_me</code>å‡½æ•°æ€»ç»“</p>
<ol>
<li>è®¾ç½®å½“å‰è¿›ç¨‹çš„çŠ¶æ€ä¸º<code>TASK_INTERRUPTIBLE</code>,å¤„äºè¯¥çŠ¶æ€çš„è¿›ç¨‹ä¸ä¼šè¢«å†…æ ¸è°ƒåº¦</li>
<li>å°†ä»£è¡¨å½“å‰è¿›ç¨‹çš„<code>futex_q</code>æ’å…¥åˆ°ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œå¹¶é‡Šæ”¾ç­‰å¾…é˜Ÿåˆ—çš„é”</li>
<li>åˆ¤æ–­<code>futex_q</code>æ˜¯å¦è¿˜åœ¨ç­‰å¾…é˜Ÿåˆ—ï¼Œå› ä¸ºå·²ç»é‡Šæ”¾äº†ç­‰å¾…é˜Ÿåˆ—çš„é”äº†ï¼Œå¯èƒ½åœ¨é‡Šæ”¾ä¹‹åå°±æœ‰è¿›ç¨‹é©¬ä¸Šè°ƒç”¨äº†<code>futex_wake</code>å”¤é†’äº†è¯¥è¿›ç¨‹ï¼Œé‚£ä¹ˆå°±ä¸éœ€è¦é‡æ–°è°ƒåº¦ï¼Œç›´æ¥è¿”å›å³å¯ï¼Œå¦‚æœè¿˜åœ¨ï¼Œé‚£ä¹ˆå°±è°ƒç”¨<code>schedule</code>æ¥é‡æ–°è°ƒåº¦è¿›ç¨‹
<ul>
<li>æ³¨æ„ï¼š<code>freezable_schedule</code>å†…éƒ¨ä¼šè°ƒç”¨<code>schedule</code>ï¼Œè¯¥å‡½æ•°æ‰æ˜¯çœŸæ­£å®ç°äº†è°ƒåº¦è¿›ç¨‹çš„åŠŸèƒ½</li>
</ul>
</li>
</ol>
<h3 id="æ€»ç»“"><a class="markdownIt-Anchor" href="#æ€»ç»“"></a> æ€»ç»“</h3>
<p><code>futex_wait</code>çš„å®Œæ•´æµç¨‹</p>
<ol>
<li>å¦‚æœè®¾ç½®äº†è¶…æ—¶å”¤é†’ï¼Œé‚£ä¹ˆä¼šä¸ºå…¶è®¾ç½®ä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œå½“è¾¾åˆ°æŒ‡å®šçš„æ—¶é—´ä½†ä»æœªå–æ¶ˆè¯¥ä»»åŠ¡ï¼Œå°±ç”±å®šæ—¶ä»»åŠ¡æ¥å”¤é†’å½“å‰è¿›ç¨‹</li>
<li>è°ƒç”¨<code>futex_wait_setup</code>æ¥å®Œæˆå°†ä»£è¡¨å½“å‰è¿›ç¨‹çš„<code>futex_q</code>æ’å…¥åˆ°ç­‰å¾…é˜Ÿåˆ—ä¹‹å‰çš„å‡†å¤‡å·¥ä½œï¼Œåœ¨è¯¥å‡½æ•°å†…éƒ¨ä¼šæ ¹æ®<code>uaddr</code>çš„åœ°å€æ¥è®¡ç®—å¹¶ä¸”åˆå§‹åŒ–<code>futex_q</code>çš„<code>key</code>å±æ€§ï¼Œç„¶åå¯¹<code>futex_q</code>è¦æ’å…¥çš„ç­‰å¾…é˜Ÿåˆ—åŠ é”ï¼Œç„¶ååˆ¤æ–­<code>uaddr</code>æ˜¯å¦å¯ä»¥è®¿é—®ï¼Œå¦‚æœå¯ä»¥ä¾¿è·å–<code>uaddr</code>çš„å€¼å¹¶ä¸”ä¸<code>val</code>æ¯”è¾ƒï¼Œå¦‚æœç›¸ç­‰ï¼Œè¯´æ˜æ²¡æœ‰è¢«å…¶ä»–è¿›ç¨‹æ›´æ”¹è¿‡ï¼Œé‚£ä¹ˆå¯ä»¥è¿›è¡Œé˜»å¡æ“ä½œè¿”å›0ï¼Œå¦‚æœä¸ç›¸ç­‰é‚£ä¹ˆé‡Šæ”¾ç­‰å¾…é˜Ÿåˆ—é”ç„¶åè¿”å›é0</li>
<li>æ ¹æ®<code>futex_wait_setup</code>çš„è¿”å›å€¼æ¥åˆ¤æ–­ï¼Œå¦‚æœæ˜¯é0ï¼Œé‚£ä¹ˆç›´æ¥é€€å‡ºè¿”å›ï¼Œå¦‚æœæ˜¯0ï¼Œé‚£ä¹ˆç»§ç»­å‘ä¸‹æ‰§è¡Œï¼Œè°ƒç”¨<code>futex_wait_queue_me</code>æ¥å®Œæˆé˜»å¡å½“å‰è¿›ç¨‹å¹¶é‡æ–°è°ƒåº¦è¿›ç¨‹çš„æ“ä½œ</li>
<li>åœ¨<code>futex_wait_queue_me</code>ä¸­ï¼Œé¦–å…ˆå°†å½“å‰è¿›ç¨‹çŠ¶æ€è®¾ç½®ä¸º<code>TASK_INTERRUPTIBLE</code>ï¼Œå°†ä»£è¡¨å½“å‰è¿›ç¨‹çš„<code>futex_q</code>æ’å…¥åˆ°ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œå¹¶ä¸”é‡Šæ”¾é”ï¼Œåœ¨çœŸæ­£é€šè¿‡<code>schedule</code>å‡½æ•°é‡æ–°è°ƒåº¦è¿›ç¨‹ä¹‹å‰ä¼šåšä¸€æ¬¡æ£€æŸ¥ï¼Œåˆ¤æ–­<code>futex_q</code>æ˜¯å¦è¿˜åœ¨ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œå¦‚æœä¸åœ¨è¯´æ˜å°±åœ¨é‡Šæ”¾é”ä¹‹åç«‹é©¬å°±æœ‰è¿›ç¨‹å”¤é†’äº†å½“å‰è¿›ç¨‹ï¼Œé‚£ä¹ˆä¸éœ€è¦é€šè¿‡<code>schedule</code>å‡½æ•°é‡æ–°è°ƒåº¦äº†ï¼Œå¦‚æœè¿˜åœ¨ï¼Œé‚£ä¹ˆå°±é€šè¿‡<code>schedule</code>å‡½æ•°æ¥é‡æ–°è°ƒåº¦è¿›ç¨‹</li>
</ol>
<h2 id="futex_wake-æºç è§£æ"><a class="markdownIt-Anchor" href="#futex_wake-æºç è§£æ"></a> futex_wake æºç è§£æ</h2>
<p><code>futex_wake</code> æºç ç›¸å¯¹<code>futex_wait</code>æ¥è¯´è¦ç®€å•è®¸å¤šï¼Œæ¥ä¸‹æ¥è®©æˆ‘ä»¬æ¢ç©¶ä¸€ä¸‹<code>futex_wake</code>æ˜¯å¦‚ä½•å”¤é†’åœ¨ç­‰å¾…é˜Ÿåˆ—ä¸Šçš„è¿›ç¨‹çš„</p>
<h3 id="futex_wake-æºç æ—¶åºå›¾"><a class="markdownIt-Anchor" href="#futex_wake-æºç æ—¶åºå›¾"></a> futex_wake æºç æ—¶åºå›¾</h3>
<pre class="mermaid">sequenceDiagram
	futex_wake->>get_futex_key: é€šè¿‡uaddrè®¡ç®—è·å–futex_key
	futex_wake->>hash_futex: é€šè¿‡futex_keyå®šä½æ‰¾åˆ°ç­‰å¾…é˜Ÿåˆ—çš„å¤´èŠ‚ç‚¹
	futex_wake->>hb_waiters_pending: åˆ¤æ–­ç­‰å¾…é˜Ÿåˆ—ä¸Šçš„waiterå±æ€§æ˜¯å¦ä¸º0ï¼Œä»è€Œæ¥å†³å®šæ˜¯å¦ç»§ç»­æ‰§è¡Œ
	Note over futex_wake,hb_waiters_pending: å¦‚æœä¸º0è¯´æ˜æ²¡æœ‰è¿›ç¨‹åœ¨ç­‰å¾…,ç›´æ¥è¿”å›<br/>å¦‚æœä¸ä¸º0è¯´æ˜å­˜åœ¨éœ€è¦å”¤é†’çš„è¿›ç¨‹,é‚£ä¹ˆå¯¹ç­‰å¾…é˜Ÿåˆ—åŠ é”,ç„¶åé€šè¿‡ç­‰å¾…é˜Ÿåˆ—å¤´èŠ‚ç‚¹è¿›è¡Œéå†
	futex_wake-->>wake_futex: å”¤é†’æŒ‡å®šè¿›ç¨‹
	rect rgb(66, 184, 131)
	wake_futex-->>__unqueue_futex: å°†ä»£è¡¨å½“å‰è¿›ç¨‹çš„futex_qä»ç­‰å¾…é˜Ÿåˆ—ä¸­ç§»é™¤,å¹¶é‡Šæ”¾é˜Ÿåˆ—é”
	wake_futex-->>wake_up_state: å°†æŒ‡å®šè¿›ç¨‹è®¾ç½®ä¸ºå¯è°ƒåº¦æ‰§è¡Œçš„çŠ¶æ€,ç„¶åå°†å…¶æ’å…¥åˆ°ç›¸åº”çš„è°ƒåº¦é˜Ÿåˆ—ä¸­,ç­‰å¾…å†…æ ¸è°ƒåº¦
	end</pre>
<h3 id="futex_wake"><a class="markdownIt-Anchor" href="#futex_wake"></a> futex_wake</h3>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span>
<span class="token function">futex_wake</span><span class="token punctuation">(</span>u32 __user <span class="token operator">*</span>uaddr<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> <span class="token keyword">int</span> nr_wake<span class="token punctuation">,</span> u32 bitset<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token keyword">struct</span> <span class="token class-name">futex_hash_bucket</span> <span class="token operator">*</span>hb<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">futex_q</span> <span class="token operator">*</span>this<span class="token punctuation">,</span> <span class="token operator">*</span>next<span class="token punctuation">;</span>
	<span class="token keyword">union</span> futex_key key <span class="token operator">=</span> FUTEX_KEY_INIT<span class="token punctuation">;</span>
	<span class="token keyword">int</span> ret<span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bitset<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
	<span class="token comment">// é€šè¿‡ uaddr è®¡ç®—futex_q çš„ key</span>
	ret <span class="token operator">=</span> <span class="token function">get_futex_key</span><span class="token punctuation">(</span>uaddr<span class="token punctuation">,</span> flags <span class="token operator">&amp;</span> FLAGS_SHARED<span class="token punctuation">,</span> <span class="token operator">&amp;</span>key<span class="token punctuation">,</span> VERIFY_READ<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unlikely</span><span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">goto</span> out<span class="token punctuation">;</span>
	<span class="token comment">// é€šè¿‡keyæ‰¾åˆ°futex_qæ‰€åœ¨çš„ç­‰å¾…é˜Ÿåˆ— </span>
	hb <span class="token operator">=</span> <span class="token function">hash_futex</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">/* Make sure we really have tasks to wakeup */</span>
	<span class="token comment">// åˆ¤æ–­ç­‰å¾…é˜Ÿåˆ—çš„waiterså±æ€§æ˜¯å¦å¤§äº0ï¼Œå†³å®šæ˜¯å¦æ‰§è¡Œæ¥ä¸‹æ¥çš„å”¤é†’åŠ¨ä½œï¼Œå¦‚æœç­‰äº0ï¼Œè¯´æ˜æ²¡æœ‰ç­‰å¾…é˜Ÿåˆ—ä¸ºç©ºï¼Œç›´æ¥è¿”å›</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">hb_waiters_pending</span><span class="token punctuation">(</span>hb<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">goto</span> out_put_key<span class="token punctuation">;</span>
	<span class="token comment">// æ¥ä¸‹æ¥å°±è¦å¯¹ç­‰å¾…é˜Ÿåˆ—æ“ä½œäº†ï¼Œå¯¹ç­‰å¾…é˜Ÿåˆ—åŠ é”</span>
	<span class="token function">spin_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hb<span class="token operator">-></span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// éå†ç­‰å¾…é˜Ÿåˆ—åˆ—è¡¨</span>
	<span class="token function">plist_for_each_entry_safe</span><span class="token punctuation">(</span>this<span class="token punctuation">,</span> next<span class="token punctuation">,</span> <span class="token operator">&amp;</span>hb<span class="token operator">-></span>chain<span class="token punctuation">,</span> list<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token comment">// æ¯”è¾ƒç­‰å¾…é˜Ÿåˆ—å…ƒç´ ä¸Šçš„keyæ˜¯å¦ä¸è®¡ç®—å¾—åˆ°çš„keyç›¸ç­‰</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">match_futex</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>this<span class="token operator">-></span>key<span class="token punctuation">,</span> <span class="token operator">&amp;</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>this<span class="token operator">-></span>pi_state <span class="token operator">||</span> this<span class="token operator">-></span>rt_waiter<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
				ret <span class="token operator">=</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token punctuation">&#125;</span>
			<span class="token comment">/* Check if one of the bits is set in both bitsets */</span>
			<span class="token comment">// åŒ¹é…æˆåŠŸ,åˆ¤æ–­ä½å›¾ä¸Šçš„bitä½æ˜¯å¦å‘ç”Ÿå˜åŒ–,å¦‚æœæ²¡æœ‰å˜åŒ–,åˆ™ä¸ä¼šå”¤é†’,é€šå¸¸ bitset æ˜¯ä¸€ä¸ª32ä½å…¨ä¸º1çš„çš„æ•°,æ‰€ä»¥éƒ½ä¼šç›´æ¥èµ°å”¤é†’çš„æµç¨‹</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>this<span class="token operator">-></span>bitset <span class="token operator">&amp;</span> bitset<span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token keyword">continue</span><span class="token punctuation">;</span>
			<span class="token comment">// å”¤é†’å½“å‰futex_qå…ƒç´ ä¸Šå…³è”çš„è¿›ç¨‹</span>
			<span class="token function">wake_futex</span><span class="token punctuation">(</span>this<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">// å”¤é†’æŒ‡å®šæ•°é‡çš„è¿›ç¨‹åå°±é€€å‡ºéå†</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">++</span>ret <span class="token operator">>=</span> nr_wake<span class="token punctuation">)</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token comment">// é‡Šæ”¾é”</span>
	<span class="token function">spin_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hb<span class="token operator">-></span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
out_put_key<span class="token operator">:</span>
	<span class="token comment">// é”€æ¯key</span>
	<span class="token function">put_futex_key</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
out<span class="token operator">:</span>
	<span class="token comment">// è¿”å›å”¤é†’çš„è¿›ç¨‹æ•°é‡</span>
	<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>futex_wake å†…éƒ¨å®Œæˆå¦‚ä¸‹åŠŸèƒ½</p>
<ol>
<li>é€šè¿‡<code>uaddr</code>æ¥è®¡ç®—å¹¶è·å–<code>futex_q</code>çš„keyï¼Œé€šè¿‡<code>key</code>ä»ç­‰å¾…é˜Ÿåˆ—hashè¡¨ä¸­è·å–å¯¹åº”çš„ç­‰å¾…é˜Ÿåˆ—</li>
<li>å¯¹ç­‰å¾…é˜Ÿåˆ—åŠ é”ï¼Œå¾ªç¯éå†ç­‰å¾…é˜Ÿåˆ—åˆ—è¡¨ä¸­çš„å…ƒç´ ï¼Œåˆ¤æ–­å…ƒç´ ä¸Šçš„<code>key</code>æ˜¯å¦ä¸<code>futex_q</code>çš„<code>key</code>åŒ¹é…ï¼Œå¦‚æœåŒ¹é…ï¼Œè°ƒç”¨<code>wake_futex</code>æ‰§è¡Œå”¤é†’æ“ä½œï¼Œå”¤é†’ç­‰å¾…é˜Ÿåˆ—ä¸ŠæŒ‡å®šæ•°é‡é˜»å¡ç­‰å¾…çš„è¿›ç¨‹åå°±ä¼šé€€å‡ºéå†</li>
<li>é‡Šæ”¾ç­‰å¾…é˜Ÿåˆ—é”ï¼Œè¿”å›å”¤é†’çš„è¿›ç¨‹æ•°é‡</li>
</ol>
<h4 id="wake_futex"><a class="markdownIt-Anchor" href="#wake_futex"></a> wake_futex</h4>
<pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">wake_futex</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">futex_q</span> <span class="token operator">*</span>q<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token comment">// futex_qå…³è”çš„è¿›ç¨‹ç»“æ„ä½“ task_struct</span>
	<span class="token keyword">struct</span> <span class="token class-name">task_struct</span> <span class="token operator">*</span>p <span class="token operator">=</span> q<span class="token operator">-></span>task<span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">WARN</span><span class="token punctuation">(</span>q<span class="token operator">-></span>pi_state <span class="token operator">||</span> q<span class="token operator">-></span>rt_waiter<span class="token punctuation">,</span> <span class="token string">"refusing to wake PI futex\n"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>

	<span class="token comment">/*
	 * We set q->lock_ptr = NULL _before_ we wake up the task. If
	 * a non-futex wake up happens on another CPU then the task
	 * might exit and p would dereference a non-existing task
	 * struct. Prevent this by holding a reference on p across the
	 * wake up.
	 */</span>
	<span class="token comment">// é€šè¿‡è°ƒç”¨ get_task_struct(p) å¢åŠ å¼•ç”¨è®¡æ•°ï¼Œå³ä½¿ä»»åŠ¡åœ¨å”¤é†’è¿‡ç¨‹ä¸­è¢«å…¶ä»–äº‹ä»¶è§¦å‘é€€å‡ºï¼Œç”±äºå¼•ç”¨è®¡æ•°ä¸ä¸º 0ï¼Œ`struct task_struct` ç»“æ„ä½“ä¹Ÿä¸ä¼šè¢«ç«‹å³é‡Šæ”¾</span>
	<span class="token function">get_task_struct</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// å°† futex_q å…ƒç´ ä»ç­‰å¾…é˜Ÿåˆ—ä¸­ç§»é™¤</span>
	<span class="token function">__unqueue_futex</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/*
	 * The waiting task can free the futex_q as soon as
	 * q->lock_ptr = NULL is written, without taking any locks. A
	 * memory barrier is required here to prevent the following
	 * store to lock_ptr from getting ahead of the plist_del.
	 */</span>
	<span class="token comment">// å†…å­˜å±éšœï¼Œä¿è¯æŒ‡ä»¤é¡ºåºæ€§</span>
	<span class="token function">smp_wmb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// é‡Šæ”¾å¯¹ç­‰å¾…é˜Ÿåˆ—çš„é”å¼•ç”¨</span>
	q<span class="token operator">-></span>lock_ptr <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token comment">// æ‰§è¡Œå”¤é†’æ“ä½œ åº•å±‚ä¼šå°†è¿›ç¨‹pçš„çŠ¶æ€è®¾ç½®ä¸ºTASK_RUNNING,ç„¶åå°†å®ƒæ”¾å…¥åˆ°ç›¸åº”çš„è°ƒåº¦é˜Ÿåˆ—ä¸­ï¼Œç­‰å¾…cpuè°ƒåº¦</span>
	<span class="token comment">// TASK_NORMAL æ˜¯ä¸€ä¸ªçŠ¶æ€æ©ç ,åœ¨å”¤é†’æ—¶ä¼šæ ¹æ®ä»»åŠ¡pçš„çŠ¶æ€æ¥åšä¸æ“ä½œ,åˆ¤æ–­å½“å‰çŠ¶æ€æ˜¯å¦æ”¯æŒå”¤é†’</span>
	<span class="token comment">// TASK_NORMAL = TASK_INTERRUPTIBLE | TASK_UNINTERRUPTIBLE</span>
	<span class="token function">wake_up_state</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> TASK_NORMAL<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// å°†ä»»åŠ¡pçš„å¼•ç”¨è®¡æ•°-1</span>
	<span class="token function">put_task_struct</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">__unqueue_futex</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">futex_q</span> <span class="token operator">*</span>q<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
	<span class="token keyword">struct</span> <span class="token class-name">futex_hash_bucket</span> <span class="token operator">*</span>hb<span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">WARN_ON_SMP</span><span class="token punctuation">(</span><span class="token operator">!</span>q<span class="token operator">-></span>lock_ptr <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">spin_is_locked</span><span class="token punctuation">(</span>q<span class="token operator">-></span>lock_ptr<span class="token punctuation">)</span><span class="token punctuation">)</span>
	    <span class="token operator">||</span> <span class="token function">WARN_ON</span><span class="token punctuation">(</span><span class="token function">plist_node_empty</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>q<span class="token operator">-></span>list<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token comment">// é€šè¿‡ container_of æ‰¾åˆ° futex_q æ‰€åœ¨çš„ç­‰å¾…é˜Ÿåˆ—</span>
	hb <span class="token operator">=</span> <span class="token function">container_of</span><span class="token punctuation">(</span>q<span class="token operator">-></span>lock_ptr<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">futex_hash_bucket</span><span class="token punctuation">,</span> lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// å°† futex_q ä»ç­‰å¾…é˜Ÿåˆ—ä¸Šç§»é™¤</span>
	<span class="token function">plist_del</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>q<span class="token operator">-></span>list<span class="token punctuation">,</span> <span class="token operator">&amp;</span>hb<span class="token operator">-></span>chain<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// å°†ç­‰å¾…é˜Ÿåˆ—ä¸Šçš„waiterså±æ€§è‡ªå‡1</span>
	
	<span class="token function">hb_waiters_dec</span><span class="token punctuation">(</span>hb<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ol>
<li>å¢åŠ <code>futex_q</code>æ‰€å…³è”çš„ä»»åŠ¡ç»“æ„ä½“å¯¹è±¡å¼•ç”¨è®¡æ•°ï¼Œå°†ä»£è¡¨å½“å‰è¿›ç¨‹çš„<code>futex_q</code>å…ƒç´ ä»ç­‰å¾…é˜Ÿåˆ—ä¸­ç§»é™¤å¹¶å¯¹ç­‰å¾…é˜Ÿåˆ—çš„<code>waiters</code>è‡ªå‡1ï¼Œç„¶åé‡Šæ”¾<code>futex_q</code>å¯¹ç­‰å¾…é˜Ÿåˆ—é”çš„å¼•ç”¨</li>
<li>è°ƒç”¨<code>wake_up_state</code>å‡½æ•°æ¥å”¤é†’æŒ‡å®šçš„è¿›ç¨‹ï¼Œå¯¹åº”ä¹‹å‰çš„ä»»åŠ¡çš„å¼•ç”¨è®¡æ•°+1ï¼Œæ­¤æ—¶éœ€è¦è°ƒç”¨<code>put_task_strcut</code>æ¥å°†ä»»åŠ¡çš„å¼•ç”¨è®¡æ•°-1</li>
</ol>
<p><code>wake_up_state</code>ç»†èŠ‚</p>
<ul>
<li><code>wake_up_state</code> æ˜¯å®šä¹‰åœ¨ <code>kernel/sched/core.c</code>ä¸­çš„å‡½æ•°ï¼Œåœ¨å†…éƒ¨ä¼šè°ƒç”¨<code>try_to_wake_up</code>å‡½æ•°æ¥å”¤é†’æŒ‡å®šè¿›ç¨‹ï¼Œå€¼å¾—ä¸€æçš„æ˜¯ï¼šåœ¨<code>futex_wait</code>ä¸­å®šä¹‰çš„å®šæ—¶ä»»åŠ¡ä¹Ÿæ˜¯é€šè¿‡è¯¥å‡½æ•°æ¥å®Œæˆå”¤é†’è¿›ç¨‹çš„åŠŸèƒ½çš„ï¼Œè¯¥å‡½æ•°æœ€åº•å±‚ä¼šè°ƒç”¨<code>ttwu_do_wakeup</code>å°†è¿›ç¨‹æ ‡è®°ä¸º<code>TASK_RUNNING</code>å¯è¿è¡ŒçŠ¶æ€ï¼Œç„¶åä¼šå°†è¿›ç¨‹æ’å…¥åˆ°ç›¸åº”çš„è°ƒåº¦é˜Ÿåˆ—ä¸­ï¼Œç­‰å¾…å†…æ ¸è°ƒåº¦</li>
</ul>
]]></content>
      <categories>
        <category>æºç åˆ†æ</category>
        <category>liunx</category>
      </categories>
  </entry>
  <entry>
    <title>Liunx ä»»åŠ¡è°ƒåº¦</title>
    <url>/posts/bcc098b4.html</url>
    <content><![CDATA[]]></content>
      <categories>
        <category>æºç åˆ†æ</category>
        <category>liunx</category>
      </categories>
  </entry>
</search>
