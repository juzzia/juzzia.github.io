<!DOCTYPE html><html lang=zh-CN data-theme=light><head><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><title>字节码解释器 Interpreter | Juzzia's Blog</title><meta name=author content=Juzzia><meta name=copyright content=Juzzia><meta name=format-detection content="telephone=no"><meta name=theme-color content=ffffff><meta name=description content="半亩方塘一鉴开，天光云影共徘徊。 问渠那得清如许？为有源头活水来。   介绍 在计算机的世界中，如果又无法解决的问题，那么只需要加一个中间层，本文所介绍的解释器同样是遵循这个思想 当我们的java代码通过编译器编译成为字节码后，此时就可以被jvm加载到内存中去解释执行了，为了支持跨平台，JVM会根据不同的硬件平台开发一个专属的解释器用于将字节码指令翻译成为对应平台的机器指令，或者采用一个通用的解"><meta property=og:type content=article><meta property=og:title content="字节码解释器 Interpreter"><meta property=og:url content=https://juzzia.github.io/posts/f95e72b6.html><meta property=og:site_name content="Juzzia&#39;s Blog"><meta property=og:description content="半亩方塘一鉴开，天光云影共徘徊。 问渠那得清如许？为有源头活水来。   介绍 在计算机的世界中，如果又无法解决的问题，那么只需要加一个中间层，本文所介绍的解释器同样是遵循这个思想 当我们的java代码通过编译器编译成为字节码后，此时就可以被jvm加载到内存中去解释执行了，为了支持跨平台，JVM会根据不同的硬件平台开发一个专属的解释器用于将字节码指令翻译成为对应平台的机器指令，或者采用一个通用的解"><meta property=og:locale content=zh_CN><meta property=og:image content=https://juzzia.github.io/img/avatar.jpg><meta property=article:published_time content=2025-02-18T14:45:00.000Z><meta property=article:modified_time content=2025-03-07T14:26:00.000Z><meta property=article:author content=Juzzia><meta property=article:tag content=源码><meta property=article:tag content=JVM><meta name=twitter:card content=summary><meta name=twitter:image content=https://juzzia.github.io/img/avatar.jpg><link rel="shortcut icon" href=/img/log.svg><link rel=canonical href=https://juzzia.github.io/posts/f95e72b6.html><link rel=preconnect href=//cdn.jsdelivr.net><link rel=preconnect href=//hm.baidu.com><link rel=preconnect href=//busuanzi.ibruce.info><meta name=msvalidate.01 content=606EBFCBDED9F21417F108AFF320F465><link rel=stylesheet href="/css/index.css?v=4.13.0"><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css media=print onload='this.media="all"'><script>var _hmt=_hmt||[];(()=>{var e=document.createElement("script"),t=(e.src="https://hm.baidu.com/hm.js?344a26e9d7e5894ce499ae53b475d975",document.getElementsByTagName("script")[0]);t.parentNode.insertBefore(e,t)})()</script><script>let GLOBAL_CONFIG={root:"/",algolia:void 0,localSearch:{path:"/search.xml",preload:!1,top_n_per_article:5,unescape:!1,languages:{hits_empty:"找不到您查询的内容：${query}",hits_stats:"共找到 ${hits} 篇文章"}},translate:void 0,noticeOutdate:void 0,highlight:{plugin:"prismjs",highlightCopy:!0,highlightLang:!0,highlightHeightLimit:300},copy:{success:"复制成功",error:"复制错误",noSupport:"浏览器不支持"},relativeDate:{homepage:!0,post:!1},runtime:"",dateSuffix:{just:"刚刚",min:"分钟前",hour:"小时前",day:"天前",month:"个月前"},copyright:void 0,lightbox:"fancybox",Snackbar:void 0,infinitegrid:{js:"https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js",buttonText:"加载更多"},isPhotoFigcaption:!0,islazyload:!1,isAnchor:!0,percent:{toc:!0,rightside:!0},autoDarkmode:!1}</script><script id=config-diff>var GLOBAL_CONFIG_SITE={title:"字节码解释器 Interpreter",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2025-03-07 22:26:00"}</script><script>(e=>{e.saveToLocal={set:(e,t,a)=>{var o;0!==a&&(o=Date.now(),localStorage.setItem(e,JSON.stringify({value:t,expiry:o+864e5*a})))},get:e=>{var t=localStorage.getItem(e);if(t){t=JSON.parse(t);if(!(Date.now()>t.expiry))return t.value;localStorage.removeItem(e)}}},e.getScript=(o,n={})=>new Promise((t,e)=>{let a=document.createElement("script");a.src=o,a.async=!0,a.onerror=e,a.onload=a.onreadystatechange=function(){var e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(a.onload=a.onreadystatechange=null,t())},Object.keys(n).forEach(e=>{a.setAttribute(e,n[e])}),document.head.appendChild(a)}),e.getCSS=(o,n=!1)=>new Promise((t,e)=>{let a=document.createElement("link");a.rel="stylesheet",a.href=o,n&&(a.id=n),a.onerror=e,a.onload=a.onreadystatechange=function(){var e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(a.onload=a.onreadystatechange=null,t())},document.head.appendChild(a)}),e.activateDarkMode=()=>{document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#0d0d0d")},e.activateLightMode=()=>{document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","ffffff")};e=saveToLocal.get("theme"),"dark"===e?activateDarkMode():"light"===e&&activateLightMode(),e=saveToLocal.get("aside-status");void 0!==e&&("hide"===e?document.documentElement.classList.add("hide-aside"):document.documentElement.classList.remove("hide-aside"));/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)&&document.documentElement.classList.add("apple")})(window)</script><link rel=stylesheet href=/css/callout/callout_blocks.css><link rel=stylesheet href=/css/mermaid.css><link rel=stylesheet href=/css/custom.css><meta name=generator content="Hexo 7.3.0"></head><body><div id=web_bg></div><div id=sidebar><div id=menu-mask></div><div id=sidebar-menus><div class="avatar-img is-center"><img src=/img/avatar.jpg onerror='onerror=null,src="/img/friend_404.gif"' alt=avatar></div><div class="sidebar-site-data site-data is-center"><a href=/archives/ ><div class=headline>文章</div><div class=length-num>10</div></a><a href=/tags/ ><div class=headline>标签</div><div class=length-num>4</div></a><a href=/categories/ ><div class=headline>分类</div><div class=length-num>5</div></a></div><hr class=custom-hr><div class=menus_items><div class=menus_item><a class=site-page href=/ ><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class=menus_item><a class=site-page href=/archives/ ><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class=menus_item><a class=site-page href=/tags/ ><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class=menus_item><a class=site-page href=/categories/ ><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class=menus_item><a class=site-page href=/about/ ><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class=post id=body-wrap><header class=not-top-img id=page-header><nav id=nav><span id=blog-info><a href=/ title="Juzzia's Blog"><span class=site-name>Juzzia's Blog</span></a></span><div id=menus><div id=search-button><a class="site-page social-icon search" href=javascript:void(0);><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class=menus_items><div class=menus_item><a class=site-page href=/ ><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class=menus_item><a class=site-page href=/archives/ ><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></div><div class=menus_item><a class=site-page href=/tags/ ><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class=menus_item><a class=site-page href=/categories/ ><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class=menus_item><a class=site-page href=/about/ ><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id=toggle-menu><a class=site-page href=javascript:void(0);><i class="fas fa-bars fa-fw"></i></a></div></div></nav></header><main class=layout id=content-inner><div id=post><div id=post-info><h1 class=post-title>字节码解释器 Interpreter</h1><div id=post-meta><div class=meta-firstline><span class=post-meta-date><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class=post-meta-label>发表于</span><time datetime=2025-02-18T14:45:00.000Z title="发表于 2025-02-18 22:45:00">2025-02-18</time></span><span class=post-meta-categories><span class=post-meta-separator>|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class=post-meta-categories href=/categories/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/ >源码分析</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class=post-meta-categories href=/categories/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/hotspot/ >hotspot</a></span></div><div class=meta-secondline><span class=post-meta-separator>|</span><span class=post-meta-wordcount><i class="far fa-file-word fa-fw post-meta-icon"></i><span class=post-meta-label>字数总计:</span><span class=word-count>6.5k</span><span class=post-meta-separator>|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class=post-meta-label>阅读时长:</span><span>28分钟</span></span><span class=post-meta-separator>|</span><span class=post-meta-pv-cv id="" data-flag-title="字节码解释器 Interpreter"><i class="far fa-eye fa-fw post-meta-icon"></i><span class=post-meta-label>阅读量:</span><span id=busuanzi_value_page_pv><i class="fa-solid fa-spinner fa-spin"></i></span></span><span class=post-meta-separator>|</span><span class=post-meta-commentcount><i class="far fa-comments fa-fw post-meta-icon"></i><span class=post-meta-label>评论数:</span><a href=/posts/f95e72b6.html#post-comment><span class=gsc-comments-count><i class="fa-solid fa-spinner fa-spin"></i></span></a></span></div></div></div><article class=post-content id=article-container><blockquote><p>半亩方塘一鉴开，天光云影共徘徊。 问渠那得清如许？为有源头活水来。</p></blockquote><h1 id=介绍><a class=markdownIt-Anchor href=#介绍></a> 介绍</h1><p>在计算机的世界中，如果又无法解决的问题，那么只需要加一个中间层，本文所介绍的解释器同样是遵循这个思想<br>当我们的java代码通过编译器编译成为字节码后，此时就可以被jvm加载到内存中去解释执行了，为了支持跨平台，JVM会根据不同的硬件平台开发一个专属的解释器用于将字节码指令翻译成为对应平台的机器指令，或者采用一个通用的解释器作为中间层来解释字节码指令然后执行对应的逻辑。</p><h1 id=hotspot中的实现><a class=markdownIt-Anchor href=#hotspot中的实现></a> Hotspot中的实现</h1><h2 id=interpreter><a class=markdownIt-Anchor href=#interpreter></a> Interpreter</h2><p><code>Hotspot</code>是<code>jvm</code>的实现之一，在<code>jdk8u</code>中的<code>Hotspot</code>中有以下两个<code>解释器</code></p><ul><li><code>cppInterpreter</code>：CppInterpreter是用C<ins>实现的字节码解释器，对每一个字节码指令都编写了c</ins>方法来进行处理，优点是实现相对简单容易理解，缺点就是执行慢</li><li><code>TemplateInterpreter</code>：TemplateInterpreter实现的模板解释器，它对每一个字节码指令都对应了一段汇编代码来实现，启动时会将字节码指令与对应的汇编代码入口做绑定，当执行到一条字节码指令时会进入对应的汇编代码入口来执行，因此效率要高很多，也是<code>Hotspot</code>中默认使用到的</li></ul><blockquote><p>可以看本文章了解解释器的发展历程 <a target=_blank rel=noopener href=https://book.douban.com/annotation/31407691/ >第232页 7.2.1 Interpreter模块</a><br>了解编译jdk时如何通过参数指定使用哪个解释器可以参考<a href=/posts/09618d5b.html>Liunx编译OpenJdk 8U</a></p></blockquote><pre class="line-numbers language-c" data-language=c><code class=language-c><span class="token comment">// 通过宏定义来让Interpreter是继承CppInterpreter还是TemplateInterpreter，从而来启用对应的解释器</span>
class Interpreter<span class="token operator">:</span> public <span class="token function">CC_INTERP_ONLY</span><span class="token punctuation">(</span>CppInterpreter<span class="token punctuation">)</span> <span class="token function">NOT_CC_INTERP</span><span class="token punctuation">(</span>TemplateInterpreter<span class="token punctuation">)</span><span aria-hidden=true class=line-numbers-rows><span></span><span></span></span></code></pre><p>在介绍中我们提到因为有了解释器java字节码才能跨平台运行，那么是如何跨平台执行的呢？答案就是为每个硬件架构做适配，对就是这么简单，<code>Hotspot</code>基于这两种解释器都提供了以下平台的汇编代码实现</p><ul><li><code>sparc</code>：SPARC（Scalable Processor Architecture）是一种 RISC 架构，由 Sun Microsystems 开发。它以其高性能、可扩展性和可靠性而闻名，曾经广泛应用于服务器和工作站领域</li><li><code>aarch64</code>：AArch64 是 ARM 架构的 64 位执行状态，是 ARMv8 架构引入的新特性。它在 ARM 处理器的发展历程中具有重要意义，为移动设备、嵌入式系统以及服务器市场带来了 64 位计算能力。</li><li><code>ppc</code>：PowerPC 是一种精简指令集计算机（RISC）架构，由 IBM、苹果和摩托罗拉（现 NXP 半导体）联合开发。</li><li><code>x86</code>：x86 是英特尔公司开发的一系列复杂指令集计算机（CISC）架构，是目前个人计算机和服务器市场中最主流的架构之一<ul><li><code>x86_32</code>：支持32位寻址</li><li><code>x86_64</code>：支持64位寻址</li></ul></li><li><code>zero</code>： 零汇编架构，指在不依赖任何架构平台就可以解释并执行字节码指令</li></ul><p>在编译jdk时可以通过<code>--with-jvm-variants</code>来构建指定架构的jdk（本文也主要zero架构做说明，其它基于汇编的晦涩难懂，有兴趣的自己可以了解）</p><p>src/share/vm/interpreter/interpreter.hpp</p><pre class="line-numbers language-c" data-language=c><code class=language-c>class InterpreterCodelet<span class="token operator">:</span> public Stub <span class="token punctuation">&#123;</span>
<span class="token comment">// .... 省略了代码</span>
<span class="token punctuation">&#125;</span>
class CodeletMark<span class="token operator">:</span> ResourceMark <span class="token punctuation">&#123;</span><span class="token comment">//...</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// 通过宏定义来让Interpreter是继承CppInterpreter还是TemplateInterpreter，从而来启用对应的解释器</span>
class Interpreter<span class="token operator">:</span> public <span class="token function">CC_INTERP_ONLY</span><span class="token punctuation">(</span>CppInterpreter<span class="token punctuation">)</span><span class="token function">NOT_CC_INTERP</span><span class="token punctuation">(</span>TemplateInterpreter<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

  public<span class="token operator">:</span>
  <span class="token comment">// Debugging/printing</span>
  <span class="token keyword">static</span> InterpreterCodelet<span class="token operator">*</span> <span class="token function">codelet_containing</span><span class="token punctuation">(</span>address pc<span class="token punctuation">)</span>     <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> <span class="token punctuation">(</span>InterpreterCodelet<span class="token operator">*</span><span class="token punctuation">)</span>_code<span class="token operator">-></span><span class="token function">stub_containing</span><span class="token punctuation">(</span>pc<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>
  
<span class="token comment">// 通过条件编译将指定架构的代码插入进来</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">TARGET_ARCH_x86</span></span>
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">include</span> <span class="token string">"interpreter_x86.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">TARGET_ARCH_aarch64</span></span>
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">include</span> <span class="token string">"interpreter_aarch64.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">TARGET_ARCH_sparc</span></span>
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">include</span> <span class="token string">"interpreter_sparc.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">TARGET_ARCH_zero  </span><span class="token comment">// 本文针对该架构所编写</span></span>
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">include</span> <span class="token string">"interpreter_zero.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">TARGET_ARCH_arm</span></span>
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">include</span> <span class="token string">"interpreter_arm.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">TARGET_ARCH_ppc</span></span>
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">include</span> <span class="token string">"interpreter_ppc.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>interpreter</code>头文件只定义了一些顶层设计的类或者接口，但最主要的是两点</p><ul><li>通过宏来判断解释器是继承<code>CppInterpreter</code>还是<code>TemplateInterpreter</code></li><li>定义了条件编译，将符合架构条件的代码在编译时插入进来</li></ul><p>上面两个解释器的实现都是继承自 <code>AbstractInterpreter</code>，而<code>AbstractInterpreter</code>中才是重点</p><h2 id=abstractinterpreter><a class=markdownIt-Anchor href=#abstractinterpreter></a> AbstractInterpreter</h2><p>hotspot/src/share/vm/interpreter/abstractInterpreter.hpp</p><pre class="line-numbers language-c" data-language=c><code class=language-c><span class="token comment">// The C++ interface to the bytecode interpreter(s).  </span>
class AbstractInterpreter<span class="token operator">:</span> AllStatic <span class="token punctuation">&#123;</span>  
  friend class VMStructs<span class="token punctuation">;</span>  
  friend class Interpreter<span class="token punctuation">;</span>  
  friend class CppInterpreterGenerator<span class="token punctuation">;</span>  
 public<span class="token operator">:</span>  
  <span class="token keyword">enum</span> <span class="token class-name">MethodKind</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// 方法分类,此处为了控制代码长度只保留了常见的几种</span>
    zerolocals<span class="token punctuation">,</span> <span class="token comment">// 需要局部变量表初始化的普通方法 method needs locals initialization  </span>
    zerolocals_synchronized<span class="token punctuation">,</span> <span class="token comment">// 需要局部变量表初始化的普通同步方法</span>
    number_of_method_entries
  <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>  
  
 protected<span class="token operator">:</span>  
  <span class="token keyword">static</span> StubQueue<span class="token operator">*</span> _code<span class="token punctuation">;</span> <span class="token comment">// 解释器初始化是会为此赋值，但我理解作用是什么 :( // the interpreter code (codelets)  </span>
  
  <span class="token comment">// method entry points  </span>
  <span class="token keyword">static</span> address    _entry_table<span class="token punctuation">[</span>number_of_method_entries<span class="token punctuation">]</span><span class="token punctuation">;</span>     <span class="token comment">// java所有分类的方法对应的 entryPoint 数组,通过MethodKind即可找到对应的进入点  </span>
  
  friend class      AbstractInterpreterGenerator<span class="token punctuation">;</span>  <span class="token comment">// 负责生成Stub以及方法进入点 entryPoint</span>
  friend class              InterpreterGenerator<span class="token punctuation">;</span> 
  
 public<span class="token operator">:</span>  
  <span class="token comment">// Initialization/debugging  </span>
  <span class="token keyword">static</span> <span class="token keyword">void</span>       <span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 初始化方法，create_vm时会被调用</span>
  
  <span class="token comment">// 根据方法的元数据返回它的所属分类 MethodKind</span>
  <span class="token keyword">static</span> MethodKind <span class="token function">method_kind</span><span class="token punctuation">(</span>methodHandle m<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 根据方法分类MethodKind返回对应的EntryPoint地址  </span>
  <span class="token keyword">static</span> address    <span class="token function">entry_for_kind</span><span class="token punctuation">(</span>MethodKind k<span class="token punctuation">)</span>                <span class="token punctuation">&#123;</span> <span class="token function">assert</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">&lt;=</span> k <span class="token operator">&amp;&amp;</span> k <span class="token operator">&lt;</span> number_of_method_entries<span class="token punctuation">,</span> <span class="token string">"illegal kind"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> _entry_table<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>  
  <span class="token comment">// 根据方法找到对应的入口点 </span>
  <span class="token comment">// ** 注意: 当类被加载后第一次链接是会遍历方法列表并执行 method->link_method() 方法，内部就会调用此方法获取并绑定对应的EntryPoint **</span>
  <span class="token keyword">static</span> address    <span class="token function">entry_for_method</span><span class="token punctuation">(</span>methodHandle m<span class="token punctuation">)</span>            <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> <span class="token function">entry_for_kind</span><span class="token punctuation">(</span><span class="token function">method_kind</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>  
  
  <span class="token comment">// 动态生成方法入口点，动态语言使用</span>
  <span class="token comment">// 已被禁用, 通过参数-XX:+UnlockDiagnosticVMOptions -XX:+EnableInvokeDynamic开启</span>
  <span class="token keyword">static</span> <span class="token keyword">void</span>       <span class="token function">set_entry_for_kind</span><span class="token punctuation">(</span>MethodKind k<span class="token punctuation">,</span> address e<span class="token punctuation">)</span><span class="token punctuation">;</span>  
  <span class="token comment">// Runtime support  </span>
  <span class="token comment">// length = invoke bytecode length (to advance to next bytecode)  static address deopt_entry(TosState state, int length) &#123; ShouldNotReachHere(); return NULL; &#125; </span>
  <span class="token comment">// 模板解释器会使用此方法，当执行return语句时会进入处理 </span>
  <span class="token keyword">static</span> address <span class="token function">return_entry</span><span class="token punctuation">(</span>TosState state<span class="token punctuation">,</span> <span class="token keyword">int</span> length<span class="token punctuation">,</span> Bytecodes<span class="token operator">::</span>Code code<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token function">ShouldNotReachHere</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span>  
  
  <span class="token keyword">static</span> address    <span class="token function">rethrow_exception_entry</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                   <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> _rethrow_exception_entry<span class="token punctuation">;</span> <span class="token punctuation">&#125;</span> 
<span class="token comment">//------------------------------------------------------------------------------------------------------------------------  </span>
<span class="token comment">// The interpreter generator.  </span>
  
class Template<span class="token punctuation">;</span>  
class AbstractInterpreterGenerator<span class="token operator">:</span> public StackObj <span class="token punctuation">&#123;</span>  
 protected<span class="token operator">:</span>  
  InterpreterMacroAssembler<span class="token operator">*</span> _masm<span class="token punctuation">;</span>  
  
  <span class="token comment">// shared code sequences  </span>
  <span class="token comment">// Converter for native abi result to tosca result  address generate_result_handler_for(BasicType type);  </span>
  address <span class="token function">generate_slow_signature_handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
  
  <span class="token comment">// 根据MethodKind生成对应的 EntryPoint  </span>
  address <span class="token function">generate_method_entry</span><span class="token punctuation">(</span>AbstractInterpreter<span class="token operator">::</span>MethodKind kind<span class="token punctuation">)</span><span class="token punctuation">;</span>  
  
  <span class="token keyword">void</span> <span class="token function">bang_stack_shadow_pages</span><span class="token punctuation">(</span>bool native_call<span class="token punctuation">)</span><span class="token punctuation">;</span>  
  
  <span class="token keyword">void</span> <span class="token function">generate_all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
  <span class="token keyword">void</span> <span class="token function">initialize_method_handle_entries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
  
 public<span class="token operator">:</span>  
  <span class="token function">AbstractInterpreterGenerator</span><span class="token punctuation">(</span>StubQueue<span class="token operator">*</span> _code<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上面展示得源码经过删减，AbstractInterpreter主要就是定义了如下几个重要的方法和类以及属性</p><ul><li><code>MethodKind</code>：表示方法的类型，每种类型的方法有对应<code>EntryPoint</code></li><li><code>_entry_table</code>：方法<code>EntryPoint</code>表，用于存储<code>MethodKind</code>对应的<code>EntryPoint</code></li><li><code>initialize()</code>：在创建虚拟机时会初始化解释器，其中就会执行该方法</li><li><code>entry_for_method(methodHandle m)</code>：根据方法对象返回对应的<code>EntryPoint</code>地址</li><li><code>AbstractInterpreterGenerator</code><ul><li><code>generate_method_entry</code>：根据<code>MethodKind</code>生成对应的<code>EntryPoint</code></li><li><code>generate_all()</code>：生成所有方法类型的<code>EntryPoint</code>，<strong>并将其保存到<code>_entry_table</code>属性中</strong></li></ul></li></ul><p>AbstractInterpreter才是主要的函数定义接口，由<code>CppInterpreter</code>和<code>TemplateInterpreter</code>来实现，上面我们说到在创建虚拟机时会对解释器进行初始化，在初始化的函数中就会执行它的<code>initialize</code>方法，接着就让我们向下看两个解释器的实现对<code>initialize</code>方法是如何处理的吧</p><blockquote><p>在此之前可以看下 create_vm 的整体流程是如何调用 <code>initialize</code>方法的</p></blockquote><pre class="line-numbers language-c" data-language=c><code class=language-c><span class="token comment">// src/share/vm/runtime/thread.cpp</span>
jint Threads<span class="token operator">::</span><span class="token function">create_vm</span><span class="token punctuation">(</span>JavaVMInitArgs<span class="token operator">*</span> args<span class="token punctuation">,</span> bool<span class="token operator">*</span> canTryAgain<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">// ...</span>
<span class="token function">init_globals</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">//...</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// hotspot/src/share/vm/runtime/init.cpp</span>
jint <span class="token function">init_globals</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">// ...</span>
<span class="token function">interpreter_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// before any methods loaded</span>
<span class="token comment">// ...</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// hotspot/src/share/vm/interpreter/interpreter.cpp</span>
<span class="token keyword">void</span> <span class="token function">interpreter_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  
  Interpreter<span class="token operator">::</span><span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 调用 解释器的 initialize()</span>
	<span class="token comment">// ... </span>
<span class="token punctuation">&#125;</span><span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id=cppinterpreter><a class=markdownIt-Anchor href=#cppinterpreter></a> CppInterpreter</h3><img src=/posts/f95e72b6/%E8%A7%A3%E9%87%8A%E5%99%A8initialize%E6%96%B9%E6%B3%95%E8%B0%83%E7%94%A8%E6%B5%81%E7%A8%8B.png class="" title=解释器initialize方法调用流程><p>上面已经介绍了<code>CppInterpreter</code>的定义，这里就不再多说，直接看<code>CppInterpreter.hpp</code>代码中定义了什么</p><p>hotspot/src/share/vm/interpreter/cppInterpreter.hpp</p><pre class="line-numbers language-c" data-language=c><code class=language-c><span class="token comment">// This file contains the platform-independent parts  </span>
<span class="token comment">// of the c++ interpreter  </span>
<span class="token comment">// 继承AbstractInterpreter</span>
class CppInterpreter<span class="token operator">:</span> public AbstractInterpreter <span class="token punctuation">&#123;</span>  
  friend class VMStructs<span class="token punctuation">;</span>  friend class Interpreter<span class="token punctuation">;</span> <span class="token comment">// contains()  </span>
  friend class InterpreterGenerator<span class="token punctuation">;</span> <span class="token comment">// result handlers  </span>
  friend class CppInterpreterGenerator<span class="token punctuation">;</span> <span class="token comment">// result handlers  </span>
 public<span class="token operator">:</span>  
  
 public<span class="token operator">:</span>  <span class="token comment">// Initialization/debugging  </span>
  <span class="token keyword">static</span> <span class="token keyword">void</span>       <span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// </span>
  <span class="token comment">// this only returns whether a pc is within generated code for the interpreter.  </span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">TARGET_ARCH_x86  </span></span>
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">include</span> <span class="token string">"cppInterpreter_x86.hpp"</span>  </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span>  </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">TARGET_ARCH_aarch64  </span></span>
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">include</span> <span class="token string">"cppInterpreter_aarch64.hpp"</span>  </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span>  </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">TARGET_ARCH_sparc  </span></span>
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">include</span> <span class="token string">"cppInterpreter_sparc.hpp"</span>  </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span>  </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">TARGET_ARCH_zero  </span></span>
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">include</span> <span class="token string">"cppInterpreter_zero.hpp"</span>  </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span>  </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">TARGET_ARCH_arm  </span></span>
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">include</span> <span class="token string">"cppInterpreter_arm.hpp"</span>  </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span>  </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">TARGET_ARCH_ppc  </span></span>
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">include</span> <span class="token string">"cppInterpreter_ppc.hpp"</span>  </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span>  </span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span><span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以看到<code>CppInterpreter</code>继承了<code>AbstractInterpreter</code>，其他就主要是声明了一些方法，不过有一点需要注意，就是增加了条件编译，这里我们选择的是zero架构，所以会将<code>cppInterpreter_zero.hpp</code>代码给插入进来，此处需留意后面会说到这里，先接着往下看它的实现代码</p><p>hotspot/src/share/vm/interpreter/cppInterpreter.cpp</p><pre class="line-numbers language-c" data-language=c><code class=language-c><span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">define</span> <span class="token macro-name">__</span> <span class="token expression">_masm<span class="token operator">-></span> </span></span>
<span class="token keyword">void</span> CppInterpreter<span class="token operator">::</span><span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>_code <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
  AbstractInterpreter<span class="token operator">::</span><span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// generate interpreter</span>
  <span class="token punctuation">&#123;</span> ResourceMark rm<span class="token punctuation">;</span>
    TraceTime <span class="token function">timer</span><span class="token punctuation">(</span><span class="token string">"Interpreter generation"</span><span class="token punctuation">,</span> TraceStartupTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> code_size <span class="token operator">=</span> InterpreterCodeSize<span class="token punctuation">;</span>
    <span class="token function">NOT_PRODUCT</span><span class="token punctuation">(</span>code_size <span class="token operator">*=</span> <span class="token number">4</span><span class="token punctuation">;</span><span class="token punctuation">)</span>  <span class="token comment">// debug uses extra interpreter code space</span>
    _code <span class="token operator">=</span> new <span class="token function">StubQueue</span><span class="token punctuation">(</span>new InterpreterCodeletInterface<span class="token punctuation">,</span> code_size<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>
                          <span class="token string">"Interpreter"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    InterpreterGenerator <span class="token function">g</span><span class="token punctuation">(</span>_code<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>PrintInterpreter<span class="token punctuation">)</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token comment">// Allow c++ interpreter to do one initialization now that switches are set, etc.</span>
  BytecodeInterpreter <span class="token function">start_msg</span><span class="token punctuation">(</span>BytecodeInterpreter<span class="token operator">::</span>initialize<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>JvmtiExport<span class="token operator">::</span><span class="token function">can_post_interpreter_events</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    BytecodeInterpreter<span class="token operator">::</span><span class="token function">runWithChecks</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>start_msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span>
    BytecodeInterpreter<span class="token operator">::</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>start_msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

CppInterpreterGenerator<span class="token operator">::</span><span class="token function">CppInterpreterGenerator</span><span class="token punctuation">(</span>StubQueue<span class="token operator">*</span> _code<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token function">AbstractInterpreterGenerator</span><span class="token punctuation">(</span>_code<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> CppInterpreterGenerator<span class="token operator">::</span><span class="token function">generate_all</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  AbstractInterpreterGenerator<span class="token operator">::</span><span class="token function">generate_all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#123;</span>
<span class="token comment">// 宏定义method_entry方法 </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">method_entry</span><span class="token expression"><span class="token punctuation">(</span>kind<span class="token punctuation">)</span> Interpreter<span class="token operator">::</span>_entry_table<span class="token punctuation">[</span>Interpreter<span class="token operator">::</span>kind<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">generate_method_entry</span><span class="token punctuation">(</span>Interpreter<span class="token operator">::</span>kind<span class="token punctuation">)</span></span></span>
  <span class="token punctuation">&#123;</span> CodeletMark <span class="token function">cm</span><span class="token punctuation">(</span>_masm<span class="token punctuation">,</span> <span class="token string">"(kind = frame_manager)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// all non-native method kinds</span>
    <span class="token comment">// 调用上面的宏</span>
    <span class="token function">method_entry</span><span class="token punctuation">(</span>zerolocals<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">method_entry</span><span class="token punctuation">(</span>zerolocals_synchronized<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">method_entry</span><span class="token punctuation">(</span>empty<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">method_entry</span><span class="token punctuation">(</span>accessor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">method_entry</span><span class="token punctuation">(</span>abstract<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ... 省略其他 method_entry(MethodKind)的调用</span>
    <span class="token comment">// 模板方法，留给条件编译的文件代码实现</span>
    <span class="token function">initialize_method_handle_entries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">undef</span> <span class="token expression">method_entry</span></span>
<span class="token punctuation">&#125;</span><span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><code>initialize()</code>：主要做了两件事情<ul><li>定义并初始化<code>InterpreterGenerator g(_code)</code>对象，</li><li>定义并初始化<code>BytecodeInterpreter start_msg(BytecodeInterpreter::initialize)</code>对象，然后执行<code>BytecodeInterpreter::run(&amp;start_msg)</code>方法<ul><li><code>BytecodeInterpreter</code> 字节码解释器，顾名思义，它是最终对字节码指令解释执行的解释器</li></ul></li></ul></li><li><code>generate_all</code>：该方法首先定义了一个<code>method_entry</code>宏，在宏中会调用<code>generate_method_entry</code>方法并传入<code>MethodKind</code>参数，<code>generate_method_entry</code>方法会返回对应的<code>EntryPoint</code>地址，接着以<code>kind</code>参数为索引保存到<code>_entry_table</code>数组属性中，最后调用<code>initialize_method_handle_entries()</code>方法</li></ul><p>可以看到<code>CppInterpreter</code>中并未实现<code>generate_method_entry</code>和<code>initialize_method_handle_entries</code>两个方法，而且<code>generate_all</code>方法没有被调用，是不是有点纳闷，下面马上就会解答，还记得我们在看到<code>CppInterpreter.hpp</code>文件定义了<code>条件编译</code>的代码吗？由于这里我们查看的是<code>zero</code>架构的代码，所以会插入<code>CppInterpreter_zero.cpp</code>的代码到<code>CppInterpreter</code>中，所以两个谜底在该类中可以揭晓</p><ol><li>initialize() 为什么没有调用 <code>generate_all</code>方法</li><li>generate_method_entry 和 initialize_method_handle_entries 方法的实现是什么</li></ol><p>让我们带着问题看下面的代码以及解释</p><h4 id=cppinterpreter_zero><a class=markdownIt-Anchor href=#cppinterpreter_zero></a> CppInterpreter_zero</h4><pre class="line-numbers language-c" data-language=c><code class=language-c><span class="token comment">// CppInterpreter中generate_all方法调用的generate_method_entry便是这里实现</span>
address AbstractInterpreterGenerator<span class="token operator">::</span><span class="token function">generate_method_entry</span><span class="token punctuation">(</span>
    AbstractInterpreter<span class="token operator">::</span>MethodKind kind<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  address entry_point <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

  <span class="token keyword">switch</span> <span class="token punctuation">(</span>kind<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">case</span> Interpreter<span class="token operator">::</span>zerolocals<span class="token operator">:</span>
  <span class="token keyword">case</span> Interpreter<span class="token operator">::</span>zerolocals_synchronized<span class="token operator">:</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token comment">// 删除了很多case，jvm会对Math类的计算方法做特殊内联的处理</span>
  <span class="token keyword">case</span> Interpreter<span class="token operator">::</span>java_lang_math_sin<span class="token operator">:</span>
  <span class="token keyword">case</span> Interpreter<span class="token operator">::</span>java_lang_math_cos<span class="token operator">:</span>
  <span class="token keyword">case</span> Interpreter<span class="token operator">::</span>java_lang_math_tan<span class="token operator">:</span>
  <span class="token keyword">case</span> Interpreter<span class="token operator">::</span>java_lang_math_abs<span class="token operator">:</span>
  <span class="token keyword">case</span> Interpreter<span class="token operator">::</span>java_lang_math_log<span class="token operator">:</span>
  <span class="token keyword">case</span> Interpreter<span class="token operator">::</span>java_lang_math_log10<span class="token operator">:</span>
  <span class="token keyword">case</span> Interpreter<span class="token operator">::</span>java_lang_math_sqrt<span class="token operator">:</span>
  <span class="token keyword">case</span> Interpreter<span class="token operator">::</span>java_lang_math_pow<span class="token operator">:</span>
  <span class="token keyword">case</span> Interpreter<span class="token operator">::</span>java_lang_math_exp<span class="token operator">:</span>
    entry_point <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>InterpreterGenerator<span class="token operator">*</span><span class="token punctuation">)</span> this<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">generate_math_entry</span><span class="token punctuation">(</span>kind<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token keyword">default</span><span class="token operator">:</span>
    <span class="token function">ShouldNotReachHere</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>entry_point <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
	<span class="token comment">// zerolocals 和 zerolocals_synchronized 会进入这里，使用generate_normal_entry方法生成 EntryPoint</span>
    entry_point <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>InterpreterGenerator<span class="token operator">*</span><span class="token punctuation">)</span> this<span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">generate_normal_entry</span><span class="token punctuation">(</span>false<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> entry_point<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

address InterpreterGenerator<span class="token operator">::</span><span class="token function">generate_normal_entry</span><span class="token punctuation">(</span>bool synchronized<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>synchronized <span class="token operator">==</span> false<span class="token punctuation">,</span> <span class="token string">"should be"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token keyword">return</span> <span class="token function">generate_entry</span><span class="token punctuation">(</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span> CppInterpreter<span class="token operator">::</span>normal_entry<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// 普通java方法执行的入口点</span>
<span class="token keyword">int</span> CppInterpreter<span class="token operator">::</span><span class="token function">normal_entry</span><span class="token punctuation">(</span>Method<span class="token operator">*</span> method<span class="token punctuation">,</span> <span class="token class-name">intptr_t</span> UNUSED<span class="token punctuation">,</span> TRAPS<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 当前线程</span>
  JavaThread <span class="token operator">*</span>thread <span class="token operator">=</span> <span class="token punctuation">(</span>JavaThread <span class="token operator">*</span><span class="token punctuation">)</span> THREAD<span class="token punctuation">;</span>  
  <span class="token comment">// Allocate and initialize our frame.  </span>
  <span class="token comment">// 为该方法分配局部变量表空间并且创建解释器栈帧</span>
  InterpreterFrame <span class="token operator">*</span>frame <span class="token operator">=</span> InterpreterFrame<span class="token operator">::</span><span class="token function">build</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> CHECK_0<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 将栈帧压入当前线程栈</span>
  thread<span class="token operator">-></span><span class="token function">push_zero_frame</span><span class="token punctuation">(</span>frame<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// Execute those bytecodes!</span>
  <span class="token comment">// 执行方法中的字节码指令</span>
  <span class="token function">main_loop</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> THREAD<span class="token punctuation">)</span><span class="token punctuation">;</span>  
  <span class="token comment">// No deoptimized frames on the stack  </span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>  
<span class="token punctuation">&#125;</span>
<span class="token comment">// 创建解释器栈帧</span>
InterpreterFrame <span class="token operator">*</span>InterpreterFrame<span class="token operator">::</span><span class="token function">build</span><span class="token punctuation">(</span>Method<span class="token operator">*</span> <span class="token keyword">const</span> method<span class="token punctuation">,</span> TRAPS<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  JavaThread <span class="token operator">*</span>thread <span class="token operator">=</span> <span class="token punctuation">(</span>JavaThread <span class="token operator">*</span><span class="token punctuation">)</span> THREAD<span class="token punctuation">;</span>
  ZeroStack <span class="token operator">*</span>stack <span class="token operator">=</span> thread<span class="token operator">-></span><span class="token function">zero_stack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Calculate the size of the frame we'll build, including</span>
  <span class="token comment">// any adjustments to the caller's frame that we'll make.</span>
  <span class="token comment">// 局部变量个数</span>
  <span class="token keyword">int</span> extra_locals  <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token comment">// 监视器锁个数</span>
  <span class="token keyword">int</span> monitor_words <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token comment">// 局部变量表大小</span>
  <span class="token keyword">int</span> stack_words   <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>method<span class="token operator">-></span><span class="token function">is_native</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">// 计算局部变量大小</span>
    extra_locals <span class="token operator">=</span> method<span class="token operator">-></span><span class="token function">max_locals</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> method<span class="token operator">-></span><span class="token function">size_of_parameters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    stack_words  <span class="token operator">=</span> method<span class="token operator">-></span><span class="token function">max_stack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>method<span class="token operator">-></span><span class="token function">is_synchronized</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
   <span class="token comment">// 如果是同步方法，获取监视器大小</span>
    monitor_words <span class="token operator">=</span> frame<span class="token operator">::</span><span class="token function">interpreter_frame_monitor_size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token comment">// 栈溢出检查</span>
  stack<span class="token operator">-></span><span class="token function">overflow_check</span><span class="token punctuation">(</span>
    extra_locals <span class="token operator">+</span> header_words <span class="token operator">+</span> monitor_words <span class="token operator">+</span> stack_words<span class="token punctuation">,</span> CHECK_NULL<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Adjust the caller's stack frame to accomodate any additional</span>
  <span class="token comment">// local variables we have contiguously with our parameters.</span>
  <span class="token comment">// 压栈操作 预分配变量数量个数的空间并初始化为0</span>
  <span class="token comment">// 因为方法参数已经入栈了,所以这里只需要分配局部变量的空间</span>
  <span class="token comment">// 本质是移动sp指针 *(--sp) = value </span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> extra_locals<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    stack<span class="token operator">-></span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 局部变量表引用</span>
  <span class="token class-name">intptr_t</span> <span class="token operator">*</span>locals<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>method<span class="token operator">-></span><span class="token function">is_native</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token comment">// native方法，没有局部变量</span>
    locals <span class="token operator">=</span> stack<span class="token operator">-></span><span class="token function">sp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>method<span class="token operator">-></span><span class="token function">size_of_parameters</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span>
	<span class="token comment">// java方法 max_locals()返回局部变量表的大小</span>
	<span class="token comment">// 计算局部变量起始位置 init_sp - extra_locals + max_locals - 1</span>
    locals <span class="token operator">=</span> stack<span class="token operator">-></span><span class="token function">sp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>method<span class="token operator">-></span><span class="token function">max_locals</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  stack<span class="token operator">-></span><span class="token function">push</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// next_frame, filled in later</span>
  <span class="token comment">// 栈顶指针</span>
  <span class="token class-name">intptr_t</span> <span class="token operator">*</span>fp <span class="token operator">=</span> stack<span class="token operator">-></span><span class="token function">sp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// next_frame_off == 0 ,这里应该是必然相等的，但不知道为啥要断言</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>fp <span class="token operator">-</span> stack<span class="token operator">-></span><span class="token function">sp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> next_frame_off<span class="token punctuation">,</span> <span class="token string">"should be"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 设置帧类型为解释器帧类型</span>
  stack<span class="token operator">-></span><span class="token function">push</span><span class="token punctuation">(</span>INTERPRETER_FRAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// frame_type_off == 1 ,这里应该是必然相等的，但不知道为啥要断言</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>fp <span class="token operator">-</span> stack<span class="token operator">-></span><span class="token function">sp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> frame_type_off<span class="token punctuation">,</span> <span class="token string">"should be"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 解释器状态或者称为解释器上下文对象(我喜欢叫上下文对象，它保存了执行方法所需要的所有信息)</span>
  <span class="token comment">// 在栈上分配一个 InterpreterState 大小的空间</span>
  <span class="token comment">// 这个空间用于存放解释器解释执行方法时所需要的空间（因为解释方法也是方法，也需要分配栈帧空间来存储变量）</span>
  interpreterState istate <span class="token operator">=</span>
    <span class="token punctuation">(</span>interpreterState<span class="token punctuation">)</span> stack<span class="token operator">-></span><span class="token function">alloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>BytecodeInterpreter<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">assert</span><span class="token punctuation">(</span>fp <span class="token operator">-</span> stack<span class="token operator">-></span><span class="token function">sp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> istate_off<span class="token punctuation">,</span> <span class="token string">"should be"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 设置局部变量表指针</span>
  istate<span class="token operator">-></span><span class="token function">set_locals</span><span class="token punctuation">(</span>locals<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 执行的方法对象</span>
  istate<span class="token operator">-></span><span class="token function">set_method</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 关联自己，如果为null说明无效</span>
  istate<span class="token operator">-></span><span class="token function">set_self_link</span><span class="token punctuation">(</span>istate<span class="token punctuation">)</span><span class="token punctuation">;</span>
  istate<span class="token operator">-></span><span class="token function">set_prev_link</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 执行线程</span>
  istate<span class="token operator">-></span><span class="token function">set_thread</span><span class="token punctuation">(</span>thread<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 字节码指针</span>
  istate<span class="token operator">-></span><span class="token function">set_bcp</span><span class="token punctuation">(</span>method<span class="token operator">-></span><span class="token function">is_native</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token constant">NULL</span> <span class="token operator">:</span> method<span class="token operator">-></span><span class="token function">code_base</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 方法常量池</span>
  istate<span class="token operator">-></span><span class="token function">set_constants</span><span class="token punctuation">(</span>method<span class="token operator">-></span><span class="token function">constants</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">cache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 消息: 表明当前解释器上下文的阶段，method_entry表示方法进入</span>
  istate<span class="token operator">-></span><span class="token function">set_msg</span><span class="token punctuation">(</span>BytecodeInterpreter<span class="token operator">::</span>method_entry<span class="token punctuation">)</span><span class="token punctuation">;</span>
  istate<span class="token operator">-></span><span class="token function">set_oop_temp</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  istate<span class="token operator">-></span><span class="token function">set_mdx</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  istate<span class="token operator">-></span><span class="token function">set_callee</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// BasicObjectLock 对象指针起始地址（有关synchronized的实现）</span>
  istate<span class="token operator">-></span><span class="token function">set_monitor_base</span><span class="token punctuation">(</span><span class="token punctuation">(</span>BasicObjectLock <span class="token operator">*</span><span class="token punctuation">)</span> stack<span class="token operator">-></span><span class="token function">sp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>method<span class="token operator">-></span><span class="token function">is_synchronized</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// 如果是同步方法，会分配锁对象的BasicObjectLock空间</span>
    BasicObjectLock <span class="token operator">*</span>monitor <span class="token operator">=</span>
      <span class="token punctuation">(</span>BasicObjectLock <span class="token operator">*</span><span class="token punctuation">)</span> stack<span class="token operator">-></span><span class="token function">alloc</span><span class="token punctuation">(</span>monitor_words <span class="token operator">*</span> wordSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 关联的锁对象</span>
    oop object<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>method<span class="token operator">-></span><span class="token function">is_static</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	  <span class="token comment">// 静态方法锁对象是 class</span>
      object <span class="token operator">=</span> method<span class="token operator">-></span><span class="token function">constants</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">pool_holder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">java_mirror</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
	  <span class="token comment">// 实例方法随对象是this</span>
      object <span class="token operator">=</span> <span class="token punctuation">(</span>oop<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>locals<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    monitor<span class="token operator">-></span><span class="token function">set_obj</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token comment">// 设置上下文的栈基地址</span>
  istate<span class="token operator">-></span><span class="token function">set_stack_base</span><span class="token punctuation">(</span>stack<span class="token operator">-></span><span class="token function">sp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 设置上下文的栈顶指针</span>
  istate<span class="token operator">-></span><span class="token function">set_stack</span><span class="token punctuation">(</span>stack<span class="token operator">-></span><span class="token function">sp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 局部变量表的大小不为0</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>stack_words<span class="token punctuation">)</span>
  <span class="token comment">// 在栈上分配局部变量长度大小的空间</span>
    stack<span class="token operator">-></span><span class="token function">alloc</span><span class="token punctuation">(</span>stack_words <span class="token operator">*</span> wordSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 设置上下文的栈边界地址</span>
  istate<span class="token operator">-></span><span class="token function">set_stack_limit</span><span class="token punctuation">(</span>stack<span class="token operator">-></span><span class="token function">sp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 返回解释器帧地址</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>InterpreterFrame <span class="token operator">*</span><span class="token punctuation">)</span> fp<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>


<span class="token comment">// 为了连贯性将cppInterpreterGenerator_zero的代码也放到这里了</span>
<span class="token comment">// ==========  hotspot/src/cpu/zero/vm/cppInterpreterGenerator_zero.hpp start =====</span>
protected<span class="token operator">:</span>  
 address <span class="token function">generate_entry</span><span class="token punctuation">(</span>address entry_point<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  
       <span class="token keyword">return</span> <span class="token function">generate_entry_impl</span><span class="token punctuation">(</span><span class="token function">assembler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> entry_point<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">&#125;</span>
 
public<span class="token operator">:</span>  
 <span class="token keyword">static</span> address <span class="token function">generate_entry_impl</span><span class="token punctuation">(</span>MacroAssembler<span class="token operator">*</span> masm<span class="token punctuation">,</span> address entry_point<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
   <span class="token comment">// 当前代码段的当前位置的地址</span>
   <span class="token comment">// src/share/vm/asm/assembler.hpp#pc()</span>
   ZeroEntry <span class="token operator">*</span>entry <span class="token operator">=</span> <span class="token punctuation">(</span>ZeroEntry <span class="token operator">*</span><span class="token punctuation">)</span> masm<span class="token operator">-></span><span class="token function">pc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// 计算 ZeroEntry 的大小，移动ZeroEntry个大小的pc()指针，腾出内存区域来存放 ZeroEntry</span>
   masm<span class="token operator">-></span><span class="token function">advance</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>ZeroEntry<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// 关联 entry_point</span>
   entry<span class="token operator">-></span><span class="token function">set_entry_point</span><span class="token punctuation">(</span>entry_point<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// 返回entry的地址  </span>
   <span class="token keyword">return</span> <span class="token punctuation">(</span>address<span class="token punctuation">)</span> entry<span class="token punctuation">;</span>  
 <span class="token punctuation">&#125;</span>  
<span class="token comment">// =========== hotspot/src/cpu/zero/vm/cppInterpreterGenerator_zero.hpp end ======</span>

<span class="token comment">// 在CppInterpreter中的initialize方法中会创建 InterpreterGenerator 实例，可以看到，在构造方法中，执行了generate_all()方法</span>
InterpreterGenerator<span class="token operator">::</span><span class="token function">InterpreterGenerator</span><span class="token punctuation">(</span>StubQueue<span class="token operator">*</span> code<span class="token punctuation">)</span>
 <span class="token operator">:</span> <span class="token function">CppInterpreterGenerator</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
   <span class="token function">generate_all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">void</span> CppInterpreter<span class="token operator">::</span><span class="token function">main_loop</span><span class="token punctuation">(</span><span class="token keyword">int</span> recurse<span class="token punctuation">,</span> TRAPS<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  JavaThread <span class="token operator">*</span>thread <span class="token operator">=</span> <span class="token punctuation">(</span>JavaThread <span class="token operator">*</span><span class="token punctuation">)</span> THREAD<span class="token punctuation">;</span>
  ZeroStack <span class="token operator">*</span>stack <span class="token operator">=</span> thread<span class="token operator">-></span><span class="token function">zero_stack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// If we are entering from a deopt we may need to call</span>
  <span class="token comment">// ourself a few times in order to get to our frame.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>recurse<span class="token punctuation">)</span>
    <span class="token function">main_loop</span><span class="token punctuation">(</span>recurse <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> THREAD<span class="token punctuation">)</span><span class="token punctuation">;</span>

  InterpreterFrame <span class="token operator">*</span>frame <span class="token operator">=</span> thread<span class="token operator">-></span><span class="token function">top_zero_frame</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">as_interpreter_frame</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  interpreterState istate <span class="token operator">=</span> frame<span class="token operator">-></span><span class="token function">interpreter_state</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Method<span class="token operator">*</span> method <span class="token operator">=</span> istate<span class="token operator">-></span><span class="token function">method</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token class-name">intptr_t</span> <span class="token operator">*</span>result <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> result_slots <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span>true<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// We can set up the frame anchor with everything we want at</span>
    <span class="token comment">// this point as we are thread_in_Java and no safepoints can</span>
    <span class="token comment">// occur until we go to vm mode.  We do have to clear flags</span>
    <span class="token comment">// on return from vm but that is it.</span>
    thread<span class="token operator">-></span><span class="token function">set_last_Java_frame</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Call the interpreter</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>JvmtiExport<span class="token operator">::</span><span class="token function">can_post_interpreter_events</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      BytecodeInterpreter<span class="token operator">::</span><span class="token function">runWithChecks</span><span class="token punctuation">(</span>istate<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
      BytecodeInterpreter<span class="token operator">::</span><span class="token function">run</span><span class="token punctuation">(</span>istate<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fixup_after_potential_safepoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Clear the frame anchor</span>
    thread<span class="token operator">-></span><span class="token function">reset_last_Java_frame</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Examine the message from the interpreter to decide what to do</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>istate<span class="token operator">-></span><span class="token function">msg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> BytecodeInterpreter<span class="token operator">::</span>call_method<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      Method<span class="token operator">*</span> callee <span class="token operator">=</span> istate<span class="token operator">-></span><span class="token function">callee</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Trim back the stack to put the parameters at the top</span>
      stack<span class="token operator">-></span><span class="token function">set_sp</span><span class="token punctuation">(</span>istate<span class="token operator">-></span><span class="token function">stack</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Make the call</span>
      Interpreter<span class="token operator">::</span><span class="token function">invoke_method</span><span class="token punctuation">(</span>callee<span class="token punctuation">,</span> istate<span class="token operator">-></span><span class="token function">callee_entry_point</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> THREAD<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">fixup_after_potential_safepoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Convert the result</span>
      istate<span class="token operator">-></span><span class="token function">set_stack</span><span class="token punctuation">(</span>stack<span class="token operator">-></span><span class="token function">sp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Restore the stack</span>
      stack<span class="token operator">-></span><span class="token function">set_sp</span><span class="token punctuation">(</span>istate<span class="token operator">-></span><span class="token function">stack_limit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Resume the interpreter</span>
      istate<span class="token operator">-></span><span class="token function">set_msg</span><span class="token punctuation">(</span>BytecodeInterpreter<span class="token operator">::</span>method_resume<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>istate<span class="token operator">-></span><span class="token function">msg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> BytecodeInterpreter<span class="token operator">::</span>more_monitors<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">int</span> monitor_words <span class="token operator">=</span> frame<span class="token operator">::</span><span class="token function">interpreter_frame_monitor_size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Allocate the space</span>
      stack<span class="token operator">-></span><span class="token function">overflow_check</span><span class="token punctuation">(</span>monitor_words<span class="token punctuation">,</span> THREAD<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>HAS_PENDING_EXCEPTION<span class="token punctuation">)</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      stack<span class="token operator">-></span><span class="token function">alloc</span><span class="token punctuation">(</span>monitor_words <span class="token operator">*</span> wordSize<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Move the expression stack contents</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">intptr_t</span> <span class="token operator">*</span>p <span class="token operator">=</span> istate<span class="token operator">-></span><span class="token function">stack</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> p <span class="token operator">&lt;</span> istate<span class="token operator">-></span><span class="token function">stack_base</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> p<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token operator">*</span><span class="token punctuation">(</span>p <span class="token operator">-</span> monitor_words<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>

      <span class="token comment">// Move the expression stack pointers</span>
      istate<span class="token operator">-></span><span class="token function">set_stack_limit</span><span class="token punctuation">(</span>istate<span class="token operator">-></span><span class="token function">stack_limit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> monitor_words<span class="token punctuation">)</span><span class="token punctuation">;</span>
      istate<span class="token operator">-></span><span class="token function">set_stack</span><span class="token punctuation">(</span>istate<span class="token operator">-></span><span class="token function">stack</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> monitor_words<span class="token punctuation">)</span><span class="token punctuation">;</span>
      istate<span class="token operator">-></span><span class="token function">set_stack_base</span><span class="token punctuation">(</span>istate<span class="token operator">-></span><span class="token function">stack_base</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> monitor_words<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Zero the new monitor so the interpreter can find it.</span>
      <span class="token punctuation">(</span><span class="token punctuation">(</span>BasicObjectLock <span class="token operator">*</span><span class="token punctuation">)</span> istate<span class="token operator">-></span><span class="token function">stack_base</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">set_obj</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Resume the interpreter</span>
      istate<span class="token operator">-></span><span class="token function">set_msg</span><span class="token punctuation">(</span>BytecodeInterpreter<span class="token operator">::</span>got_monitors<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>istate<span class="token operator">-></span><span class="token function">msg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> BytecodeInterpreter<span class="token operator">::</span>return_from_method<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// Copy the result into the caller's frame</span>
      result_slots <span class="token operator">=</span> type2size<span class="token punctuation">[</span>method<span class="token operator">-></span><span class="token function">result_type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token function">assert</span><span class="token punctuation">(</span>result_slots <span class="token operator">>=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> result_slots <span class="token operator">&lt;=</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"what?"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      result <span class="token operator">=</span> istate<span class="token operator">-></span><span class="token function">stack</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> result_slots<span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>istate<span class="token operator">-></span><span class="token function">msg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> BytecodeInterpreter<span class="token operator">::</span>throwing_exception<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token function">assert</span><span class="token punctuation">(</span>HAS_PENDING_EXCEPTION<span class="token punctuation">,</span> <span class="token string">"should do"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>istate<span class="token operator">-></span><span class="token function">msg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> BytecodeInterpreter<span class="token operator">::</span>do_osr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// Unwind the current frame</span>
      thread<span class="token operator">-></span><span class="token function">pop_zero_frame</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Remove any extension of the previous frame</span>
      <span class="token keyword">int</span> extra_locals <span class="token operator">=</span> method<span class="token operator">-></span><span class="token function">max_locals</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> method<span class="token operator">-></span><span class="token function">size_of_parameters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      stack<span class="token operator">-></span><span class="token function">set_sp</span><span class="token punctuation">(</span>stack<span class="token operator">-></span><span class="token function">sp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> extra_locals<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// Jump into the OSR method</span>
      Interpreter<span class="token operator">::</span><span class="token function">invoke_osr</span><span class="token punctuation">(</span>
        method<span class="token punctuation">,</span> istate<span class="token operator">-></span><span class="token function">osr_entry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> istate<span class="token operator">-></span><span class="token function">osr_buf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> THREAD<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
      <span class="token function">ShouldNotReachHere</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token comment">// Unwind the current frame</span>
  thread<span class="token operator">-></span><span class="token function">pop_zero_frame</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// Pop our local variables</span>
  stack<span class="token operator">-></span><span class="token function">set_sp</span><span class="token punctuation">(</span>stack<span class="token operator">-></span><span class="token function">sp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> method<span class="token operator">-></span><span class="token function">max_locals</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Push our result</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> result_slots<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// Adjust result to smaller</span>
    <span class="token keyword">union</span> <span class="token punctuation">&#123;</span>
      <span class="token class-name">intptr_t</span> res<span class="token punctuation">;</span>
      jint res_jint<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
    res <span class="token operator">=</span> result<span class="token punctuation">[</span><span class="token operator">-</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result_slots <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      BasicType t <span class="token operator">=</span> method<span class="token operator">-></span><span class="token function">result_type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">is_subword_type</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        res_jint <span class="token operator">=</span> <span class="token punctuation">(</span>jint<span class="token punctuation">)</span><span class="token function">narrow</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> res_jint<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    stack<span class="token operator">-></span><span class="token function">push</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">// CC_INTERP</span></span><span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>该类中的其他函数都已经被删掉，只保留核心的280行代码<br>之前看到<code>CppInterpreter#generate_all</code> 方法会调用<code>generate_method_entry</code>，其实就是调用上面的方法<br>下面来分析整个执行链做了哪些事情<br><code>generate_method_entry</code>：根据传入的<code>MethodKind</code>参数进入对应的分支处理，我们普通的java方法大都是<code>zerolocals</code>，所以会直接break，接着会直接<code>generate_normal_entry</code>方法</p><ul><li><code>generate_normal_entry</code>：它直接执行<code>generate_entry</code>方法，并将<code>CppInterpreter::normal_entry</code>方法的地址值作为参数进行传递</li><li><code>generate_entry</code>：<br><code>normal_entry</code>：就做三件事</li></ul><ul><li><code>InterpreterFrame::build</code>：为方法局部变量表分配空间，如果是同步方法会创建BasicLockObject对象来关联锁对象，然后在栈上分配解释器方法栈帧，存放解释器上下文对象以及执行方法时所需的变量</li><li><code>Thread::push_zero_frame</code>：将创建的栈帧压入线程栈中</li><li><code>main_loop</code>：执行字节码指令的入口<ul><li><code>BytecodeInterpreter::run(istate)</code> 内部调用此方法执行字节码指令，限于篇幅，本章不介绍如何执行的了，有兴趣查看这篇博客<a href=/posts/1fe4afce.html>字节码指令执行过程 BytecodeInterpreter</a></li></ul></li></ul><h3 id=templateinterpreter><a class=markdownIt-Anchor href=#templateinterpreter></a> TemplateInterpreter</h3><p>前文说过，初始化解释器时会调用<code>Interpreter::initialize</code>方法，那么这里就不再花费过多的篇幅，让我们直接看<code>TemplateInterpreter::initialize</code>方法做了什么</p><blockquote><p>注意的是，TemplateInterpreter没有zero架构的实现，因此我这里采取<code>aarch64</code>架构的进行展示，这种逻辑都是一样的，看懂一个就ok了</p></blockquote><p>hotspot/src/share/vm/interpreter/templateInterpreter.cpp</p><pre class="line-numbers language-c" data-language=c><code class=language-c><span class="token comment">// 正在使用到的字节码指令分发表，在_normal_table和_safept_table之间切换</span>
DispatchTable TemplateInterpreter<span class="token operator">::</span>_active_table<span class="token punctuation">;</span> 
<span class="token comment">// 正常状态下的字节码指令分发表 只要关注这个即可</span>
DispatchTable TemplateInterpreter<span class="token operator">::</span>_normal_table<span class="token punctuation">;</span>
<span class="token comment">// 安全点状态下的字节码指令分发表</span>
DispatchTable TemplateInterpreter<span class="token operator">::</span>_safept_table<span class="token punctuation">;</span>

<span class="token keyword">void</span> TemplateInterpreter<span class="token operator">::</span><span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>_code <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token comment">// assertions</span>
  <span class="token function">assert</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>Bytecodes<span class="token operator">::</span>number_of_codes <span class="token operator">&lt;=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>DispatchTable<span class="token operator">::</span>length<span class="token punctuation">,</span>
         <span class="token string">"dispatch table too small"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  AbstractInterpreter<span class="token operator">::</span><span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 这里是关键，初始化 dispatch table</span>
  TemplateTable<span class="token operator">::</span><span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// generate interpreter</span>
  <span class="token punctuation">&#123;</span> ResourceMark rm<span class="token punctuation">;</span>
    TraceTime <span class="token function">timer</span><span class="token punctuation">(</span><span class="token string">"Interpreter generation"</span><span class="token punctuation">,</span> TraceStartupTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> code_size <span class="token operator">=</span> InterpreterCodeSize<span class="token punctuation">;</span>
    <span class="token function">NOT_PRODUCT</span><span class="token punctuation">(</span>code_size <span class="token operator">*=</span> <span class="token number">4</span><span class="token punctuation">;</span><span class="token punctuation">)</span>  <span class="token comment">// debug uses extra interpreter code space</span>
    _code <span class="token operator">=</span> new <span class="token function">StubQueue</span><span class="token punctuation">(</span>new InterpreterCodeletInterface<span class="token punctuation">,</span> code_size<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>
                          <span class="token string">"Interpreter"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 解释器生成器：也是生成各种方法类型的 EntryPoint</span>
    InterpreterGenerator <span class="token function">g</span><span class="token punctuation">(</span>_code<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>PrintInterpreter<span class="token punctuation">)</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token comment">// initialize dispatch table</span>
  <span class="token comment">// 将当前使用的分发表指针 _active_table 指向normal_table </span>
  _active_table <span class="token operator">=</span> _normal_table<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上面的代码最核心的就是执行<code>TemplateTable::initialize</code>方法以及初始化解释器生成器<code>InterpreterGenerator g(_code)</code>，接下来直接查看这两个方法内做了哪些事情</p><h4 id=templatetable><a class=markdownIt-Anchor href=#templatetable></a> TemplateTable</h4><ul><li>hotspot/src/share/vm/interpreter/templateTable.cpp</li></ul><pre class="line-numbers language-c" data-language=c><code class=language-c><span class="token keyword">void</span> TemplateTable<span class="token operator">::</span><span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>_is_initialized<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

  <span class="token comment">// Initialize table</span>
  TraceTime <span class="token function">timer</span><span class="token punctuation">(</span><span class="token string">"TemplateTable initialization"</span><span class="token punctuation">,</span> TraceStartupTime<span class="token punctuation">)</span><span class="token punctuation">;</span>

  _bs <span class="token operator">=</span> Universe<span class="token operator">::</span><span class="token function">heap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">barrier_set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// For better readability</span>
  <span class="token keyword">const</span> <span class="token keyword">char</span> _    <span class="token operator">=</span> <span class="token char">' '</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token keyword">int</span>  ____ <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token keyword">int</span>  ubcp <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> Template<span class="token operator">::</span>uses_bcp_bit<span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token keyword">int</span>  disp <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> Template<span class="token operator">::</span>does_dispatch_bit<span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token keyword">int</span>  clvm <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> Template<span class="token operator">::</span>calls_vm_bit<span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token keyword">int</span>  iswd <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> Template<span class="token operator">::</span>wide_bit<span class="token punctuation">;</span>
  <span class="token comment">//                                    interpr. templates</span>
  <span class="token comment">// Java spec bytecodes                ubcp|disp|clvm|iswd  in    out   generator             argument</span>
  <span class="token comment">// 这里就是建立字节码指令和与之对应处理方法的映射关系</span>
  <span class="token comment">// 这里只展示了建立 iload 以及对应处理方法的映射关系 </span>
  <span class="token function">def</span><span class="token punctuation">(</span>Bytecodes<span class="token operator">::</span>_iload               <span class="token punctuation">,</span> ubcp<span class="token operator">|</span>____<span class="token operator">|</span>clvm<span class="token operator">|</span>____<span class="token punctuation">,</span> vtos<span class="token punctuation">,</span> itos<span class="token punctuation">,</span> iload               <span class="token punctuation">,</span>  _           <span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">// 省略了将近300行的字节码指令与模板方法的映射关系定义</span>

  _is_initialized <span class="token operator">=</span> true<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">/*
*  Bytecodes::Code code：字节码指令
*  flags: 字节码指令的标识位
*  TosState in：执行该字节码指令时输入的栈顶状态 Top Of Stack State
*  TosState out：执行该字节码指令时输出的栈顶状态 Top Of Stack State
*  gen: 字节码指令处理函数地址
*  arg：字节码指令处理函数参数
*/</span>
<span class="token keyword">void</span> TemplateTable<span class="token operator">::</span><span class="token function">def</span><span class="token punctuation">(</span>Bytecodes<span class="token operator">::</span>Code code<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> TosState in<span class="token punctuation">,</span> TosState out<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>gen<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">int</span> arg<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  
  <span class="token comment">// should factor out these constants  </span>
  <span class="token keyword">const</span> <span class="token keyword">int</span> ubcp <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> Template<span class="token operator">::</span>uses_bcp_bit<span class="token punctuation">;</span>  
  <span class="token keyword">const</span> <span class="token keyword">int</span> disp <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> Template<span class="token operator">::</span>does_dispatch_bit<span class="token punctuation">;</span>  
  <span class="token keyword">const</span> <span class="token keyword">int</span> clvm <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> Template<span class="token operator">::</span>calls_vm_bit<span class="token punctuation">;</span>  
  <span class="token keyword">const</span> <span class="token keyword">int</span> iswd <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> Template<span class="token operator">::</span>wide_bit<span class="token punctuation">;</span>  
  <span class="token comment">// determine which table to use  </span>
  bool is_wide <span class="token operator">=</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> iswd<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>  
  <span class="token comment">// make sure that wide instructions have a vtos entry point  </span>
  <span class="token comment">// (since they are executed extremely rarely, it doesn't pay out to have an  // extra set of 5 dispatch tables for the wide instructions - for simplicity  // they all go with one table)  assert(in == vtos || !is_wide, "wide instructions have vtos entry point only"); </span>
 <span class="token comment">// </span>
  Template<span class="token operator">*</span> t <span class="token operator">=</span> is_wide <span class="token operator">?</span> <span class="token function">template_for_wide</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">template_for</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>  
  <span class="token comment">// setup entry  属性初始化</span>
  t<span class="token operator">-></span><span class="token function">initialize</span><span class="token punctuation">(</span>flags<span class="token punctuation">,</span> in<span class="token punctuation">,</span> out<span class="token punctuation">,</span> gen<span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>  
  <span class="token function">assert</span><span class="token punctuation">(</span>t<span class="token operator">-></span><span class="token function">bytecode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> code<span class="token punctuation">,</span> <span class="token string">"just checkin'"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">&#125;</span>

<span class="token comment">// 根据code获取从模板表中获取对应的Template对象</span>
<span class="token keyword">static</span> Template<span class="token operator">*</span> <span class="token function">template_for</span><span class="token punctuation">(</span>Bytecodes<span class="token operator">::</span>Code code<span class="token punctuation">)</span>  <span class="token punctuation">&#123;</span>
	Bytecodes<span class="token operator">::</span><span class="token function">check</span>     <span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>_template_table     <span class="token punctuation">[</span>code<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 初始化模板对象属性值</span>
<span class="token keyword">void</span> Template<span class="token operator">::</span><span class="token function">initialize</span><span class="token punctuation">(</span><span class="token keyword">int</span> flags<span class="token punctuation">,</span> TosState tos_in<span class="token punctuation">,</span> TosState tos_out<span class="token punctuation">,</span> generator gen<span class="token punctuation">,</span> <span class="token keyword">int</span> arg<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  _flags   <span class="token operator">=</span> flags<span class="token punctuation">;</span>
  _tos_in  <span class="token operator">=</span> tos_in<span class="token punctuation">;</span>
  _tos_out <span class="token operator">=</span> tos_out<span class="token punctuation">;</span>
  _gen     <span class="token operator">=</span> gen<span class="token punctuation">;</span>
  _arg     <span class="token operator">=</span> arg<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>可以看到在<code>def</code>方法中会传入字节码指令处理函数<code>gen</code>的地址，而根据不同架构函数的实现也会有所不同，所以<code>TemplateTable</code>有不同的架构实现，我们看<code>aarch64</code>平台下的<code>TemplateTable</code>的实现<br>hotspot/src/cpu/aarch64/vm/templateTable_aarch64.cpp</p><pre class="line-numbers language-c" data-language=c><code class=language-c><span class="token keyword">void</span> TemplateTable<span class="token operator">::</span><span class="token function">iload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>  
  <span class="token function">transition</span><span class="token punctuation">(</span>vtos<span class="token punctuation">,</span> itos<span class="token punctuation">)</span><span class="token punctuation">;</span>  
  <span class="token keyword">if</span> <span class="token punctuation">(</span>RewriteFrequentPairs<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  
    <span class="token comment">// 删掉了在某些case下对iload重写优化的逻辑</span>
  <span class="token punctuation">&#125;</span>  
  <span class="token comment">// do iload, get the local value into tos  </span>
  <span class="token function">locals_index</span><span class="token punctuation">(</span>r1<span class="token punctuation">)</span><span class="token punctuation">;</span>  
  __ <span class="token function">ldr</span><span class="token punctuation">(</span>r0<span class="token punctuation">,</span> <span class="token function">iaddress</span><span class="token punctuation">(</span>r1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token punctuation">&#125;</span>
<span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><code>iload()</code>：可以看到对<code>iload</code>指令的处理就是将局部变量表的索引给r1，然后从局部变量表加载int类型的值到寄存器r0中</li></ul><p>初始化<code>InterpreterGenerator</code> 时会生成各种类型方法的<code>EntryPoint</code><br>hotspot/src/cpu/aarch64/vm/templateInterpreter_aarch64.cpp</p><pre class="line-numbers language-c" data-language=c><code class=language-c>  
InterpreterGenerator<span class="token operator">::</span><span class="token function">InterpreterGenerator</span><span class="token punctuation">(</span>StubQueue<span class="token operator">*</span> code<span class="token punctuation">)</span>  
  <span class="token operator">:</span> <span class="token function">TemplateInterpreterGenerator</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  
   <span class="token function">generate_all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// down here so it can be "virtual"  </span>
<span class="token punctuation">&#125;</span>


<span class="token keyword">void</span> TemplateInterpreterGenerator<span class="token operator">::</span><span class="token function">generate_all</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  AbstractInterpreterGenerator<span class="token operator">::</span><span class="token function">generate_all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 宏定义</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">method_entry</span><span class="token expression"><span class="token punctuation">(</span>kind<span class="token punctuation">)</span>                                                                    </span><span class="token punctuation">\</span>
  <span class="token expression"><span class="token punctuation">&#123;</span> CodeletMark <span class="token function">cm</span><span class="token punctuation">(</span>_masm<span class="token punctuation">,</span> </span><span class="token string">"method entry point (kind = "</span> <span class="token expression"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">kind</span> </span></span><span class="token string">")"</span><span class="token expression"><span class="token punctuation">)</span><span class="token punctuation">;</span>                    </span><span class="token punctuation">\</span>
    <span class="token expression">Interpreter<span class="token operator">::</span>_entry_table<span class="token punctuation">[</span>Interpreter<span class="token operator">::</span>kind<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">generate_method_entry</span><span class="token punctuation">(</span>Interpreter<span class="token operator">::</span>kind<span class="token punctuation">)</span><span class="token punctuation">;</span>  </span><span class="token punctuation">\</span>
  <span class="token expression"><span class="token punctuation">&#125;</span></span></span>

  <span class="token comment">// all non-native method kinds</span>
  <span class="token function">method_entry</span><span class="token punctuation">(</span>zerolocals<span class="token punctuation">)</span>
  <span class="token function">method_entry</span><span class="token punctuation">(</span>zerolocals_synchronized<span class="token punctuation">)</span>
  <span class="token comment">// 动态方法支持</span>
  <span class="token function">initialize_method_handle_entries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// all native method kinds (must be one contiguous block)</span>
  Interpreter<span class="token operator">::</span>_native_entry_begin <span class="token operator">=</span> Interpreter<span class="token operator">::</span><span class="token function">code</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">code_end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">method_entry</span><span class="token punctuation">(</span>native<span class="token punctuation">)</span>
  <span class="token function">method_entry</span><span class="token punctuation">(</span>native_synchronized<span class="token punctuation">)</span>
  Interpreter<span class="token operator">::</span>_native_entry_end <span class="token operator">=</span> Interpreter<span class="token operator">::</span><span class="token function">code</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">code_end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">undef</span> <span class="token expression">method_entry</span></span>
  <span class="token comment">// Bytecodes</span>
  <span class="token function">set_entry_points_for_all_bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">set_safepoints_for_all_bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li>可以看到也是在<code>InterpreterGenerator</code>构造方法中调用了<code>generate_all</code>函数来给各种类型的方法生成并关联 EntryPoint<ul><li>具体逻辑就不概述了，思路一样</li></ul></li></ul><p>这里直接展示生成<code>zerolocals</code>类型方法的<code>EntryPoint</code>代码，但是不会做注释(汇编看不懂 😦 ，只能靠推测，为了不误导大家，只是贴出源代码作为了解 )</p><h4 id=interpretergenerator><a class=markdownIt-Anchor href=#interpretergenerator></a> InterpreterGenerator</h4><pre class="line-numbers language-c" data-language=c><code class=language-c>address InterpreterGenerator<span class="token operator">::</span><span class="token function">generate_normal_entry</span><span class="token punctuation">(</span>bool synchronized<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// determine code generation flags</span>
  bool inc_counter  <span class="token operator">=</span> UseCompiler <span class="token operator">||</span> CountCompiledCalls<span class="token punctuation">;</span>

  <span class="token comment">// rscratch1: sender sp</span>
  address entry_point <span class="token operator">=</span> __ <span class="token function">pc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> Address <span class="token function">constMethod</span><span class="token punctuation">(</span>rmethod<span class="token punctuation">,</span> Method<span class="token operator">::</span><span class="token function">const_offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> Address <span class="token function">access_flags</span><span class="token punctuation">(</span>rmethod<span class="token punctuation">,</span> Method<span class="token operator">::</span><span class="token function">access_flags_offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> Address <span class="token function">size_of_parameters</span><span class="token punctuation">(</span>r3<span class="token punctuation">,</span>
                                   ConstMethod<span class="token operator">::</span><span class="token function">size_of_parameters_offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> Address <span class="token function">size_of_locals</span><span class="token punctuation">(</span>r3<span class="token punctuation">,</span> ConstMethod<span class="token operator">::</span><span class="token function">size_of_locals_offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// get parameter size (always needed)</span>
  <span class="token comment">// need to load the const method first</span>
  __ <span class="token function">ldr</span><span class="token punctuation">(</span>r3<span class="token punctuation">,</span> constMethod<span class="token punctuation">)</span><span class="token punctuation">;</span>
  __ <span class="token function">load_unsigned_short</span><span class="token punctuation">(</span>r2<span class="token punctuation">,</span> size_of_parameters<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// r2: size of parameters</span>

  __ <span class="token function">load_unsigned_short</span><span class="token punctuation">(</span>r3<span class="token punctuation">,</span> size_of_locals<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// get size of locals in words</span>
  __ <span class="token function">sub</span><span class="token punctuation">(</span>r3<span class="token punctuation">,</span> r3<span class="token punctuation">,</span> r2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// r3 = no. of additional locals</span>

  <span class="token comment">// see if we've got enough room on the stack for locals plus overhead.</span>
  <span class="token function">generate_stack_overflow_check</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// compute beginning of parameters (rlocals)</span>
  __ <span class="token function">add</span><span class="token punctuation">(</span>rlocals<span class="token punctuation">,</span> esp<span class="token punctuation">,</span> r2<span class="token punctuation">,</span> ext<span class="token operator">::</span>uxtx<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  __ <span class="token function">sub</span><span class="token punctuation">(</span>rlocals<span class="token punctuation">,</span> rlocals<span class="token punctuation">,</span> wordSize<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Make room for locals</span>
  __ <span class="token function">sub</span><span class="token punctuation">(</span>rscratch1<span class="token punctuation">,</span> esp<span class="token punctuation">,</span> r3<span class="token punctuation">,</span> ext<span class="token operator">::</span>uxtx<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  __ <span class="token function">andr</span><span class="token punctuation">(</span>sp<span class="token punctuation">,</span> rscratch1<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// r3 - # of additional locals</span>
  <span class="token comment">// allocate space for locals</span>
  <span class="token comment">// explicitly initialize locals</span>
  <span class="token punctuation">&#123;</span>
    Label exit<span class="token punctuation">,</span> loop<span class="token punctuation">;</span>
    __ <span class="token function">ands</span><span class="token punctuation">(</span>zr<span class="token punctuation">,</span> r3<span class="token punctuation">,</span> r3<span class="token punctuation">)</span><span class="token punctuation">;</span>
    __ <span class="token function">br</span><span class="token punctuation">(</span>Assembler<span class="token operator">::</span>LE<span class="token punctuation">,</span> exit<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// do nothing if r3 &lt;= 0</span>
    __ <span class="token function">bind</span><span class="token punctuation">(</span>loop<span class="token punctuation">)</span><span class="token punctuation">;</span>
    __ <span class="token function">str</span><span class="token punctuation">(</span>zr<span class="token punctuation">,</span> <span class="token function">Address</span><span class="token punctuation">(</span>__ <span class="token function">post</span><span class="token punctuation">(</span>rscratch1<span class="token punctuation">,</span> wordSize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    __ <span class="token function">sub</span><span class="token punctuation">(</span>r3<span class="token punctuation">,</span> r3<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// until everything initialized</span>
    __ <span class="token function">cbnz</span><span class="token punctuation">(</span>r3<span class="token punctuation">,</span> loop<span class="token punctuation">)</span><span class="token punctuation">;</span>
    __ <span class="token function">bind</span><span class="token punctuation">(</span>exit<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// And the base dispatch table</span>
  __ <span class="token function">get_dispatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// initialize fixed part of activation frame</span>
  <span class="token function">generate_fixed_frame</span><span class="token punctuation">(</span>false<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// make sure method is not native &amp; not abstract</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">ASSERT</span></span>
  __ <span class="token function">ldrw</span><span class="token punctuation">(</span>r0<span class="token punctuation">,</span> access_flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#123;</span>
    Label L<span class="token punctuation">;</span>
    __ <span class="token function">tst</span><span class="token punctuation">(</span>r0<span class="token punctuation">,</span> JVM_ACC_NATIVE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    __ <span class="token function">br</span><span class="token punctuation">(</span>Assembler<span class="token operator">::</span>EQ<span class="token punctuation">,</span> L<span class="token punctuation">)</span><span class="token punctuation">;</span>
    __ <span class="token function">stop</span><span class="token punctuation">(</span><span class="token string">"tried to execute native method as non-native"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    __ <span class="token function">bind</span><span class="token punctuation">(</span>L<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
 <span class="token punctuation">&#123;</span>
    Label L<span class="token punctuation">;</span>
    __ <span class="token function">tst</span><span class="token punctuation">(</span>r0<span class="token punctuation">,</span> JVM_ACC_ABSTRACT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    __ <span class="token function">br</span><span class="token punctuation">(</span>Assembler<span class="token operator">::</span>EQ<span class="token punctuation">,</span> L<span class="token punctuation">)</span><span class="token punctuation">;</span>
    __ <span class="token function">stop</span><span class="token punctuation">(</span><span class="token string">"tried to execute abstract method in interpreter"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    __ <span class="token function">bind</span><span class="token punctuation">(</span>L<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

  <span class="token comment">// Since at this point in the method invocation the exception</span>
  <span class="token comment">// handler would try to exit the monitor of synchronized methods</span>
  <span class="token comment">// which hasn't been entered yet, we set the thread local variable</span>
  <span class="token comment">// _do_not_unlock_if_synchronized to true. The remove_activation</span>
  <span class="token comment">// will check this flag.</span>

   <span class="token keyword">const</span> Address <span class="token function">do_not_unlock_if_synchronized</span><span class="token punctuation">(</span>rthread<span class="token punctuation">,</span>
        <span class="token function">in_bytes</span><span class="token punctuation">(</span>JavaThread<span class="token operator">::</span><span class="token function">do_not_unlock_if_synchronized_offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  __ <span class="token function">mov</span><span class="token punctuation">(</span>rscratch2<span class="token punctuation">,</span> true<span class="token punctuation">)</span><span class="token punctuation">;</span>
  __ <span class="token function">strb</span><span class="token punctuation">(</span>rscratch2<span class="token punctuation">,</span> do_not_unlock_if_synchronized<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// increment invocation count &amp; check for overflow</span>
  Label invocation_counter_overflow<span class="token punctuation">;</span>
  Label profile_method<span class="token punctuation">;</span>
  Label profile_method_continue<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>inc_counter<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">generate_counter_incr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>invocation_counter_overflow<span class="token punctuation">,</span>
                          <span class="token operator">&amp;</span>profile_method<span class="token punctuation">,</span>
                          <span class="token operator">&amp;</span>profile_method_continue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ProfileInterpreter<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      __ <span class="token function">bind</span><span class="token punctuation">(</span>profile_method_continue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>

  Label continue_after_compile<span class="token punctuation">;</span>
  __ <span class="token function">bind</span><span class="token punctuation">(</span>continue_after_compile<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">bang_stack_shadow_pages</span><span class="token punctuation">(</span>false<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// reset the _do_not_unlock_if_synchronized flag</span>
  __ <span class="token function">strb</span><span class="token punctuation">(</span>zr<span class="token punctuation">,</span> do_not_unlock_if_synchronized<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// check for synchronized methods</span>
  <span class="token comment">// Must happen AFTER invocation_counter check and stack overflow check,</span>
  <span class="token comment">// so method is not locked if overflows.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>synchronized<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// Allocate monitor and lock method</span>
    <span class="token function">lock_method</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// no synchronization necessary</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">ASSERT</span></span>
    <span class="token punctuation">&#123;</span>
      Label L<span class="token punctuation">;</span>
      __ <span class="token function">ldrw</span><span class="token punctuation">(</span>r0<span class="token punctuation">,</span> access_flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
      __ <span class="token function">tst</span><span class="token punctuation">(</span>r0<span class="token punctuation">,</span> JVM_ACC_SYNCHRONIZED<span class="token punctuation">)</span><span class="token punctuation">;</span>
      __ <span class="token function">br</span><span class="token punctuation">(</span>Assembler<span class="token operator">::</span>EQ<span class="token punctuation">,</span> L<span class="token punctuation">)</span><span class="token punctuation">;</span>
      __ <span class="token function">stop</span><span class="token punctuation">(</span><span class="token string">"method needs synchronization"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      __ <span class="token function">bind</span><span class="token punctuation">(</span>L<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
  <span class="token punctuation">&#125;</span>

  <span class="token comment">// start execution</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">ASSERT</span></span>
  <span class="token punctuation">&#123;</span>
    Label L<span class="token punctuation">;</span>
     <span class="token keyword">const</span> Address <span class="token function">monitor_block_top</span> <span class="token punctuation">(</span>rfp<span class="token punctuation">,</span>
                 frame<span class="token operator">::</span>interpreter_frame_monitor_block_top_offset <span class="token operator">*</span> wordSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    __ <span class="token function">ldr</span><span class="token punctuation">(</span>rscratch1<span class="token punctuation">,</span> monitor_block_top<span class="token punctuation">)</span><span class="token punctuation">;</span>
    __ <span class="token function">cmp</span><span class="token punctuation">(</span>esp<span class="token punctuation">,</span> rscratch1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    __ <span class="token function">br</span><span class="token punctuation">(</span>Assembler<span class="token operator">::</span>EQ<span class="token punctuation">,</span> L<span class="token punctuation">)</span><span class="token punctuation">;</span>
    __ <span class="token function">stop</span><span class="token punctuation">(</span><span class="token string">"broken stack frame setup in interpreter"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    __ <span class="token function">bind</span><span class="token punctuation">(</span>L<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

  <span class="token comment">// jvmti support</span>
  __ <span class="token function">notify_method_entry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  __ <span class="token function">dispatch_next</span><span class="token punctuation">(</span>vtos<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// invocation counter overflow</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>inc_counter<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ProfileInterpreter<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token comment">// We have decided to profile this method in the interpreter</span>
      __ <span class="token function">bind</span><span class="token punctuation">(</span>profile_method<span class="token punctuation">)</span><span class="token punctuation">;</span>
      __ <span class="token function">call_VM</span><span class="token punctuation">(</span>noreg<span class="token punctuation">,</span> <span class="token function">CAST_FROM_FN_PTR</span><span class="token punctuation">(</span>address<span class="token punctuation">,</span> InterpreterRuntime<span class="token operator">::</span>profile_method<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      __ <span class="token function">set_method_data_pointer_for_bcp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// don't think we need this</span>
      __ <span class="token function">get_method</span><span class="token punctuation">(</span>r1<span class="token punctuation">)</span><span class="token punctuation">;</span>
      __ <span class="token function">b</span><span class="token punctuation">(</span>profile_method_continue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// Handle overflow of counter and compile method</span>
    __ <span class="token function">bind</span><span class="token punctuation">(</span>invocation_counter_overflow<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">generate_counter_overflow</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>continue_after_compile<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">return</span> entry_point<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>上面的代码中在48行处调用了<code>generate_fixed_frame</code>，为解释器方法生成栈帧，并且会在栈上存放后续方法执行所需要的常量池，以及分配目标执行方法内部的局部变量所使用到的空间</p><pre class="line-numbers language-c" data-language=c><code class=language-c><span class="token keyword">void</span> TemplateInterpreterGenerator<span class="token operator">::</span><span class="token function">generate_fixed_frame</span><span class="token punctuation">(</span>bool native_call<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">// initialize fixed part of activation frame</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>native_call<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    __ <span class="token function">sub</span><span class="token punctuation">(</span>esp<span class="token punctuation">,</span> sp<span class="token punctuation">,</span> <span class="token number">12</span> <span class="token operator">*</span>  wordSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    __ <span class="token function">mov</span><span class="token punctuation">(</span>rbcp<span class="token punctuation">,</span> zr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    __ <span class="token function">stp</span><span class="token punctuation">(</span>esp<span class="token punctuation">,</span> zr<span class="token punctuation">,</span> <span class="token function">Address</span><span class="token punctuation">(</span>__ <span class="token function">pre</span><span class="token punctuation">(</span>sp<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">12</span> <span class="token operator">*</span> wordSize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// add 2 zero-initialized slots for native calls</span>
    __ <span class="token function">stp</span><span class="token punctuation">(</span>zr<span class="token punctuation">,</span> zr<span class="token punctuation">,</span> <span class="token function">Address</span><span class="token punctuation">(</span>sp<span class="token punctuation">,</span> <span class="token number">10</span> <span class="token operator">*</span> wordSize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    __ <span class="token function">sub</span><span class="token punctuation">(</span>esp<span class="token punctuation">,</span> sp<span class="token punctuation">,</span> <span class="token number">10</span> <span class="token operator">*</span>  wordSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    __ <span class="token function">ldr</span><span class="token punctuation">(</span>rscratch1<span class="token punctuation">,</span> <span class="token function">Address</span><span class="token punctuation">(</span>rmethod<span class="token punctuation">,</span> Method<span class="token operator">::</span><span class="token function">const_offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// get ConstMethod</span>
    __ <span class="token function">add</span><span class="token punctuation">(</span>rbcp<span class="token punctuation">,</span> rscratch1<span class="token punctuation">,</span> <span class="token function">in_bytes</span><span class="token punctuation">(</span>ConstMethod<span class="token operator">::</span><span class="token function">codes_offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// get codebase</span>
    __ <span class="token function">stp</span><span class="token punctuation">(</span>esp<span class="token punctuation">,</span> rbcp<span class="token punctuation">,</span> <span class="token function">Address</span><span class="token punctuation">(</span>__ <span class="token function">pre</span><span class="token punctuation">(</span>sp<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">10</span> <span class="token operator">*</span> wordSize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>ProfileInterpreter<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    Label method_data_continue<span class="token punctuation">;</span>
    __ <span class="token function">ldr</span><span class="token punctuation">(</span>rscratch1<span class="token punctuation">,</span> <span class="token function">Address</span><span class="token punctuation">(</span>rmethod<span class="token punctuation">,</span> Method<span class="token operator">::</span><span class="token function">method_data_offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    __ <span class="token function">cbz</span><span class="token punctuation">(</span>rscratch1<span class="token punctuation">,</span> method_data_continue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    __ <span class="token function">lea</span><span class="token punctuation">(</span>rscratch1<span class="token punctuation">,</span> <span class="token function">Address</span><span class="token punctuation">(</span>rscratch1<span class="token punctuation">,</span> <span class="token function">in_bytes</span><span class="token punctuation">(</span>MethodData<span class="token operator">::</span><span class="token function">data_offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    __ <span class="token function">bind</span><span class="token punctuation">(</span>method_data_continue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    __ <span class="token function">stp</span><span class="token punctuation">(</span>rscratch1<span class="token punctuation">,</span> rmethod<span class="token punctuation">,</span> <span class="token function">Address</span><span class="token punctuation">(</span>sp<span class="token punctuation">,</span> <span class="token number">4</span> <span class="token operator">*</span> wordSize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// save Method* and mdp (method data pointer)</span>
  <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
    __ <span class="token function">stp</span><span class="token punctuation">(</span>zr<span class="token punctuation">,</span> rmethod<span class="token punctuation">,</span> <span class="token function">Address</span><span class="token punctuation">(</span>sp<span class="token punctuation">,</span> <span class="token number">4</span> <span class="token operator">*</span> wordSize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// save Method* (no mdp)</span>
  <span class="token punctuation">&#125;</span>

  __ <span class="token function">ldr</span><span class="token punctuation">(</span>rcpool<span class="token punctuation">,</span> <span class="token function">Address</span><span class="token punctuation">(</span>rmethod<span class="token punctuation">,</span> Method<span class="token operator">::</span><span class="token function">const_offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  __ <span class="token function">ldr</span><span class="token punctuation">(</span>rcpool<span class="token punctuation">,</span> <span class="token function">Address</span><span class="token punctuation">(</span>rcpool<span class="token punctuation">,</span> ConstMethod<span class="token operator">::</span><span class="token function">constants_offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  __ <span class="token function">ldr</span><span class="token punctuation">(</span>rcpool<span class="token punctuation">,</span> <span class="token function">Address</span><span class="token punctuation">(</span>rcpool<span class="token punctuation">,</span> ConstantPool<span class="token operator">::</span><span class="token function">cache_offset_in_bytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  __ <span class="token function">stp</span><span class="token punctuation">(</span>rlocals<span class="token punctuation">,</span> rcpool<span class="token punctuation">,</span> <span class="token function">Address</span><span class="token punctuation">(</span>sp<span class="token punctuation">,</span> <span class="token number">2</span> <span class="token operator">*</span> wordSize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  __ <span class="token function">stp</span><span class="token punctuation">(</span>rfp<span class="token punctuation">,</span> lr<span class="token punctuation">,</span> <span class="token function">Address</span><span class="token punctuation">(</span>sp<span class="token punctuation">,</span> <span class="token number">8</span> <span class="token operator">*</span> wordSize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  __ <span class="token function">lea</span><span class="token punctuation">(</span>rfp<span class="token punctuation">,</span> <span class="token function">Address</span><span class="token punctuation">(</span>sp<span class="token punctuation">,</span> <span class="token number">8</span> <span class="token operator">*</span> wordSize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// set sender sp</span>
  <span class="token comment">// leave last_sp as null</span>
  __ <span class="token function">stp</span><span class="token punctuation">(</span>zr<span class="token punctuation">,</span> r13<span class="token punctuation">,</span> <span class="token function">Address</span><span class="token punctuation">(</span>sp<span class="token punctuation">,</span> <span class="token number">6</span> <span class="token operator">*</span> wordSize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Move SP out of the way</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> native_call<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    __ <span class="token function">ldr</span><span class="token punctuation">(</span>rscratch1<span class="token punctuation">,</span> <span class="token function">Address</span><span class="token punctuation">(</span>rmethod<span class="token punctuation">,</span> Method<span class="token operator">::</span><span class="token function">const_offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// </span>
    __ <span class="token function">ldrh</span><span class="token punctuation">(</span>rscratch1<span class="token punctuation">,</span> <span class="token function">Address</span><span class="token punctuation">(</span>rscratch1<span class="token punctuation">,</span> ConstMethod<span class="token operator">::</span><span class="token function">max_stack_offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    __ <span class="token function">add</span><span class="token punctuation">(</span>rscratch1<span class="token punctuation">,</span> rscratch1<span class="token punctuation">,</span> frame<span class="token operator">::</span><span class="token function">interpreter_frame_monitor_size</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
           <span class="token operator">+</span> <span class="token punctuation">(</span>EnableInvokeDynamic <span class="token operator">?</span> <span class="token number">2</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    __ <span class="token function">sub</span><span class="token punctuation">(</span>rscratch1<span class="token punctuation">,</span> sp<span class="token punctuation">,</span> rscratch1<span class="token punctuation">,</span> ext<span class="token operator">::</span>uxtw<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    __ <span class="token function">andr</span><span class="token punctuation">(</span>sp<span class="token punctuation">,</span> rscratch1<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden=true class=line-numbers-rows><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><p>本文到此结束，可能有诸多纰漏之处还请指正</p></article><div class=post-copyright><div class=post-copyright__author><span class=post-copyright-meta><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class=post-copyright-info><a href=https://juzzia.github.io>Juzzia</a></span></div><div class=post-copyright__type><span class=post-copyright-meta><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class=post-copyright-info><a href=https://juzzia.github.io/posts/f95e72b6.html>https://juzzia.github.io/posts/f95e72b6.html</a></span></div><div class=post-copyright__notice><span class=post-copyright-meta><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class=post-copyright-info>本博客所有文章除特别声明外，均采用 <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/ target=_blank>CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href=https://juzzia.github.io target=_blank>Juzzia's Blog</a>！</span></div></div><div class=tag_share><div class=post-meta__tag-list><a class=post-meta__tags href=/tags/%E6%BA%90%E7%A0%81/ >源码</a><a class=post-meta__tags href=/tags/JVM/ >JVM</a></div><div class=post_share><div class=social-share data-image=/img/avatar.jpg data-sites=wechat,weibo,qq></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css media=print onload='this.media="all"'><script src=https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js defer=defer></script></div></div><div class=post-reward><div class=reward-button><i class="fas fa-qrcode"></i>赞助</div><div class=reward-main><ul class=reward-all><li class=reward-item><a href=https://s2.loli.net/2024/08/01/jL2klE39vx5Ft4r.jpg target=_blank><img class=post-qr-code-img src=https://s2.loli.net/2024/08/01/jL2klE39vx5Ft4r.jpg alt=wechat></a><div class=post-qr-code-desc>wechat</div></li><li class=reward-item><a href=https://s2.loli.net/2024/08/01/2s3UCWdlneAiYRa.jpg target=_blank><img class=post-qr-code-img src=https://s2.loli.net/2024/08/01/2s3UCWdlneAiYRa.jpg alt=alipay></a><div class=post-qr-code-desc>alipay</div></li></ul></div></div><nav class=pagination-post id=pagination><div class="prev-post pull-left"><a href=/posts/991d833e.html title="Liunx Futex"><div class=cover style=background:var(--default-bg-color)></div><div class=pagination-info><div class=label>上一篇</div><div class=prev_info>Liunx Futex</div></div></a></div><div class="next-post pull-right"><a href=/posts/48bea92d.html title=Hotspot源码剖析Java方法执行流程><div class=cover style=background:var(--default-bg-color)></div><div class=pagination-info><div class=label>下一篇</div><div class=next_info>Hotspot源码剖析Java方法执行流程</div></div></a></div></nav><div class=relatedPosts><div class=headline><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class=relatedPosts-list><div><a href=/posts/6961ed95.html title="JVM Atomic源码解析"><div class=cover style=background:var(--default-bg-color)></div><div class="content is-center"><div class=date><i class="far fa-calendar-alt fa-fw"></i> 2025-02-16</div><div class=title>JVM Atomic源码解析</div></div></a></div><div><a href=/posts/1fe4afce.html title="字节码指令执行过程 BytecodeInterpreter"><div class=cover style=background:var(--default-bg-color)></div><div class="content is-center"><div class=date><i class="far fa-calendar-alt fa-fw"></i> 2025-03-07</div><div class=title>字节码指令执行过程 BytecodeInterpreter</div></div></a></div></div></div><hr class=custom-hr><div id=post-comment><div class=comment-head><div class=comment-headline><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class=comment-wrap><div><div id=giscus-wrap></div></div></div></div></div><div class=aside-content id=aside-content><div class="card-widget card-info"><div class=is-center><div class=avatar-img><img src=/img/avatar.jpg onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt=avatar></div><div class=author-info__name>Juzzia</div><div class=author-info__description>分享技术，开发经验，学习总结</div></div><div class="card-info-data site-data is-center"><a href=/archives/ ><div class=headline>文章</div><div class=length-num>10</div></a><a href=/tags/ ><div class=headline>标签</div><div class=length-num>4</div></a><a href=/categories/ ><div class=headline>分类</div><div class=length-num>5</div></a></div><a id=card-info-btn target=_blank rel=noopener href=https://github.com/juzzia><i class="fab fa-github"></i><span>github</span></a><div class="card-info-social-icons is-center"><a class=social-icon href=https://github.com/juzzia target=_blank title=Github><i class="fab fa-github" style=color:#24292e></i></a><a class=social-icon href=mailto:juzzia@github.com target=_blank title=Email><i class="fas fa-envelope" style=color:#4a7dbe></i></a></div></div><div class=sticky_layout><div class=card-widget id=card-toc><div class=item-headline><i class="fas fa-stream"></i><span>目录</span><span class=toc-percentage></span></div><div class="toc-content is-expand"><ol class=toc><li class="toc-item toc-level-1"><a class=toc-link href=#%E4%BB%8B%E7%BB%8D><span class=toc-number>1.</span> <span class=toc-text>介绍</span></a></li><li class="toc-item toc-level-1"><a class=toc-link href=#hotspot%E4%B8%AD%E7%9A%84%E5%AE%9E%E7%8E%B0><span class=toc-number>2.</span> <span class=toc-text>Hotspot中的实现</span></a><ol class=toc-child><li class="toc-item toc-level-2"><a class=toc-link href=#interpreter><span class=toc-number>2.1.</span> <span class=toc-text>Interpreter</span></a></li><li class="toc-item toc-level-2"><a class=toc-link href=#abstractinterpreter><span class=toc-number>2.2.</span> <span class=toc-text>AbstractInterpreter</span></a><ol class=toc-child><li class="toc-item toc-level-3"><a class=toc-link href=#cppinterpreter><span class=toc-number>2.2.1.</span> <span class=toc-text>CppInterpreter</span></a><ol class=toc-child><li class="toc-item toc-level-4"><a class=toc-link href=#cppinterpreter_zero><span class=toc-number>2.2.1.1.</span> <span class=toc-text>CppInterpreter_zero</span></a></li></ol></li><li class="toc-item toc-level-3"><a class=toc-link href=#templateinterpreter><span class=toc-number>2.2.2.</span> <span class=toc-text>TemplateInterpreter</span></a><ol class=toc-child><li class="toc-item toc-level-4"><a class=toc-link href=#templatetable><span class=toc-number>2.2.2.1.</span> <span class=toc-text>TemplateTable</span></a></li><li class="toc-item toc-level-4"><a class=toc-link href=#interpretergenerator><span class=toc-number>2.2.2.2.</span> <span class=toc-text>InterpreterGenerator</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class=item-headline><i class="fas fa-history"></i><span>最新文章</span></div><div class=aside-list><div class="aside-list-item no-cover"><div class=content><a class=title href=/posts/1fe4afce.html title="字节码指令执行过程 BytecodeInterpreter">字节码指令执行过程 BytecodeInterpreter</a><time datetime=2025-03-07T13:34:00.000Z title="发表于 2025-03-07 21:34:00">2025-03-07</time></div></div><div class="aside-list-item no-cover"><div class=content><a class=title href=/posts/1a5fbe08.html title=CPU缓存与MESI协议>CPU缓存与MESI协议</a><time datetime=2025-03-04T12:42:00.000Z title="发表于 2025-03-04 20:42:00">2025-03-04</time></div></div><div class="aside-list-item no-cover"><div class=content><a class=title href=/posts/bcc098b4.html title="Liunx 任务调度">Liunx 任务调度</a><time datetime=2025-02-24T13:52:00.000Z title="发表于 2025-02-24 21:52:00">2025-02-24</time></div></div><div class="aside-list-item no-cover"><div class=content><a class=title href=/posts/991d833e.html title="Liunx Futex">Liunx Futex</a><time datetime=2025-02-22T15:33:00.000Z title="发表于 2025-02-22 23:33:00">2025-02-22</time></div></div><div class="aside-list-item no-cover"><div class=content><a class=title href=/posts/f95e72b6.html title="字节码解释器 Interpreter">字节码解释器 Interpreter</a><time datetime=2025-02-18T14:45:00.000Z title="发表于 2025-02-18 22:45:00">2025-02-18</time></div></div></div></div></div></div></main></div><div id=rightside><div id=rightside-config-hide><button id=readmode type=button title=阅读模式><i class="fas fa-book-open"></i></button><button id=darkmode type=button title=浅色和深色模式转换><i class="fas fa-adjust"></i></button><button id=hide-aside-btn type=button title=单栏和双栏切换><i class="fas fa-arrows-alt-h"></i></button></div><div id=rightside-config-show><button id=rightside-config type=button title=设置><i class="fas fa-cog fa-spin"></i></button><button class=close id=mobile-toc-button type=button title=目录><i class="fas fa-list-ul"></i></button><a id=to_comment href=#post-comment title=直达评论><i class="fas fa-comments"></i></a><button id=go-up type=button title=回到顶部><span class=scroll-percent></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.13.0"></script><script src="/js/main.js?v=4.13.0"></script><script src=https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js></script><script>function panguFn(){"object"==typeof pangu?pangu.autoSpacingPage():getScript("https://cdn.jsdelivr.net/npm/pangu@4.0.7/dist/browser/pangu.min.js").then(()=>{pangu.autoSpacingPage()})}function panguInit(){panguFn()}document.addEventListener("DOMContentLoaded",panguInit)</script><div class=js-pjax><script>(()=>{var e=()=>{var e;0!==(e=document.querySelectorAll("pre > code.mermaid")).length&&e.forEach(e=>{var t=document.createElement("div");t.className="mermaid-wrap",t.innerHTML=`<pre class="mermaid-src" hidden>${e.textContent}</pre>`,e.parentNode.replaceWith(t)});let t=document.querySelectorAll("#article-container .mermaid");0!==t.length&&(e=()=>(e=>{window.loadMermaid=!0;let c="dark"===document.documentElement.getAttribute("data-theme")?"dark":"default";Array.from(e).forEach((e,t)=>{let n=e.firstElementChild;e="%%{init:{ 'theme':'"+c+"'}}%%\n"+n.textContent;let i=mermaid.render("mermaid-"+t,e);"string"==typeof i?(t=i,n.insertAdjacentHTML("afterend",t)):(i.then(({svg:e})=>{n.insertAdjacentHTML("afterend",e)}),setTimeout(()=>{var e=document.getElementsByTagName("svg");Array.from(e).forEach((e,t)=>{o(e)})},3e3))})})(t),btf.addGlobalFn("themeChange",e,"mermaid"),window.loadMermaid?e():btf.getScript("https://cdn.jsdelivr.net/npm/mermaid@11.0.0/dist/mermaid.min.js").then(e))};let o=l=>{let u=1,m=0,h=0,c=!1,o,d,r=0,e=!1,t=1,n=0,i=0;function a(){u=t,m=n,h=i,e=!1,s()}function s(){l.style.transform=`translate(${m}px, ${h}px) scale(${u})`}l.addEventListener("wheel",function(e){e.preventDefault();var t=0<e.deltaY?-.04:.04,n=(t=Math.min(Math.max(u+t,1),2.3))/u,i=l.getBoundingClientRect(),c=(e.clientX-i.left)/i.width,e=(e.clientY-i.top)/i.height,i=l.getBBox(),c=c*i.width,e=e*i.height;m=m*n-c*(n-1),h=h*n-e*(n-1),u=t,s()}),l.addEventListener("mousedown",function(e){c=!0,o=e.clientX,d=e.clientY,l.style.cursor="grabbing"}),document.addEventListener("mousemove",function(e){c&&(m+=e.clientX-o,h+=e.clientY-d,o=e.clientX,d=e.clientY,s())}),document.addEventListener("mouseup",function(){c=!1,l.style.cursor="grab"}),l.parentElement.addEventListener("dblclick",function(e){var t=Date.now();a(),r=t}),l.addEventListener("touchstart",function(e){if(1===e.touches.length&&((t=Date.now())-r<300&&(n=Date.now(),a(),r=n),r=t),1===(n=e).touches.length)c=!0,o=n.touches[0].clientX,d=n.touches[0].clientY;else if(2===n.touches.length){var t=n.touches[0].clientX-n.touches[1].clientX,n=n.touches[0].clientY-n.touches[1].clientY;let o=Math.sqrt(t*t+n*n),d=m,r=h,a=u;function i(e){var t,n,i,c;2===e.touches.length&&(t=e.touches[0].clientX-e.touches[1].clientX,n=e.touches[0].clientY-e.touches[1].clientY,t=Math.sqrt(t*t+n*n)/o,n=Math.min(Math.max(a*t,.5),1.15),c=(e.touches[0].clientX+e.touches[1].clientX)/2-l.getBoundingClientRect().left,e=(e.touches[0].clientY+e.touches[1].clientY)/2-l.getBoundingClientRect().top,i=l.getBBox(),c=c/l.getBoundingClientRect().width*i.width,e=e/l.getBoundingClientRect().height*i.height,m=d*t-c*(t-1),h=r*t-e*(t-1),u=n,s())}document.addEventListener("touchmove",i),document.addEventListener("touchend",function e(){document.removeEventListener("touchmove",i),document.removeEventListener("touchend",e)})}}),document.addEventListener("touchend",function(){c=!1})};btf.addGlobalFn("encrypt",e,"mermaid"),window.pjax?e():document.addEventListener("DOMContentLoaded",e)})()</script><script>(()=>{let s=t=>"dark"===t?"dark":"light";var t=()=>{var t,e=Object.assign({src:"https://giscus.app/client.js","data-repo":"juzzia/blog-comment","data-repo-id":"R_kgDOMc3hsw","data-category-id":"DIC_kwDOMc3hs84ChTYG","data-mapping":"pathname","data-theme":s(document.documentElement.getAttribute("data-theme")),"data-reactions-enabled":"1",crossorigin:"anonymous",async:!0},{"data-input-position":"top","data-emit-metadata":1,"data-lang":"zh-CN"}),a=document.createElement("script");for(t in e)a.setAttribute(t,e[t]);document.getElementById("giscus-wrap").appendChild(a)};function e(t){var e=document.querySelector("#post-meta .gsc-comments-count");e&&(e.textContent=t)}window.addEventListener("message",function(t){"https://giscus.app"===t.origin&&"object"==typeof t.data&&t.data.giscus&&((t=t.data.giscus).error?e(0):t.discussion&&e(t.discussion.totalCommentCount+t.discussion.totalReplyCount))}),btf.addGlobalFn("themeChange",t=>{var e;t={setConfig:{theme:s(t)}},(e=document.querySelector("iframe.giscus-frame"))&&e.contentWindow.postMessage({giscus:t},"https://giscus.app")},"giscus"),t()})()</script></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.css media=print onload='this.media="all"'><script src=https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.js></script><script src=https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/metingjs/dist/Meting.min.js></script><script async data-pjax src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><div id=local-search><div class=search-dialog><nav class=search-nav><span class=search-dialog-title>搜索</span><span id=loading-status></span><button class=search-close-button><i class="fas fa-times"></i></button></nav><div class=is-center id=loading-database><i class="fas fa-spinner fa-pulse"></i><span> 数据库加载中</span></div><div class=search-wrap><div id=local-search-input><div class=local-search-box><input class=local-search-box--input placeholder=搜索文章 type=text></div></div><hr><div id=local-search-results></div><div id=local-search-stats-wrap></div></div></div><div id=search-mask></div><script src="/js/search/local-search.js?v=4.13.0"></script></div></div></body></html>